<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete documentation for MediaNest - Advanced Media Management Platform with Plex Integration, API, and Developer Resources"><meta name=author content="MediaNest Development Team"><link href=https://docs.medianest.com/AUTHENTICATION_ARCHITECTURE/ rel=canonical><link rel=icon href=../assets/images/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.18"><title>MediaNest Authentication Architecture and Implementation Guide - MediaNest Documentation</title><link rel=stylesheet href=../assets/stylesheets/main.7e37652d.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../css/timeago.css><link rel=stylesheet href=../assets/stylesheets/extra.css><link rel=stylesheet href=../assets/stylesheets/medianest-theme.css><link rel=stylesheet href=../assets/stylesheets/animations.css><link rel=stylesheet href=../assets/stylesheets/responsive.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=purple><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#medianest-authentication-architecture-and-implementation-guide class=md-skip> Skip to content </a></div><div data-md-component=announce></div><div data-md-color-scheme=default data-md-component=outdated hidden></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=.. title="MediaNest Documentation" class="md-header__button md-logo" aria-label="MediaNest Documentation" data-md-component=logo><img src=../assets/images/logo.svg alt=logo></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> MediaNest Documentation </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> MediaNest Authentication Architecture and Implementation Guide </span></div></div></div><form class=md-header__option data-md-component=palette><input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=deep-purple data-md-color-accent=purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav class=md-search__options aria-label=Search><a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg></a><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav><div class=md-search__suggest data-md-component=search-suggest></div></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div><div class=md-header__source><a href=https://github.com/medianest/medianest title="Go to repository" class=md-source data-md-component=source><div class="md-source__icon md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg></div><div class=md-source__repository> MediaNest/MediaNest </div></a></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=.. class=md-tabs__link> Home </a></li><li class=md-tabs__item><a href=../getting-started/ class=md-tabs__link> Getting Started </a></li><li class=md-tabs__item><a href=../installation/ class=md-tabs__link> Installation </a></li><li class=md-tabs__item><a href=../user-guides/ class=md-tabs__link> User Guides </a></li><li class=md-tabs__item><a href=../api/ class=md-tabs__link> API Reference </a></li><li class=md-tabs__item><a href=../developers/ class=md-tabs__link> Developer Docs </a></li><li class=md-tabs__item><a href=../troubleshooting/ class=md-tabs__link> Troubleshooting </a></li><li class=md-tabs__item><a href=../reference/ class=md-tabs__link> Reference </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=.. title="MediaNest Documentation" class="md-nav__button md-logo" aria-label="MediaNest Documentation" data-md-component=logo><img src=../assets/images/logo.svg alt=logo></a> MediaNest Documentation </label><div class=md-nav__source><a href=https://github.com/medianest/medianest title="Go to repository" class=md-source data-md-component=source><div class="md-source__icon md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg></div><div class=md-source__repository> MediaNest/MediaNest </div></a></div><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=.. class=md-nav__link><span class=md-ellipsis> Home </span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../getting-started/ class=md-nav__link><span class=md-ellipsis> Getting Started </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../installation/ class=md-nav__link><span class=md-ellipsis> Installation </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../user-guides/ class=md-nav__link><span class=md-ellipsis> User Guides </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../api/ class=md-nav__link><span class=md-ellipsis> API Reference </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../developers/ class=md-nav__link><span class=md-ellipsis> Developer Docs </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../troubleshooting/ class=md-nav__link><span class=md-ellipsis> Troubleshooting </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../reference/ class=md-nav__link><span class=md-ellipsis> Reference </span><span class="md-nav__icon md-icon"></span></a></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><a href=https://github.com/medianest/medianest/edit/develop/docs/AUTHENTICATION_ARCHITECTURE.md title="Edit this page" class="md-content__button md-icon" rel=edit><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg></a><a href=https://github.com/medianest/medianest/raw/develop/docs/AUTHENTICATION_ARCHITECTURE.md title="View source of this page" class="md-content__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg></a><h1 id=medianest-authentication-architecture-and-implementation-guide>MediaNest Authentication Architecture and Implementation Guide<a class=headerlink href=#medianest-authentication-architecture-and-implementation-guide title="Permanent link">&para;</a></h1><p><strong>Version:</strong> 2.0<br><strong>Date:</strong> January 2025<br><strong>Status:</strong> Enhanced - System Architecture Review Complete </p><h2 id=table-of-contents>Table of Contents<a class=headerlink href=#table-of-contents title="Permanent link">&para;</a></h2><ol><li><a href=#1-overview>Overview</a></li><li><a href=#2-architecture-design>Architecture Design</a></li><li><a href=#3-technology-stack>Technology Stack</a></li><li><a href=#4-authentication-flow>Authentication Flow</a></li><li><a href=#5-implementation-details>Implementation Details</a></li><li><a href=#6-security-measures>Security Measures</a></li><li><a href=#7-session-management>Session Management</a></li><li><a href=#8-role-based-access-control>Role-Based Access Control</a></li><li><a href=#9-api-authentication>API Authentication</a></li><li><a href=#10-enhanced-security-features>Enhanced Security Features</a></li><li><a href=#11-scalability-architecture>Scalability Architecture</a></li><li><a href=#12-integration-patterns>Integration Patterns</a></li><li><a href=#13-code-examples>Code Examples</a></li><li><a href=#14-testing-strategy>Testing Strategy</a></li><li><a href=#15-migration-strategy>Migration Strategy</a></li><li><a href=#16-troubleshooting>Troubleshooting</a></li></ol><h2 id=1-overview>1. Overview<a class=headerlink href=#1-overview title="Permanent link">&para;</a></h2><p>MediaNest's authentication system is designed to provide secure, seamless access for 10-20 concurrent users while integrating with Plex's OAuth PIN flow. The architecture prioritizes security, user experience, and maintainability.</p><h3 id=key-features>Key Features<a class=headerlink href=#key-features title="Permanent link">&para;</a></h3><ul><li><strong>Primary Authentication</strong>: Plex OAuth PIN flow with enhanced security</li><li><strong>Admin Bootstrap</strong>: Initial admin/admin login with forced password change</li><li><strong>Session Management</strong>: JWT tokens with Redis-backed sessions and automatic cleanup</li><li><strong>Remember Me</strong>: 90-day persistent authentication with rotation</li><li><strong>Role-Based Access</strong>: Admin and User roles with granular permissions</li><li><strong>API Security</strong>: JWT-protected endpoints with sophisticated rate limiting</li><li><strong>Enhanced Security</strong>: Password reset flows, email verification, 2FA readiness</li><li><strong>Multi-Provider Support</strong>: Architecture ready for GitHub, Google OAuth</li><li><strong>Audit Logging</strong>: Comprehensive authentication event tracking</li><li><strong>Scalability</strong>: Distributed session management and horizontal scaling support</li></ul><h3 id=design-principles>Design Principles<a class=headerlink href=#design-principles title="Permanent link">&para;</a></h3><ol><li><strong>Security First</strong>: All sensitive data encrypted, tokens rotated regularly, zero-trust architecture</li><li><strong>User-Friendly</strong>: Single sign-on with Plex credentials, fallback authentication methods</li><li><strong>Stateless API</strong>: JWT tokens for horizontal scalability with Redis session coordination</li><li><strong>Graceful Degradation</strong>: System functions even if external auth providers are unavailable</li><li><strong>Enterprise-Ready</strong>: Audit trails, compliance features, and administrative controls</li><li><strong>Future-Proof</strong>: Modular architecture supporting additional authentication methods</li><li><strong>Performance</strong>: Optimized for 10-20 users with ability to scale to 100+</li></ol><h2 id=2-architecture-design>2. Architecture Design<a class=headerlink href=#2-architecture-design title="Permanent link">&para;</a></h2><div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>┌─────────────────────────────────────────────────────────────┐
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>│                   Authentication Flow                        │
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>├─────────────────────────────────────────────────────────────┤
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>│                                                             │
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>│  ┌──────────┐    ┌──────────────┐    ┌──────────────────┐ │
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>│  │  Client  │───►│  Next.js App │───►│ Express Backend  │ │
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>│  │ Browser  │    │  (Frontend)  │    │     (API)        │ │
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>│  └──────────┘    └──────────────┘    └──────────────────┘ │
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>│        │                 │                     │            │
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>│        │                 │                     │            │
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>│        │         ┌───────▼────────┐           │            │
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>│        │         │  NextAuth.js   │           │            │
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>│        │         │  (Auth Layer)  │           │            │
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>│        │         └───────┬────────┘           │            │
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>│        │                 │                     │            │
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>│        │         ┌───────▼────────┐    ┌──────▼────────┐  │
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>│        └────────►│   Plex OAuth   │    │ JWT Manager   │  │
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>│                  │   (PIN Flow)   │    │  (Express)    │  │
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>│                  └────────────────┘    └───────────────┘  │
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>│                                                │            │
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>│                                        ┌───────▼────────┐  │
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>│                                        │     Redis      │  │
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>│                                        │ (Session Store)│  │
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>│                                        └────────────────┘  │
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>└─────────────────────────────────────────────────────────────┘
</span></code></pre></div><h3 id=component-responsibilities>Component Responsibilities<a class=headerlink href=#component-responsibilities title="Permanent link">&para;</a></h3><ul><li><strong>NextAuth.js</strong>: Manages authentication flows, session creation, and provider integration</li><li><strong>Plex OAuth</strong>: Handles PIN-based authentication without client secrets</li><li><strong>JWT Manager</strong>: Issues and validates API tokens</li><li><strong>Redis</strong>: Stores sessions, rate limits, and remember tokens</li></ul><h2 id=3-technology-stack>3. Technology Stack<a class=headerlink href=#3-technology-stack title="Permanent link">&para;</a></h2><h3 id=core-dependencies>Core Dependencies<a class=headerlink href=#core-dependencies title="Permanent link">&para;</a></h3><div class="language-json highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=p>{</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>  </span><span class=nt>&quot;dependencies&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=nt>&quot;next-auth&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^5.x&quot;</span><span class=p>,</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span><span class=nt>&quot;@auth/prisma-adapter&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^2.x&quot;</span><span class=p>,</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>    </span><span class=nt>&quot;jsonwebtoken&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^9.x&quot;</span><span class=p>,</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>    </span><span class=nt>&quot;bcryptjs&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^2.x&quot;</span><span class=p>,</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>    </span><span class=nt>&quot;ioredis&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^5.x&quot;</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=p>}</span>
</span></code></pre></div><h3 id=key-libraries>Key Libraries<a class=headerlink href=#key-libraries title="Permanent link">&para;</a></h3><ul><li><strong>NextAuth.js</strong>: Authentication framework for Next.js</li><li><strong>Prisma</strong>: Database ORM with type safety</li><li><strong>jsonwebtoken</strong>: JWT token generation and validation</li><li><strong>bcryptjs</strong>: Password hashing for admin bootstrap</li><li><strong>ioredis</strong>: Redis client for session management</li></ul><h2 id=4-authentication-flow>4. Authentication Flow<a class=headerlink href=#4-authentication-flow title="Permanent link">&para;</a></h2><h3 id=41-plex-oauth-pin-flow>4.1 Plex OAuth PIN Flow<a class=headerlink href=#41-plex-oauth-pin-flow title="Permanent link">&para;</a></h3><pre class=mermaid><code>sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant Plex
    participant Database
    participant Redis

    User-&gt;&gt;Frontend: Click "Login with Plex"
    Frontend-&gt;&gt;Backend: POST /api/auth/plex/pin
    Backend-&gt;&gt;Plex: POST /pins (generate PIN)
    Plex-&gt;&gt;Backend: Return {id, code}
    Backend-&gt;&gt;Frontend: Return {pin, authUrl, pinId}
    Frontend-&gt;&gt;User: Display PIN &amp; plex.tv/link

    Note over User,Plex: User enters PIN at plex.tv/link

    loop Poll for authorization (max 30 attempts)
        Frontend-&gt;&gt;Backend: GET /api/auth/plex/poll/{pinId}
        Backend-&gt;&gt;Plex: GET /pins/{pinId}
        alt PIN claimed
            Plex-&gt;&gt;Backend: Return {authToken}
            Backend-&gt;&gt;Plex: GET /users/account
            Plex-&gt;&gt;Backend: Return user data
            Backend-&gt;&gt;Database: Create/update user
            Backend-&gt;&gt;Redis: Store session
            Backend-&gt;&gt;Frontend: Return {token, user}
            Frontend-&gt;&gt;User: Redirect to dashboard
        else PIN not claimed
            Plex-&gt;&gt;Backend: Return {authToken: null}
            Backend-&gt;&gt;Frontend: Return {pending: true}
        end
    end</code></pre><h3 id=42-admin-bootstrap-flow>4.2 Admin Bootstrap Flow<a class=headerlink href=#42-admin-bootstrap-flow title="Permanent link">&para;</a></h3><div class="language-javascript highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1>// First-run admin creation</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>firstRun</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>credentials</span><span class=p>.</span><span class=nx>username</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;admin&#39;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>credentials</span><span class=p>.</span><span class=nx>password</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;admin&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>hashedPassword</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>bcrypt</span><span class=p>.</span><span class=nx>hash</span><span class=p>(</span><span class=nx>credentials</span><span class=p>.</span><span class=nx>password</span><span class=p>,</span><span class=w> </span><span class=mf>10</span><span class=p>);</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>adminUser</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>      </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;admin@medianest.local&#39;</span><span class=p>,</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>      </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>      </span><span class=nx>plex_username</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>      </span><span class=nx>password</span><span class=o>:</span><span class=w> </span><span class=nx>hashedPassword</span><span class=p>,</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>      </span><span class=nx>isBootstrap</span><span class=o>:</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>  </span><span class=c1>// Force password change on next login</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>...</span><span class=nx>adminUser</span><span class=p>,</span><span class=w> </span><span class=nx>requirePasswordChange</span><span class=o>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=p>}</span>
</span></code></pre></div><h2 id=5-implementation-details>5. Implementation Details<a class=headerlink href=#5-implementation-details title="Permanent link">&para;</a></h2><h3 id=51-nextauthjs-configuration>5.1 NextAuth.js Configuration<a class=headerlink href=#51-nextauthjs-configuration title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=c1>// app/api/auth/[...nextauth]/route.ts</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=k>import</span><span class=w> </span><span class=nx>NextAuth</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next-auth&quot;</span><span class=p>;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=k>import</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>NextAuthOptions</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next-auth&quot;</span><span class=p>;</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PrismaAdapter</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@auth/prisma-adapter&quot;</span><span class=p>;</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=k>import</span><span class=w> </span><span class=nx>CredentialsProvider</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next-auth/providers/credentials&quot;</span><span class=p>;</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>prisma</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/lib/prisma&quot;</span><span class=p>;</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PlexProvider</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;./providers/plex&quot;</span><span class=p>;</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>authOptions</span><span class=o>:</span><span class=w> </span><span class=kt>NextAuthOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>  </span><span class=nx>adapter</span><span class=o>:</span><span class=w> </span><span class=kt>PrismaAdapter</span><span class=p>(</span><span class=nx>prisma</span><span class=p>),</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>  </span><span class=nx>session</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>    </span><span class=nx>strategy</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;jwt&quot;</span><span class=p>,</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>    </span><span class=nx>maxAge</span><span class=o>:</span><span class=w> </span><span class=kt>30</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=p>,</span><span class=w> </span><span class=c1>// 30 days</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>  </span><span class=nx>providers</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>    </span><span class=nx>PlexProvider</span><span class=p>({</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>      </span><span class=nx>clientId</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.PLEX_CLIENT_ID</span><span class=o>!</span><span class=p>,</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>      </span><span class=nx>clientName</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;MediaNest&quot;</span><span class=p>,</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>    </span><span class=nx>CredentialsProvider</span><span class=p>({</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;admin-bootstrap&quot;</span><span class=p>,</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>      </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Admin Bootstrap&quot;</span><span class=p>,</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>      </span><span class=nx>credentials</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>        </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>label</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Username&quot;</span><span class=p>,</span><span class=w> </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;text&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=w>        </span><span class=nx>password</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>label</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Password&quot;</span><span class=p>,</span><span class=w> </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;password&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=w>      </span><span class=k>async</span><span class=w> </span><span class=nx>authorize</span><span class=p>(</span><span class=nx>credentials</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a><span class=w>        </span><span class=c1>// Admin bootstrap logic</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>await</span><span class=w> </span><span class=nx>isFirstRun</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a><span class=w>          </span><span class=k>return</span><span class=w> </span><span class=nx>handleAdminBootstrap</span><span class=p>(</span><span class=nx>credentials</span><span class=p>);</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a><span class=w>  </span><span class=p>],</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a><span class=w>  </span><span class=nx>callbacks</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=nx>jwt</span><span class=p>({</span><span class=w> </span><span class=nx>token</span><span class=p>,</span><span class=w> </span><span class=nx>user</span><span class=p>,</span><span class=w> </span><span class=nx>account</span><span class=p>,</span><span class=w> </span><span class=nx>trigger</span><span class=p>,</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a><span class=w>      </span><span class=c1>// Initial sign in</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>account</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>user</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a><span class=w>          </span><span class=p>...</span><span class=nx>token</span><span class=p>,</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a><span class=w>          </span><span class=nx>accessToken</span><span class=o>:</span><span class=w> </span><span class=kt>account.access_token</span><span class=p>,</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a><span class=w>          </span><span class=nx>refreshToken</span><span class=o>:</span><span class=w> </span><span class=kt>account.refresh_token</span><span class=p>,</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a><span class=w>          </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>user.id</span><span class=p>,</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a><span class=w>          </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>user.role</span><span class=p>,</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a><span class=w>          </span><span class=nx>plexToken</span><span class=o>:</span><span class=w> </span><span class=kt>account.plexToken</span><span class=p>,</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a><span class=w>        </span><span class=p>};</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50 href=#__codelineno-3-50></a><span class=w>      </span><span class=c1>// Update session</span>
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51 href=#__codelineno-3-51></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>trigger</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;update&quot;</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>session</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52 href=#__codelineno-3-52></a><span class=w>        </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>...</span><span class=nx>token</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=nx>session</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-3-53><a id=__codelineno-3-53 name=__codelineno-3-53 href=#__codelineno-3-53></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-3-54><a id=__codelineno-3-54 name=__codelineno-3-54 href=#__codelineno-3-54></a>
</span><span id=__span-3-55><a id=__codelineno-3-55 name=__codelineno-3-55 href=#__codelineno-3-55></a><span class=w>      </span><span class=c1>// Return previous token if no update</span>
</span><span id=__span-3-56><a id=__codelineno-3-56 name=__codelineno-3-56 href=#__codelineno-3-56></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>token</span><span class=p>;</span>
</span><span id=__span-3-57><a id=__codelineno-3-57 name=__codelineno-3-57 href=#__codelineno-3-57></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-3-58><a id=__codelineno-3-58 name=__codelineno-3-58 href=#__codelineno-3-58></a><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=nx>session</span><span class=p>({</span><span class=w> </span><span class=nx>session</span><span class=p>,</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-59><a id=__codelineno-3-59 name=__codelineno-3-59 href=#__codelineno-3-59></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-60><a id=__codelineno-3-60 name=__codelineno-3-60 href=#__codelineno-3-60></a><span class=w>        </span><span class=p>...</span><span class=nx>session</span><span class=p>,</span>
</span><span id=__span-3-61><a id=__codelineno-3-61 name=__codelineno-3-61 href=#__codelineno-3-61></a><span class=w>        </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-62><a id=__codelineno-3-62 name=__codelineno-3-62 href=#__codelineno-3-62></a><span class=w>          </span><span class=p>...</span><span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span>
</span><span id=__span-3-63><a id=__codelineno-3-63 name=__codelineno-3-63 href=#__codelineno-3-63></a><span class=w>          </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>token.userId</span><span class=p>,</span>
</span><span id=__span-3-64><a id=__codelineno-3-64 name=__codelineno-3-64 href=#__codelineno-3-64></a><span class=w>          </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>token.role</span><span class=p>,</span>
</span><span id=__span-3-65><a id=__codelineno-3-65 name=__codelineno-3-65 href=#__codelineno-3-65></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-3-66><a id=__codelineno-3-66 name=__codelineno-3-66 href=#__codelineno-3-66></a><span class=w>        </span><span class=nx>accessToken</span><span class=o>:</span><span class=w> </span><span class=kt>token.accessToken</span><span class=p>,</span>
</span><span id=__span-3-67><a id=__codelineno-3-67 name=__codelineno-3-67 href=#__codelineno-3-67></a><span class=w>        </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=kt>token.error</span><span class=p>,</span>
</span><span id=__span-3-68><a id=__codelineno-3-68 name=__codelineno-3-68 href=#__codelineno-3-68></a><span class=w>      </span><span class=p>};</span>
</span><span id=__span-3-69><a id=__codelineno-3-69 name=__codelineno-3-69 href=#__codelineno-3-69></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-3-70><a id=__codelineno-3-70 name=__codelineno-3-70 href=#__codelineno-3-70></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-3-71><a id=__codelineno-3-71 name=__codelineno-3-71 href=#__codelineno-3-71></a><span class=w>  </span><span class=nx>pages</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-72><a id=__codelineno-3-72 name=__codelineno-3-72 href=#__codelineno-3-72></a><span class=w>    </span><span class=nx>signIn</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;/auth/signin&quot;</span><span class=p>,</span>
</span><span id=__span-3-73><a id=__codelineno-3-73 name=__codelineno-3-73 href=#__codelineno-3-73></a><span class=w>    </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;/auth/error&quot;</span><span class=p>,</span>
</span><span id=__span-3-74><a id=__codelineno-3-74 name=__codelineno-3-74 href=#__codelineno-3-74></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-3-75><a id=__codelineno-3-75 name=__codelineno-3-75 href=#__codelineno-3-75></a><span class=w>  </span><span class=nx>events</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-76><a id=__codelineno-3-76 name=__codelineno-3-76 href=#__codelineno-3-76></a><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=nx>signIn</span><span class=p>({</span><span class=w> </span><span class=nx>user</span><span class=p>,</span><span class=w> </span><span class=nx>account</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-77><a id=__codelineno-3-77 name=__codelineno-3-77 href=#__codelineno-3-77></a><span class=w>      </span><span class=c1>// Log successful sign-ins</span>
</span><span id=__span-3-78><a id=__codelineno-3-78 name=__codelineno-3-78 href=#__codelineno-3-78></a><span class=w>      </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>auditLog</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span><span id=__span-3-79><a id=__codelineno-3-79 name=__codelineno-3-79 href=#__codelineno-3-79></a><span class=w>        </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-80><a id=__codelineno-3-80 name=__codelineno-3-80 href=#__codelineno-3-80></a><span class=w>          </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>user.id</span><span class=p>,</span>
</span><span id=__span-3-81><a id=__codelineno-3-81 name=__codelineno-3-81 href=#__codelineno-3-81></a><span class=w>          </span><span class=nx>action</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;SIGN_IN&quot;</span><span class=p>,</span>
</span><span id=__span-3-82><a id=__codelineno-3-82 name=__codelineno-3-82 href=#__codelineno-3-82></a><span class=w>          </span><span class=nx>ipAddress</span><span class=o>:</span><span class=w> </span><span class=kt>account?.ip_address</span><span class=p>,</span>
</span><span id=__span-3-83><a id=__codelineno-3-83 name=__codelineno-3-83 href=#__codelineno-3-83></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-3-84><a id=__codelineno-3-84 name=__codelineno-3-84 href=#__codelineno-3-84></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-3-85><a id=__codelineno-3-85 name=__codelineno-3-85 href=#__codelineno-3-85></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-3-86><a id=__codelineno-3-86 name=__codelineno-3-86 href=#__codelineno-3-86></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-3-87><a id=__codelineno-3-87 name=__codelineno-3-87 href=#__codelineno-3-87></a><span class=p>};</span>
</span><span id=__span-3-88><a id=__codelineno-3-88 name=__codelineno-3-88 href=#__codelineno-3-88></a>
</span><span id=__span-3-89><a id=__codelineno-3-89 name=__codelineno-3-89 href=#__codelineno-3-89></a><span class=kd>const</span><span class=w> </span><span class=nx>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>NextAuth</span><span class=p>(</span><span class=nx>authOptions</span><span class=p>);</span>
</span><span id=__span-3-90><a id=__codelineno-3-90 name=__codelineno-3-90 href=#__codelineno-3-90></a><span class=k>export</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>handler</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>GET</span><span class=p>,</span><span class=w> </span><span class=nx>handler</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>POST</span><span class=w> </span><span class=p>};</span>
</span></code></pre></div><h3 id=52-custom-plex-provider-implementation>5.2 Custom Plex Provider Implementation<a class=headerlink href=#52-custom-plex-provider-implementation title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1>// app/api/auth/[...nextauth]/providers/plex.ts</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>import</span><span class=w> </span><span class=kr>type</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>OAuthConfig</span><span class=p>,</span><span class=w> </span><span class=nx>OAuthUserConfig</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next-auth/providers&quot;</span><span class=p>;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PlexUser</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/types/auth&quot;</span><span class=p>;</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>PlexProvider</span><span class=p>(</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>  </span><span class=nx>options</span><span class=o>:</span><span class=w> </span><span class=kt>OAuthUserConfig</span><span class=o>&lt;</span><span class=nx>PlexUser</span><span class=o>&gt;</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nx>OAuthConfig</span><span class=o>&lt;</span><span class=nx>PlexUser</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>    </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;plex&quot;</span><span class=p>,</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>    </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Plex&quot;</span><span class=p>,</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>    </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;oauth&quot;</span><span class=p>,</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>    </span><span class=nx>authorization</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>      </span><span class=nx>url</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;https://app.plex.tv/auth#&quot;</span><span class=p>,</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>      </span><span class=nx>params</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>        </span><span class=nx>clientID</span><span class=o>:</span><span class=w> </span><span class=kt>options.clientId</span><span class=p>,</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>        </span><span class=nx>code</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;{PIN_CODE}&quot;</span><span class=p>,</span><span class=w> </span><span class=c1>// Dynamically replaced</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=w>    </span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=w>      </span><span class=c1>// Custom token handling for PIN flow</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>      </span><span class=k>async</span><span class=w> </span><span class=nx>request</span><span class=p>({</span><span class=w> </span><span class=nx>params</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>pollForPlexToken</span><span class=p>(</span><span class=nx>params</span><span class=p>.</span><span class=nx>pinId</span><span class=p>,</span><span class=w> </span><span class=nx>options</span><span class=p>.</span><span class=nx>clientId</span><span class=p>);</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>tokens</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>access_token</span><span class=o>:</span><span class=w> </span><span class=kt>token</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-4-24><a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-4-25><a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-4-26><a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=w>    </span><span class=nx>userinfo</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-27><a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a><span class=w>      </span><span class=nx>url</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;https://plex.tv/users/account&quot;</span><span class=p>,</span>
</span><span id=__span-4-28><a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a><span class=w>      </span><span class=k>async</span><span class=w> </span><span class=nx>request</span><span class=p>({</span><span class=w> </span><span class=nx>tokens</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-29><a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a><span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>fetch</span><span class=p>(</span><span class=s2>&quot;https://plex.tv/users/account&quot;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-30><a id=__codelineno-4-30 name=__codelineno-4-30 href=#__codelineno-4-30></a><span class=w>          </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-31><a id=__codelineno-4-31 name=__codelineno-4-31 href=#__codelineno-4-31></a><span class=w>            </span><span class=nx>Accept</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;application/json&quot;</span><span class=p>,</span>
</span><span id=__span-4-32><a id=__codelineno-4-32 name=__codelineno-4-32 href=#__codelineno-4-32></a><span class=w>            </span><span class=s2>&quot;X-Plex-Token&quot;</span><span class=o>:</span><span class=w> </span><span class=nx>tokens</span><span class=p>.</span><span class=nx>access_token</span><span class=o>!</span><span class=p>,</span>
</span><span id=__span-4-33><a id=__codelineno-4-33 name=__codelineno-4-33 href=#__codelineno-4-33></a><span class=w>          </span><span class=p>},</span>
</span><span id=__span-4-34><a id=__codelineno-4-34 name=__codelineno-4-34 href=#__codelineno-4-34></a><span class=w>        </span><span class=p>});</span>
</span><span id=__span-4-35><a id=__codelineno-4-35 name=__codelineno-4-35 href=#__codelineno-4-35></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span><span id=__span-4-36><a id=__codelineno-4-36 name=__codelineno-4-36 href=#__codelineno-4-36></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-4-37><a id=__codelineno-4-37 name=__codelineno-4-37 href=#__codelineno-4-37></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-4-38><a id=__codelineno-4-38 name=__codelineno-4-38 href=#__codelineno-4-38></a><span class=w>    </span><span class=nx>profile</span><span class=p>(</span><span class=nx>profile</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-39><a id=__codelineno-4-39 name=__codelineno-4-39 href=#__codelineno-4-39></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-40><a id=__codelineno-4-40 name=__codelineno-4-40 href=#__codelineno-4-40></a><span class=w>        </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>profile.uuid</span><span class=p>,</span>
</span><span id=__span-4-41><a id=__codelineno-4-41 name=__codelineno-4-41 href=#__codelineno-4-41></a><span class=w>        </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>profile.username</span><span class=p>,</span>
</span><span id=__span-4-42><a id=__codelineno-4-42 name=__codelineno-4-42 href=#__codelineno-4-42></a><span class=w>        </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>profile.email</span><span class=p>,</span>
</span><span id=__span-4-43><a id=__codelineno-4-43 name=__codelineno-4-43 href=#__codelineno-4-43></a><span class=w>        </span><span class=nx>image</span><span class=o>:</span><span class=w> </span><span class=kt>profile.thumb</span><span class=p>,</span>
</span><span id=__span-4-44><a id=__codelineno-4-44 name=__codelineno-4-44 href=#__codelineno-4-44></a><span class=w>        </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;user&quot;</span><span class=p>,</span><span class=w> </span><span class=c1>// Default role</span>
</span><span id=__span-4-45><a id=__codelineno-4-45 name=__codelineno-4-45 href=#__codelineno-4-45></a><span class=w>      </span><span class=p>};</span>
</span><span id=__span-4-46><a id=__codelineno-4-46 name=__codelineno-4-46 href=#__codelineno-4-46></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-4-47><a id=__codelineno-4-47 name=__codelineno-4-47 href=#__codelineno-4-47></a><span class=w>    </span><span class=nx>style</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-48><a id=__codelineno-4-48 name=__codelineno-4-48 href=#__codelineno-4-48></a><span class=w>      </span><span class=nx>logo</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;/images/plex-logo.svg&quot;</span><span class=p>,</span>
</span><span id=__span-4-49><a id=__codelineno-4-49 name=__codelineno-4-49 href=#__codelineno-4-49></a><span class=w>      </span><span class=nx>bg</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;#1f2937&quot;</span><span class=p>,</span>
</span><span id=__span-4-50><a id=__codelineno-4-50 name=__codelineno-4-50 href=#__codelineno-4-50></a><span class=w>      </span><span class=nx>text</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;#ffffff&quot;</span><span class=p>,</span>
</span><span id=__span-4-51><a id=__codelineno-4-51 name=__codelineno-4-51 href=#__codelineno-4-51></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-4-52><a id=__codelineno-4-52 name=__codelineno-4-52 href=#__codelineno-4-52></a><span class=w>    </span><span class=nx>options</span><span class=p>,</span>
</span><span id=__span-4-53><a id=__codelineno-4-53 name=__codelineno-4-53 href=#__codelineno-4-53></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-4-54><a id=__codelineno-4-54 name=__codelineno-4-54 href=#__codelineno-4-54></a><span class=p>}</span>
</span></code></pre></div><h3 id=53-pin-flow-api-routes>5.3 PIN Flow API Routes<a class=headerlink href=#53-pin-flow-api-routes title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1>// app/api/auth/plex/pin/route.ts</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>NextResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next/server&quot;</span><span class=p>;</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>generatePlexPin</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/lib/plex&quot;</span><span class=p>;</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>POST</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=nx>code</span><span class=p>,</span><span class=w> </span><span class=nx>authUrl</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>generatePlexPin</span><span class=p>({</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>      </span><span class=nx>clientId</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.PLEX_CLIENT_ID</span><span class=o>!</span><span class=p>,</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=w>      </span><span class=nx>clientName</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;MediaNest&quot;</span><span class=p>,</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=w>      </span><span class=nx>device</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;MediaNest Web&quot;</span><span class=p>,</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=w>      </span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=kt>id</span><span class=p>,</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=w>      </span><span class=nx>pin</span><span class=o>:</span><span class=w> </span><span class=kt>code</span><span class=p>,</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=w>      </span><span class=nx>authUrl</span><span class=p>,</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=w>      </span><span class=nx>expiresIn</span><span class=o>:</span><span class=w> </span><span class=kt>900</span><span class=p>,</span><span class=w> </span><span class=c1>// 15 minutes</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Failed to generate PIN&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>500</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=p>}</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a><span class=c1>// app/api/auth/plex/poll/[pinId]/route.ts</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>GET</span><span class=p>(</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a><span class=w>  </span><span class=nx>request</span><span class=o>:</span><span class=w> </span><span class=kt>Request</span><span class=p>,</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a><span class=w>  </span><span class=p>{</span><span class=w> </span><span class=nx>params</span><span class=w> </span><span class=p>}</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>params</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>checkPlexPin</span><span class=p>(</span><span class=nx>params</span><span class=p>.</span><span class=nx>pinId</span><span class=p>);</span>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a><span class=w>      </span><span class=c1>// PIN claimed, fetch user data</span>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>userData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>getPlexUser</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
</span><span id=__span-5-38><a id=__codelineno-5-38 name=__codelineno-5-38 href=#__codelineno-5-38></a>
</span><span id=__span-5-39><a id=__codelineno-5-39 name=__codelineno-5-39 href=#__codelineno-5-39></a><span class=w>      </span><span class=c1>// Create NextAuth session</span>
</span><span id=__span-5-40><a id=__codelineno-5-40 name=__codelineno-5-40 href=#__codelineno-5-40></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>createSession</span><span class=p>({</span>
</span><span id=__span-5-41><a id=__codelineno-5-41 name=__codelineno-5-41 href=#__codelineno-5-41></a><span class=w>        </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=kt>userData</span><span class=p>,</span>
</span><span id=__span-5-42><a id=__codelineno-5-42 name=__codelineno-5-42 href=#__codelineno-5-42></a><span class=w>        </span><span class=nx>token</span><span class=p>,</span>
</span><span id=__span-5-43><a id=__codelineno-5-43 name=__codelineno-5-43 href=#__codelineno-5-43></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-5-44><a id=__codelineno-5-44 name=__codelineno-5-44 href=#__codelineno-5-44></a>
</span><span id=__span-5-45><a id=__codelineno-5-45 name=__codelineno-5-45 href=#__codelineno-5-45></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span><span id=__span-5-46><a id=__codelineno-5-46 name=__codelineno-5-46 href=#__codelineno-5-46></a><span class=w>        </span><span class=nx>success</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-5-47><a id=__codelineno-5-47 name=__codelineno-5-47 href=#__codelineno-5-47></a><span class=w>        </span><span class=nx>token</span><span class=p>,</span>
</span><span id=__span-5-48><a id=__codelineno-5-48 name=__codelineno-5-48 href=#__codelineno-5-48></a><span class=w>        </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=kt>userData</span><span class=p>,</span>
</span><span id=__span-5-49><a id=__codelineno-5-49 name=__codelineno-5-49 href=#__codelineno-5-49></a><span class=w>        </span><span class=nx>sessionToken</span><span class=o>:</span><span class=w> </span><span class=kt>session.sessionToken</span><span class=p>,</span>
</span><span id=__span-5-50><a id=__codelineno-5-50 name=__codelineno-5-50 href=#__codelineno-5-50></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-5-51><a id=__codelineno-5-51 name=__codelineno-5-51 href=#__codelineno-5-51></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-52><a id=__codelineno-5-52 name=__codelineno-5-52 href=#__codelineno-5-52></a>
</span><span id=__span-5-53><a id=__codelineno-5-53 name=__codelineno-5-53 href=#__codelineno-5-53></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span><span id=__span-5-54><a id=__codelineno-5-54 name=__codelineno-5-54 href=#__codelineno-5-54></a><span class=w>      </span><span class=nx>success</span><span class=o>:</span><span class=w> </span><span class=kt>false</span><span class=p>,</span>
</span><span id=__span-5-55><a id=__codelineno-5-55 name=__codelineno-5-55 href=#__codelineno-5-55></a><span class=w>      </span><span class=nx>pending</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-5-56><a id=__codelineno-5-56 name=__codelineno-5-56 href=#__codelineno-5-56></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-5-57><a id=__codelineno-5-57 name=__codelineno-5-57 href=#__codelineno-5-57></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-58><a id=__codelineno-5-58 name=__codelineno-5-58 href=#__codelineno-5-58></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-5-59><a id=__codelineno-5-59 name=__codelineno-5-59 href=#__codelineno-5-59></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Polling failed&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-5-60><a id=__codelineno-5-60 name=__codelineno-5-60 href=#__codelineno-5-60></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>500</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-5-61><a id=__codelineno-5-61 name=__codelineno-5-61 href=#__codelineno-5-61></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-5-62><a id=__codelineno-5-62 name=__codelineno-5-62 href=#__codelineno-5-62></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-5-63><a id=__codelineno-5-63 name=__codelineno-5-63 href=#__codelineno-5-63></a><span class=p>}</span>
</span></code></pre></div><h3 id=54-remember-me-implementation>5.4 Remember Me Implementation<a class=headerlink href=#54-remember-me-implementation title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1>// lib/auth/remember-me.ts</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>import</span><span class=w> </span><span class=nx>crypto</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;crypto&quot;</span><span class=p>;</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Redis</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;ioredis&quot;</span><span class=p>;</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=kd>const</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Redis</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>REDIS_URL</span><span class=o>!</span><span class=p>);</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=kd>const</span><span class=w> </span><span class=nx>REMEMBER_TOKEN_TTL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>90</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=p>;</span><span class=w> </span><span class=c1>// 90 days</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>createRememberToken</span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>string</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mf>32</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s2>&quot;hex&quot;</span><span class=p>);</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>hashedToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>    </span><span class=p>.</span><span class=nx>createHash</span><span class=p>(</span><span class=s2>&quot;sha256&quot;</span><span class=p>)</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>    </span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>token</span><span class=p>)</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>    </span><span class=p>.</span><span class=nx>digest</span><span class=p>(</span><span class=s2>&quot;hex&quot;</span><span class=p>);</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>  </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>setex</span><span class=p>(</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>    </span><span class=sb>`remember:</span><span class=si>${</span><span class=nx>hashedToken</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>    </span><span class=nx>REMEMBER_TOKEN_TTL</span><span class=p>,</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>    </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>      </span><span class=nx>userId</span><span class=p>,</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>      </span><span class=nx>createdAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>    </span><span class=p>})</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>token</span><span class=p>;</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=p>}</span>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>validateRememberToken</span><span class=p>(</span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>hashedToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span>
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=w>    </span><span class=p>.</span><span class=nx>createHash</span><span class=p>(</span><span class=s2>&quot;sha256&quot;</span><span class=p>)</span>
</span><span id=__span-6-30><a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=w>    </span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>token</span><span class=p>)</span>
</span><span id=__span-6-31><a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=w>    </span><span class=p>.</span><span class=nx>digest</span><span class=p>(</span><span class=s2>&quot;hex&quot;</span><span class=p>);</span>
</span><span id=__span-6-32><a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a>
</span><span id=__span-6-33><a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`remember:</span><span class=si>${</span><span class=nx>hashedToken</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-6-34><a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-6-35><a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a>
</span><span id=__span-6-36><a id=__codelineno-6-36 name=__codelineno-6-36 href=#__codelineno-6-36></a><span class=w>  </span><span class=c1>// Rotate token on use</span>
</span><span id=__span-6-37><a id=__codelineno-6-37 name=__codelineno-6-37 href=#__codelineno-6-37></a><span class=w>  </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=sb>`remember:</span><span class=si>${</span><span class=nx>hashedToken</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-6-38><a id=__codelineno-6-38 name=__codelineno-6-38 href=#__codelineno-6-38></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>userId</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span><span id=__span-6-39><a id=__codelineno-6-39 name=__codelineno-6-39 href=#__codelineno-6-39></a>
</span><span id=__span-6-40><a id=__codelineno-6-40 name=__codelineno-6-40 href=#__codelineno-6-40></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>newToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>createRememberToken</span><span class=p>(</span><span class=nx>userId</span><span class=p>);</span>
</span><span id=__span-6-41><a id=__codelineno-6-41 name=__codelineno-6-41 href=#__codelineno-6-41></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>userId</span><span class=p>,</span><span class=w> </span><span class=nx>newToken</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-6-42><a id=__codelineno-6-42 name=__codelineno-6-42 href=#__codelineno-6-42></a><span class=p>}</span>
</span></code></pre></div><h2 id=6-security-measures>6. Security Measures<a class=headerlink href=#6-security-measures title="Permanent link">&para;</a></h2><h3 id=61-token-security>6.1 Token Security<a class=headerlink href=#61-token-security title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1>// lib/security/tokens.ts</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>import</span><span class=w> </span><span class=nx>jwt</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;jsonwebtoken&quot;</span><span class=p>;</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=k>import</span><span class=w> </span><span class=nx>crypto</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;crypto&quot;</span><span class=p>;</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=kd>const</span><span class=w> </span><span class=nx>JWT_SECRET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET</span><span class=o>!</span><span class=p>;</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=kd>const</span><span class=w> </span><span class=nx>ENCRYPTION_KEY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>ENCRYPTION_KEY</span><span class=o>!</span><span class=p>;</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=kd>interface</span><span class=w> </span><span class=nx>TokenPayload</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>  </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=w>  </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>  </span><span class=nx>sessionId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>  </span><span class=nx>iat?</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>;</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=w>  </span><span class=nx>exp?</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>;</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=p>}</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>generateAccessToken</span><span class=p>(</span><span class=nx>payload</span><span class=o>:</span><span class=w> </span><span class=kt>TokenPayload</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>payload</span><span class=p>,</span><span class=w> </span><span class=nx>JWT_SECRET</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=w>    </span><span class=nx>expiresIn</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;1h&quot;</span><span class=p>,</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=w>    </span><span class=nx>issuer</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;medianest&quot;</span><span class=p>,</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=w>    </span><span class=nx>audience</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;medianest-api&quot;</span><span class=p>,</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=p>}</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>generateRefreshToken</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mf>32</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s2>&quot;base64url&quot;</span><span class=p>);</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a><span class=p>}</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>encryptSensitiveData</span><span class=p>(</span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>algorithm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;aes-256-gcm&quot;</span><span class=p>;</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>iv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mf>16</span><span class=p>);</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>cipher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>createCipheriv</span><span class=p>(</span>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a><span class=w>    </span><span class=nx>algorithm</span><span class=p>,</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a><span class=w>    </span><span class=nx>Buffer</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=nx>ENCRYPTION_KEY</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;hex&quot;</span><span class=p>),</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a><span class=w>    </span><span class=nx>iv</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>encrypted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>cipher</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;utf8&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;hex&quot;</span><span class=p>);</span>
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a><span class=w>  </span><span class=nx>encrypted</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>cipher</span><span class=p>.</span><span class=kr>final</span><span class=p>(</span><span class=s2>&quot;hex&quot;</span><span class=p>);</span>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>authTag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>cipher</span><span class=p>.</span><span class=nx>getAuthTag</span><span class=p>();</span>
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a>
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a><span class=w>    </span><span class=nx>encrypted</span><span class=p>,</span>
</span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a><span class=w>    </span><span class=nx>iv</span><span class=o>:</span><span class=w> </span><span class=kt>iv.toString</span><span class=p>(</span><span class=s2>&quot;hex&quot;</span><span class=p>),</span>
</span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a><span class=w>    </span><span class=nx>authTag</span><span class=o>:</span><span class=w> </span><span class=kt>authTag.toString</span><span class=p>(</span><span class=s2>&quot;hex&quot;</span><span class=p>),</span>
</span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a><span class=p>}</span>
</span></code></pre></div><h3 id=62-rate-limiting>6.2 Rate Limiting<a class=headerlink href=#62-rate-limiting title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=c1>// middleware/rateLimiter.ts</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Redis</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;ioredis&quot;</span><span class=p>;</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>NextRequest</span><span class=p>,</span><span class=w> </span><span class=nx>NextResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next/server&quot;</span><span class=p>;</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=kd>const</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Redis</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>REDIS_URL</span><span class=o>!</span><span class=p>);</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=kd>interface</span><span class=w> </span><span class=nx>RateLimitConfig</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>  </span><span class=nx>windowMs</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>;</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>  </span><span class=nx>max</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>;</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>  </span><span class=nx>keyPrefix</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=p>}</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>createRateLimiter</span><span class=p>(</span><span class=nx>config</span><span class=o>:</span><span class=w> </span><span class=kt>RateLimitConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>rateLimiter</span><span class=p>(</span><span class=nx>req</span><span class=o>:</span><span class=w> </span><span class=kt>NextRequest</span><span class=p>,</span><span class=w> </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`</span><span class=si>${</span><span class=nx>config</span><span class=p>.</span><span class=nx>keyPrefix</span><span class=si>}</span><span class=sb>:</span><span class=si>${</span><span class=nx>userId</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>windowStart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>now</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>windowMs</span><span class=p>;</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=w>    </span><span class=c1>// Use Redis sorted set for sliding window</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>pipe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>pipeline</span><span class=p>();</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=w>    </span><span class=nx>pipe</span><span class=p>.</span><span class=nx>zremrangebyscore</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;-inf&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>windowStart</span><span class=p>);</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=w>    </span><span class=nx>pipe</span><span class=p>.</span><span class=nx>zadd</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=nx>now</span><span class=p>,</span><span class=w> </span><span class=sb>`</span><span class=si>${</span><span class=nx>now</span><span class=si>}</span><span class=sb>-</span><span class=si>${</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=w>    </span><span class=nx>pipe</span><span class=p>.</span><span class=nx>zcard</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=w>    </span><span class=nx>pipe</span><span class=p>.</span><span class=nx>expire</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>windowMs</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>1000</span><span class=p>));</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>results</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>pipe</span><span class=p>.</span><span class=nx>exec</span><span class=p>();</span>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>results</span><span class=o>?</span><span class=p>.[</span><span class=mf>2</span><span class=p>]</span><span class=o>?</span><span class=p>.[</span><span class=mf>1</span><span class=p>]</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=kt>number</span><span class=p>;</span>
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>max</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>oldestRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>zrange</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;WITHSCORES&quot;</span><span class=p>);</span>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>resetTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>parseInt</span><span class=p>(</span><span class=nx>oldestRequest</span><span class=p>[</span><span class=mf>1</span><span class=p>])</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>windowMs</span><span class=p>;</span>
</span><span id=__span-8-32><a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a>
</span><span id=__span-8-33><a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-8-34><a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-35><a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a><span class=w>          </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Too many requests&quot;</span><span class=p>,</span>
</span><span id=__span-8-36><a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a><span class=w>          </span><span class=nx>retryAfter</span><span class=o>:</span><span class=w> </span><span class=kt>Math.ceil</span><span class=p>((</span><span class=nx>resetTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>now</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>1000</span><span class=p>),</span>
</span><span id=__span-8-37><a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-8-38><a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-39><a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a><span class=w>          </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>429</span><span class=p>,</span>
</span><span id=__span-8-40><a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a><span class=w>          </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-41><a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a><span class=w>            </span><span class=s2>&quot;Retry-After&quot;</span><span class=o>:</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span><span class=p>((</span><span class=nx>resetTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>now</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>1000</span><span class=p>).</span><span class=nx>toString</span><span class=p>(),</span>
</span><span id=__span-8-42><a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a><span class=w>            </span><span class=s2>&quot;X-RateLimit-Limit&quot;</span><span class=o>:</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>max</span><span class=p>.</span><span class=nx>toString</span><span class=p>(),</span>
</span><span id=__span-8-43><a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a><span class=w>            </span><span class=s2>&quot;X-RateLimit-Remaining&quot;</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>,</span>
</span><span id=__span-8-44><a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a><span class=w>            </span><span class=s2>&quot;X-RateLimit-Reset&quot;</span><span class=o>:</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Date</span><span class=p>(</span><span class=nx>resetTime</span><span class=p>).</span><span class=nx>toISOString</span><span class=p>(),</span>
</span><span id=__span-8-45><a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a><span class=w>          </span><span class=p>},</span>
</span><span id=__span-8-46><a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-47><a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-8-48><a id=__codelineno-8-48 name=__codelineno-8-48 href=#__codelineno-8-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-49><a id=__codelineno-8-49 name=__codelineno-8-49 href=#__codelineno-8-49></a>
</span><span id=__span-8-50><a id=__codelineno-8-50 name=__codelineno-8-50 href=#__codelineno-8-50></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// Request allowed</span>
</span><span id=__span-8-51><a id=__codelineno-8-51 name=__codelineno-8-51 href=#__codelineno-8-51></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-8-52><a id=__codelineno-8-52 name=__codelineno-8-52 href=#__codelineno-8-52></a><span class=p>}</span>
</span><span id=__span-8-53><a id=__codelineno-8-53 name=__codelineno-8-53 href=#__codelineno-8-53></a>
</span><span id=__span-8-54><a id=__codelineno-8-54 name=__codelineno-8-54 href=#__codelineno-8-54></a><span class=c1>// Usage</span>
</span><span id=__span-8-55><a id=__codelineno-8-55 name=__codelineno-8-55 href=#__codelineno-8-55></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>apiRateLimiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>createRateLimiter</span><span class=p>({</span>
</span><span id=__span-8-56><a id=__codelineno-8-56 name=__codelineno-8-56 href=#__codelineno-8-56></a><span class=w>  </span><span class=nx>windowMs</span><span class=o>:</span><span class=w> </span><span class=kt>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>,</span><span class=w> </span><span class=c1>// 1 minute</span>
</span><span id=__span-8-57><a id=__codelineno-8-57 name=__codelineno-8-57 href=#__codelineno-8-57></a><span class=w>  </span><span class=nx>max</span><span class=o>:</span><span class=w> </span><span class=kt>100</span><span class=p>,</span>
</span><span id=__span-8-58><a id=__codelineno-8-58 name=__codelineno-8-58 href=#__codelineno-8-58></a><span class=w>  </span><span class=nx>keyPrefix</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;rate:api&quot;</span><span class=p>,</span>
</span><span id=__span-8-59><a id=__codelineno-8-59 name=__codelineno-8-59 href=#__codelineno-8-59></a><span class=p>});</span>
</span><span id=__span-8-60><a id=__codelineno-8-60 name=__codelineno-8-60 href=#__codelineno-8-60></a>
</span><span id=__span-8-61><a id=__codelineno-8-61 name=__codelineno-8-61 href=#__codelineno-8-61></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>authRateLimiter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>createRateLimiter</span><span class=p>({</span>
</span><span id=__span-8-62><a id=__codelineno-8-62 name=__codelineno-8-62 href=#__codelineno-8-62></a><span class=w>  </span><span class=nx>windowMs</span><span class=o>:</span><span class=w> </span><span class=kt>15</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>,</span><span class=w> </span><span class=c1>// 15 minutes</span>
</span><span id=__span-8-63><a id=__codelineno-8-63 name=__codelineno-8-63 href=#__codelineno-8-63></a><span class=w>  </span><span class=nx>max</span><span class=o>:</span><span class=w> </span><span class=kt>5</span><span class=p>,</span>
</span><span id=__span-8-64><a id=__codelineno-8-64 name=__codelineno-8-64 href=#__codelineno-8-64></a><span class=w>  </span><span class=nx>keyPrefix</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;rate:auth&quot;</span><span class=p>,</span>
</span><span id=__span-8-65><a id=__codelineno-8-65 name=__codelineno-8-65 href=#__codelineno-8-65></a><span class=p>});</span>
</span></code></pre></div><h3 id=63-csrf-protection>6.3 CSRF Protection<a class=headerlink href=#63-csrf-protection title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1>// lib/security/csrf.ts</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=k>import</span><span class=w> </span><span class=nx>crypto</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;crypto&quot;</span><span class=p>;</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>generateCSRFToken</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mf>32</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s2>&quot;hex&quot;</span><span class=p>);</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=p>}</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>validateCSRFToken</span><span class=p>(</span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>sessionToken</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>  </span><span class=c1>// Implement double-submit cookie pattern</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>expectedToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>    </span><span class=p>.</span><span class=nx>createHmac</span><span class=p>(</span><span class=s2>&quot;sha256&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CSRF_SECRET</span><span class=o>!</span><span class=p>)</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>    </span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>sessionToken</span><span class=p>)</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>    </span><span class=p>.</span><span class=nx>digest</span><span class=p>(</span><span class=s2>&quot;hex&quot;</span><span class=p>);</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>timingSafeEqual</span><span class=p>(</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=w>    </span><span class=nx>Buffer</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=nx>token</span><span class=p>),</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=w>    </span><span class=nx>Buffer</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=nx>expectedToken</span><span class=p>)</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=p>}</span>
</span></code></pre></div><h2 id=7-session-management>7. Session Management<a class=headerlink href=#7-session-management title="Permanent link">&para;</a></h2><h3 id=71-session-store-implementation>7.1 Session Store Implementation<a class=headerlink href=#71-session-store-implementation title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1>// lib/session/store.ts</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Redis</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;ioredis&quot;</span><span class=p>;</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>nanoid</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;nanoid&quot;</span><span class=p>;</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=kd>const</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Redis</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>REDIS_URL</span><span class=o>!</span><span class=p>);</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=kd>const</span><span class=w> </span><span class=nx>SESSION_TTL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>30</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=p>;</span><span class=w> </span><span class=c1>// 30 days</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=k>export</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=nx>Session</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>  </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>  </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>  </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>  </span><span class=nx>plexToken?</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=w>  </span><span class=nx>createdAt</span><span class=o>:</span><span class=w> </span><span class=kt>Date</span><span class=p>;</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>  </span><span class=nx>expiresAt</span><span class=o>:</span><span class=w> </span><span class=kt>Date</span><span class=p>;</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=w>  </span><span class=nx>lastActivityAt</span><span class=o>:</span><span class=w> </span><span class=kt>Date</span><span class=p>;</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=w>  </span><span class=nx>ipAddress?</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>  </span><span class=nx>userAgent?</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=p>}</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>SessionStore</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>create</span><span class=p>(</span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>Omit</span><span class=o>&lt;</span><span class=nx>Session</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;id&quot;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=s2>&quot;createdAt&quot;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=s2>&quot;expiresAt&quot;</span><span class=o>&gt;</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>Session</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=o>:</span><span class=w> </span><span class=kt>Session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a><span class=w>      </span><span class=p>...</span><span class=nx>data</span><span class=p>,</span>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>nanoid</span><span class=p>(),</span>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a><span class=w>      </span><span class=nx>createdAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>(),</span>
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a><span class=w>      </span><span class=nx>expiresAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>(</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>SESSION_TTL</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>),</span>
</span><span id=__span-10-27><a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a><span class=w>      </span><span class=nx>lastActivityAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>(),</span>
</span><span id=__span-10-28><a id=__codelineno-10-28 name=__codelineno-10-28 href=#__codelineno-10-28></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-10-29><a id=__codelineno-10-29 name=__codelineno-10-29 href=#__codelineno-10-29></a>
</span><span id=__span-10-30><a id=__codelineno-10-30 name=__codelineno-10-30 href=#__codelineno-10-30></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>setex</span><span class=p>(</span>
</span><span id=__span-10-31><a id=__codelineno-10-31 name=__codelineno-10-31 href=#__codelineno-10-31></a><span class=w>      </span><span class=sb>`session:</span><span class=si>${</span><span class=nx>session</span><span class=p>.</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-10-32><a id=__codelineno-10-32 name=__codelineno-10-32 href=#__codelineno-10-32></a><span class=w>      </span><span class=nx>SESSION_TTL</span><span class=p>,</span>
</span><span id=__span-10-33><a id=__codelineno-10-33 name=__codelineno-10-33 href=#__codelineno-10-33></a><span class=w>      </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>session</span><span class=p>)</span>
</span><span id=__span-10-34><a id=__codelineno-10-34 name=__codelineno-10-34 href=#__codelineno-10-34></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-10-35><a id=__codelineno-10-35 name=__codelineno-10-35 href=#__codelineno-10-35></a>
</span><span id=__span-10-36><a id=__codelineno-10-36 name=__codelineno-10-36 href=#__codelineno-10-36></a><span class=w>    </span><span class=c1>// Track active sessions per user</span>
</span><span id=__span-10-37><a id=__codelineno-10-37 name=__codelineno-10-37 href=#__codelineno-10-37></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>sadd</span><span class=p>(</span><span class=sb>`user:sessions:</span><span class=si>${</span><span class=nx>data</span><span class=p>.</span><span class=nx>userId</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span><span id=__span-10-38><a id=__codelineno-10-38 name=__codelineno-10-38 href=#__codelineno-10-38></a>
</span><span id=__span-10-39><a id=__codelineno-10-39 name=__codelineno-10-39 href=#__codelineno-10-39></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>session</span><span class=p>;</span>
</span><span id=__span-10-40><a id=__codelineno-10-40 name=__codelineno-10-40 href=#__codelineno-10-40></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-10-41><a id=__codelineno-10-41 name=__codelineno-10-41 href=#__codelineno-10-41></a>
</span><span id=__span-10-42><a id=__codelineno-10-42 name=__codelineno-10-42 href=#__codelineno-10-42></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>get</span><span class=p>(</span><span class=nx>sessionId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>Session</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kc>null</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-43><a id=__codelineno-10-43 name=__codelineno-10-43 href=#__codelineno-10-43></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`session:</span><span class=si>${</span><span class=nx>sessionId</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-10-44><a id=__codelineno-10-44 name=__codelineno-10-44 href=#__codelineno-10-44></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-10-45><a id=__codelineno-10-45 name=__codelineno-10-45 href=#__codelineno-10-45></a>
</span><span id=__span-10-46><a id=__codelineno-10-46 name=__codelineno-10-46 href=#__codelineno-10-46></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span><span id=__span-10-47><a id=__codelineno-10-47 name=__codelineno-10-47 href=#__codelineno-10-47></a>
</span><span id=__span-10-48><a id=__codelineno-10-48 name=__codelineno-10-48 href=#__codelineno-10-48></a><span class=w>    </span><span class=c1>// Update last activity</span>
</span><span id=__span-10-49><a id=__codelineno-10-49 name=__codelineno-10-49 href=#__codelineno-10-49></a><span class=w>    </span><span class=nx>session</span><span class=p>.</span><span class=nx>lastActivityAt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Date</span><span class=p>();</span>
</span><span id=__span-10-50><a id=__codelineno-10-50 name=__codelineno-10-50 href=#__codelineno-10-50></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>setex</span><span class=p>(</span>
</span><span id=__span-10-51><a id=__codelineno-10-51 name=__codelineno-10-51 href=#__codelineno-10-51></a><span class=w>      </span><span class=sb>`session:</span><span class=si>${</span><span class=nx>sessionId</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-10-52><a id=__codelineno-10-52 name=__codelineno-10-52 href=#__codelineno-10-52></a><span class=w>      </span><span class=nx>SESSION_TTL</span><span class=p>,</span>
</span><span id=__span-10-53><a id=__codelineno-10-53 name=__codelineno-10-53 href=#__codelineno-10-53></a><span class=w>      </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>session</span><span class=p>)</span>
</span><span id=__span-10-54><a id=__codelineno-10-54 name=__codelineno-10-54 href=#__codelineno-10-54></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-10-55><a id=__codelineno-10-55 name=__codelineno-10-55 href=#__codelineno-10-55></a>
</span><span id=__span-10-56><a id=__codelineno-10-56 name=__codelineno-10-56 href=#__codelineno-10-56></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>session</span><span class=p>;</span>
</span><span id=__span-10-57><a id=__codelineno-10-57 name=__codelineno-10-57 href=#__codelineno-10-57></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-10-58><a id=__codelineno-10-58 name=__codelineno-10-58 href=#__codelineno-10-58></a>
</span><span id=__span-10-59><a id=__codelineno-10-59 name=__codelineno-10-59 href=#__codelineno-10-59></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>revoke</span><span class=p>(</span><span class=nx>sessionId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-60><a id=__codelineno-10-60 name=__codelineno-10-60 href=#__codelineno-10-60></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>sessionId</span><span class=p>);</span>
</span><span id=__span-10-61><a id=__codelineno-10-61 name=__codelineno-10-61 href=#__codelineno-10-61></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>session</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-62><a id=__codelineno-10-62 name=__codelineno-10-62 href=#__codelineno-10-62></a><span class=w>      </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=sb>`session:</span><span class=si>${</span><span class=nx>sessionId</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-10-63><a id=__codelineno-10-63 name=__codelineno-10-63 href=#__codelineno-10-63></a><span class=w>      </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>srem</span><span class=p>(</span><span class=sb>`user:sessions:</span><span class=si>${</span><span class=nx>session</span><span class=p>.</span><span class=nx>userId</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span><span class=w> </span><span class=nx>sessionId</span><span class=p>);</span>
</span><span id=__span-10-64><a id=__codelineno-10-64 name=__codelineno-10-64 href=#__codelineno-10-64></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-65><a id=__codelineno-10-65 name=__codelineno-10-65 href=#__codelineno-10-65></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-10-66><a id=__codelineno-10-66 name=__codelineno-10-66 href=#__codelineno-10-66></a>
</span><span id=__span-10-67><a id=__codelineno-10-67 name=__codelineno-10-67 href=#__codelineno-10-67></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>revokeAllUserSessions</span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-68><a id=__codelineno-10-68 name=__codelineno-10-68 href=#__codelineno-10-68></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionIds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>smembers</span><span class=p>(</span><span class=sb>`user:sessions:</span><span class=si>${</span><span class=nx>userId</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-10-69><a id=__codelineno-10-69 name=__codelineno-10-69 href=#__codelineno-10-69></a>
</span><span id=__span-10-70><a id=__codelineno-10-70 name=__codelineno-10-70 href=#__codelineno-10-70></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>sessionIds</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-71><a id=__codelineno-10-71 name=__codelineno-10-71 href=#__codelineno-10-71></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>pipeline</span><span class=p>();</span>
</span><span id=__span-10-72><a id=__codelineno-10-72 name=__codelineno-10-72 href=#__codelineno-10-72></a><span class=w>      </span><span class=nx>sessionIds</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>id</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>pipeline</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=sb>`session:</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span><span class=p>));</span>
</span><span id=__span-10-73><a id=__codelineno-10-73 name=__codelineno-10-73 href=#__codelineno-10-73></a><span class=w>      </span><span class=nx>pipeline</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=sb>`user:sessions:</span><span class=si>${</span><span class=nx>userId</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-10-74><a id=__codelineno-10-74 name=__codelineno-10-74 href=#__codelineno-10-74></a><span class=w>      </span><span class=k>await</span><span class=w> </span><span class=nx>pipeline</span><span class=p>.</span><span class=nx>exec</span><span class=p>();</span>
</span><span id=__span-10-75><a id=__codelineno-10-75 name=__codelineno-10-75 href=#__codelineno-10-75></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-76><a id=__codelineno-10-76 name=__codelineno-10-76 href=#__codelineno-10-76></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-10-77><a id=__codelineno-10-77 name=__codelineno-10-77 href=#__codelineno-10-77></a><span class=p>}</span>
</span></code></pre></div><h3 id=72-session-middleware>7.2 Session Middleware<a class=headerlink href=#72-session-middleware title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1>// middleware/session.ts</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>NextRequest</span><span class=p>,</span><span class=w> </span><span class=nx>NextResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next/server&quot;</span><span class=p>;</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>verifyJWT</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/lib/auth/jwt&quot;</span><span class=p>;</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>SessionStore</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/lib/session/store&quot;</span><span class=p>;</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=kd>const</span><span class=w> </span><span class=nx>sessionStore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>SessionStore</span><span class=p>();</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>sessionMiddleware</span><span class=p>(</span><span class=nx>request</span><span class=o>:</span><span class=w> </span><span class=kt>NextRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&quot;authorization&quot;</span><span class=p>)</span><span class=o>?</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&quot;Bearer &quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>);</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Unauthorized&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>401</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>verifyJWT</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>sessionStore</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>payload</span><span class=p>.</span><span class=nx>sessionId</span><span class=p>);</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>session</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Session expired&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>401</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-28><a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a>
</span><span id=__span-11-29><a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=w>    </span><span class=c1>// Attach session to request</span>
</span><span id=__span-11-30><a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>requestHeaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Headers</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>);</span>
</span><span id=__span-11-31><a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a><span class=w>    </span><span class=nx>requestHeaders</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>&quot;x-user-id&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>userId</span><span class=p>);</span>
</span><span id=__span-11-32><a id=__codelineno-11-32 name=__codelineno-11-32 href=#__codelineno-11-32></a><span class=w>    </span><span class=nx>requestHeaders</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>&quot;x-user-role&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>role</span><span class=p>);</span>
</span><span id=__span-11-33><a id=__codelineno-11-33 name=__codelineno-11-33 href=#__codelineno-11-33></a><span class=w>    </span><span class=nx>requestHeaders</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>&quot;x-session-id&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>session</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span><span id=__span-11-34><a id=__codelineno-11-34 name=__codelineno-11-34 href=#__codelineno-11-34></a>
</span><span id=__span-11-35><a id=__codelineno-11-35 name=__codelineno-11-35 href=#__codelineno-11-35></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>next</span><span class=p>({</span>
</span><span id=__span-11-36><a id=__codelineno-11-36 name=__codelineno-11-36 href=#__codelineno-11-36></a><span class=w>      </span><span class=nx>request</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-37><a id=__codelineno-11-37 name=__codelineno-11-37 href=#__codelineno-11-37></a><span class=w>        </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=kt>requestHeaders</span><span class=p>,</span>
</span><span id=__span-11-38><a id=__codelineno-11-38 name=__codelineno-11-38 href=#__codelineno-11-38></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-11-39><a id=__codelineno-11-39 name=__codelineno-11-39 href=#__codelineno-11-39></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-11-40><a id=__codelineno-11-40 name=__codelineno-11-40 href=#__codelineno-11-40></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-41><a id=__codelineno-11-41 name=__codelineno-11-41 href=#__codelineno-11-41></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-11-42><a id=__codelineno-11-42 name=__codelineno-11-42 href=#__codelineno-11-42></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Invalid token&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-11-43><a id=__codelineno-11-43 name=__codelineno-11-43 href=#__codelineno-11-43></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>401</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-11-44><a id=__codelineno-11-44 name=__codelineno-11-44 href=#__codelineno-11-44></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-11-45><a id=__codelineno-11-45 name=__codelineno-11-45 href=#__codelineno-11-45></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-11-46><a id=__codelineno-11-46 name=__codelineno-11-46 href=#__codelineno-11-46></a><span class=p>}</span>
</span></code></pre></div><h2 id=8-role-based-access-control>8. Role-Based Access Control<a class=headerlink href=#8-role-based-access-control title="Permanent link">&para;</a></h2><h3 id=81-role-definitions>8.1 Role Definitions<a class=headerlink href=#81-role-definitions title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1>// types/auth.ts</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>export</span><span class=w> </span><span class=kd>enum</span><span class=w> </span><span class=nx>UserRole</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>  </span><span class=nx>ADMIN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;admin&quot;</span><span class=p>,</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>  </span><span class=nx>USER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=p>}</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=k>export</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=nx>Permission</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>  </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=w>  </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>[];</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=p>}</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>rolePermissions</span><span class=o>:</span><span class=w> </span><span class=kt>Record</span><span class=o>&lt;</span><span class=nx>UserRole</span><span class=p>,</span><span class=w> </span><span class=nx>Permission</span><span class=p>[]</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=w>  </span><span class=p>[</span><span class=nx>UserRole</span><span class=p>.</span><span class=nx>ADMIN</span><span class=p>]</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;users&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;create&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;update&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;delete&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;services&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;create&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;update&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;delete&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;settings&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;update&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;youtube&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;create&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;update&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;delete&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;requests&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;update&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;delete&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a><span class=w>  </span><span class=p>],</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=w>  </span><span class=p>[</span><span class=nx>UserRole</span><span class=p>.</span><span class=nx>USER</span><span class=p>]</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;profile&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;update&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;youtube&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;create&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;read&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;requests&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;create&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;read&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;services&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>actions</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a><span class=w>  </span><span class=p>],</span>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a><span class=p>};</span>
</span></code></pre></div><h3 id=82-authorization-middleware>8.2 Authorization Middleware<a class=headerlink href=#82-authorization-middleware title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1>// middleware/authorization.ts</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>NextRequest</span><span class=p>,</span><span class=w> </span><span class=nx>NextResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next/server&quot;</span><span class=p>;</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>rolePermissions</span><span class=p>,</span><span class=w> </span><span class=nx>UserRole</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/types/auth&quot;</span><span class=p>;</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>requirePermission</span><span class=p>(</span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>action</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>authorize</span><span class=p>(</span><span class=nx>request</span><span class=o>:</span><span class=w> </span><span class=kt>NextRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>userRole</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&quot;x-user-role&quot;</span><span class=p>)</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>UserRole</span><span class=p>;</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>userRole</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Unauthorized&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>401</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>permissions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>rolePermissions</span><span class=p>[</span><span class=nx>userRole</span><span class=p>];</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>hasPermission</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>permissions</span><span class=p>.</span><span class=nx>some</span><span class=p>(</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=w>      </span><span class=nx>p</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>resource</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>resource</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>actions</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>action</span><span class=p>)</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>hasPermission</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Forbidden&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>403</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a><span class=p>}</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32 href=#__codelineno-13-32></a><span class=c1>// Usage in API routes</span>
</span><span id=__span-13-33><a id=__codelineno-13-33 name=__codelineno-13-33 href=#__codelineno-13-33></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>GET</span><span class=p>(</span><span class=nx>request</span><span class=o>:</span><span class=w> </span><span class=kt>NextRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-34><a id=__codelineno-13-34 name=__codelineno-13-34 href=#__codelineno-13-34></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>authResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>requirePermission</span><span class=p>(</span><span class=s2>&quot;users&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;read&quot;</span><span class=p>)(</span><span class=nx>request</span><span class=p>);</span>
</span><span id=__span-13-35><a id=__codelineno-13-35 name=__codelineno-13-35 href=#__codelineno-13-35></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>authResult</span><span class=p>.</span><span class=nx>status</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=mf>200</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nx>authResult</span><span class=p>;</span>
</span><span id=__span-13-36><a id=__codelineno-13-36 name=__codelineno-13-36 href=#__codelineno-13-36></a>
</span><span id=__span-13-37><a id=__codelineno-13-37 name=__codelineno-13-37 href=#__codelineno-13-37></a><span class=w>  </span><span class=c1>// Handle request...</span>
</span><span id=__span-13-38><a id=__codelineno-13-38 name=__codelineno-13-38 href=#__codelineno-13-38></a><span class=p>}</span>
</span></code></pre></div><h3 id=83-frontend-authorization>8.3 Frontend Authorization<a class=headerlink href=#83-frontend-authorization title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1>// hooks/useAuthorization.ts</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>useSession</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next-auth/react&quot;</span><span class=p>;</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>rolePermissions</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/types/auth&quot;</span><span class=p>;</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>useAuthorization</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>session</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useSession</span><span class=p>();</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>can</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=nx>resource</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>action</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>role</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>permissions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>rolePermissions</span><span class=p>[</span><span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>role</span><span class=p>];</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>permissions</span><span class=p>.</span><span class=nx>some</span><span class=p>(</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=w>      </span><span class=nx>p</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>resource</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>resource</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>actions</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>action</span><span class=p>)</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>isAdmin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>role</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;admin&quot;</span><span class=p>;</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>can</span><span class=p>,</span><span class=w> </span><span class=nx>isAdmin</span><span class=p>,</span><span class=w> </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>session?.user?.role</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=p>}</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=c1>// Usage in components</span>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>AdminPanel</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>can</span><span class=p>,</span><span class=w> </span><span class=nx>isAdmin</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useAuthorization</span><span class=p>();</span>
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a>
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>isAdmin</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-29><a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span><span class=nx>Access</span><span class=w> </span><span class=nx>Denied</span><span class=o>&lt;</span><span class=err>/div&gt;;</span>
</span><span id=__span-14-30><a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-14-31><a id=__codelineno-14-31 name=__codelineno-14-31 href=#__codelineno-14-31></a>
</span><span id=__span-14-32><a id=__codelineno-14-32 name=__codelineno-14-32 href=#__codelineno-14-32></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-14-33><a id=__codelineno-14-33 name=__codelineno-14-33 href=#__codelineno-14-33></a><span class=w>    </span><span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span>
</span><span id=__span-14-34><a id=__codelineno-14-34 name=__codelineno-14-34 href=#__codelineno-14-34></a><span class=w>      </span><span class=p>{</span><span class=nx>can</span><span class=p>(</span><span class=s2>&quot;users&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;create&quot;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>&lt;</span><span class=nx>CreateUserButton</span><span class=w> </span><span class=o>/&gt;</span><span class=p>}</span>
</span><span id=__span-14-35><a id=__codelineno-14-35 name=__codelineno-14-35 href=#__codelineno-14-35></a><span class=w>      </span><span class=p>{</span><span class=nx>can</span><span class=p>(</span><span class=s2>&quot;settings&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;update&quot;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>&lt;</span><span class=nx>SettingsForm</span><span class=w> </span><span class=o>/&gt;</span><span class=p>}</span>
</span><span id=__span-14-36><a id=__codelineno-14-36 name=__codelineno-14-36 href=#__codelineno-14-36></a><span class=w>    </span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span><span id=__span-14-37><a id=__codelineno-14-37 name=__codelineno-14-37 href=#__codelineno-14-37></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-14-38><a id=__codelineno-14-38 name=__codelineno-14-38 href=#__codelineno-14-38></a><span class=p>}</span>
</span></code></pre></div><h2 id=9-api-authentication>9. API Authentication<a class=headerlink href=#9-api-authentication title="Permanent link">&para;</a></h2><h3 id=91-api-token-management>9.1 API Token Management<a class=headerlink href=#91-api-token-management title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1>// backend/src/services/authService.ts</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=k>import</span><span class=w> </span><span class=nx>jwt</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;jsonwebtoken&quot;</span><span class=p>;</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Redis</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;ioredis&quot;</span><span class=p>;</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>AuthService</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>redis</span><span class=o>:</span><span class=w> </span><span class=kt>Redis</span><span class=p>;</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>jwtSecret</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=w>  </span><span class=kr>constructor</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Redis</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>REDIS_URL</span><span class=o>!</span><span class=p>);</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=nx>jwtSecret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET</span><span class=o>!</span><span class=p>;</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>generateAPITokens</span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>accessToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=w>        </span><span class=nx>sub</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=p>,</span>
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=w>        </span><span class=nx>role</span><span class=p>,</span>
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a><span class=w>        </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;access&quot;</span><span class=p>,</span>
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>jwtSecret</span><span class=p>,</span>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=w>        </span><span class=nx>expiresIn</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;1h&quot;</span><span class=p>,</span>
</span><span id=__span-15-24><a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=w>        </span><span class=nx>issuer</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;medianest-api&quot;</span><span class=p>,</span>
</span><span id=__span-15-25><a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-15-26><a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-15-27><a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a>
</span><span id=__span-15-28><a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>refreshToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span>
</span><span id=__span-15-29><a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-15-30><a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a><span class=w>        </span><span class=nx>sub</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=p>,</span>
</span><span id=__span-15-31><a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a><span class=w>        </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;refresh&quot;</span><span class=p>,</span>
</span><span id=__span-15-32><a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-15-33><a id=__codelineno-15-33 name=__codelineno-15-33 href=#__codelineno-15-33></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>jwtSecret</span><span class=p>,</span>
</span><span id=__span-15-34><a id=__codelineno-15-34 name=__codelineno-15-34 href=#__codelineno-15-34></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-15-35><a id=__codelineno-15-35 name=__codelineno-15-35 href=#__codelineno-15-35></a><span class=w>        </span><span class=nx>expiresIn</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;30d&quot;</span><span class=p>,</span>
</span><span id=__span-15-36><a id=__codelineno-15-36 name=__codelineno-15-36 href=#__codelineno-15-36></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-15-37><a id=__codelineno-15-37 name=__codelineno-15-37 href=#__codelineno-15-37></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-15-38><a id=__codelineno-15-38 name=__codelineno-15-38 href=#__codelineno-15-38></a>
</span><span id=__span-15-39><a id=__codelineno-15-39 name=__codelineno-15-39 href=#__codelineno-15-39></a><span class=w>    </span><span class=c1>// Store refresh token in Redis</span>
</span><span id=__span-15-40><a id=__codelineno-15-40 name=__codelineno-15-40 href=#__codelineno-15-40></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>setex</span><span class=p>(</span>
</span><span id=__span-15-41><a id=__codelineno-15-41 name=__codelineno-15-41 href=#__codelineno-15-41></a><span class=w>      </span><span class=sb>`refresh:</span><span class=si>${</span><span class=nx>userId</span><span class=si>}</span><span class=sb>:</span><span class=si>${</span><span class=nx>refreshToken</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-15-42><a id=__codelineno-15-42 name=__codelineno-15-42 href=#__codelineno-15-42></a><span class=w>      </span><span class=mf>30</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=p>,</span>
</span><span id=__span-15-43><a id=__codelineno-15-43 name=__codelineno-15-43 href=#__codelineno-15-43></a><span class=w>      </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-15-44><a id=__codelineno-15-44 name=__codelineno-15-44 href=#__codelineno-15-44></a><span class=w>        </span><span class=nx>userId</span><span class=p>,</span>
</span><span id=__span-15-45><a id=__codelineno-15-45 name=__codelineno-15-45 href=#__codelineno-15-45></a><span class=w>        </span><span class=nx>createdAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span><span id=__span-15-46><a id=__codelineno-15-46 name=__codelineno-15-46 href=#__codelineno-15-46></a><span class=w>      </span><span class=p>})</span>
</span><span id=__span-15-47><a id=__codelineno-15-47 name=__codelineno-15-47 href=#__codelineno-15-47></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-15-48><a id=__codelineno-15-48 name=__codelineno-15-48 href=#__codelineno-15-48></a>
</span><span id=__span-15-49><a id=__codelineno-15-49 name=__codelineno-15-49 href=#__codelineno-15-49></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>accessToken</span><span class=p>,</span><span class=w> </span><span class=nx>refreshToken</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-15-50><a id=__codelineno-15-50 name=__codelineno-15-50 href=#__codelineno-15-50></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-15-51><a id=__codelineno-15-51 name=__codelineno-15-51 href=#__codelineno-15-51></a>
</span><span id=__span-15-52><a id=__codelineno-15-52 name=__codelineno-15-52 href=#__codelineno-15-52></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>refreshAccessToken</span><span class=p>(</span><span class=nx>refreshToken</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-53><a id=__codelineno-15-53 name=__codelineno-15-53 href=#__codelineno-15-53></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-54><a id=__codelineno-15-54 name=__codelineno-15-54 href=#__codelineno-15-54></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>decoded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>refreshToken</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>jwtSecret</span><span class=p>)</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>any</span><span class=p>;</span>
</span><span id=__span-15-55><a id=__codelineno-15-55 name=__codelineno-15-55 href=#__codelineno-15-55></a>
</span><span id=__span-15-56><a id=__codelineno-15-56 name=__codelineno-15-56 href=#__codelineno-15-56></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>decoded</span><span class=p>.</span><span class=kr>type</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s2>&quot;refresh&quot;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-57><a id=__codelineno-15-57 name=__codelineno-15-57 href=#__codelineno-15-57></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s2>&quot;Invalid token type&quot;</span><span class=p>);</span>
</span><span id=__span-15-58><a id=__codelineno-15-58 name=__codelineno-15-58 href=#__codelineno-15-58></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-15-59><a id=__codelineno-15-59 name=__codelineno-15-59 href=#__codelineno-15-59></a>
</span><span id=__span-15-60><a id=__codelineno-15-60 name=__codelineno-15-60 href=#__codelineno-15-60></a><span class=w>      </span><span class=c1>// Check if refresh token exists in Redis</span>
</span><span id=__span-15-61><a id=__codelineno-15-61 name=__codelineno-15-61 href=#__codelineno-15-61></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>exists</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>exists</span><span class=p>(</span>
</span><span id=__span-15-62><a id=__codelineno-15-62 name=__codelineno-15-62 href=#__codelineno-15-62></a><span class=w>        </span><span class=sb>`refresh:</span><span class=si>${</span><span class=nx>decoded</span><span class=p>.</span><span class=nx>sub</span><span class=si>}</span><span class=sb>:</span><span class=si>${</span><span class=nx>refreshToken</span><span class=si>}</span><span class=sb>`</span>
</span><span id=__span-15-63><a id=__codelineno-15-63 name=__codelineno-15-63 href=#__codelineno-15-63></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-15-64><a id=__codelineno-15-64 name=__codelineno-15-64 href=#__codelineno-15-64></a>
</span><span id=__span-15-65><a id=__codelineno-15-65 name=__codelineno-15-65 href=#__codelineno-15-65></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>exists</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-66><a id=__codelineno-15-66 name=__codelineno-15-66 href=#__codelineno-15-66></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s2>&quot;Refresh token revoked&quot;</span><span class=p>);</span>
</span><span id=__span-15-67><a id=__codelineno-15-67 name=__codelineno-15-67 href=#__codelineno-15-67></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-15-68><a id=__codelineno-15-68 name=__codelineno-15-68 href=#__codelineno-15-68></a>
</span><span id=__span-15-69><a id=__codelineno-15-69 name=__codelineno-15-69 href=#__codelineno-15-69></a><span class=w>      </span><span class=c1>// Get user details</span>
</span><span id=__span-15-70><a id=__codelineno-15-70 name=__codelineno-15-70 href=#__codelineno-15-70></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>getUserById</span><span class=p>(</span><span class=nx>decoded</span><span class=p>.</span><span class=nx>sub</span><span class=p>);</span>
</span><span id=__span-15-71><a id=__codelineno-15-71 name=__codelineno-15-71 href=#__codelineno-15-71></a>
</span><span id=__span-15-72><a id=__codelineno-15-72 name=__codelineno-15-72 href=#__codelineno-15-72></a><span class=w>      </span><span class=c1>// Generate new access token</span>
</span><span id=__span-15-73><a id=__codelineno-15-73 name=__codelineno-15-73 href=#__codelineno-15-73></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>accessToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span>
</span><span id=__span-15-74><a id=__codelineno-15-74 name=__codelineno-15-74 href=#__codelineno-15-74></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-15-75><a id=__codelineno-15-75 name=__codelineno-15-75 href=#__codelineno-15-75></a><span class=w>          </span><span class=nx>sub</span><span class=o>:</span><span class=w> </span><span class=kt>user.id</span><span class=p>,</span>
</span><span id=__span-15-76><a id=__codelineno-15-76 name=__codelineno-15-76 href=#__codelineno-15-76></a><span class=w>          </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>user.role</span><span class=p>,</span>
</span><span id=__span-15-77><a id=__codelineno-15-77 name=__codelineno-15-77 href=#__codelineno-15-77></a><span class=w>          </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;access&quot;</span><span class=p>,</span>
</span><span id=__span-15-78><a id=__codelineno-15-78 name=__codelineno-15-78 href=#__codelineno-15-78></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-15-79><a id=__codelineno-15-79 name=__codelineno-15-79 href=#__codelineno-15-79></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>jwtSecret</span><span class=p>,</span>
</span><span id=__span-15-80><a id=__codelineno-15-80 name=__codelineno-15-80 href=#__codelineno-15-80></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-15-81><a id=__codelineno-15-81 name=__codelineno-15-81 href=#__codelineno-15-81></a><span class=w>          </span><span class=nx>expiresIn</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;1h&quot;</span><span class=p>,</span>
</span><span id=__span-15-82><a id=__codelineno-15-82 name=__codelineno-15-82 href=#__codelineno-15-82></a><span class=w>          </span><span class=nx>issuer</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;medianest-api&quot;</span><span class=p>,</span>
</span><span id=__span-15-83><a id=__codelineno-15-83 name=__codelineno-15-83 href=#__codelineno-15-83></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-15-84><a id=__codelineno-15-84 name=__codelineno-15-84 href=#__codelineno-15-84></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-15-85><a id=__codelineno-15-85 name=__codelineno-15-85 href=#__codelineno-15-85></a>
</span><span id=__span-15-86><a id=__codelineno-15-86 name=__codelineno-15-86 href=#__codelineno-15-86></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>accessToken</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-15-87><a id=__codelineno-15-87 name=__codelineno-15-87 href=#__codelineno-15-87></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-88><a id=__codelineno-15-88 name=__codelineno-15-88 href=#__codelineno-15-88></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s2>&quot;Invalid refresh token&quot;</span><span class=p>);</span>
</span><span id=__span-15-89><a id=__codelineno-15-89 name=__codelineno-15-89 href=#__codelineno-15-89></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-15-90><a id=__codelineno-15-90 name=__codelineno-15-90 href=#__codelineno-15-90></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-15-91><a id=__codelineno-15-91 name=__codelineno-15-91 href=#__codelineno-15-91></a><span class=p>}</span>
</span></code></pre></div><h3 id=92-express-jwt-middleware>9.2 Express JWT Middleware<a class=headerlink href=#92-express-jwt-middleware title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>// backend/src/middleware/auth.ts</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Request</span><span class=p>,</span><span class=w> </span><span class=nx>Response</span><span class=p>,</span><span class=w> </span><span class=nx>NextFunction</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;express&quot;</span><span class=p>;</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=k>import</span><span class=w> </span><span class=nx>jwt</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;jsonwebtoken&quot;</span><span class=p>;</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>AuthService</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;../services/authService&quot;</span><span class=p>;</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=kr>declare</span><span class=w> </span><span class=nb>global</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>  </span><span class=nx>namespace</span><span class=w> </span><span class=nx>Express</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>    </span><span class=kd>interface</span><span class=w> </span><span class=nx>Request</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>      </span><span class=nx>user</span><span class=o>?:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>        </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>        </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=w>      </span><span class=p>};</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=p>}</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=kd>const</span><span class=w> </span><span class=nx>authService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>AuthService</span><span class=p>();</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>authenticateToken</span><span class=p>(</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=w>  </span><span class=nx>req</span><span class=o>:</span><span class=w> </span><span class=kt>Request</span><span class=p>,</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=w>  </span><span class=nx>res</span><span class=o>:</span><span class=w> </span><span class=kt>Response</span><span class=p>,</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=w>  </span><span class=nx>next</span><span class=o>:</span><span class=w> </span><span class=kt>NextFunction</span>
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>authHeader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>req</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s2>&quot;authorization&quot;</span><span class=p>];</span>
</span><span id=__span-16-25><a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>authHeader</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>authHeader</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>)[</span><span class=mf>1</span><span class=p>];</span>
</span><span id=__span-16-26><a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a>
</span><span id=__span-16-27><a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-28><a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>401</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Access token required&quot;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-16-29><a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-16-30><a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a>
</span><span id=__span-16-31><a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-32><a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>decoded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span>
</span><span id=__span-16-33><a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a><span class=w>      </span><span class=nx>token</span><span class=p>,</span>
</span><span id=__span-16-34><a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a><span class=w>      </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET</span><span class=o>!</span>
</span><span id=__span-16-35><a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>any</span><span class=p>;</span>
</span><span id=__span-16-36><a id=__codelineno-16-36 name=__codelineno-16-36 href=#__codelineno-16-36></a>
</span><span id=__span-16-37><a id=__codelineno-16-37 name=__codelineno-16-37 href=#__codelineno-16-37></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>decoded</span><span class=p>.</span><span class=kr>type</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s2>&quot;access&quot;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-38><a id=__codelineno-16-38 name=__codelineno-16-38 href=#__codelineno-16-38></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s2>&quot;Invalid token type&quot;</span><span class=p>);</span>
</span><span id=__span-16-39><a id=__codelineno-16-39 name=__codelineno-16-39 href=#__codelineno-16-39></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-40><a id=__codelineno-16-40 name=__codelineno-16-40 href=#__codelineno-16-40></a>
</span><span id=__span-16-41><a id=__codelineno-16-41 name=__codelineno-16-41 href=#__codelineno-16-41></a><span class=w>    </span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-42><a id=__codelineno-16-42 name=__codelineno-16-42 href=#__codelineno-16-42></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>decoded.sub</span><span class=p>,</span>
</span><span id=__span-16-43><a id=__codelineno-16-43 name=__codelineno-16-43 href=#__codelineno-16-43></a><span class=w>      </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>decoded.role</span><span class=p>,</span>
</span><span id=__span-16-44><a id=__codelineno-16-44 name=__codelineno-16-44 href=#__codelineno-16-44></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-16-45><a id=__codelineno-16-45 name=__codelineno-16-45 href=#__codelineno-16-45></a>
</span><span id=__span-16-46><a id=__codelineno-16-46 name=__codelineno-16-46 href=#__codelineno-16-46></a><span class=w>    </span><span class=nx>next</span><span class=p>();</span>
</span><span id=__span-16-47><a id=__codelineno-16-47 name=__codelineno-16-47 href=#__codelineno-16-47></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-48><a id=__codelineno-16-48 name=__codelineno-16-48 href=#__codelineno-16-48></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>name</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;TokenExpiredError&quot;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-49><a id=__codelineno-16-49 name=__codelineno-16-49 href=#__codelineno-16-49></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>401</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=w> </span>
</span><span id=__span-16-50><a id=__codelineno-16-50 name=__codelineno-16-50 href=#__codelineno-16-50></a><span class=w>        </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Token expired&quot;</span><span class=p>,</span>
</span><span id=__span-16-51><a id=__codelineno-16-51 name=__codelineno-16-51 href=#__codelineno-16-51></a><span class=w>        </span><span class=nx>code</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;TOKEN_EXPIRED&quot;</span><span class=w> </span>
</span><span id=__span-16-52><a id=__codelineno-16-52 name=__codelineno-16-52 href=#__codelineno-16-52></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-16-53><a id=__codelineno-16-53 name=__codelineno-16-53 href=#__codelineno-16-53></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-54><a id=__codelineno-16-54 name=__codelineno-16-54 href=#__codelineno-16-54></a>
</span><span id=__span-16-55><a id=__codelineno-16-55 name=__codelineno-16-55 href=#__codelineno-16-55></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>403</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Invalid token&quot;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-16-56><a id=__codelineno-16-56 name=__codelineno-16-56 href=#__codelineno-16-56></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-16-57><a id=__codelineno-16-57 name=__codelineno-16-57 href=#__codelineno-16-57></a><span class=p>}</span>
</span><span id=__span-16-58><a id=__codelineno-16-58 name=__codelineno-16-58 href=#__codelineno-16-58></a>
</span><span id=__span-16-59><a id=__codelineno-16-59 name=__codelineno-16-59 href=#__codelineno-16-59></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>requireRole</span><span class=p>(</span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-60><a id=__codelineno-16-60 name=__codelineno-16-60 href=#__codelineno-16-60></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=nx>req</span><span class=o>:</span><span class=w> </span><span class=kt>Request</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=o>:</span><span class=w> </span><span class=kt>Response</span><span class=p>,</span><span class=w> </span><span class=nx>next</span><span class=o>:</span><span class=w> </span><span class=kt>NextFunction</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-61><a id=__codelineno-16-61 name=__codelineno-16-61 href=#__codelineno-16-61></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>role</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=nx>role</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-62><a id=__codelineno-16-62 name=__codelineno-16-62 href=#__codelineno-16-62></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mf>403</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span><span class=w> </span>
</span><span id=__span-16-63><a id=__codelineno-16-63 name=__codelineno-16-63 href=#__codelineno-16-63></a><span class=w>        </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Insufficient permissions&quot;</span><span class=w> </span>
</span><span id=__span-16-64><a id=__codelineno-16-64 name=__codelineno-16-64 href=#__codelineno-16-64></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-16-65><a id=__codelineno-16-65 name=__codelineno-16-65 href=#__codelineno-16-65></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-66><a id=__codelineno-16-66 name=__codelineno-16-66 href=#__codelineno-16-66></a><span class=w>    </span><span class=nx>next</span><span class=p>();</span>
</span><span id=__span-16-67><a id=__codelineno-16-67 name=__codelineno-16-67 href=#__codelineno-16-67></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-16-68><a id=__codelineno-16-68 name=__codelineno-16-68 href=#__codelineno-16-68></a><span class=p>}</span>
</span></code></pre></div><h2 id=10-enhanced-security-features>10. Enhanced Security Features<a class=headerlink href=#10-enhanced-security-features title="Permanent link">&para;</a></h2><h3 id=101-password-reset-architecture>10.1 Password Reset Architecture<a class=headerlink href=#101-password-reset-architecture title="Permanent link">&para;</a></h3><h4 id=secure-password-reset-flow>Secure Password Reset Flow<a class=headerlink href=#secure-password-reset-flow title="Permanent link">&para;</a></h4><pre class=mermaid><code>sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant Email
    participant Redis
    participant Database

    User-&gt;&gt;Frontend: Request password reset
    Frontend-&gt;&gt;Backend: POST /api/auth/password-reset
    Backend-&gt;&gt;Database: Verify user exists
    Database-&gt;&gt;Backend: User confirmation
    Backend-&gt;&gt;Redis: Store reset token (15min TTL)
    Backend-&gt;&gt;Email: Send reset email with token
    Email-&gt;&gt;User: Reset email delivered
    User-&gt;&gt;Frontend: Click reset link
    Frontend-&gt;&gt;Backend: GET /api/auth/reset/{token}
    Backend-&gt;&gt;Redis: Validate token
    Redis-&gt;&gt;Backend: Token valid
    Frontend-&gt;&gt;User: Show password reset form
    User-&gt;&gt;Frontend: Submit new password
    Frontend-&gt;&gt;Backend: POST /api/auth/reset/{token}
    Backend-&gt;&gt;Database: Update password hash
    Backend-&gt;&gt;Redis: Invalidate all user sessions
    Backend-&gt;&gt;Frontend: Success response</code></pre><h4 id=implementation>Implementation<a class=headerlink href=#implementation title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=c1>// lib/auth/password-reset.ts</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=k>import</span><span class=w> </span><span class=nx>crypto</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;crypto&#39;</span><span class=p>;</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>getRedisClient</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../redis/redis-client&#39;</span><span class=p>;</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>prisma</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../db/prisma&#39;</span><span class=p>;</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>sendPasswordResetEmail</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../email/templates&#39;</span><span class=p>;</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=kd>const</span><span class=w> </span><span class=nx>RESET_TOKEN_TTL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>15</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=p>;</span><span class=w> </span><span class=c1>// 15 minutes</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=kd>const</span><span class=w> </span><span class=nx>MAX_RESET_ATTEMPTS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>3</span><span class=p>;</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>PasswordResetService</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getRedisClient</span><span class=p>();</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>requestPasswordReset</span><span class=p>(</span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>boolean</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=w>    </span><span class=c1>// Check rate limiting</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>attemptKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`pwd_reset_attempts:</span><span class=si>${</span><span class=nx>email</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>attempts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>attemptKey</span><span class=p>);</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>attempts</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>parseInt</span><span class=p>(</span><span class=nx>attempts</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>MAX_RESET_ATTEMPTS</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;Too many reset attempts. Please try again later.&#39;</span><span class=p>);</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=w>    </span><span class=c1>// Verify user exists</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>findUnique</span><span class=p>({</span><span class=w> </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>email</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>user</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=w>      </span><span class=c1>// Don&#39;t reveal if email exists - always return success</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-17-27><a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-28><a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a>
</span><span id=__span-17-29><a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a><span class=w>    </span><span class=c1>// Generate secure token</span>
</span><span id=__span-17-30><a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>resetToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mf>32</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-17-31><a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>createHash</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>).</span><span class=nx>update</span><span class=p>(</span><span class=nx>resetToken</span><span class=p>).</span><span class=nx>digest</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-17-32><a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a>
</span><span id=__span-17-33><a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a><span class=w>    </span><span class=c1>// Store token in Redis</span>
</span><span id=__span-17-34><a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`pwd_reset_token:</span><span class=si>${</span><span class=nx>tokenHash</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span><span id=__span-17-35><a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>setex</span><span class=p>(</span><span class=nx>tokenKey</span><span class=p>,</span><span class=w> </span><span class=nx>RESET_TOKEN_TTL</span><span class=p>,</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-17-36><a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a><span class=w>      </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>user.id</span><span class=p>,</span>
</span><span id=__span-17-37><a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a><span class=w>      </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>user.email</span><span class=p>,</span>
</span><span id=__span-17-38><a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a><span class=w>      </span><span class=nx>createdAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>()</span>
</span><span id=__span-17-39><a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a><span class=w>    </span><span class=p>}));</span>
</span><span id=__span-17-40><a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a>
</span><span id=__span-17-41><a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a><span class=w>    </span><span class=c1>// Track attempt</span>
</span><span id=__span-17-42><a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>incr</span><span class=p>(</span><span class=nx>attemptKey</span><span class=p>);</span>
</span><span id=__span-17-43><a id=__codelineno-17-43 name=__codelineno-17-43 href=#__codelineno-17-43></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>expire</span><span class=p>(</span><span class=nx>attemptKey</span><span class=p>,</span><span class=w> </span><span class=mf>3600</span><span class=p>);</span><span class=w> </span><span class=c1>// 1 hour window</span>
</span><span id=__span-17-44><a id=__codelineno-17-44 name=__codelineno-17-44 href=#__codelineno-17-44></a>
</span><span id=__span-17-45><a id=__codelineno-17-45 name=__codelineno-17-45 href=#__codelineno-17-45></a><span class=w>    </span><span class=c1>// Send email</span>
</span><span id=__span-17-46><a id=__codelineno-17-46 name=__codelineno-17-46 href=#__codelineno-17-46></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>sendPasswordResetEmail</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>email</span><span class=p>,</span><span class=w> </span><span class=nx>resetToken</span><span class=p>);</span>
</span><span id=__span-17-47><a id=__codelineno-17-47 name=__codelineno-17-47 href=#__codelineno-17-47></a>
</span><span id=__span-17-48><a id=__codelineno-17-48 name=__codelineno-17-48 href=#__codelineno-17-48></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-17-49><a id=__codelineno-17-49 name=__codelineno-17-49 href=#__codelineno-17-49></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-17-50><a id=__codelineno-17-50 name=__codelineno-17-50 href=#__codelineno-17-50></a>
</span><span id=__span-17-51><a id=__codelineno-17-51 name=__codelineno-17-51 href=#__codelineno-17-51></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>validateResetToken</span><span class=p>(</span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=p>{</span><span class=w> </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w> </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kc>null</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-52><a id=__codelineno-17-52 name=__codelineno-17-52 href=#__codelineno-17-52></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>createHash</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>).</span><span class=nx>update</span><span class=p>(</span><span class=nx>token</span><span class=p>).</span><span class=nx>digest</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-17-53><a id=__codelineno-17-53 name=__codelineno-17-53 href=#__codelineno-17-53></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`pwd_reset_token:</span><span class=si>${</span><span class=nx>tokenHash</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span><span id=__span-17-54><a id=__codelineno-17-54 name=__codelineno-17-54 href=#__codelineno-17-54></a>
</span><span id=__span-17-55><a id=__codelineno-17-55 name=__codelineno-17-55 href=#__codelineno-17-55></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>tokenKey</span><span class=p>);</span>
</span><span id=__span-17-56><a id=__codelineno-17-56 name=__codelineno-17-56 href=#__codelineno-17-56></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>tokenData</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-57><a id=__codelineno-17-57 name=__codelineno-17-57 href=#__codelineno-17-57></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-17-58><a id=__codelineno-17-58 name=__codelineno-17-58 href=#__codelineno-17-58></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-59><a id=__codelineno-17-59 name=__codelineno-17-59 href=#__codelineno-17-59></a>
</span><span id=__span-17-60><a id=__codelineno-17-60 name=__codelineno-17-60 href=#__codelineno-17-60></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>tokenData</span><span class=p>);</span>
</span><span id=__span-17-61><a id=__codelineno-17-61 name=__codelineno-17-61 href=#__codelineno-17-61></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-17-62><a id=__codelineno-17-62 name=__codelineno-17-62 href=#__codelineno-17-62></a>
</span><span id=__span-17-63><a id=__codelineno-17-63 name=__codelineno-17-63 href=#__codelineno-17-63></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>resetPassword</span><span class=p>(</span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>newPassword</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>boolean</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-64><a id=__codelineno-17-64 name=__codelineno-17-64 href=#__codelineno-17-64></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>validateResetToken</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
</span><span id=__span-17-65><a id=__codelineno-17-65 name=__codelineno-17-65 href=#__codelineno-17-65></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>tokenData</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-66><a id=__codelineno-17-66 name=__codelineno-17-66 href=#__codelineno-17-66></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;Invalid or expired reset token&#39;</span><span class=p>);</span>
</span><span id=__span-17-67><a id=__codelineno-17-67 name=__codelineno-17-67 href=#__codelineno-17-67></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-68><a id=__codelineno-17-68 name=__codelineno-17-68 href=#__codelineno-17-68></a>
</span><span id=__span-17-69><a id=__codelineno-17-69 name=__codelineno-17-69 href=#__codelineno-17-69></a><span class=w>    </span><span class=c1>// Hash new password</span>
</span><span id=__span-17-70><a id=__codelineno-17-70 name=__codelineno-17-70 href=#__codelineno-17-70></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>bcrypt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>import</span><span class=p>(</span><span class=s1>&#39;bcryptjs&#39;</span><span class=p>);</span>
</span><span id=__span-17-71><a id=__codelineno-17-71 name=__codelineno-17-71 href=#__codelineno-17-71></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>hashedPassword</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>bcrypt</span><span class=p>.</span><span class=nx>hash</span><span class=p>(</span><span class=nx>newPassword</span><span class=p>,</span><span class=w> </span><span class=mf>12</span><span class=p>);</span>
</span><span id=__span-17-72><a id=__codelineno-17-72 name=__codelineno-17-72 href=#__codelineno-17-72></a>
</span><span id=__span-17-73><a id=__codelineno-17-73 name=__codelineno-17-73 href=#__codelineno-17-73></a><span class=w>    </span><span class=c1>// Update password in database</span>
</span><span id=__span-17-74><a id=__codelineno-17-74 name=__codelineno-17-74 href=#__codelineno-17-74></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span>
</span><span id=__span-17-75><a id=__codelineno-17-75 name=__codelineno-17-75 href=#__codelineno-17-75></a><span class=w>      </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>tokenData.userId</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-17-76><a id=__codelineno-17-76 name=__codelineno-17-76 href=#__codelineno-17-76></a><span class=w>      </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span>
</span><span id=__span-17-77><a id=__codelineno-17-77 name=__codelineno-17-77 href=#__codelineno-17-77></a><span class=w>        </span><span class=nx>password</span><span class=o>:</span><span class=w> </span><span class=kt>hashedPassword</span><span class=p>,</span>
</span><span id=__span-17-78><a id=__codelineno-17-78 name=__codelineno-17-78 href=#__codelineno-17-78></a><span class=w>        </span><span class=c1>// Force password change flag off</span>
</span><span id=__span-17-79><a id=__codelineno-17-79 name=__codelineno-17-79 href=#__codelineno-17-79></a><span class=w>        </span><span class=nx>requiresPasswordChange</span><span class=o>:</span><span class=w> </span><span class=kt>false</span><span class=p>,</span>
</span><span id=__span-17-80><a id=__codelineno-17-80 name=__codelineno-17-80 href=#__codelineno-17-80></a><span class=w>        </span><span class=c1>// Update password changed timestamp</span>
</span><span id=__span-17-81><a id=__codelineno-17-81 name=__codelineno-17-81 href=#__codelineno-17-81></a><span class=w>        </span><span class=nx>passwordChangedAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>()</span>
</span><span id=__span-17-82><a id=__codelineno-17-82 name=__codelineno-17-82 href=#__codelineno-17-82></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-17-83><a id=__codelineno-17-83 name=__codelineno-17-83 href=#__codelineno-17-83></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-17-84><a id=__codelineno-17-84 name=__codelineno-17-84 href=#__codelineno-17-84></a>
</span><span id=__span-17-85><a id=__codelineno-17-85 name=__codelineno-17-85 href=#__codelineno-17-85></a><span class=w>    </span><span class=c1>// Invalidate all user sessions</span>
</span><span id=__span-17-86><a id=__codelineno-17-86 name=__codelineno-17-86 href=#__codelineno-17-86></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>invalidateUserSessions</span><span class=p>(</span><span class=nx>tokenData</span><span class=p>.</span><span class=nx>userId</span><span class=p>);</span>
</span><span id=__span-17-87><a id=__codelineno-17-87 name=__codelineno-17-87 href=#__codelineno-17-87></a>
</span><span id=__span-17-88><a id=__codelineno-17-88 name=__codelineno-17-88 href=#__codelineno-17-88></a><span class=w>    </span><span class=c1>// Remove reset token</span>
</span><span id=__span-17-89><a id=__codelineno-17-89 name=__codelineno-17-89 href=#__codelineno-17-89></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>createHash</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>).</span><span class=nx>update</span><span class=p>(</span><span class=nx>token</span><span class=p>).</span><span class=nx>digest</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-17-90><a id=__codelineno-17-90 name=__codelineno-17-90 href=#__codelineno-17-90></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=sb>`pwd_reset_token:</span><span class=si>${</span><span class=nx>tokenHash</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-17-91><a id=__codelineno-17-91 name=__codelineno-17-91 href=#__codelineno-17-91></a>
</span><span id=__span-17-92><a id=__codelineno-17-92 name=__codelineno-17-92 href=#__codelineno-17-92></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-17-93><a id=__codelineno-17-93 name=__codelineno-17-93 href=#__codelineno-17-93></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-17-94><a id=__codelineno-17-94 name=__codelineno-17-94 href=#__codelineno-17-94></a>
</span><span id=__span-17-95><a id=__codelineno-17-95 name=__codelineno-17-95 href=#__codelineno-17-95></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>invalidateUserSessions</span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-96><a id=__codelineno-17-96 name=__codelineno-17-96 href=#__codelineno-17-96></a><span class=w>    </span><span class=c1>// Get all user sessions from Redis</span>
</span><span id=__span-17-97><a id=__codelineno-17-97 name=__codelineno-17-97 href=#__codelineno-17-97></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionKeys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=sb>`session:*`</span><span class=p>);</span>
</span><span id=__span-17-98><a id=__codelineno-17-98 name=__codelineno-17-98 href=#__codelineno-17-98></a>
</span><span id=__span-17-99><a id=__codelineno-17-99 name=__codelineno-17-99 href=#__codelineno-17-99></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=nx>sessionKey</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nx>sessionKeys</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-100><a id=__codelineno-17-100 name=__codelineno-17-100 href=#__codelineno-17-100></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>sessionKey</span><span class=p>);</span>
</span><span id=__span-17-101><a id=__codelineno-17-101 name=__codelineno-17-101 href=#__codelineno-17-101></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>sessionData</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-102><a id=__codelineno-17-102 name=__codelineno-17-102 href=#__codelineno-17-102></a><span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>sessionData</span><span class=p>);</span>
</span><span id=__span-17-103><a id=__codelineno-17-103 name=__codelineno-17-103 href=#__codelineno-17-103></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>id</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>userId</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-104><a id=__codelineno-17-104 name=__codelineno-17-104 href=#__codelineno-17-104></a><span class=w>          </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=nx>sessionKey</span><span class=p>);</span>
</span><span id=__span-17-105><a id=__codelineno-17-105 name=__codelineno-17-105 href=#__codelineno-17-105></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-17-106><a id=__codelineno-17-106 name=__codelineno-17-106 href=#__codelineno-17-106></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-17-107><a id=__codelineno-17-107 name=__codelineno-17-107 href=#__codelineno-17-107></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-108><a id=__codelineno-17-108 name=__codelineno-17-108 href=#__codelineno-17-108></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-17-109><a id=__codelineno-17-109 name=__codelineno-17-109 href=#__codelineno-17-109></a><span class=p>}</span>
</span></code></pre></div><h3 id=102-email-verification-system>10.2 Email Verification System<a class=headerlink href=#102-email-verification-system title="Permanent link">&para;</a></h3><h4 id=email-verification-architecture>Email Verification Architecture<a class=headerlink href=#email-verification-architecture title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1>// lib/auth/email-verification.ts</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>EmailVerificationService</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getRedisClient</span><span class=p>();</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>sendVerificationEmail</span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=w>    </span><span class=c1>// Generate verification token</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>verificationToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mf>32</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>createHash</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>).</span><span class=nx>update</span><span class=p>(</span><span class=nx>verificationToken</span><span class=p>).</span><span class=nx>digest</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=w>    </span><span class=c1>// Store token with 24-hour expiry</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`email_verify:</span><span class=si>${</span><span class=nx>tokenHash</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>setex</span><span class=p>(</span><span class=nx>tokenKey</span><span class=p>,</span><span class=w> </span><span class=mf>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>60</span><span class=p>,</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=w>      </span><span class=nx>userId</span><span class=p>,</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=w>      </span><span class=nx>email</span><span class=p>,</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=w>      </span><span class=nx>createdAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>()</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=w>    </span><span class=p>}));</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=w>    </span><span class=c1>// Send verification email</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>sendEmailVerificationEmail</span><span class=p>(</span><span class=nx>email</span><span class=p>,</span><span class=w> </span><span class=nx>verificationToken</span><span class=p>);</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>verifyEmail</span><span class=p>(</span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>boolean</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>createHash</span><span class=p>(</span><span class=s1>&#39;sha256&#39;</span><span class=p>).</span><span class=nx>update</span><span class=p>(</span><span class=nx>token</span><span class=p>).</span><span class=nx>digest</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`email_verify:</span><span class=si>${</span><span class=nx>tokenHash</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tokenData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>tokenKey</span><span class=p>);</span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>tokenData</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a>
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>userId</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>tokenData</span><span class=p>);</span>
</span><span id=__span-18-32><a id=__codelineno-18-32 name=__codelineno-18-32 href=#__codelineno-18-32></a>
</span><span id=__span-18-33><a id=__codelineno-18-33 name=__codelineno-18-33 href=#__codelineno-18-33></a><span class=w>    </span><span class=c1>// Update user as verified</span>
</span><span id=__span-18-34><a id=__codelineno-18-34 name=__codelineno-18-34 href=#__codelineno-18-34></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span>
</span><span id=__span-18-35><a id=__codelineno-18-35 name=__codelineno-18-35 href=#__codelineno-18-35></a><span class=w>      </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-18-36><a id=__codelineno-18-36 name=__codelineno-18-36 href=#__codelineno-18-36></a><span class=w>      </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span>
</span><span id=__span-18-37><a id=__codelineno-18-37 name=__codelineno-18-37 href=#__codelineno-18-37></a><span class=w>        </span><span class=nx>emailVerified</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>(),</span>
</span><span id=__span-18-38><a id=__codelineno-18-38 name=__codelineno-18-38 href=#__codelineno-18-38></a><span class=w>        </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>email</span>
</span><span id=__span-18-39><a id=__codelineno-18-39 name=__codelineno-18-39 href=#__codelineno-18-39></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-18-40><a id=__codelineno-18-40 name=__codelineno-18-40 href=#__codelineno-18-40></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-18-41><a id=__codelineno-18-41 name=__codelineno-18-41 href=#__codelineno-18-41></a>
</span><span id=__span-18-42><a id=__codelineno-18-42 name=__codelineno-18-42 href=#__codelineno-18-42></a><span class=w>    </span><span class=c1>// Remove verification token</span>
</span><span id=__span-18-43><a id=__codelineno-18-43 name=__codelineno-18-43 href=#__codelineno-18-43></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=nx>tokenKey</span><span class=p>);</span>
</span><span id=__span-18-44><a id=__codelineno-18-44 name=__codelineno-18-44 href=#__codelineno-18-44></a>
</span><span id=__span-18-45><a id=__codelineno-18-45 name=__codelineno-18-45 href=#__codelineno-18-45></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-18-46><a id=__codelineno-18-46 name=__codelineno-18-46 href=#__codelineno-18-46></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-18-47><a id=__codelineno-18-47 name=__codelineno-18-47 href=#__codelineno-18-47></a><span class=p>}</span>
</span></code></pre></div><h3 id=103-multi-factor-authentication-2fa-architecture>10.3 Multi-Factor Authentication (2FA) Architecture<a class=headerlink href=#103-multi-factor-authentication-2fa-architecture title="Permanent link">&para;</a></h3><h4 id=2fa-implementation-framework>2FA Implementation Framework<a class=headerlink href=#2fa-implementation-framework title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=c1>// lib/auth/two-factor.ts</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>authenticator</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;otplib&#39;</span><span class=p>;</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=k>import</span><span class=w> </span><span class=nx>QRCode</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;qrcode&#39;</span><span class=p>;</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>TwoFactorService</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>generateTwoFactorSecret</span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=p>{</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=w>    </span><span class=nx>secret</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=w>    </span><span class=nx>qrCodeUrl</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>    </span><span class=nx>backupCodes</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>[];</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=w>  </span><span class=p>}</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>secret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>generateSecret</span><span class=p>();</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>findUnique</span><span class=p>({</span><span class=w> </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>user</span><span class=p>)</span><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;User not found&#39;</span><span class=p>);</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=w>    </span><span class=c1>// Generate QR code</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>otpUrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>keyuri</span><span class=p>(</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=w>      </span><span class=nx>user</span><span class=p>.</span><span class=nx>email</span><span class=p>,</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=w>      </span><span class=s1>&#39;MediaNest&#39;</span><span class=p>,</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=w>      </span><span class=nx>secret</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>qrCodeUrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>QRCode</span><span class=p>.</span><span class=nx>toDataURL</span><span class=p>(</span><span class=nx>otpUrl</span><span class=p>);</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a><span class=w>    </span><span class=c1>// Generate backup codes</span>
</span><span id=__span-19-25><a id=__codelineno-19-25 name=__codelineno-19-25 href=#__codelineno-19-25></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>backupCodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Array</span><span class=p>.</span><span class=kr>from</span><span class=p>({</span><span class=w> </span><span class=nx>length</span><span class=o>:</span><span class=w> </span><span class=kt>10</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span>
</span><span id=__span-19-26><a id=__codelineno-19-26 name=__codelineno-19-26 href=#__codelineno-19-26></a><span class=w>      </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mf>4</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>).</span><span class=nx>toUpperCase</span><span class=p>()</span>
</span><span id=__span-19-27><a id=__codelineno-19-27 name=__codelineno-19-27 href=#__codelineno-19-27></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-19-28><a id=__codelineno-19-28 name=__codelineno-19-28 href=#__codelineno-19-28></a>
</span><span id=__span-19-29><a id=__codelineno-19-29 name=__codelineno-19-29 href=#__codelineno-19-29></a><span class=w>    </span><span class=c1>// Store encrypted secret and backup codes</span>
</span><span id=__span-19-30><a id=__codelineno-19-30 name=__codelineno-19-30 href=#__codelineno-19-30></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>encryptedSecret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>encryptTwoFactorData</span><span class=p>({</span>
</span><span id=__span-19-31><a id=__codelineno-19-31 name=__codelineno-19-31 href=#__codelineno-19-31></a><span class=w>      </span><span class=nx>secret</span><span class=p>,</span>
</span><span id=__span-19-32><a id=__codelineno-19-32 name=__codelineno-19-32 href=#__codelineno-19-32></a><span class=w>      </span><span class=nx>backupCodes</span>
</span><span id=__span-19-33><a id=__codelineno-19-33 name=__codelineno-19-33 href=#__codelineno-19-33></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-19-34><a id=__codelineno-19-34 name=__codelineno-19-34 href=#__codelineno-19-34></a>
</span><span id=__span-19-35><a id=__codelineno-19-35 name=__codelineno-19-35 href=#__codelineno-19-35></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span>
</span><span id=__span-19-36><a id=__codelineno-19-36 name=__codelineno-19-36 href=#__codelineno-19-36></a><span class=w>      </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-19-37><a id=__codelineno-19-37 name=__codelineno-19-37 href=#__codelineno-19-37></a><span class=w>      </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-38><a id=__codelineno-19-38 name=__codelineno-19-38 href=#__codelineno-19-38></a><span class=w>        </span><span class=nx>twoFactorSecret</span><span class=o>:</span><span class=w> </span><span class=kt>encryptedSecret</span><span class=p>,</span>
</span><span id=__span-19-39><a id=__codelineno-19-39 name=__codelineno-19-39 href=#__codelineno-19-39></a><span class=w>        </span><span class=nx>twoFactorEnabled</span><span class=o>:</span><span class=w> </span><span class=kt>false</span><span class=w> </span><span class=c1>// Not enabled until verified</span>
</span><span id=__span-19-40><a id=__codelineno-19-40 name=__codelineno-19-40 href=#__codelineno-19-40></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-19-41><a id=__codelineno-19-41 name=__codelineno-19-41 href=#__codelineno-19-41></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-19-42><a id=__codelineno-19-42 name=__codelineno-19-42 href=#__codelineno-19-42></a>
</span><span id=__span-19-43><a id=__codelineno-19-43 name=__codelineno-19-43 href=#__codelineno-19-43></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>secret</span><span class=p>,</span><span class=w> </span><span class=nx>qrCodeUrl</span><span class=p>,</span><span class=w> </span><span class=nx>backupCodes</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-19-44><a id=__codelineno-19-44 name=__codelineno-19-44 href=#__codelineno-19-44></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-45><a id=__codelineno-19-45 name=__codelineno-19-45 href=#__codelineno-19-45></a>
</span><span id=__span-19-46><a id=__codelineno-19-46 name=__codelineno-19-46 href=#__codelineno-19-46></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>enableTwoFactor</span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>boolean</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-47><a id=__codelineno-19-47 name=__codelineno-19-47 href=#__codelineno-19-47></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>findUnique</span><span class=p>({</span><span class=w> </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-48><a id=__codelineno-19-48 name=__codelineno-19-48 href=#__codelineno-19-48></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>twoFactorSecret</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-19-49><a id=__codelineno-19-49 name=__codelineno-19-49 href=#__codelineno-19-49></a>
</span><span id=__span-19-50><a id=__codelineno-19-50 name=__codelineno-19-50 href=#__codelineno-19-50></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>decryptedData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>decryptTwoFactorData</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>twoFactorSecret</span><span class=p>);</span>
</span><span id=__span-19-51><a id=__codelineno-19-51 name=__codelineno-19-51 href=#__codelineno-19-51></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>isValid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>verify</span><span class=p>({</span><span class=w> </span><span class=nx>token</span><span class=p>,</span><span class=w> </span><span class=nx>secret</span><span class=o>:</span><span class=w> </span><span class=kt>decryptedData.secret</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-52><a id=__codelineno-19-52 name=__codelineno-19-52 href=#__codelineno-19-52></a>
</span><span id=__span-19-53><a id=__codelineno-19-53 name=__codelineno-19-53 href=#__codelineno-19-53></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>isValid</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-54><a id=__codelineno-19-54 name=__codelineno-19-54 href=#__codelineno-19-54></a><span class=w>      </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span>
</span><span id=__span-19-55><a id=__codelineno-19-55 name=__codelineno-19-55 href=#__codelineno-19-55></a><span class=w>        </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-19-56><a id=__codelineno-19-56 name=__codelineno-19-56 href=#__codelineno-19-56></a><span class=w>        </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>twoFactorEnabled</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-19-57><a id=__codelineno-19-57 name=__codelineno-19-57 href=#__codelineno-19-57></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-19-58><a id=__codelineno-19-58 name=__codelineno-19-58 href=#__codelineno-19-58></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-19-59><a id=__codelineno-19-59 name=__codelineno-19-59 href=#__codelineno-19-59></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-60><a id=__codelineno-19-60 name=__codelineno-19-60 href=#__codelineno-19-60></a>
</span><span id=__span-19-61><a id=__codelineno-19-61 name=__codelineno-19-61 href=#__codelineno-19-61></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-19-62><a id=__codelineno-19-62 name=__codelineno-19-62 href=#__codelineno-19-62></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-63><a id=__codelineno-19-63 name=__codelineno-19-63 href=#__codelineno-19-63></a>
</span><span id=__span-19-64><a id=__codelineno-19-64 name=__codelineno-19-64 href=#__codelineno-19-64></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>verifyTwoFactor</span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>boolean</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-65><a id=__codelineno-19-65 name=__codelineno-19-65 href=#__codelineno-19-65></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>findUnique</span><span class=p>({</span><span class=w> </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-66><a id=__codelineno-19-66 name=__codelineno-19-66 href=#__codelineno-19-66></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>twoFactorSecret</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=nx>user</span><span class=p>.</span><span class=nx>twoFactorEnabled</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-19-67><a id=__codelineno-19-67 name=__codelineno-19-67 href=#__codelineno-19-67></a>
</span><span id=__span-19-68><a id=__codelineno-19-68 name=__codelineno-19-68 href=#__codelineno-19-68></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>decryptedData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>decryptTwoFactorData</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>twoFactorSecret</span><span class=p>);</span>
</span><span id=__span-19-69><a id=__codelineno-19-69 name=__codelineno-19-69 href=#__codelineno-19-69></a>
</span><span id=__span-19-70><a id=__codelineno-19-70 name=__codelineno-19-70 href=#__codelineno-19-70></a><span class=w>    </span><span class=c1>// Check TOTP token</span>
</span><span id=__span-19-71><a id=__codelineno-19-71 name=__codelineno-19-71 href=#__codelineno-19-71></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>verify</span><span class=p>({</span><span class=w> </span><span class=nx>token</span><span class=p>,</span><span class=w> </span><span class=nx>secret</span><span class=o>:</span><span class=w> </span><span class=kt>decryptedData.secret</span><span class=w> </span><span class=p>}))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-72><a id=__codelineno-19-72 name=__codelineno-19-72 href=#__codelineno-19-72></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-19-73><a id=__codelineno-19-73 name=__codelineno-19-73 href=#__codelineno-19-73></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-74><a id=__codelineno-19-74 name=__codelineno-19-74 href=#__codelineno-19-74></a>
</span><span id=__span-19-75><a id=__codelineno-19-75 name=__codelineno-19-75 href=#__codelineno-19-75></a><span class=w>    </span><span class=c1>// Check backup codes</span>
</span><span id=__span-19-76><a id=__codelineno-19-76 name=__codelineno-19-76 href=#__codelineno-19-76></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>backupCodeIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>decryptedData</span><span class=p>.</span><span class=nx>backupCodes</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>token</span><span class=p>.</span><span class=nx>toUpperCase</span><span class=p>());</span>
</span><span id=__span-19-77><a id=__codelineno-19-77 name=__codelineno-19-77 href=#__codelineno-19-77></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>backupCodeIndex</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=o>-</span><span class=mf>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-78><a id=__codelineno-19-78 name=__codelineno-19-78 href=#__codelineno-19-78></a><span class=w>      </span><span class=c1>// Remove used backup code</span>
</span><span id=__span-19-79><a id=__codelineno-19-79 name=__codelineno-19-79 href=#__codelineno-19-79></a><span class=w>      </span><span class=nx>decryptedData</span><span class=p>.</span><span class=nx>backupCodes</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>backupCodeIndex</span><span class=p>,</span><span class=w> </span><span class=mf>1</span><span class=p>);</span>
</span><span id=__span-19-80><a id=__codelineno-19-80 name=__codelineno-19-80 href=#__codelineno-19-80></a>
</span><span id=__span-19-81><a id=__codelineno-19-81 name=__codelineno-19-81 href=#__codelineno-19-81></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>encryptedData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>encryptTwoFactorData</span><span class=p>(</span><span class=nx>decryptedData</span><span class=p>);</span>
</span><span id=__span-19-82><a id=__codelineno-19-82 name=__codelineno-19-82 href=#__codelineno-19-82></a><span class=w>      </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span>
</span><span id=__span-19-83><a id=__codelineno-19-83 name=__codelineno-19-83 href=#__codelineno-19-83></a><span class=w>        </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>userId</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-19-84><a id=__codelineno-19-84 name=__codelineno-19-84 href=#__codelineno-19-84></a><span class=w>        </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>twoFactorSecret</span><span class=o>:</span><span class=w> </span><span class=kt>encryptedData</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-19-85><a id=__codelineno-19-85 name=__codelineno-19-85 href=#__codelineno-19-85></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-19-86><a id=__codelineno-19-86 name=__codelineno-19-86 href=#__codelineno-19-86></a>
</span><span id=__span-19-87><a id=__codelineno-19-87 name=__codelineno-19-87 href=#__codelineno-19-87></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-19-88><a id=__codelineno-19-88 name=__codelineno-19-88 href=#__codelineno-19-88></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-89><a id=__codelineno-19-89 name=__codelineno-19-89 href=#__codelineno-19-89></a>
</span><span id=__span-19-90><a id=__codelineno-19-90 name=__codelineno-19-90 href=#__codelineno-19-90></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-19-91><a id=__codelineno-19-91 name=__codelineno-19-91 href=#__codelineno-19-91></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-92><a id=__codelineno-19-92 name=__codelineno-19-92 href=#__codelineno-19-92></a>
</span><span id=__span-19-93><a id=__codelineno-19-93 name=__codelineno-19-93 href=#__codelineno-19-93></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>encryptTwoFactorData</span><span class=p>(</span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>string</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-94><a id=__codelineno-19-94 name=__codelineno-19-94 href=#__codelineno-19-94></a><span class=w>    </span><span class=c1>// Implement AES-256-GCM encryption</span>
</span><span id=__span-19-95><a id=__codelineno-19-95 name=__codelineno-19-95 href=#__codelineno-19-95></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>algorithm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;aes-256-gcm&#39;</span><span class=p>;</span>
</span><span id=__span-19-96><a id=__codelineno-19-96 name=__codelineno-19-96 href=#__codelineno-19-96></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Buffer</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>TWO_FACTOR_ENCRYPTION_KEY</span><span class=o>!</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-19-97><a id=__codelineno-19-97 name=__codelineno-19-97 href=#__codelineno-19-97></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>iv</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mf>16</span><span class=p>);</span>
</span><span id=__span-19-98><a id=__codelineno-19-98 name=__codelineno-19-98 href=#__codelineno-19-98></a>
</span><span id=__span-19-99><a id=__codelineno-19-99 name=__codelineno-19-99 href=#__codelineno-19-99></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>cipher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>createCipheriv</span><span class=p>(</span><span class=nx>algorithm</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=nx>iv</span><span class=p>);</span>
</span><span id=__span-19-100><a id=__codelineno-19-100 name=__codelineno-19-100 href=#__codelineno-19-100></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>encrypted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>cipher</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span><span class=p>),</span><span class=w> </span><span class=s1>&#39;utf8&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-19-101><a id=__codelineno-19-101 name=__codelineno-19-101 href=#__codelineno-19-101></a><span class=w>    </span><span class=nx>encrypted</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>cipher</span><span class=p>.</span><span class=kr>final</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-19-102><a id=__codelineno-19-102 name=__codelineno-19-102 href=#__codelineno-19-102></a>
</span><span id=__span-19-103><a id=__codelineno-19-103 name=__codelineno-19-103 href=#__codelineno-19-103></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>authTag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>cipher</span><span class=p>.</span><span class=nx>getAuthTag</span><span class=p>();</span>
</span><span id=__span-19-104><a id=__codelineno-19-104 name=__codelineno-19-104 href=#__codelineno-19-104></a>
</span><span id=__span-19-105><a id=__codelineno-19-105 name=__codelineno-19-105 href=#__codelineno-19-105></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-19-106><a id=__codelineno-19-106 name=__codelineno-19-106 href=#__codelineno-19-106></a><span class=w>      </span><span class=nx>encrypted</span><span class=p>,</span>
</span><span id=__span-19-107><a id=__codelineno-19-107 name=__codelineno-19-107 href=#__codelineno-19-107></a><span class=w>      </span><span class=nx>iv</span><span class=o>:</span><span class=w> </span><span class=kt>iv.toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>),</span>
</span><span id=__span-19-108><a id=__codelineno-19-108 name=__codelineno-19-108 href=#__codelineno-19-108></a><span class=w>      </span><span class=nx>authTag</span><span class=o>:</span><span class=w> </span><span class=kt>authTag.toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)</span>
</span><span id=__span-19-109><a id=__codelineno-19-109 name=__codelineno-19-109 href=#__codelineno-19-109></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-19-110><a id=__codelineno-19-110 name=__codelineno-19-110 href=#__codelineno-19-110></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-111><a id=__codelineno-19-111 name=__codelineno-19-111 href=#__codelineno-19-111></a>
</span><span id=__span-19-112><a id=__codelineno-19-112 name=__codelineno-19-112 href=#__codelineno-19-112></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>decryptTwoFactorData</span><span class=p>(</span><span class=nx>encryptedData</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>any</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-113><a id=__codelineno-19-113 name=__codelineno-19-113 href=#__codelineno-19-113></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>encrypted</span><span class=p>,</span><span class=w> </span><span class=nx>iv</span><span class=p>,</span><span class=w> </span><span class=nx>authTag</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>encryptedData</span><span class=p>);</span>
</span><span id=__span-19-114><a id=__codelineno-19-114 name=__codelineno-19-114 href=#__codelineno-19-114></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>algorithm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;aes-256-gcm&#39;</span><span class=p>;</span>
</span><span id=__span-19-115><a id=__codelineno-19-115 name=__codelineno-19-115 href=#__codelineno-19-115></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>Buffer</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>TWO_FACTOR_ENCRYPTION_KEY</span><span class=o>!</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span><span id=__span-19-116><a id=__codelineno-19-116 name=__codelineno-19-116 href=#__codelineno-19-116></a>
</span><span id=__span-19-117><a id=__codelineno-19-117 name=__codelineno-19-117 href=#__codelineno-19-117></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>decipher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>crypto</span><span class=p>.</span><span class=nx>createDecipheriv</span><span class=p>(</span><span class=nx>algorithm</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=nx>Buffer</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=nx>iv</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;hex&#39;</span><span class=p>));</span>
</span><span id=__span-19-118><a id=__codelineno-19-118 name=__codelineno-19-118 href=#__codelineno-19-118></a><span class=w>    </span><span class=nx>decipher</span><span class=p>.</span><span class=nx>setAuthTag</span><span class=p>(</span><span class=nx>Buffer</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=nx>authTag</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;hex&#39;</span><span class=p>));</span>
</span><span id=__span-19-119><a id=__codelineno-19-119 name=__codelineno-19-119 href=#__codelineno-19-119></a>
</span><span id=__span-19-120><a id=__codelineno-19-120 name=__codelineno-19-120 href=#__codelineno-19-120></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>decrypted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>decipher</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>encrypted</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;hex&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;utf8&#39;</span><span class=p>);</span>
</span><span id=__span-19-121><a id=__codelineno-19-121 name=__codelineno-19-121 href=#__codelineno-19-121></a><span class=w>    </span><span class=nx>decrypted</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>decipher</span><span class=p>.</span><span class=kr>final</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>);</span>
</span><span id=__span-19-122><a id=__codelineno-19-122 name=__codelineno-19-122 href=#__codelineno-19-122></a>
</span><span id=__span-19-123><a id=__codelineno-19-123 name=__codelineno-19-123 href=#__codelineno-19-123></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>decrypted</span><span class=p>);</span>
</span><span id=__span-19-124><a id=__codelineno-19-124 name=__codelineno-19-124 href=#__codelineno-19-124></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-125><a id=__codelineno-19-125 name=__codelineno-19-125 href=#__codelineno-19-125></a><span class=p>}</span>
</span></code></pre></div><h2 id=11-scalability-architecture>11. Scalability Architecture<a class=headerlink href=#11-scalability-architecture title="Permanent link">&para;</a></h2><h3 id=111-distributed-session-management>11.1 Distributed Session Management<a class=headerlink href=#111-distributed-session-management title="Permanent link">&para;</a></h3><h4 id=session-clustering-strategy>Session Clustering Strategy<a class=headerlink href=#session-clustering-strategy title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1>// lib/auth/distributed-session.ts</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>DistributedSessionManager</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getRedisClient</span><span class=p>();</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>storeSession</span><span class=p>(</span><span class=nx>sessionToken</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>sessionData</span><span class=o>:</span><span class=w> </span><span class=kt>SessionData</span><span class=p>,</span><span class=w> </span><span class=nx>nodeId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>pipeline</span><span class=p>();</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=w>    </span><span class=c1>// Store session data</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`session:</span><span class=si>${</span><span class=nx>sessionToken</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=w>    </span><span class=nx>pipeline</span><span class=p>.</span><span class=nx>setex</span><span class=p>(</span><span class=nx>sessionKey</span><span class=p>,</span><span class=w> </span><span class=nx>SESSION_TTL</span><span class=p>,</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=w>      </span><span class=p>...</span><span class=nx>sessionData</span><span class=p>,</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=w>      </span><span class=nx>nodeId</span><span class=p>,</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=w>      </span><span class=nx>lastAccessed</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>()</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=w>    </span><span class=p>}));</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a><span class=w>    </span><span class=c1>// Update node session count</span>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>nodeKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sb>`node:</span><span class=si>${</span><span class=nx>nodeId</span><span class=si>}</span><span class=sb>:sessions`</span><span class=p>;</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a><span class=w>    </span><span class=nx>pipeline</span><span class=p>.</span><span class=nx>sadd</span><span class=p>(</span><span class=nx>nodeKey</span><span class=p>,</span><span class=w> </span><span class=nx>sessionToken</span><span class=p>);</span>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a><span class=w>    </span><span class=nx>pipeline</span><span class=p>.</span><span class=nx>expire</span><span class=p>(</span><span class=nx>nodeKey</span><span class=p>,</span><span class=w> </span><span class=nx>SESSION_TTL</span><span class=p>);</span>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a><span class=w>    </span><span class=c1>// Update global session registry</span>
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a><span class=w>    </span><span class=nx>pipeline</span><span class=p>.</span><span class=nx>zadd</span><span class=p>(</span><span class=s1>&#39;global:active_sessions&#39;</span><span class=p>,</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>(),</span><span class=w> </span><span class=nx>sessionToken</span><span class=p>);</span>
</span><span id=__span-20-23><a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a>
</span><span id=__span-20-24><a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>pipeline</span><span class=p>.</span><span class=nx>exec</span><span class=p>();</span>
</span><span id=__span-20-25><a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-20-26><a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a>
</span><span id=__span-20-27><a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>getSessionWithLoadBalancing</span><span class=p>(</span><span class=nx>sessionToken</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>SessionData</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kc>null</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-28><a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`session:</span><span class=si>${</span><span class=nx>sessionToken</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-20-29><a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>sessionData</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-20-30><a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a>
</span><span id=__span-20-31><a id=__codelineno-20-31 name=__codelineno-20-31 href=#__codelineno-20-31></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>parsed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>sessionData</span><span class=p>);</span>
</span><span id=__span-20-32><a id=__codelineno-20-32 name=__codelineno-20-32 href=#__codelineno-20-32></a>
</span><span id=__span-20-33><a id=__codelineno-20-33 name=__codelineno-20-33 href=#__codelineno-20-33></a><span class=w>    </span><span class=c1>// Update access patterns for load balancing</span>
</span><span id=__span-20-34><a id=__codelineno-20-34 name=__codelineno-20-34 href=#__codelineno-20-34></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>zadd</span><span class=p>(</span><span class=s1>&#39;session:access_patterns&#39;</span><span class=p>,</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>(),</span><span class=w> </span><span class=nx>sessionToken</span><span class=p>);</span>
</span><span id=__span-20-35><a id=__codelineno-20-35 name=__codelineno-20-35 href=#__codelineno-20-35></a>
</span><span id=__span-20-36><a id=__codelineno-20-36 name=__codelineno-20-36 href=#__codelineno-20-36></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>parsed</span><span class=p>;</span>
</span><span id=__span-20-37><a id=__codelineno-20-37 name=__codelineno-20-37 href=#__codelineno-20-37></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-20-38><a id=__codelineno-20-38 name=__codelineno-20-38 href=#__codelineno-20-38></a>
</span><span id=__span-20-39><a id=__codelineno-20-39 name=__codelineno-20-39 href=#__codelineno-20-39></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>redistributeSessions</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-40><a id=__codelineno-20-40 name=__codelineno-20-40 href=#__codelineno-20-40></a><span class=w>    </span><span class=c1>// Get all active nodes</span>
</span><span id=__span-20-41><a id=__codelineno-20-41 name=__codelineno-20-41 href=#__codelineno-20-41></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>nodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=s1>&#39;node:*:sessions&#39;</span><span class=p>);</span>
</span><span id=__span-20-42><a id=__codelineno-20-42 name=__codelineno-20-42 href=#__codelineno-20-42></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionCounts</span><span class=o>:</span><span class=w> </span><span class=kt>Record</span><span class=o>&lt;</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=kt>number</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{};</span>
</span><span id=__span-20-43><a id=__codelineno-20-43 name=__codelineno-20-43 href=#__codelineno-20-43></a>
</span><span id=__span-20-44><a id=__codelineno-20-44 name=__codelineno-20-44 href=#__codelineno-20-44></a><span class=w>    </span><span class=c1>// Count sessions per node</span>
</span><span id=__span-20-45><a id=__codelineno-20-45 name=__codelineno-20-45 href=#__codelineno-20-45></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=nx>nodeKey</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nx>nodes</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-46><a id=__codelineno-20-46 name=__codelineno-20-46 href=#__codelineno-20-46></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>nodeId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>nodeKey</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)[</span><span class=mf>1</span><span class=p>];</span>
</span><span id=__span-20-47><a id=__codelineno-20-47 name=__codelineno-20-47 href=#__codelineno-20-47></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>scard</span><span class=p>(</span><span class=nx>nodeKey</span><span class=p>);</span>
</span><span id=__span-20-48><a id=__codelineno-20-48 name=__codelineno-20-48 href=#__codelineno-20-48></a><span class=w>      </span><span class=nx>sessionCounts</span><span class=p>[</span><span class=nx>nodeId</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>sessionCount</span><span class=p>;</span>
</span><span id=__span-20-49><a id=__codelineno-20-49 name=__codelineno-20-49 href=#__codelineno-20-49></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-50><a id=__codelineno-20-50 name=__codelineno-20-50 href=#__codelineno-20-50></a>
</span><span id=__span-20-51><a id=__codelineno-20-51 name=__codelineno-20-51 href=#__codelineno-20-51></a><span class=w>    </span><span class=c1>// Identify overloaded nodes and redistribute</span>
</span><span id=__span-20-52><a id=__codelineno-20-52 name=__codelineno-20-52 href=#__codelineno-20-52></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>avgSessions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Object</span><span class=p>.</span><span class=nx>values</span><span class=p>(</span><span class=nx>sessionCounts</span><span class=p>).</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>a</span><span class=p>,</span><span class=w> </span><span class=nx>b</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>b</span><span class=p>,</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=nx>nodes</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span><span id=__span-20-53><a id=__codelineno-20-53 name=__codelineno-20-53 href=#__codelineno-20-53></a>
</span><span id=__span-20-54><a id=__codelineno-20-54 name=__codelineno-20-54 href=#__codelineno-20-54></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>nodeId</span><span class=p>,</span><span class=w> </span><span class=nx>count</span><span class=p>]</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nb>Object</span><span class=p>.</span><span class=nx>entries</span><span class=p>(</span><span class=nx>sessionCounts</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-55><a id=__codelineno-20-55 name=__codelineno-20-55 href=#__codelineno-20-55></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>count</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=nx>avgSessions</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1.5</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-56><a id=__codelineno-20-56 name=__codelineno-20-56 href=#__codelineno-20-56></a><span class=w>        </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redistributeNodeSessions</span><span class=p>(</span><span class=nx>nodeId</span><span class=p>,</span><span class=w> </span><span class=nx>count</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nx>avgSessions</span><span class=p>));</span>
</span><span id=__span-20-57><a id=__codelineno-20-57 name=__codelineno-20-57 href=#__codelineno-20-57></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-20-58><a id=__codelineno-20-58 name=__codelineno-20-58 href=#__codelineno-20-58></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-59><a id=__codelineno-20-59 name=__codelineno-20-59 href=#__codelineno-20-59></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-20-60><a id=__codelineno-20-60 name=__codelineno-20-60 href=#__codelineno-20-60></a>
</span><span id=__span-20-61><a id=__codelineno-20-61 name=__codelineno-20-61 href=#__codelineno-20-61></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>redistributeNodeSessions</span><span class=p>(</span><span class=nx>overloadedNodeId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>sessionsToMove</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-62><a id=__codelineno-20-62 name=__codelineno-20-62 href=#__codelineno-20-62></a><span class=w>    </span><span class=c1>// Implementation for moving sessions to less loaded nodes</span>
</span><span id=__span-20-63><a id=__codelineno-20-63 name=__codelineno-20-63 href=#__codelineno-20-63></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionsToRedistribute</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>srandmember</span><span class=p>(</span>
</span><span id=__span-20-64><a id=__codelineno-20-64 name=__codelineno-20-64 href=#__codelineno-20-64></a><span class=w>      </span><span class=sb>`node:</span><span class=si>${</span><span class=nx>overloadedNodeId</span><span class=si>}</span><span class=sb>:sessions`</span><span class=p>,</span>
</span><span id=__span-20-65><a id=__codelineno-20-65 name=__codelineno-20-65 href=#__codelineno-20-65></a><span class=w>      </span><span class=nx>sessionsToMove</span>
</span><span id=__span-20-66><a id=__codelineno-20-66 name=__codelineno-20-66 href=#__codelineno-20-66></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-20-67><a id=__codelineno-20-67 name=__codelineno-20-67 href=#__codelineno-20-67></a>
</span><span id=__span-20-68><a id=__codelineno-20-68 name=__codelineno-20-68 href=#__codelineno-20-68></a><span class=w>    </span><span class=c1>// Find least loaded node</span>
</span><span id=__span-20-69><a id=__codelineno-20-69 name=__codelineno-20-69 href=#__codelineno-20-69></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>targetNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>findLeastLoadedNode</span><span class=p>();</span>
</span><span id=__span-20-70><a id=__codelineno-20-70 name=__codelineno-20-70 href=#__codelineno-20-70></a>
</span><span id=__span-20-71><a id=__codelineno-20-71 name=__codelineno-20-71 href=#__codelineno-20-71></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=nx>sessionToken</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nx>sessionsToRedistribute</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-72><a id=__codelineno-20-72 name=__codelineno-20-72 href=#__codelineno-20-72></a><span class=w>      </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>moveSession</span><span class=p>(</span><span class=nx>sessionToken</span><span class=p>,</span><span class=w> </span><span class=nx>overloadedNodeId</span><span class=p>,</span><span class=w> </span><span class=nx>targetNode</span><span class=p>);</span>
</span><span id=__span-20-73><a id=__codelineno-20-73 name=__codelineno-20-73 href=#__codelineno-20-73></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-74><a id=__codelineno-20-74 name=__codelineno-20-74 href=#__codelineno-20-74></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-20-75><a id=__codelineno-20-75 name=__codelineno-20-75 href=#__codelineno-20-75></a><span class=p>}</span>
</span></code></pre></div><h3 id=112-horizontal-scaling-architecture>11.2 Horizontal Scaling Architecture<a class=headerlink href=#112-horizontal-scaling-architecture title="Permanent link">&para;</a></h3><h4 id=api-gateway-pattern>API Gateway Pattern<a class=headerlink href=#api-gateway-pattern title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1>// lib/gateway/auth-gateway.ts</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>AuthenticationGateway</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>nodes</span><span class=o>:</span><span class=w> </span><span class=kt>Array</span><span class=o>&lt;</span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w> </span><span class=nx>url</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w> </span><span class=nx>weight</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=w> </span><span class=p>}</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[];</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>healthCheck</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Map</span><span class=o>&lt;</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>routeAuthRequest</span><span class=p>(</span><span class=nx>request</span><span class=o>:</span><span class=w> </span><span class=kt>AuthRequest</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>AuthResponse</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=w>    </span><span class=c1>// Select optimal node based on load and health</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>selectedNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>selectOptimalNode</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=kr>type</span><span class=p>);</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>selectedNode</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;No healthy authentication nodes available&#39;</span><span class=p>);</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>      </span><span class=c1>// Forward request to selected node</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>forwardRequest</span><span class=p>(</span><span class=nx>selectedNode</span><span class=p>,</span><span class=w> </span><span class=nx>request</span><span class=p>);</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=w>      </span><span class=c1>// Update node health status</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>healthCheck</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>selectedNode</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>response</span><span class=p>;</span>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-23><a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a><span class=w>      </span><span class=c1>// Mark node as unhealthy and retry</span>
</span><span id=__span-21-24><a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>healthCheck</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>selectedNode</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-21-25><a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a>
</span><span id=__span-21-26><a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>fallbackNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>selectFallbackNode</span><span class=p>(</span><span class=nx>selectedNode</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span><span id=__span-21-27><a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>fallbackNode</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-28><a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>forwardRequest</span><span class=p>(</span><span class=nx>fallbackNode</span><span class=p>,</span><span class=w> </span><span class=nx>request</span><span class=p>);</span>
</span><span id=__span-21-29><a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-21-30><a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a>
</span><span id=__span-21-31><a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=nx>error</span><span class=p>;</span>
</span><span id=__span-21-32><a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-33><a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-21-34><a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a>
</span><span id=__span-21-35><a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>selectOptimalNode</span><span class=p>(</span><span class=nx>requestType</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>AuthNode</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kc>null</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-36><a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a><span class=w>    </span><span class=c1>// Implement weighted round-robin with health checks</span>
</span><span id=__span-21-37><a id=__codelineno-21-37 name=__codelineno-21-37 href=#__codelineno-21-37></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>healthyNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>nodes</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>node</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span>
</span><span id=__span-21-38><a id=__codelineno-21-38 name=__codelineno-21-38 href=#__codelineno-21-38></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>healthCheck</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=kc>false</span>
</span><span id=__span-21-39><a id=__codelineno-21-39 name=__codelineno-21-39 href=#__codelineno-21-39></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-21-40><a id=__codelineno-21-40 name=__codelineno-21-40 href=#__codelineno-21-40></a>
</span><span id=__span-21-41><a id=__codelineno-21-41 name=__codelineno-21-41 href=#__codelineno-21-41></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>healthyNodes</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-21-42><a id=__codelineno-21-42 name=__codelineno-21-42 href=#__codelineno-21-42></a>
</span><span id=__span-21-43><a id=__codelineno-21-43 name=__codelineno-21-43 href=#__codelineno-21-43></a><span class=w>    </span><span class=c1>// For auth-heavy operations, prefer nodes with auth specialization</span>
</span><span id=__span-21-44><a id=__codelineno-21-44 name=__codelineno-21-44 href=#__codelineno-21-44></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>requestType</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;plex-oauth&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-45><a id=__codelineno-21-45 name=__codelineno-21-45 href=#__codelineno-21-45></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>plexSpecializedNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>healthyNodes</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>node</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span>
</span><span id=__span-21-46><a id=__codelineno-21-46 name=__codelineno-21-46 href=#__codelineno-21-46></a><span class=w>        </span><span class=nx>node</span><span class=p>.</span><span class=nx>capabilities</span><span class=o>?</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;plex-oauth&#39;</span><span class=p>)</span>
</span><span id=__span-21-47><a id=__codelineno-21-47 name=__codelineno-21-47 href=#__codelineno-21-47></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-21-48><a id=__codelineno-21-48 name=__codelineno-21-48 href=#__codelineno-21-48></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>plexSpecializedNodes</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-49><a id=__codelineno-21-49 name=__codelineno-21-49 href=#__codelineno-21-49></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>weightedSelection</span><span class=p>(</span><span class=nx>plexSpecializedNodes</span><span class=p>);</span>
</span><span id=__span-21-50><a id=__codelineno-21-50 name=__codelineno-21-50 href=#__codelineno-21-50></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-21-51><a id=__codelineno-21-51 name=__codelineno-21-51 href=#__codelineno-21-51></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-52><a id=__codelineno-21-52 name=__codelineno-21-52 href=#__codelineno-21-52></a>
</span><span id=__span-21-53><a id=__codelineno-21-53 name=__codelineno-21-53 href=#__codelineno-21-53></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>weightedSelection</span><span class=p>(</span><span class=nx>healthyNodes</span><span class=p>);</span>
</span><span id=__span-21-54><a id=__codelineno-21-54 name=__codelineno-21-54 href=#__codelineno-21-54></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-21-55><a id=__codelineno-21-55 name=__codelineno-21-55 href=#__codelineno-21-55></a>
</span><span id=__span-21-56><a id=__codelineno-21-56 name=__codelineno-21-56 href=#__codelineno-21-56></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>performHealthChecks</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-57><a id=__codelineno-21-57 name=__codelineno-21-57 href=#__codelineno-21-57></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>healthPromises</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>nodes</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=nx>node</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-58><a id=__codelineno-21-58 name=__codelineno-21-58 href=#__codelineno-21-58></a><span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-59><a id=__codelineno-21-59 name=__codelineno-21-59 href=#__codelineno-21-59></a><span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>fetch</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>node</span><span class=p>.</span><span class=nx>url</span><span class=si>}</span><span class=sb>/health`</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span>
</span><span id=__span-21-60><a id=__codelineno-21-60 name=__codelineno-21-60 href=#__codelineno-21-60></a><span class=w>          </span><span class=nx>timeout</span><span class=o>:</span><span class=w> </span><span class=kt>5000</span><span class=w> </span>
</span><span id=__span-21-61><a id=__codelineno-21-61 name=__codelineno-21-61 href=#__codelineno-21-61></a><span class=w>        </span><span class=p>});</span>
</span><span id=__span-21-62><a id=__codelineno-21-62 name=__codelineno-21-62 href=#__codelineno-21-62></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>healthCheck</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=nx>response</span><span class=p>.</span><span class=nx>ok</span><span class=p>);</span>
</span><span id=__span-21-63><a id=__codelineno-21-63 name=__codelineno-21-63 href=#__codelineno-21-63></a><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-64><a id=__codelineno-21-64 name=__codelineno-21-64 href=#__codelineno-21-64></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>healthCheck</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-21-65><a id=__codelineno-21-65 name=__codelineno-21-65 href=#__codelineno-21-65></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-21-66><a id=__codelineno-21-66 name=__codelineno-21-66 href=#__codelineno-21-66></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-21-67><a id=__codelineno-21-67 name=__codelineno-21-67 href=#__codelineno-21-67></a>
</span><span id=__span-21-68><a id=__codelineno-21-68 name=__codelineno-21-68 href=#__codelineno-21-68></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nb>Promise</span><span class=p>.</span><span class=nx>allSettled</span><span class=p>(</span><span class=nx>healthPromises</span><span class=p>);</span>
</span><span id=__span-21-69><a id=__codelineno-21-69 name=__codelineno-21-69 href=#__codelineno-21-69></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-21-70><a id=__codelineno-21-70 name=__codelineno-21-70 href=#__codelineno-21-70></a><span class=p>}</span>
</span></code></pre></div><h2 id=12-integration-patterns>12. Integration Patterns<a class=headerlink href=#12-integration-patterns title="Permanent link">&para;</a></h2><h3 id=121-multi-provider-oauth-architecture>12.1 Multi-Provider OAuth Architecture<a class=headerlink href=#121-multi-provider-oauth-architecture title="Permanent link">&para;</a></h3><h4 id=oauth-provider-registry>OAuth Provider Registry<a class=headerlink href=#oauth-provider-registry title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=c1>// lib/auth/oauth-registry.ts</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>OAuthProviderRegistry</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>providers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Map</span><span class=o>&lt;</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>OAuthProviderConfig</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=w>  </span><span class=nx>registerProvider</span><span class=p>(</span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=o>:</span><span class=w> </span><span class=kt>OAuthProviderConfig</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=ow>void</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=w>      </span><span class=p>...</span><span class=nx>config</span><span class=p>,</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=w>      </span><span class=nx>enabled</span><span class=o>:</span><span class=w> </span><span class=kt>config.enabled</span><span class=w> </span><span class=o>??</span><span class=w> </span><span class=kc>true</span><span class=p>,</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=w>      </span><span class=nx>priority</span><span class=o>:</span><span class=w> </span><span class=kt>config.priority</span><span class=w> </span><span class=o>??</span><span class=w> </span><span class=mf>0</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>authenticateWithProvider</span><span class=p>(</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=w>    </span><span class=nx>provider</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a><span class=w>    </span><span class=nx>credentials</span><span class=o>:</span><span class=w> </span><span class=kt>any</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=w>  </span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>AuthResult</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>providerConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>provider</span><span class=p>);</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>providerConfig</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=nx>providerConfig</span><span class=p>.</span><span class=nx>enabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=sb>`Provider </span><span class=si>${</span><span class=nx>provider</span><span class=si>}</span><span class=sb> not available`</span><span class=p>);</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>authHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>getProviderHandler</span><span class=p>(</span><span class=nx>provider</span><span class=p>);</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23 href=#__codelineno-22-23></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>authHandler</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=nx>credentials</span><span class=p>);</span>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24 href=#__codelineno-22-24></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25 href=#__codelineno-22-25></a>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26 href=#__codelineno-22-26></a><span class=w>  </span><span class=nx>getAvailableProviders</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Array</span><span class=o>&lt;</span><span class=p>{</span><span class=w> </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w> </span><span class=nx>displayName</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span><span class=w> </span><span class=nx>icon</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>}</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27 href=#__codelineno-22-27></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Array</span><span class=p>.</span><span class=kr>from</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>providers</span><span class=p>.</span><span class=nx>entries</span><span class=p>())</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28 href=#__codelineno-22-28></a><span class=w>      </span><span class=p>.</span><span class=nx>filter</span><span class=p>(([,</span><span class=w> </span><span class=nx>config</span><span class=p>])</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>enabled</span><span class=p>)</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29 href=#__codelineno-22-29></a><span class=w>      </span><span class=p>.</span><span class=nx>sort</span><span class=p>(([,</span><span class=w> </span><span class=nx>a</span><span class=p>],</span><span class=w> </span><span class=p>[,</span><span class=w> </span><span class=nx>b</span><span class=p>])</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>b</span><span class=p>.</span><span class=nx>priority</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>a</span><span class=p>.</span><span class=nx>priority</span><span class=p>)</span>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30 href=#__codelineno-22-30></a><span class=w>      </span><span class=p>.</span><span class=nx>map</span><span class=p>(([</span><span class=nx>name</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=p>])</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>({</span>
</span><span id=__span-22-31><a id=__codelineno-22-31 name=__codelineno-22-31 href=#__codelineno-22-31></a><span class=w>        </span><span class=nx>name</span><span class=p>,</span>
</span><span id=__span-22-32><a id=__codelineno-22-32 name=__codelineno-22-32 href=#__codelineno-22-32></a><span class=w>        </span><span class=nx>displayName</span><span class=o>:</span><span class=w> </span><span class=kt>config.displayName</span><span class=p>,</span>
</span><span id=__span-22-33><a id=__codelineno-22-33 name=__codelineno-22-33 href=#__codelineno-22-33></a><span class=w>        </span><span class=nx>icon</span><span class=o>:</span><span class=w> </span><span class=kt>config.icon</span>
</span><span id=__span-22-34><a id=__codelineno-22-34 name=__codelineno-22-34 href=#__codelineno-22-34></a><span class=w>      </span><span class=p>}));</span>
</span><span id=__span-22-35><a id=__codelineno-22-35 name=__codelineno-22-35 href=#__codelineno-22-35></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-22-36><a id=__codelineno-22-36 name=__codelineno-22-36 href=#__codelineno-22-36></a>
</span><span id=__span-22-37><a id=__codelineno-22-37 name=__codelineno-22-37 href=#__codelineno-22-37></a><span class=w>  </span><span class=c1>// Provider-specific handlers</span>
</span><span id=__span-22-38><a id=__codelineno-22-38 name=__codelineno-22-38 href=#__codelineno-22-38></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>getProviderHandler</span><span class=p>(</span><span class=nx>provider</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nx>AuthProviderHandler</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-39><a id=__codelineno-22-39 name=__codelineno-22-39 href=#__codelineno-22-39></a><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=nx>provider</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-40><a id=__codelineno-22-40 name=__codelineno-22-40 href=#__codelineno-22-40></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=s1>&#39;plex&#39;</span><span class=o>:</span>
</span><span id=__span-22-41><a id=__codelineno-22-41 name=__codelineno-22-41 href=#__codelineno-22-41></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PlexOAuthHandler</span><span class=p>();</span>
</span><span id=__span-22-42><a id=__codelineno-22-42 name=__codelineno-22-42 href=#__codelineno-22-42></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=s1>&#39;github&#39;</span><span class=o>:</span>
</span><span id=__span-22-43><a id=__codelineno-22-43 name=__codelineno-22-43 href=#__codelineno-22-43></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>GitHubOAuthHandler</span><span class=p>();</span>
</span><span id=__span-22-44><a id=__codelineno-22-44 name=__codelineno-22-44 href=#__codelineno-22-44></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=s1>&#39;google&#39;</span><span class=o>:</span>
</span><span id=__span-22-45><a id=__codelineno-22-45 name=__codelineno-22-45 href=#__codelineno-22-45></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>GoogleOAuthHandler</span><span class=p>();</span>
</span><span id=__span-22-46><a id=__codelineno-22-46 name=__codelineno-22-46 href=#__codelineno-22-46></a><span class=w>      </span><span class=nx>default</span><span class=o>:</span>
</span><span id=__span-22-47><a id=__codelineno-22-47 name=__codelineno-22-47 href=#__codelineno-22-47></a><span class=w>        </span><span class=kt>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=sb>`Unsupported provider: </span><span class=si>${</span><span class=nx>provider</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-22-48><a id=__codelineno-22-48 name=__codelineno-22-48 href=#__codelineno-22-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-22-49><a id=__codelineno-22-49 name=__codelineno-22-49 href=#__codelineno-22-49></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-22-50><a id=__codelineno-22-50 name=__codelineno-22-50 href=#__codelineno-22-50></a><span class=p>}</span>
</span><span id=__span-22-51><a id=__codelineno-22-51 name=__codelineno-22-51 href=#__codelineno-22-51></a>
</span><span id=__span-22-52><a id=__codelineno-22-52 name=__codelineno-22-52 href=#__codelineno-22-52></a><span class=c1>// Initialize providers</span>
</span><span id=__span-22-53><a id=__codelineno-22-53 name=__codelineno-22-53 href=#__codelineno-22-53></a><span class=kd>const</span><span class=w> </span><span class=nx>oauthRegistry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>OAuthProviderRegistry</span><span class=p>();</span>
</span><span id=__span-22-54><a id=__codelineno-22-54 name=__codelineno-22-54 href=#__codelineno-22-54></a>
</span><span id=__span-22-55><a id=__codelineno-22-55 name=__codelineno-22-55 href=#__codelineno-22-55></a><span class=nx>oauthRegistry</span><span class=p>.</span><span class=nx>registerProvider</span><span class=p>(</span><span class=s1>&#39;plex&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-56><a id=__codelineno-22-56 name=__codelineno-22-56 href=#__codelineno-22-56></a><span class=w>  </span><span class=nx>displayName</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Plex&#39;</span><span class=p>,</span>
</span><span id=__span-22-57><a id=__codelineno-22-57 name=__codelineno-22-57 href=#__codelineno-22-57></a><span class=w>  </span><span class=nx>icon</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;plex-icon&#39;</span><span class=p>,</span>
</span><span id=__span-22-58><a id=__codelineno-22-58 name=__codelineno-22-58 href=#__codelineno-22-58></a><span class=w>  </span><span class=nx>priority</span><span class=o>:</span><span class=w> </span><span class=kt>100</span><span class=p>,</span>
</span><span id=__span-22-59><a id=__codelineno-22-59 name=__codelineno-22-59 href=#__codelineno-22-59></a><span class=w>  </span><span class=nx>enabled</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-22-60><a id=__codelineno-22-60 name=__codelineno-22-60 href=#__codelineno-22-60></a><span class=w>  </span><span class=nx>clientId</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.AUTH_PLEX_CLIENT_ID</span><span class=o>!</span><span class=p>,</span>
</span><span id=__span-22-61><a id=__codelineno-22-61 name=__codelineno-22-61 href=#__codelineno-22-61></a><span class=w>  </span><span class=nx>clientSecret</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.AUTH_PLEX_CLIENT_SECRET</span><span class=o>!</span>
</span><span id=__span-22-62><a id=__codelineno-22-62 name=__codelineno-22-62 href=#__codelineno-22-62></a><span class=p>});</span>
</span><span id=__span-22-63><a id=__codelineno-22-63 name=__codelineno-22-63 href=#__codelineno-22-63></a>
</span><span id=__span-22-64><a id=__codelineno-22-64 name=__codelineno-22-64 href=#__codelineno-22-64></a><span class=nx>oauthRegistry</span><span class=p>.</span><span class=nx>registerProvider</span><span class=p>(</span><span class=s1>&#39;github&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-65><a id=__codelineno-22-65 name=__codelineno-22-65 href=#__codelineno-22-65></a><span class=w>  </span><span class=nx>displayName</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;GitHub&#39;</span><span class=p>,</span>
</span><span id=__span-22-66><a id=__codelineno-22-66 name=__codelineno-22-66 href=#__codelineno-22-66></a><span class=w>  </span><span class=nx>icon</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;github-icon&#39;</span><span class=p>,</span>
</span><span id=__span-22-67><a id=__codelineno-22-67 name=__codelineno-22-67 href=#__codelineno-22-67></a><span class=w>  </span><span class=nx>priority</span><span class=o>:</span><span class=w> </span><span class=kt>50</span><span class=p>,</span>
</span><span id=__span-22-68><a id=__codelineno-22-68 name=__codelineno-22-68 href=#__codelineno-22-68></a><span class=w>  </span><span class=nx>enabled</span><span class=o>:</span><span class=w> </span><span class=o>!!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>AUTH_GITHUB_CLIENT_ID</span><span class=p>,</span>
</span><span id=__span-22-69><a id=__codelineno-22-69 name=__codelineno-22-69 href=#__codelineno-22-69></a><span class=w>  </span><span class=nx>clientId</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.AUTH_GITHUB_CLIENT_ID</span><span class=o>!</span><span class=p>,</span>
</span><span id=__span-22-70><a id=__codelineno-22-70 name=__codelineno-22-70 href=#__codelineno-22-70></a><span class=w>  </span><span class=nx>clientSecret</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.AUTH_GITHUB_CLIENT_SECRET</span><span class=o>!</span>
</span><span id=__span-22-71><a id=__codelineno-22-71 name=__codelineno-22-71 href=#__codelineno-22-71></a><span class=p>});</span>
</span></code></pre></div><h3 id=122-audit-trail-implementation>12.2 Audit Trail Implementation<a class=headerlink href=#122-audit-trail-implementation title="Permanent link">&para;</a></h3><h4 id=comprehensive-audit-logging>Comprehensive Audit Logging<a class=headerlink href=#comprehensive-audit-logging title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=c1>// lib/audit/audit-logger.ts</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>AuditLogger</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getRedisClient</span><span class=p>();</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>logAuthEvent</span><span class=p>(</span><span class=nx>event</span><span class=o>:</span><span class=w> </span><span class=kt>AuthAuditEvent</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=ow>void</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>auditEntry</span><span class=o>:</span><span class=w> </span><span class=kt>AuditEntry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>crypto.randomUUID</span><span class=p>(),</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=w>      </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=w>      </span><span class=nx>eventType</span><span class=o>:</span><span class=w> </span><span class=kt>event.type</span><span class=p>,</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=w>      </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>event.userId</span><span class=p>,</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=w>      </span><span class=nx>sessionId</span><span class=o>:</span><span class=w> </span><span class=kt>event.sessionId</span><span class=p>,</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=w>      </span><span class=nx>ipAddress</span><span class=o>:</span><span class=w> </span><span class=kt>event.ipAddress</span><span class=p>,</span>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=w>      </span><span class=nx>userAgent</span><span class=o>:</span><span class=w> </span><span class=kt>event.userAgent</span><span class=p>,</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=w>      </span><span class=nx>details</span><span class=o>:</span><span class=w> </span><span class=kt>event.details</span><span class=p>,</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=w>      </span><span class=nx>success</span><span class=o>:</span><span class=w> </span><span class=kt>event.success</span><span class=p>,</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=w>      </span><span class=nx>risk_score</span><span class=o>:</span><span class=w> </span><span class=kt>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>calculateRiskScore</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=w>    </span><span class=c1>// Store in both Redis (for recent events) and database (for long-term storage)</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>([</span>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>storeInRedis</span><span class=p>(</span><span class=nx>auditEntry</span><span class=p>),</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>storeInDatabase</span><span class=p>(</span><span class=nx>auditEntry</span><span class=p>)</span>
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23 href=#__codelineno-23-23></a><span class=w>    </span><span class=p>]);</span>
</span><span id=__span-23-24><a id=__codelineno-23-24 name=__codelineno-23-24 href=#__codelineno-23-24></a>
</span><span id=__span-23-25><a id=__codelineno-23-25 name=__codelineno-23-25 href=#__codelineno-23-25></a><span class=w>    </span><span class=c1>// Check for suspicious patterns</span>
</span><span id=__span-23-26><a id=__codelineno-23-26 name=__codelineno-23-26 href=#__codelineno-23-26></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>checkSuspiciousActivity</span><span class=p>(</span><span class=nx>auditEntry</span><span class=p>);</span>
</span><span id=__span-23-27><a id=__codelineno-23-27 name=__codelineno-23-27 href=#__codelineno-23-27></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-23-28><a id=__codelineno-23-28 name=__codelineno-23-28 href=#__codelineno-23-28></a>
</span><span id=__span-23-29><a id=__codelineno-23-29 name=__codelineno-23-29 href=#__codelineno-23-29></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>calculateRiskScore</span><span class=p>(</span><span class=nx>event</span><span class=o>:</span><span class=w> </span><span class=kt>AuthAuditEvent</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>number</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-30><a id=__codelineno-23-30 name=__codelineno-23-30 href=#__codelineno-23-30></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>riskScore</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span>
</span><span id=__span-23-31><a id=__codelineno-23-31 name=__codelineno-23-31 href=#__codelineno-23-31></a>
</span><span id=__span-23-32><a id=__codelineno-23-32 name=__codelineno-23-32 href=#__codelineno-23-32></a><span class=w>    </span><span class=c1>// Failed authentication attempts</span>
</span><span id=__span-23-33><a id=__codelineno-23-33 name=__codelineno-23-33 href=#__codelineno-23-33></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>event</span><span class=p>.</span><span class=nx>success</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-34><a id=__codelineno-23-34 name=__codelineno-23-34 href=#__codelineno-23-34></a><span class=w>      </span><span class=nx>riskScore</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mf>10</span><span class=p>;</span>
</span><span id=__span-23-35><a id=__codelineno-23-35 name=__codelineno-23-35 href=#__codelineno-23-35></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-36><a id=__codelineno-23-36 name=__codelineno-23-36 href=#__codelineno-23-36></a>
</span><span id=__span-23-37><a id=__codelineno-23-37 name=__codelineno-23-37 href=#__codelineno-23-37></a><span class=w>    </span><span class=c1>// Multiple IPs for same user</span>
</span><span id=__span-23-38><a id=__codelineno-23-38 name=__codelineno-23-38 href=#__codelineno-23-38></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>userIPs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>smembers</span><span class=p>(</span><span class=sb>`user_ips:</span><span class=si>${</span><span class=nx>event</span><span class=p>.</span><span class=nx>userId</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-23-39><a id=__codelineno-23-39 name=__codelineno-23-39 href=#__codelineno-23-39></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>userIPs</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>3</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-40><a id=__codelineno-23-40 name=__codelineno-23-40 href=#__codelineno-23-40></a><span class=w>      </span><span class=nx>riskScore</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mf>20</span><span class=p>;</span>
</span><span id=__span-23-41><a id=__codelineno-23-41 name=__codelineno-23-41 href=#__codelineno-23-41></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-42><a id=__codelineno-23-42 name=__codelineno-23-42 href=#__codelineno-23-42></a>
</span><span id=__span-23-43><a id=__codelineno-23-43 name=__codelineno-23-43 href=#__codelineno-23-43></a><span class=w>    </span><span class=c1>// Unusual time patterns</span>
</span><span id=__span-23-44><a id=__codelineno-23-44 name=__codelineno-23-44 href=#__codelineno-23-44></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>hour</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>getHours</span><span class=p>();</span>
</span><span id=__span-23-45><a id=__codelineno-23-45 name=__codelineno-23-45 href=#__codelineno-23-45></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>hour</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mf>6</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>hour</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>23</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-46><a id=__codelineno-23-46 name=__codelineno-23-46 href=#__codelineno-23-46></a><span class=w>      </span><span class=nx>riskScore</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mf>5</span><span class=p>;</span>
</span><span id=__span-23-47><a id=__codelineno-23-47 name=__codelineno-23-47 href=#__codelineno-23-47></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-48><a id=__codelineno-23-48 name=__codelineno-23-48 href=#__codelineno-23-48></a>
</span><span id=__span-23-49><a id=__codelineno-23-49 name=__codelineno-23-49 href=#__codelineno-23-49></a><span class=w>    </span><span class=c1>// Geographic anomalies (if IP geolocation available)</span>
</span><span id=__span-23-50><a id=__codelineno-23-50 name=__codelineno-23-50 href=#__codelineno-23-50></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>previousLocation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`user_location:</span><span class=si>${</span><span class=nx>event</span><span class=p>.</span><span class=nx>userId</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-23-51><a id=__codelineno-23-51 name=__codelineno-23-51 href=#__codelineno-23-51></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>previousLocation</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>location</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>
</span><span id=__span-23-52><a id=__codelineno-23-52 name=__codelineno-23-52 href=#__codelineno-23-52></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=nx>calculateDistance</span><span class=p>(</span><span class=nx>previousLocation</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>location</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>1000</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-53><a id=__codelineno-23-53 name=__codelineno-23-53 href=#__codelineno-23-53></a><span class=w>      </span><span class=nx>riskScore</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mf>15</span><span class=p>;</span>
</span><span id=__span-23-54><a id=__codelineno-23-54 name=__codelineno-23-54 href=#__codelineno-23-54></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-55><a id=__codelineno-23-55 name=__codelineno-23-55 href=#__codelineno-23-55></a>
</span><span id=__span-23-56><a id=__codelineno-23-56 name=__codelineno-23-56 href=#__codelineno-23-56></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>riskScore</span><span class=p>,</span><span class=w> </span><span class=mf>100</span><span class=p>);</span>
</span><span id=__span-23-57><a id=__codelineno-23-57 name=__codelineno-23-57 href=#__codelineno-23-57></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-23-58><a id=__codelineno-23-58 name=__codelineno-23-58 href=#__codelineno-23-58></a>
</span><span id=__span-23-59><a id=__codelineno-23-59 name=__codelineno-23-59 href=#__codelineno-23-59></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>getAuditTrail</span><span class=p>(</span>
</span><span id=__span-23-60><a id=__codelineno-23-60 name=__codelineno-23-60 href=#__codelineno-23-60></a><span class=w>    </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-23-61><a id=__codelineno-23-61 name=__codelineno-23-61 href=#__codelineno-23-61></a><span class=w>    </span><span class=nx>options</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>limit?</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>;</span><span class=w> </span><span class=nx>startDate?</span><span class=o>:</span><span class=w> </span><span class=kt>Date</span><span class=p>;</span><span class=w> </span><span class=nx>endDate?</span><span class=o>:</span><span class=w> </span><span class=kt>Date</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-23-62><a id=__codelineno-23-62 name=__codelineno-23-62 href=#__codelineno-23-62></a><span class=w>  </span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>AuditEntry</span><span class=p>[]</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-63><a id=__codelineno-23-63 name=__codelineno-23-63 href=#__codelineno-23-63></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>auditEntry</span><span class=p>.</span><span class=nx>findMany</span><span class=p>({</span>
</span><span id=__span-23-64><a id=__codelineno-23-64 name=__codelineno-23-64 href=#__codelineno-23-64></a><span class=w>      </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-65><a id=__codelineno-23-65 name=__codelineno-23-65 href=#__codelineno-23-65></a><span class=w>        </span><span class=nx>userId</span><span class=p>,</span>
</span><span id=__span-23-66><a id=__codelineno-23-66 name=__codelineno-23-66 href=#__codelineno-23-66></a><span class=w>        </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-67><a id=__codelineno-23-67 name=__codelineno-23-67 href=#__codelineno-23-67></a><span class=w>          </span><span class=nx>gte</span><span class=o>:</span><span class=w> </span><span class=kt>options.startDate</span><span class=p>,</span>
</span><span id=__span-23-68><a id=__codelineno-23-68 name=__codelineno-23-68 href=#__codelineno-23-68></a><span class=w>          </span><span class=nx>lte</span><span class=o>:</span><span class=w> </span><span class=kt>options.endDate</span>
</span><span id=__span-23-69><a id=__codelineno-23-69 name=__codelineno-23-69 href=#__codelineno-23-69></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-23-70><a id=__codelineno-23-70 name=__codelineno-23-70 href=#__codelineno-23-70></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-23-71><a id=__codelineno-23-71 name=__codelineno-23-71 href=#__codelineno-23-71></a><span class=w>      </span><span class=nx>orderBy</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;desc&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-23-72><a id=__codelineno-23-72 name=__codelineno-23-72 href=#__codelineno-23-72></a><span class=w>      </span><span class=nx>take</span><span class=o>:</span><span class=w> </span><span class=kt>options.limit</span><span class=w> </span><span class=o>??</span><span class=w> </span><span class=mf>50</span>
</span><span id=__span-23-73><a id=__codelineno-23-73 name=__codelineno-23-73 href=#__codelineno-23-73></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-23-74><a id=__codelineno-23-74 name=__codelineno-23-74 href=#__codelineno-23-74></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-23-75><a id=__codelineno-23-75 name=__codelineno-23-75 href=#__codelineno-23-75></a>
</span><span id=__span-23-76><a id=__codelineno-23-76 name=__codelineno-23-76 href=#__codelineno-23-76></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>detectAnomalies</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>SecurityAnomaly</span><span class=p>[]</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-77><a id=__codelineno-23-77 name=__codelineno-23-77 href=#__codelineno-23-77></a><span class=w>    </span><span class=c1>// Implement ML-based anomaly detection</span>
</span><span id=__span-23-78><a id=__codelineno-23-78 name=__codelineno-23-78 href=#__codelineno-23-78></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>anomalies</span><span class=o>:</span><span class=w> </span><span class=kt>SecurityAnomaly</span><span class=p>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[];</span>
</span><span id=__span-23-79><a id=__codelineno-23-79 name=__codelineno-23-79 href=#__codelineno-23-79></a>
</span><span id=__span-23-80><a id=__codelineno-23-80 name=__codelineno-23-80 href=#__codelineno-23-80></a><span class=w>    </span><span class=c1>// Check for brute force patterns</span>
</span><span id=__span-23-81><a id=__codelineno-23-81 name=__codelineno-23-81 href=#__codelineno-23-81></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>recentFailures</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>hgetall</span><span class=p>(</span><span class=s1>&#39;auth_failures&#39;</span><span class=p>);</span>
</span><span id=__span-23-82><a id=__codelineno-23-82 name=__codelineno-23-82 href=#__codelineno-23-82></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>ip</span><span class=p>,</span><span class=w> </span><span class=nx>failures</span><span class=p>]</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nb>Object</span><span class=p>.</span><span class=nx>entries</span><span class=p>(</span><span class=nx>recentFailures</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-83><a id=__codelineno-23-83 name=__codelineno-23-83 href=#__codelineno-23-83></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nb>parseInt</span><span class=p>(</span><span class=nx>failures</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>10</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-84><a id=__codelineno-23-84 name=__codelineno-23-84 href=#__codelineno-23-84></a><span class=w>        </span><span class=nx>anomalies</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span><span id=__span-23-85><a id=__codelineno-23-85 name=__codelineno-23-85 href=#__codelineno-23-85></a><span class=w>          </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;brute_force&#39;</span><span class=p>,</span>
</span><span id=__span-23-86><a id=__codelineno-23-86 name=__codelineno-23-86 href=#__codelineno-23-86></a><span class=w>          </span><span class=nx>severity</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;high&#39;</span><span class=p>,</span>
</span><span id=__span-23-87><a id=__codelineno-23-87 name=__codelineno-23-87 href=#__codelineno-23-87></a><span class=w>          </span><span class=nx>details</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>ip</span><span class=p>,</span><span class=w> </span><span class=nx>failures</span><span class=o>:</span><span class=w> </span><span class=kt>parseInt</span><span class=p>(</span><span class=nx>failures</span><span class=p>)</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-23-88><a id=__codelineno-23-88 name=__codelineno-23-88 href=#__codelineno-23-88></a><span class=w>          </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>()</span>
</span><span id=__span-23-89><a id=__codelineno-23-89 name=__codelineno-23-89 href=#__codelineno-23-89></a><span class=w>        </span><span class=p>});</span>
</span><span id=__span-23-90><a id=__codelineno-23-90 name=__codelineno-23-90 href=#__codelineno-23-90></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-23-91><a id=__codelineno-23-91 name=__codelineno-23-91 href=#__codelineno-23-91></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-92><a id=__codelineno-23-92 name=__codelineno-23-92 href=#__codelineno-23-92></a>
</span><span id=__span-23-93><a id=__codelineno-23-93 name=__codelineno-23-93 href=#__codelineno-23-93></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>anomalies</span><span class=p>;</span>
</span><span id=__span-23-94><a id=__codelineno-23-94 name=__codelineno-23-94 href=#__codelineno-23-94></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-23-95><a id=__codelineno-23-95 name=__codelineno-23-95 href=#__codelineno-23-95></a><span class=p>}</span>
</span></code></pre></div><h2 id=14-testing-strategy>14. Testing Strategy<a class=headerlink href=#14-testing-strategy title="Permanent link">&para;</a></h2><h3 id=141-authentication-testing-framework>14.1 Authentication Testing Framework<a class=headerlink href=#141-authentication-testing-framework title="Permanent link">&para;</a></h3><h4 id=test-categories>Test Categories<a class=headerlink href=#test-categories title="Permanent link">&para;</a></h4><ol><li><strong>Unit Tests</strong>: Authentication service logic, token generation/validation</li><li><strong>Integration Tests</strong>: OAuth flows, session management, database operations</li><li><strong>Security Tests</strong>: Penetration testing, vulnerability scanning</li><li><strong>Performance Tests</strong>: Session load testing, concurrent authentication</li><li><strong>E2E Tests</strong>: Complete user authentication journeys</li></ol><h4 id=sample-test-implementation>Sample Test Implementation<a class=headerlink href=#sample-test-implementation title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=c1>// tests/auth/plex-oauth.test.ts</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Plex OAuth Authentication&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should complete PIN-based OAuth flow&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>authService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PlexOAuthService</span><span class=p>();</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>    </span><span class=c1>// Generate PIN</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>pin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>authService</span><span class=p>.</span><span class=nx>generatePin</span><span class=p>();</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>pin</span><span class=p>.</span><span class=nx>code</span><span class=p>).</span><span class=nx>toHaveLength</span><span class=p>(</span><span class=mf>4</span><span class=p>);</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>    </span><span class=c1>// Simulate PIN verification</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>mockPlexResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>      </span><span class=nx>authToken</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test-token&#39;</span><span class=p>,</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>      </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test@example.com&#39;</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>    </span><span class=nx>jest</span><span class=p>.</span><span class=nx>spyOn</span><span class=p>(</span><span class=nx>authService</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;verifyPin&#39;</span><span class=p>)</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=w>      </span><span class=p>.</span><span class=nx>mockResolvedValue</span><span class=p>(</span><span class=nx>mockPlexResponse</span><span class=p>);</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=w>    </span><span class=c1>// Complete authentication</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>authService</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=nx>pin</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>email</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;test@example.com&#39;</span><span class=p>);</span>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class=p>});</span>
</span></code></pre></div><h2 id=15-migration-strategy>15. Migration Strategy<a class=headerlink href=#15-migration-strategy title="Permanent link">&para;</a></h2><h3 id=151-current-state-assessment>15.1 Current State Assessment<a class=headerlink href=#151-current-state-assessment title="Permanent link">&para;</a></h3><p>Based on analysis of the existing codebase, the current implementation includes:</p><p><strong>✅ Already Implemented:</strong> - NextAuth.js 4.x integration - Plex OAuth provider with PIN flow - Redis session storage - Admin bootstrap functionality - Basic role-based access control - JWT token management</p><p><strong>🔧 Needs Enhancement:</strong> - Password reset functionality - Email verification system - 2FA/MFA implementation - Multi-provider OAuth support - Audit logging system - Enhanced rate limiting</p><h3 id=152-migration-phases>15.2 Migration Phases<a class=headerlink href=#152-migration-phases title="Permanent link">&para;</a></h3><h4 id=phase-1-core-security-enhancements-week-1-2>Phase 1: Core Security Enhancements (Week 1-2)<a class=headerlink href=#phase-1-core-security-enhancements-week-1-2 title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1>// Migration checklist</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=kd>const</span><span class=w> </span><span class=nx>phase1Tasks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>  </span><span class=s1>&#39;Implement password reset service&#39;</span><span class=p>,</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>  </span><span class=s1>&#39;Add email verification system&#39;</span><span class=p>,</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>  </span><span class=s1>&#39;Enhance rate limiting with Redis Lua scripts&#39;</span><span class=p>,</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=w>  </span><span class=s1>&#39;Implement comprehensive audit logging&#39;</span><span class=p>,</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=w>  </span><span class=s1>&#39;Add session security improvements&#39;</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=p>];</span>
</span></code></pre></div><h4 id=phase-2-multi-factor-authentication-week-3-4>Phase 2: Multi-Factor Authentication (Week 3-4)<a class=headerlink href=#phase-2-multi-factor-authentication-week-3-4 title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=kd>const</span><span class=w> </span><span class=nx>phase2Tasks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>  </span><span class=s1>&#39;Implement TOTP-based 2FA&#39;</span><span class=p>,</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>  </span><span class=s1>&#39;Add backup codes system&#39;</span><span class=p>,</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>  </span><span class=s1>&#39;Create 2FA enrollment UI&#39;</span><span class=p>,</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>  </span><span class=s1>&#39;Add 2FA verification middleware&#39;</span><span class=p>,</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=w>  </span><span class=s1>&#39;Implement 2FA recovery flows&#39;</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=p>];</span>
</span></code></pre></div><h4 id=phase-3-scalability-multi-provider-week-5-6>Phase 3: Scalability &amp; Multi-Provider (Week 5-6)<a class=headerlink href=#phase-3-scalability-multi-provider-week-5-6 title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=kd>const</span><span class=w> </span><span class=nx>phase3Tasks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=w>  </span><span class=s1>&#39;Add GitHub OAuth provider&#39;</span><span class=p>,</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=w>  </span><span class=s1>&#39;Implement distributed session management&#39;</span><span class=p>,</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=w>  </span><span class=s1>&#39;Add API gateway patterns&#39;</span><span class=p>,</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=w>  </span><span class=s1>&#39;Implement horizontal scaling support&#39;</span><span class=p>,</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=w>  </span><span class=s1>&#39;Add performance monitoring&#39;</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=p>];</span>
</span></code></pre></div><h3 id=153-database-schema-updates>15.3 Database Schema Updates<a class=headerlink href=#153-database-schema-updates title="Permanent link">&para;</a></h3><h4 id=required-schema-additions>Required Schema Additions<a class=headerlink href=#required-schema-additions title="Permanent link">&para;</a></h4><div class="language-sql highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1>-- Add new columns to existing users table</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>);</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>email_verified</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=p>;</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>two_factor_secret</span><span class=w> </span><span class=nb>TEXT</span><span class=p>;</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>two_factor_enabled</span><span class=w> </span><span class=nb>BOOLEAN</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>FALSE</span><span class=p>;</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>password_changed_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=p>;</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=c1>-- Create audit log table</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>audit_entries</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>gen_random_uuid</span><span class=p>(),</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=w>  </span><span class=n>user_id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>id</span><span class=p>),</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=w>  </span><span class=n>event_type</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=w>  </span><span class=n>ip_address</span><span class=w> </span><span class=n>INET</span><span class=p>,</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=w>  </span><span class=n>user_agent</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=w>  </span><span class=n>success</span><span class=w> </span><span class=nb>BOOLEAN</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=w>  </span><span class=n>risk_score</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=w>  </span><span class=n>details</span><span class=w> </span><span class=n>JSONB</span><span class=p>,</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a><span class=p>);</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a><span class=c1>-- Create session management table (backup to Redis)</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=n>user_sessions</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a><span class=w>  </span><span class=n>id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>gen_random_uuid</span><span class=p>(),</span>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24 href=#__codelineno-28-24></a><span class=w>  </span><span class=n>user_id</span><span class=w> </span><span class=n>UUID</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>id</span><span class=p>),</span>
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25 href=#__codelineno-28-25></a><span class=w>  </span><span class=n>session_token</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26 href=#__codelineno-28-26></a><span class=w>  </span><span class=n>expires_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27 href=#__codelineno-28-27></a><span class=w>  </span><span class=n>ip_address</span><span class=w> </span><span class=n>INET</span><span class=p>,</span>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28 href=#__codelineno-28-28></a><span class=w>  </span><span class=n>user_agent</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span>
</span><span id=__span-28-29><a id=__codelineno-28-29 name=__codelineno-28-29 href=#__codelineno-28-29></a><span class=w>  </span><span class=n>created_at</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=p>,</span>
</span><span id=__span-28-30><a id=__codelineno-28-30 name=__codelineno-28-30 href=#__codelineno-28-30></a><span class=w>  </span><span class=n>last_accessed</span><span class=w> </span><span class=k>TIMESTAMP</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span>
</span><span id=__span-28-31><a id=__codelineno-28-31 name=__codelineno-28-31 href=#__codelineno-28-31></a><span class=p>);</span>
</span><span id=__span-28-32><a id=__codelineno-28-32 name=__codelineno-28-32 href=#__codelineno-28-32></a>
</span><span id=__span-28-33><a id=__codelineno-28-33 name=__codelineno-28-33 href=#__codelineno-28-33></a><span class=c1>-- Indexes for performance</span>
</span><span id=__span-28-34><a id=__codelineno-28-34 name=__codelineno-28-34 href=#__codelineno-28-34></a><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_audit_entries_user_id</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>audit_entries</span><span class=p>(</span><span class=n>user_id</span><span class=p>);</span>
</span><span id=__span-28-35><a id=__codelineno-28-35 name=__codelineno-28-35 href=#__codelineno-28-35></a><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_audit_entries_created_at</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>audit_entries</span><span class=p>(</span><span class=n>created_at</span><span class=p>);</span>
</span><span id=__span-28-36><a id=__codelineno-28-36 name=__codelineno-28-36 href=#__codelineno-28-36></a><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_user_sessions_user_id</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>user_sessions</span><span class=p>(</span><span class=n>user_id</span><span class=p>);</span>
</span><span id=__span-28-37><a id=__codelineno-28-37 name=__codelineno-28-37 href=#__codelineno-28-37></a><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_user_sessions_expires_at</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>user_sessions</span><span class=p>(</span><span class=n>expires_at</span><span class=p>);</span>
</span></code></pre></div><h3 id=154-environment-variables-update>15.4 Environment Variables Update<a class=headerlink href=#154-environment-variables-update title="Permanent link">&para;</a></h3><h4 id=new-environment-variables>New Environment Variables<a class=headerlink href=#new-environment-variables title="Permanent link">&para;</a></h4><div class="language-bash highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=c1># Enhanced security</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=nv>TWO_FACTOR_ENCRYPTION_KEY</span><span class=o>=</span><span class=m>32</span>-byte-hex-key
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=nv>PASSWORD_RESET_TOKEN_TTL</span><span class=o>=</span><span class=m>900</span><span class=w>  </span><span class=c1># 15 minutes</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=nv>EMAIL_VERIFICATION_TTL</span><span class=o>=</span><span class=m>86400</span><span class=w>  </span><span class=c1># 24 hours</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=c1># Multi-provider OAuth</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=nv>AUTH_GITHUB_CLIENT_ID</span><span class=o>=</span>github-client-id
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=nv>AUTH_GITHUB_CLIENT_SECRET</span><span class=o>=</span>github-client-secret
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=nv>AUTH_GOOGLE_CLIENT_ID</span><span class=o>=</span>google-client-id
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=nv>AUTH_GOOGLE_CLIENT_SECRET</span><span class=o>=</span>google-client-secret
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=c1># Email service</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=nv>SMTP_HOST</span><span class=o>=</span>smtp.example.com
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=nv>SMTP_PORT</span><span class=o>=</span><span class=m>587</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=nv>SMTP_USER</span><span class=o>=</span>noreply@medianest.com
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=nv>SMTP_PASS</span><span class=o>=</span>smtp-password
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=nv>EMAIL_FROM</span><span class=o>=</span>noreply@medianest.com
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=c1># Audit and monitoring</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=nv>AUDIT_LOG_RETENTION_DAYS</span><span class=o>=</span><span class=m>365</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=nv>SECURITY_ALERT_EMAIL</span><span class=o>=</span>admin@medianest.com
</span></code></pre></div><h2 id=16-troubleshooting>16. Troubleshooting<a class=headerlink href=#16-troubleshooting title="Permanent link">&para;</a></h2><h3 id=161-common-issues-and-solutions>16.1 Common Issues and Solutions<a class=headerlink href=#161-common-issues-and-solutions title="Permanent link">&para;</a></h3><h4 id=authentication-flow-issues>Authentication Flow Issues<a class=headerlink href=#authentication-flow-issues title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=c1>// Debug authentication issues</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>AuthDebugger</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>diagnoseAuthIssue</span><span class=p>(</span><span class=nx>sessionToken</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>DiagnosticReport</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>report</span><span class=o>:</span><span class=w> </span><span class=kt>DiagnosticReport</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=w>      </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>(),</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=w>      </span><span class=nx>sessionToken</span><span class=o>:</span><span class=w> </span><span class=kt>sessionToken?.substring</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=mf>8</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;...&#39;</span><span class=p>,</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=w>      </span><span class=nx>issues</span><span class=o>:</span><span class=w> </span><span class=p>[]</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=w>    </span><span class=c1>// Check session existence</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionExists</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>redis</span><span class=p>.</span><span class=nx>exists</span><span class=p>(</span><span class=sb>`session:</span><span class=si>${</span><span class=nx>sessionToken</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>sessionExists</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=w>      </span><span class=nx>report</span><span class=p>.</span><span class=nx>issues</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=w>        </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;session_not_found&#39;</span><span class=p>,</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=w>        </span><span class=nx>severity</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;high&#39;</span><span class=p>,</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=w>        </span><span class=nx>description</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Session does not exist in Redis&#39;</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-30-19><a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a>
</span><span id=__span-30-20><a id=__codelineno-30-20 name=__codelineno-30-20 href=#__codelineno-30-20></a><span class=w>    </span><span class=c1>// Check JWT validity</span>
</span><span id=__span-30-21><a id=__codelineno-30-21 name=__codelineno-30-21 href=#__codelineno-30-21></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-22><a id=__codelineno-30-22 name=__codelineno-30-22 href=#__codelineno-30-22></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>decoded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>sessionToken</span><span class=p>,</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET</span><span class=o>!</span><span class=p>);</span>
</span><span id=__span-30-23><a id=__codelineno-30-23 name=__codelineno-30-23 href=#__codelineno-30-23></a><span class=w>      </span><span class=nx>report</span><span class=p>.</span><span class=nx>jwtPayload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>decoded</span><span class=p>;</span>
</span><span id=__span-30-24><a id=__codelineno-30-24 name=__codelineno-30-24 href=#__codelineno-30-24></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-25><a id=__codelineno-30-25 name=__codelineno-30-25 href=#__codelineno-30-25></a><span class=w>      </span><span class=nx>report</span><span class=p>.</span><span class=nx>issues</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span><span id=__span-30-26><a id=__codelineno-30-26 name=__codelineno-30-26 href=#__codelineno-30-26></a><span class=w>        </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;invalid_jwt&#39;</span><span class=p>,</span>
</span><span id=__span-30-27><a id=__codelineno-30-27 name=__codelineno-30-27 href=#__codelineno-30-27></a><span class=w>        </span><span class=nx>severity</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;high&#39;</span><span class=p>,</span>
</span><span id=__span-30-28><a id=__codelineno-30-28 name=__codelineno-30-28 href=#__codelineno-30-28></a><span class=w>        </span><span class=nx>description</span><span class=o>:</span><span class=w> </span><span class=sb>`JWT validation failed: </span><span class=si>${</span><span class=nx>error</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span>
</span><span id=__span-30-29><a id=__codelineno-30-29 name=__codelineno-30-29 href=#__codelineno-30-29></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-30-30><a id=__codelineno-30-30 name=__codelineno-30-30 href=#__codelineno-30-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-30-31><a id=__codelineno-30-31 name=__codelineno-30-31 href=#__codelineno-30-31></a>
</span><span id=__span-30-32><a id=__codelineno-30-32 name=__codelineno-30-32 href=#__codelineno-30-32></a><span class=w>    </span><span class=c1>// Check user existence</span>
</span><span id=__span-30-33><a id=__codelineno-30-33 name=__codelineno-30-33 href=#__codelineno-30-33></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>report</span><span class=p>.</span><span class=nx>jwtPayload</span><span class=o>?</span><span class=p>.</span><span class=nx>sub</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-34><a id=__codelineno-30-34 name=__codelineno-30-34 href=#__codelineno-30-34></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>findUnique</span><span class=p>({</span>
</span><span id=__span-30-35><a id=__codelineno-30-35 name=__codelineno-30-35 href=#__codelineno-30-35></a><span class=w>        </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>report.jwtPayload.sub</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-30-36><a id=__codelineno-30-36 name=__codelineno-30-36 href=#__codelineno-30-36></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-30-37><a id=__codelineno-30-37 name=__codelineno-30-37 href=#__codelineno-30-37></a>
</span><span id=__span-30-38><a id=__codelineno-30-38 name=__codelineno-30-38 href=#__codelineno-30-38></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>user</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-39><a id=__codelineno-30-39 name=__codelineno-30-39 href=#__codelineno-30-39></a><span class=w>        </span><span class=nx>report</span><span class=p>.</span><span class=nx>issues</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span><span id=__span-30-40><a id=__codelineno-30-40 name=__codelineno-30-40 href=#__codelineno-30-40></a><span class=w>          </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user_not_found&#39;</span><span class=p>,</span>
</span><span id=__span-30-41><a id=__codelineno-30-41 name=__codelineno-30-41 href=#__codelineno-30-41></a><span class=w>          </span><span class=nx>severity</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;high&#39;</span><span class=p>,</span>
</span><span id=__span-30-42><a id=__codelineno-30-42 name=__codelineno-30-42 href=#__codelineno-30-42></a><span class=w>          </span><span class=nx>description</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;User referenced in JWT does not exist&#39;</span>
</span><span id=__span-30-43><a id=__codelineno-30-43 name=__codelineno-30-43 href=#__codelineno-30-43></a><span class=w>        </span><span class=p>});</span>
</span><span id=__span-30-44><a id=__codelineno-30-44 name=__codelineno-30-44 href=#__codelineno-30-44></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-30-45><a id=__codelineno-30-45 name=__codelineno-30-45 href=#__codelineno-30-45></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-30-46><a id=__codelineno-30-46 name=__codelineno-30-46 href=#__codelineno-30-46></a>
</span><span id=__span-30-47><a id=__codelineno-30-47 name=__codelineno-30-47 href=#__codelineno-30-47></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>report</span><span class=p>;</span>
</span><span id=__span-30-48><a id=__codelineno-30-48 name=__codelineno-30-48 href=#__codelineno-30-48></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-49><a id=__codelineno-30-49 name=__codelineno-30-49 href=#__codelineno-30-49></a><span class=p>}</span>
</span></code></pre></div><h4 id=session-management-issues>Session Management Issues<a class=headerlink href=#session-management-issues title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=c1>// Session cleanup and diagnostics</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>SessionDiagnostics</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>cleanupOrphanedSessions</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>number</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getRedisClient</span><span class=p>();</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>cleaned</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=w>    </span><span class=c1>// Find all session keys</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionKeys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=s1>&#39;session:*&#39;</span><span class=p>);</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=nx>sessionKey</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=nx>sessionKeys</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>sessionKey</span><span class=p>);</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>sessionData</span><span class=p>)</span><span class=w> </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>sessionData</span><span class=p>);</span>
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a>
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a><span class=w>        </span><span class=c1>// Check if user still exists</span>
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>findUnique</span><span class=p>({</span>
</span><span id=__span-31-20><a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a><span class=w>          </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>session.user?.id</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-31-21><a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a><span class=w>        </span><span class=p>});</span>
</span><span id=__span-31-22><a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a>
</span><span id=__span-31-23><a id=__codelineno-31-23 name=__codelineno-31-23 href=#__codelineno-31-23></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>user</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-24><a id=__codelineno-31-24 name=__codelineno-31-24 href=#__codelineno-31-24></a><span class=w>          </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=nx>sessionKey</span><span class=p>);</span>
</span><span id=__span-31-25><a id=__codelineno-31-25 name=__codelineno-31-25 href=#__codelineno-31-25></a><span class=w>          </span><span class=nx>cleaned</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-31-26><a id=__codelineno-31-26 name=__codelineno-31-26 href=#__codelineno-31-26></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-31-27><a id=__codelineno-31-27 name=__codelineno-31-27 href=#__codelineno-31-27></a><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-28><a id=__codelineno-31-28 name=__codelineno-31-28 href=#__codelineno-31-28></a><span class=w>        </span><span class=c1>// Invalid session data, remove it</span>
</span><span id=__span-31-29><a id=__codelineno-31-29 name=__codelineno-31-29 href=#__codelineno-31-29></a><span class=w>        </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=nx>sessionKey</span><span class=p>);</span>
</span><span id=__span-31-30><a id=__codelineno-31-30 name=__codelineno-31-30 href=#__codelineno-31-30></a><span class=w>        </span><span class=nx>cleaned</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-31-31><a id=__codelineno-31-31 name=__codelineno-31-31 href=#__codelineno-31-31></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-31-32><a id=__codelineno-31-32 name=__codelineno-31-32 href=#__codelineno-31-32></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-31-33><a id=__codelineno-31-33 name=__codelineno-31-33 href=#__codelineno-31-33></a>
</span><span id=__span-31-34><a id=__codelineno-31-34 name=__codelineno-31-34 href=#__codelineno-31-34></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>cleaned</span><span class=p>;</span>
</span><span id=__span-31-35><a id=__codelineno-31-35 name=__codelineno-31-35 href=#__codelineno-31-35></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-31-36><a id=__codelineno-31-36 name=__codelineno-31-36 href=#__codelineno-31-36></a>
</span><span id=__span-31-37><a id=__codelineno-31-37 name=__codelineno-31-37 href=#__codelineno-31-37></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>getSessionStats</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>SessionStats</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-38><a id=__codelineno-31-38 name=__codelineno-31-38 href=#__codelineno-31-38></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getRedisClient</span><span class=p>();</span>
</span><span id=__span-31-39><a id=__codelineno-31-39 name=__codelineno-31-39 href=#__codelineno-31-39></a>
</span><span id=__span-31-40><a id=__codelineno-31-40 name=__codelineno-31-40 href=#__codelineno-31-40></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>totalSessions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>dbsize</span><span class=p>();</span>
</span><span id=__span-31-41><a id=__codelineno-31-41 name=__codelineno-31-41 href=#__codelineno-31-41></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>activeSessions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>zcard</span><span class=p>(</span><span class=s1>&#39;global:active_sessions&#39;</span><span class=p>);</span>
</span><span id=__span-31-42><a id=__codelineno-31-42 name=__codelineno-31-42 href=#__codelineno-31-42></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>nodeSessionCounts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>getNodeSessionCounts</span><span class=p>();</span>
</span><span id=__span-31-43><a id=__codelineno-31-43 name=__codelineno-31-43 href=#__codelineno-31-43></a>
</span><span id=__span-31-44><a id=__codelineno-31-44 name=__codelineno-31-44 href=#__codelineno-31-44></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-45><a id=__codelineno-31-45 name=__codelineno-31-45 href=#__codelineno-31-45></a><span class=w>      </span><span class=nx>totalSessions</span><span class=p>,</span>
</span><span id=__span-31-46><a id=__codelineno-31-46 name=__codelineno-31-46 href=#__codelineno-31-46></a><span class=w>      </span><span class=nx>activeSessions</span><span class=p>,</span>
</span><span id=__span-31-47><a id=__codelineno-31-47 name=__codelineno-31-47 href=#__codelineno-31-47></a><span class=w>      </span><span class=nx>nodeDistribution</span><span class=o>:</span><span class=w> </span><span class=kt>nodeSessionCounts</span><span class=p>,</span>
</span><span id=__span-31-48><a id=__codelineno-31-48 name=__codelineno-31-48 href=#__codelineno-31-48></a><span class=w>      </span><span class=nx>memoryUsage</span><span class=o>:</span><span class=w> </span><span class=kt>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>getRedisMemoryUsage</span><span class=p>()</span>
</span><span id=__span-31-49><a id=__codelineno-31-49 name=__codelineno-31-49 href=#__codelineno-31-49></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-31-50><a id=__codelineno-31-50 name=__codelineno-31-50 href=#__codelineno-31-50></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-31-51><a id=__codelineno-31-51 name=__codelineno-31-51 href=#__codelineno-31-51></a><span class=p>}</span>
</span></code></pre></div><h4 id=performance-troubleshooting>Performance Troubleshooting<a class=headerlink href=#performance-troubleshooting title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=c1>// Performance monitoring and optimization</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>AuthPerformanceMonitor</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>analyzeAuthPerformance</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=nx>PerformanceReport</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getRedisClient</span><span class=p>();</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=w>    </span><span class=c1>// Measure Redis response times</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>redisLatency</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>measureRedisLatency</span><span class=p>();</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=w>    </span><span class=c1>// Check database connection pool</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>dbStats</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>getDatabaseStats</span><span class=p>();</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=w>    </span><span class=c1>// Analyze session access patterns</span>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>sessionPatterns</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>analyzeSessionPatterns</span><span class=p>();</span>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=w>      </span><span class=nx>redisLatency</span><span class=p>,</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=w>      </span><span class=nx>databaseStats</span><span class=o>:</span><span class=w> </span><span class=kt>dbStats</span><span class=p>,</span>
</span><span id=__span-32-18><a id=__codelineno-32-18 name=__codelineno-32-18 href=#__codelineno-32-18></a><span class=w>      </span><span class=nx>sessionPatterns</span><span class=p>,</span>
</span><span id=__span-32-19><a id=__codelineno-32-19 name=__codelineno-32-19 href=#__codelineno-32-19></a><span class=w>      </span><span class=nx>recommendations</span><span class=o>:</span><span class=w> </span><span class=kt>this.generateRecommendations</span><span class=p>({</span>
</span><span id=__span-32-20><a id=__codelineno-32-20 name=__codelineno-32-20 href=#__codelineno-32-20></a><span class=w>        </span><span class=nx>redisLatency</span><span class=p>,</span>
</span><span id=__span-32-21><a id=__codelineno-32-21 name=__codelineno-32-21 href=#__codelineno-32-21></a><span class=w>        </span><span class=nx>dbStats</span><span class=p>,</span>
</span><span id=__span-32-22><a id=__codelineno-32-22 name=__codelineno-32-22 href=#__codelineno-32-22></a><span class=w>        </span><span class=nx>sessionPatterns</span>
</span><span id=__span-32-23><a id=__codelineno-32-23 name=__codelineno-32-23 href=#__codelineno-32-23></a><span class=w>      </span><span class=p>})</span>
</span><span id=__span-32-24><a id=__codelineno-32-24 name=__codelineno-32-24 href=#__codelineno-32-24></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-32-25><a id=__codelineno-32-25 name=__codelineno-32-25 href=#__codelineno-32-25></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-32-26><a id=__codelineno-32-26 name=__codelineno-32-26 href=#__codelineno-32-26></a>
</span><span id=__span-32-27><a id=__codelineno-32-27 name=__codelineno-32-27 href=#__codelineno-32-27></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=nx>measureRedisLatency</span><span class=p>()</span><span class=o>:</span><span class=w> </span><span class=nb>Promise</span><span class=o>&lt;</span><span class=kt>number</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-28><a id=__codelineno-32-28 name=__codelineno-32-28 href=#__codelineno-32-28></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>getRedisClient</span><span class=p>();</span>
</span><span id=__span-32-29><a id=__codelineno-32-29 name=__codelineno-32-29 href=#__codelineno-32-29></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span><span id=__span-32-30><a id=__codelineno-32-30 name=__codelineno-32-30 href=#__codelineno-32-30></a>
</span><span id=__span-32-31><a id=__codelineno-32-31 name=__codelineno-32-31 href=#__codelineno-32-31></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>ping</span><span class=p>();</span>
</span><span id=__span-32-32><a id=__codelineno-32-32 name=__codelineno-32-32 href=#__codelineno-32-32></a>
</span><span id=__span-32-33><a id=__codelineno-32-33 name=__codelineno-32-33 href=#__codelineno-32-33></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>start</span><span class=p>;</span>
</span><span id=__span-32-34><a id=__codelineno-32-34 name=__codelineno-32-34 href=#__codelineno-32-34></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-32-35><a id=__codelineno-32-35 name=__codelineno-32-35 href=#__codelineno-32-35></a>
</span><span id=__span-32-36><a id=__codelineno-32-36 name=__codelineno-32-36 href=#__codelineno-32-36></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>generateRecommendations</span><span class=p>(</span><span class=nx>stats</span><span class=o>:</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>[]</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-37><a id=__codelineno-32-37 name=__codelineno-32-37 href=#__codelineno-32-37></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>recommendations</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[];</span>
</span><span id=__span-32-38><a id=__codelineno-32-38 name=__codelineno-32-38 href=#__codelineno-32-38></a>
</span><span id=__span-32-39><a id=__codelineno-32-39 name=__codelineno-32-39 href=#__codelineno-32-39></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>stats</span><span class=p>.</span><span class=nx>redisLatency</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>10</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-40><a id=__codelineno-32-40 name=__codelineno-32-40 href=#__codelineno-32-40></a><span class=w>      </span><span class=nx>recommendations</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s1>&#39;Consider Redis optimization or scaling&#39;</span><span class=p>);</span>
</span><span id=__span-32-41><a id=__codelineno-32-41 name=__codelineno-32-41 href=#__codelineno-32-41></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-42><a id=__codelineno-32-42 name=__codelineno-32-42 href=#__codelineno-32-42></a>
</span><span id=__span-32-43><a id=__codelineno-32-43 name=__codelineno-32-43 href=#__codelineno-32-43></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>stats</span><span class=p>.</span><span class=nx>dbStats</span><span class=p>.</span><span class=nx>activeConnections</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mf>15</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-44><a id=__codelineno-32-44 name=__codelineno-32-44 href=#__codelineno-32-44></a><span class=w>      </span><span class=nx>recommendations</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s1>&#39;Consider increasing database connection pool&#39;</span><span class=p>);</span>
</span><span id=__span-32-45><a id=__codelineno-32-45 name=__codelineno-32-45 href=#__codelineno-32-45></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-46><a id=__codelineno-32-46 name=__codelineno-32-46 href=#__codelineno-32-46></a>
</span><span id=__span-32-47><a id=__codelineno-32-47 name=__codelineno-32-47 href=#__codelineno-32-47></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>stats</span><span class=p>.</span><span class=nx>sessionPatterns</span><span class=p>.</span><span class=nx>averageSessionDuration</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mf>300</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-48><a id=__codelineno-32-48 name=__codelineno-32-48 href=#__codelineno-32-48></a><span class=w>      </span><span class=nx>recommendations</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s1>&#39;Consider adjusting session timeout settings&#39;</span><span class=p>);</span>
</span><span id=__span-32-49><a id=__codelineno-32-49 name=__codelineno-32-49 href=#__codelineno-32-49></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-50><a id=__codelineno-32-50 name=__codelineno-32-50 href=#__codelineno-32-50></a>
</span><span id=__span-32-51><a id=__codelineno-32-51 name=__codelineno-32-51 href=#__codelineno-32-51></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>recommendations</span><span class=p>;</span>
</span><span id=__span-32-52><a id=__codelineno-32-52 name=__codelineno-32-52 href=#__codelineno-32-52></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-32-53><a id=__codelineno-32-53 name=__codelineno-32-53 href=#__codelineno-32-53></a><span class=p>}</span>
</span></code></pre></div><h2 id=13-code-examples>13. Code Examples<a class=headerlink href=#13-code-examples title="Permanent link">&para;</a></h2><div class="language-typescript highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=c1>// app/auth/signin/page.tsx</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=s2>&quot;use client&quot;</span><span class=p>;</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>useState</span><span class=p>,</span><span class=w> </span><span class=nx>useEffect</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;react&quot;</span><span class=p>;</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>signIn</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next-auth/react&quot;</span><span class=p>;</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>useRouter</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next/navigation&quot;</span><span class=p>;</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>SignInPage</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>router</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useRouter</span><span class=p>();</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>isLoading</span><span class=p>,</span><span class=w> </span><span class=nx>setIsLoading</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useState</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>pinData</span><span class=p>,</span><span class=w> </span><span class=nx>setPinData</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useState</span><span class=o>&lt;</span><span class=p>{</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a><span class=w>    </span><span class=nx>pin</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=w>    </span><span class=nx>authUrl</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=w>    </span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a><span class=w>    </span><span class=nx>expiresAt</span><span class=o>:</span><span class=w> </span><span class=kt>Date</span><span class=p>;</span>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kc>null</span><span class=o>&gt;</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>initiatePlexLogin</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=w>    </span><span class=nx>setIsLoading</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-33-20><a id=__codelineno-33-20 name=__codelineno-33-20 href=#__codelineno-33-20></a>
</span><span id=__span-33-21><a id=__codelineno-33-21 name=__codelineno-33-21 href=#__codelineno-33-21></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-22><a id=__codelineno-33-22 name=__codelineno-33-22 href=#__codelineno-33-22></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>fetch</span><span class=p>(</span><span class=s2>&quot;/api/auth/plex/pin&quot;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-23><a id=__codelineno-33-23 name=__codelineno-33-23 href=#__codelineno-33-23></a><span class=w>        </span><span class=nx>method</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;POST&quot;</span><span class=p>,</span>
</span><span id=__span-33-24><a id=__codelineno-33-24 name=__codelineno-33-24 href=#__codelineno-33-24></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-33-25><a id=__codelineno-33-25 name=__codelineno-33-25 href=#__codelineno-33-25></a>
</span><span id=__span-33-26><a id=__codelineno-33-26 name=__codelineno-33-26 href=#__codelineno-33-26></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span><span id=__span-33-27><a id=__codelineno-33-27 name=__codelineno-33-27 href=#__codelineno-33-27></a>
</span><span id=__span-33-28><a id=__codelineno-33-28 name=__codelineno-33-28 href=#__codelineno-33-28></a><span class=w>      </span><span class=nx>setPinData</span><span class=p>({</span>
</span><span id=__span-33-29><a id=__codelineno-33-29 name=__codelineno-33-29 href=#__codelineno-33-29></a><span class=w>        </span><span class=p>...</span><span class=nx>data</span><span class=p>,</span>
</span><span id=__span-33-30><a id=__codelineno-33-30 name=__codelineno-33-30 href=#__codelineno-33-30></a><span class=w>        </span><span class=nx>expiresAt</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>(</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>data</span><span class=p>.</span><span class=nx>expiresIn</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1000</span><span class=p>),</span>
</span><span id=__span-33-31><a id=__codelineno-33-31 name=__codelineno-33-31 href=#__codelineno-33-31></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-33-32><a id=__codelineno-33-32 name=__codelineno-33-32 href=#__codelineno-33-32></a>
</span><span id=__span-33-33><a id=__codelineno-33-33 name=__codelineno-33-33 href=#__codelineno-33-33></a><span class=w>      </span><span class=c1>// Open Plex auth page in new tab</span>
</span><span id=__span-33-34><a id=__codelineno-33-34 name=__codelineno-33-34 href=#__codelineno-33-34></a><span class=w>      </span><span class=nb>window</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>authUrl</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;_blank&quot;</span><span class=p>);</span>
</span><span id=__span-33-35><a id=__codelineno-33-35 name=__codelineno-33-35 href=#__codelineno-33-35></a>
</span><span id=__span-33-36><a id=__codelineno-33-36 name=__codelineno-33-36 href=#__codelineno-33-36></a><span class=w>      </span><span class=c1>// Start polling</span>
</span><span id=__span-33-37><a id=__codelineno-33-37 name=__codelineno-33-37 href=#__codelineno-33-37></a><span class=w>      </span><span class=nx>pollForAuthentication</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>pinId</span><span class=p>);</span>
</span><span id=__span-33-38><a id=__codelineno-33-38 name=__codelineno-33-38 href=#__codelineno-33-38></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-39><a id=__codelineno-33-39 name=__codelineno-33-39 href=#__codelineno-33-39></a><span class=w>      </span><span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&quot;Failed to initiate Plex login:&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>error</span><span class=p>);</span>
</span><span id=__span-33-40><a id=__codelineno-33-40 name=__codelineno-33-40 href=#__codelineno-33-40></a><span class=w>      </span><span class=nx>setIsLoading</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-33-41><a id=__codelineno-33-41 name=__codelineno-33-41 href=#__codelineno-33-41></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-33-42><a id=__codelineno-33-42 name=__codelineno-33-42 href=#__codelineno-33-42></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-33-43><a id=__codelineno-33-43 name=__codelineno-33-43 href=#__codelineno-33-43></a>
</span><span id=__span-33-44><a id=__codelineno-33-44 name=__codelineno-33-44 href=#__codelineno-33-44></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>pollForAuthentication</span><span class=p>(</span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-45><a id=__codelineno-33-45 name=__codelineno-33-45 href=#__codelineno-33-45></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>maxAttempts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>60</span><span class=p>;</span><span class=w> </span><span class=c1>// 5 minutes</span>
</span><span id=__span-33-46><a id=__codelineno-33-46 name=__codelineno-33-46 href=#__codelineno-33-46></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>attempts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span>
</span><span id=__span-33-47><a id=__codelineno-33-47 name=__codelineno-33-47 href=#__codelineno-33-47></a>
</span><span id=__span-33-48><a id=__codelineno-33-48 name=__codelineno-33-48 href=#__codelineno-33-48></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>pollInterval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>setInterval</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-49><a id=__codelineno-33-49 name=__codelineno-33-49 href=#__codelineno-33-49></a><span class=w>      </span><span class=nx>attempts</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-33-50><a id=__codelineno-33-50 name=__codelineno-33-50 href=#__codelineno-33-50></a>
</span><span id=__span-33-51><a id=__codelineno-33-51 name=__codelineno-33-51 href=#__codelineno-33-51></a><span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-52><a id=__codelineno-33-52 name=__codelineno-33-52 href=#__codelineno-33-52></a><span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>fetch</span><span class=p>(</span><span class=sb>`/api/auth/plex/poll/</span><span class=si>${</span><span class=nx>pinId</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span><span id=__span-33-53><a id=__codelineno-33-53 name=__codelineno-33-53 href=#__codelineno-33-53></a><span class=w>        </span><span class=kd>const</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span><span id=__span-33-54><a id=__codelineno-33-54 name=__codelineno-33-54 href=#__codelineno-33-54></a>
</span><span id=__span-33-55><a id=__codelineno-33-55 name=__codelineno-33-55 href=#__codelineno-33-55></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>success</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-56><a id=__codelineno-33-56 name=__codelineno-33-56 href=#__codelineno-33-56></a><span class=w>          </span><span class=nx>clearInterval</span><span class=p>(</span><span class=nx>pollInterval</span><span class=p>);</span>
</span><span id=__span-33-57><a id=__codelineno-33-57 name=__codelineno-33-57 href=#__codelineno-33-57></a>
</span><span id=__span-33-58><a id=__codelineno-33-58 name=__codelineno-33-58 href=#__codelineno-33-58></a><span class=w>          </span><span class=c1>// Sign in with NextAuth using the token</span>
</span><span id=__span-33-59><a id=__codelineno-33-59 name=__codelineno-33-59 href=#__codelineno-33-59></a><span class=w>          </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>signIn</span><span class=p>(</span><span class=s2>&quot;plex&quot;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-60><a id=__codelineno-33-60 name=__codelineno-33-60 href=#__codelineno-33-60></a><span class=w>            </span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=kt>data.token</span><span class=p>,</span>
</span><span id=__span-33-61><a id=__codelineno-33-61 name=__codelineno-33-61 href=#__codelineno-33-61></a><span class=w>            </span><span class=nx>redirect</span><span class=o>:</span><span class=w> </span><span class=kt>false</span><span class=p>,</span>
</span><span id=__span-33-62><a id=__codelineno-33-62 name=__codelineno-33-62 href=#__codelineno-33-62></a><span class=w>          </span><span class=p>});</span>
</span><span id=__span-33-63><a id=__codelineno-33-63 name=__codelineno-33-63 href=#__codelineno-33-63></a>
</span><span id=__span-33-64><a id=__codelineno-33-64 name=__codelineno-33-64 href=#__codelineno-33-64></a><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>result</span><span class=o>?</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-65><a id=__codelineno-33-65 name=__codelineno-33-65 href=#__codelineno-33-65></a><span class=w>            </span><span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s2>&quot;/dashboard&quot;</span><span class=p>);</span>
</span><span id=__span-33-66><a id=__codelineno-33-66 name=__codelineno-33-66 href=#__codelineno-33-66></a><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-67><a id=__codelineno-33-67 name=__codelineno-33-67 href=#__codelineno-33-67></a><span class=w>            </span><span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&quot;Sign in failed:&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>result</span><span class=o>?</span><span class=p>.</span><span class=nx>error</span><span class=p>);</span>
</span><span id=__span-33-68><a id=__codelineno-33-68 name=__codelineno-33-68 href=#__codelineno-33-68></a><span class=w>          </span><span class=p>}</span>
</span><span id=__span-33-69><a id=__codelineno-33-69 name=__codelineno-33-69 href=#__codelineno-33-69></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>attempts</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>maxAttempts</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-70><a id=__codelineno-33-70 name=__codelineno-33-70 href=#__codelineno-33-70></a><span class=w>          </span><span class=nx>clearInterval</span><span class=p>(</span><span class=nx>pollInterval</span><span class=p>);</span>
</span><span id=__span-33-71><a id=__codelineno-33-71 name=__codelineno-33-71 href=#__codelineno-33-71></a><span class=w>          </span><span class=nx>setPinData</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span><span id=__span-33-72><a id=__codelineno-33-72 name=__codelineno-33-72 href=#__codelineno-33-72></a><span class=w>          </span><span class=nx>setIsLoading</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-33-73><a id=__codelineno-33-73 name=__codelineno-33-73 href=#__codelineno-33-73></a><span class=w>          </span><span class=nx>alert</span><span class=p>(</span><span class=s2>&quot;Authentication timeout. Please try again.&quot;</span><span class=p>);</span>
</span><span id=__span-33-74><a id=__codelineno-33-74 name=__codelineno-33-74 href=#__codelineno-33-74></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-33-75><a id=__codelineno-33-75 name=__codelineno-33-75 href=#__codelineno-33-75></a><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-76><a id=__codelineno-33-76 name=__codelineno-33-76 href=#__codelineno-33-76></a><span class=w>        </span><span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&quot;Polling error:&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>error</span><span class=p>);</span>
</span><span id=__span-33-77><a id=__codelineno-33-77 name=__codelineno-33-77 href=#__codelineno-33-77></a><span class=w>        </span><span class=nx>clearInterval</span><span class=p>(</span><span class=nx>pollInterval</span><span class=p>);</span>
</span><span id=__span-33-78><a id=__codelineno-33-78 name=__codelineno-33-78 href=#__codelineno-33-78></a><span class=w>        </span><span class=nx>setIsLoading</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-33-79><a id=__codelineno-33-79 name=__codelineno-33-79 href=#__codelineno-33-79></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-33-80><a id=__codelineno-33-80 name=__codelineno-33-80 href=#__codelineno-33-80></a><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=mf>5000</span><span class=p>);</span><span class=w> </span><span class=c1>// Poll every 5 seconds</span>
</span><span id=__span-33-81><a id=__codelineno-33-81 name=__codelineno-33-81 href=#__codelineno-33-81></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-33-82><a id=__codelineno-33-82 name=__codelineno-33-82 href=#__codelineno-33-82></a>
</span><span id=__span-33-83><a id=__codelineno-33-83 name=__codelineno-33-83 href=#__codelineno-33-83></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-33-84><a id=__codelineno-33-84 name=__codelineno-33-84 href=#__codelineno-33-84></a><span class=w>    </span><span class=o>&lt;</span><span class=nx>div</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;flex min-h-screen items-center justify-center&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-85><a id=__codelineno-33-85 name=__codelineno-33-85 href=#__codelineno-33-85></a><span class=w>      </span><span class=o>&lt;</span><span class=nx>div</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;w-full max-w-md space-y-8 rounded-lg bg-white p-6 shadow-lg&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-86><a id=__codelineno-33-86 name=__codelineno-33-86 href=#__codelineno-33-86></a><span class=w>        </span><span class=o>&lt;</span><span class=nx>div</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;text-center&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-87><a id=__codelineno-33-87 name=__codelineno-33-87 href=#__codelineno-33-87></a><span class=w>          </span><span class=o>&lt;</span><span class=nx>h2</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;text-3xl font-bold&quot;</span><span class=o>&gt;</span><span class=nx>Sign</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=nx>to</span><span class=w> </span><span class=nx>MediaNest</span><span class=o>&lt;</span><span class=err>/h2&gt;</span>
</span><span id=__span-33-88><a id=__codelineno-33-88 name=__codelineno-33-88 href=#__codelineno-33-88></a><span class=w>          </span><span class=o>&lt;</span><span class=nx>p</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;mt-2 text-gray-600&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-89><a id=__codelineno-33-89 name=__codelineno-33-89 href=#__codelineno-33-89></a><span class=w>            </span><span class=nx>Use</span><span class=w> </span><span class=nx>your</span><span class=w> </span><span class=nx>Plex</span><span class=w> </span><span class=nx>account</span><span class=w> </span><span class=nx>to</span><span class=w> </span><span class=nx>sign</span><span class=w> </span><span class=ow>in</span>
</span><span id=__span-33-90><a id=__codelineno-33-90 name=__codelineno-33-90 href=#__codelineno-33-90></a><span class=w>          </span><span class=o>&lt;</span><span class=err>/p&gt;</span>
</span><span id=__span-33-91><a id=__codelineno-33-91 name=__codelineno-33-91 href=#__codelineno-33-91></a><span class=w>        </span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span><span id=__span-33-92><a id=__codelineno-33-92 name=__codelineno-33-92 href=#__codelineno-33-92></a>
</span><span id=__span-33-93><a id=__codelineno-33-93 name=__codelineno-33-93 href=#__codelineno-33-93></a><span class=w>        </span><span class=p>{</span><span class=o>!</span><span class=nx>pinData</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-33-94><a id=__codelineno-33-94 name=__codelineno-33-94 href=#__codelineno-33-94></a><span class=w>          </span><span class=o>&lt;</span><span class=nx>button</span>
</span><span id=__span-33-95><a id=__codelineno-33-95 name=__codelineno-33-95 href=#__codelineno-33-95></a><span class=w>            </span><span class=nx>onClick</span><span class=o>=</span><span class=p>{</span><span class=nx>initiatePlexLogin</span><span class=p>}</span>
</span><span id=__span-33-96><a id=__codelineno-33-96 name=__codelineno-33-96 href=#__codelineno-33-96></a><span class=w>            </span><span class=nx>disabled</span><span class=o>=</span><span class=p>{</span><span class=nx>isLoading</span><span class=p>}</span>
</span><span id=__span-33-97><a id=__codelineno-33-97 name=__codelineno-33-97 href=#__codelineno-33-97></a><span class=w>            </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;w-full rounded-md bg-orange-600 px-4 py-2 text-white hover:bg-orange-700 disabled:opacity-50&quot;</span>
</span><span id=__span-33-98><a id=__codelineno-33-98 name=__codelineno-33-98 href=#__codelineno-33-98></a><span class=w>          </span><span class=o>&gt;</span>
</span><span id=__span-33-99><a id=__codelineno-33-99 name=__codelineno-33-99 href=#__codelineno-33-99></a><span class=w>            </span><span class=p>{</span><span class=nx>isLoading</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s2>&quot;Loading...&quot;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Sign in with Plex&quot;</span><span class=p>}</span>
</span><span id=__span-33-100><a id=__codelineno-33-100 name=__codelineno-33-100 href=#__codelineno-33-100></a><span class=w>          </span><span class=o>&lt;</span><span class=err>/button&gt;</span>
</span><span id=__span-33-101><a id=__codelineno-33-101 name=__codelineno-33-101 href=#__codelineno-33-101></a><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-33-102><a id=__codelineno-33-102 name=__codelineno-33-102 href=#__codelineno-33-102></a><span class=w>          </span><span class=o>&lt;</span><span class=nx>div</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;space-y-4&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-103><a id=__codelineno-33-103 name=__codelineno-33-103 href=#__codelineno-33-103></a><span class=w>            </span><span class=o>&lt;</span><span class=nx>div</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;rounded-lg bg-gray-100 p-4&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-104><a id=__codelineno-33-104 name=__codelineno-33-104 href=#__codelineno-33-104></a><span class=w>              </span><span class=o>&lt;</span><span class=nx>p</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;text-sm text-gray-600&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-105><a id=__codelineno-33-105 name=__codelineno-33-105 href=#__codelineno-33-105></a><span class=w>                </span><span class=nx>Enter</span><span class=w> </span><span class=k>this</span><span class=w> </span><span class=nx>PIN</span><span class=w> </span><span class=nx>on</span><span class=w> </span><span class=nx>plex</span><span class=p>.</span><span class=nx>tv</span><span class=o>:</span>
</span><span id=__span-33-106><a id=__codelineno-33-106 name=__codelineno-33-106 href=#__codelineno-33-106></a><span class=w>              </span><span class=o>&lt;</span><span class=err>/p&gt;</span>
</span><span id=__span-33-107><a id=__codelineno-33-107 name=__codelineno-33-107 href=#__codelineno-33-107></a><span class=w>              </span><span class=o>&lt;</span><span class=nx>p</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;mt-2 text-center text-4xl font-bold tracking-wider&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-108><a id=__codelineno-33-108 name=__codelineno-33-108 href=#__codelineno-33-108></a><span class=w>                </span><span class=p>{</span><span class=nx>pinData</span><span class=p>.</span><span class=nx>pin</span><span class=p>}</span>
</span><span id=__span-33-109><a id=__codelineno-33-109 name=__codelineno-33-109 href=#__codelineno-33-109></a><span class=w>              </span><span class=o>&lt;</span><span class=err>/p&gt;</span>
</span><span id=__span-33-110><a id=__codelineno-33-110 name=__codelineno-33-110 href=#__codelineno-33-110></a><span class=w>            </span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span><span id=__span-33-111><a id=__codelineno-33-111 name=__codelineno-33-111 href=#__codelineno-33-111></a>
</span><span id=__span-33-112><a id=__codelineno-33-112 name=__codelineno-33-112 href=#__codelineno-33-112></a><span class=w>            </span><span class=o>&lt;</span><span class=nx>div</span><span class=w> </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;text-center text-sm text-gray-600&quot;</span><span class=o>&gt;</span>
</span><span id=__span-33-113><a id=__codelineno-33-113 name=__codelineno-33-113 href=#__codelineno-33-113></a><span class=w>              </span><span class=o>&lt;</span><span class=nx>p</span><span class=o>&gt;</span><span class=nx>Waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=nx>authentication</span><span class=p>...</span><span class=o>&lt;</span><span class=err>/p&gt;</span>
</span><span id=__span-33-114><a id=__codelineno-33-114 name=__codelineno-33-114 href=#__codelineno-33-114></a><span class=w>              </span><span class=o>&lt;</span><span class=nx>p</span><span class=o>&gt;</span>
</span><span id=__span-33-115><a id=__codelineno-33-115 name=__codelineno-33-115 href=#__codelineno-33-115></a><span class=w>                </span><span class=nx>Expires</span><span class=w> </span><span class=ow>in</span><span class=p>{</span><span class=s2>&quot; &quot;</span><span class=p>}</span>
</span><span id=__span-33-116><a id=__codelineno-33-116 name=__codelineno-33-116 href=#__codelineno-33-116></a><span class=w>                </span><span class=p>{</span><span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span>
</span><span id=__span-33-117><a id=__codelineno-33-117 name=__codelineno-33-117 href=#__codelineno-33-117></a><span class=w>                  </span><span class=mf>0</span><span class=p>,</span>
</span><span id=__span-33-118><a id=__codelineno-33-118 name=__codelineno-33-118 href=#__codelineno-33-118></a><span class=w>                  </span><span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span>
</span><span id=__span-33-119><a id=__codelineno-33-119 name=__codelineno-33-119 href=#__codelineno-33-119></a><span class=w>                    </span><span class=p>(</span><span class=nx>pinData</span><span class=p>.</span><span class=nx>expiresAt</span><span class=p>.</span><span class=nx>getTime</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>())</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>1000</span>
</span><span id=__span-33-120><a id=__codelineno-33-120 name=__codelineno-33-120 href=#__codelineno-33-120></a><span class=w>                  </span><span class=p>)</span>
</span><span id=__span-33-121><a id=__codelineno-33-121 name=__codelineno-33-121 href=#__codelineno-33-121></a><span class=w>                </span><span class=p>)}{</span><span class=s2>&quot; &quot;</span><span class=p>}</span>
</span><span id=__span-33-122><a id=__codelineno-33-122 name=__codelineno-33-122 href=#__codelineno-33-122></a><span class=w>                </span><span class=nx>seconds</span>
</span><span id=__span-33-123><a id=__codelineno-33-123 name=__codelineno-33-123 href=#__codelineno-33-123></a><span class=w>              </span><span class=o>&lt;</span><span class=err>/p&gt;</span>
</span><span id=__span-33-124><a id=__codelineno-33-124 name=__codelineno-33-124 href=#__codelineno-33-124></a><span class=w>            </span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span><span id=__span-33-125><a id=__codelineno-33-125 name=__codelineno-33-125 href=#__codelineno-33-125></a>
</span><span id=__span-33-126><a id=__codelineno-33-126 name=__codelineno-33-126 href=#__codelineno-33-126></a><span class=w>            </span><span class=o>&lt;</span><span class=nx>a</span>
</span><span id=__span-33-127><a id=__codelineno-33-127 name=__codelineno-33-127 href=#__codelineno-33-127></a><span class=w>              </span><span class=nx>href</span><span class=o>=</span><span class=p>{</span><span class=nx>pinData</span><span class=p>.</span><span class=nx>authUrl</span><span class=p>}</span>
</span><span id=__span-33-128><a id=__codelineno-33-128 name=__codelineno-33-128 href=#__codelineno-33-128></a><span class=w>              </span><span class=nx>target</span><span class=o>=</span><span class=s2>&quot;_blank&quot;</span>
</span><span id=__span-33-129><a id=__codelineno-33-129 name=__codelineno-33-129 href=#__codelineno-33-129></a><span class=w>              </span><span class=nx>rel</span><span class=o>=</span><span class=s2>&quot;noopener noreferrer&quot;</span>
</span><span id=__span-33-130><a id=__codelineno-33-130 name=__codelineno-33-130 href=#__codelineno-33-130></a><span class=w>              </span><span class=nx>className</span><span class=o>=</span><span class=s2>&quot;block w-full rounded-md border border-gray-300 px-4 py-2 text-center text-gray-700 hover:bg-gray-50&quot;</span>
</span><span id=__span-33-131><a id=__codelineno-33-131 name=__codelineno-33-131 href=#__codelineno-33-131></a><span class=w>            </span><span class=o>&gt;</span>
</span><span id=__span-33-132><a id=__codelineno-33-132 name=__codelineno-33-132 href=#__codelineno-33-132></a><span class=w>              </span><span class=nx>Open</span><span class=w> </span><span class=nx>plex</span><span class=p>.</span><span class=nx>tv</span><span class=o>/</span><span class=nx>link</span>
</span><span id=__span-33-133><a id=__codelineno-33-133 name=__codelineno-33-133 href=#__codelineno-33-133></a><span class=w>            </span><span class=o>&lt;</span><span class=err>/a&gt;</span>
</span><span id=__span-33-134><a id=__codelineno-33-134 name=__codelineno-33-134 href=#__codelineno-33-134></a><span class=w>          </span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span><span id=__span-33-135><a id=__codelineno-33-135 name=__codelineno-33-135 href=#__codelineno-33-135></a><span class=w>        </span><span class=p>)}</span>
</span><span id=__span-33-136><a id=__codelineno-33-136 name=__codelineno-33-136 href=#__codelineno-33-136></a><span class=w>      </span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span><span id=__span-33-137><a id=__codelineno-33-137 name=__codelineno-33-137 href=#__codelineno-33-137></a><span class=w>    </span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span><span id=__span-33-138><a id=__codelineno-33-138 name=__codelineno-33-138 href=#__codelineno-33-138></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-33-139><a id=__codelineno-33-139 name=__codelineno-33-139 href=#__codelineno-33-139></a><span class=p>}</span>
</span></code></pre></div><h3 id=102-protected-api-route>10.2 Protected API Route<a class=headerlink href=#102-protected-api-route title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=c1>// app/api/admin/users/route.ts</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>NextRequest</span><span class=p>,</span><span class=w> </span><span class=nx>NextResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next/server&quot;</span><span class=p>;</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>getServerSession</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next-auth&quot;</span><span class=p>;</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>authOptions</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/app/api/auth/[...nextauth]/route&quot;</span><span class=p>;</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>prisma</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/lib/prisma&quot;</span><span class=p>;</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=k>export</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>GET</span><span class=p>(</span><span class=nx>request</span><span class=o>:</span><span class=w> </span><span class=kt>NextRequest</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=w>  </span><span class=c1>// Verify session</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>getServerSession</span><span class=p>(</span><span class=nx>authOptions</span><span class=p>);</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>session</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Unauthorized&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>401</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a>
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a><span class=w>  </span><span class=c1>// Check admin role</span>
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>role</span><span class=w> </span><span class=o>!==</span><span class=w> </span><span class=s2>&quot;admin&quot;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Forbidden&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-34-22><a id=__codelineno-34-22 name=__codelineno-34-22 href=#__codelineno-34-22></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>403</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-34-23><a id=__codelineno-34-23 name=__codelineno-34-23 href=#__codelineno-34-23></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-34-24><a id=__codelineno-34-24 name=__codelineno-34-24 href=#__codelineno-34-24></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-34-25><a id=__codelineno-34-25 name=__codelineno-34-25 href=#__codelineno-34-25></a>
</span><span id=__span-34-26><a id=__codelineno-34-26 name=__codelineno-34-26 href=#__codelineno-34-26></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-27><a id=__codelineno-34-27 name=__codelineno-34-27 href=#__codelineno-34-27></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>users</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>findMany</span><span class=p>({</span>
</span><span id=__span-34-28><a id=__codelineno-34-28 name=__codelineno-34-28 href=#__codelineno-34-28></a><span class=w>      </span><span class=nx>select</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-29><a id=__codelineno-34-29 name=__codelineno-34-29 href=#__codelineno-34-29></a><span class=w>        </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-34-30><a id=__codelineno-34-30 name=__codelineno-34-30 href=#__codelineno-34-30></a><span class=w>        </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-34-31><a id=__codelineno-34-31 name=__codelineno-34-31 href=#__codelineno-34-31></a><span class=w>        </span><span class=nx>plex_username</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-34-32><a id=__codelineno-34-32 name=__codelineno-34-32 href=#__codelineno-34-32></a><span class=w>        </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-34-33><a id=__codelineno-34-33 name=__codelineno-34-33 href=#__codelineno-34-33></a><span class=w>        </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-34-34><a id=__codelineno-34-34 name=__codelineno-34-34 href=#__codelineno-34-34></a><span class=w>        </span><span class=nx>created_at</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-34-35><a id=__codelineno-34-35 name=__codelineno-34-35 href=#__codelineno-34-35></a><span class=w>        </span><span class=nx>last_login_at</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-34-36><a id=__codelineno-34-36 name=__codelineno-34-36 href=#__codelineno-34-36></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-34-37><a id=__codelineno-34-37 name=__codelineno-34-37 href=#__codelineno-34-37></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-34-38><a id=__codelineno-34-38 name=__codelineno-34-38 href=#__codelineno-34-38></a>
</span><span id=__span-34-39><a id=__codelineno-34-39 name=__codelineno-34-39 href=#__codelineno-34-39></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>users</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-34-40><a id=__codelineno-34-40 name=__codelineno-34-40 href=#__codelineno-34-40></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-41><a id=__codelineno-34-41 name=__codelineno-34-41 href=#__codelineno-34-41></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-34-42><a id=__codelineno-34-42 name=__codelineno-34-42 href=#__codelineno-34-42></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Failed to fetch users&quot;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-34-43><a id=__codelineno-34-43 name=__codelineno-34-43 href=#__codelineno-34-43></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>500</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-34-44><a id=__codelineno-34-44 name=__codelineno-34-44 href=#__codelineno-34-44></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-34-45><a id=__codelineno-34-45 name=__codelineno-34-45 href=#__codelineno-34-45></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-34-46><a id=__codelineno-34-46 name=__codelineno-34-46 href=#__codelineno-34-46></a><span class=p>}</span>
</span></code></pre></div><h3 id=103-client-side-protected-component>10.3 Client-Side Protected Component<a class=headerlink href=#103-client-side-protected-component title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=c1>// components/ProtectedContent.tsx</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=s2>&quot;use client&quot;</span><span class=p>;</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>useSession</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next-auth/react&quot;</span><span class=p>;</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>redirect</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;next/navigation&quot;</span><span class=p>;</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>useAuthorization</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/hooks/useAuthorization&quot;</span><span class=p>;</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=kd>interface</span><span class=w> </span><span class=nx>ProtectedContentProps</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=w>  </span><span class=nx>children</span><span class=o>:</span><span class=w> </span><span class=kt>React.ReactNode</span><span class=p>;</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=w>  </span><span class=nx>resource?</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=w>  </span><span class=nx>action?</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>;</span>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=w>  </span><span class=nx>fallback?</span><span class=o>:</span><span class=w> </span><span class=kt>React.ReactNode</span><span class=p>;</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=p>}</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>ProtectedContent</span><span class=p>({</span>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=w>  </span><span class=nx>children</span><span class=p>,</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a><span class=w>  </span><span class=nx>resource</span><span class=p>,</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=w>  </span><span class=nx>action</span><span class=p>,</span>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a><span class=w>  </span><span class=nx>fallback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span><span class=nx>Access</span><span class=w> </span><span class=nx>Denied</span><span class=o>&lt;</span><span class=err>/div&gt;,</span>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a><span class=p>}</span><span class=o>:</span><span class=w> </span><span class=nx>ProtectedContentProps</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>session</span><span class=p>,</span><span class=w> </span><span class=nx>status</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useSession</span><span class=p>({</span>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a><span class=w>    </span><span class=nx>required</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a><span class=w>    </span><span class=nx>onUnauthenticated</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-24><a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a><span class=w>      </span><span class=nx>redirect</span><span class=p>(</span><span class=s2>&quot;/auth/signin&quot;</span><span class=p>);</span>
</span><span id=__span-35-25><a id=__codelineno-35-25 name=__codelineno-35-25 href=#__codelineno-35-25></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-35-26><a id=__codelineno-35-26 name=__codelineno-35-26 href=#__codelineno-35-26></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-35-27><a id=__codelineno-35-27 name=__codelineno-35-27 href=#__codelineno-35-27></a>
</span><span id=__span-35-28><a id=__codelineno-35-28 name=__codelineno-35-28 href=#__codelineno-35-28></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>can</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>useAuthorization</span><span class=p>();</span>
</span><span id=__span-35-29><a id=__codelineno-35-29 name=__codelineno-35-29 href=#__codelineno-35-29></a>
</span><span id=__span-35-30><a id=__codelineno-35-30 name=__codelineno-35-30 href=#__codelineno-35-30></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>status</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;loading&quot;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-31><a id=__codelineno-35-31 name=__codelineno-35-31 href=#__codelineno-35-31></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span><span class=nx>Loading</span><span class=p>...</span><span class=o>&lt;</span><span class=err>/div&gt;;</span>
</span><span id=__span-35-32><a id=__codelineno-35-32 name=__codelineno-35-32 href=#__codelineno-35-32></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-35-33><a id=__codelineno-35-33 name=__codelineno-35-33 href=#__codelineno-35-33></a>
</span><span id=__span-35-34><a id=__codelineno-35-34 name=__codelineno-35-34 href=#__codelineno-35-34></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>resource</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>action</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=nx>can</span><span class=p>(</span><span class=nx>resource</span><span class=p>,</span><span class=w> </span><span class=nx>action</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-35><a id=__codelineno-35-35 name=__codelineno-35-35 href=#__codelineno-35-35></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&lt;&gt;</span><span class=p>{</span><span class=nx>fallback</span><span class=p>}</span><span class=o>&lt;</span><span class=err>/&gt;;</span>
</span><span id=__span-35-36><a id=__codelineno-35-36 name=__codelineno-35-36 href=#__codelineno-35-36></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-35-37><a id=__codelineno-35-37 name=__codelineno-35-37 href=#__codelineno-35-37></a>
</span><span id=__span-35-38><a id=__codelineno-35-38 name=__codelineno-35-38 href=#__codelineno-35-38></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=o>&lt;&gt;</span><span class=p>{</span><span class=nx>children</span><span class=p>}</span><span class=o>&lt;</span><span class=err>/&gt;;</span>
</span><span id=__span-35-39><a id=__codelineno-35-39 name=__codelineno-35-39 href=#__codelineno-35-39></a><span class=p>}</span>
</span></code></pre></div><h2 id=11-testing-strategy>11. Testing Strategy<a class=headerlink href=#11-testing-strategy title="Permanent link">&para;</a></h2><h3 id=111-unit-tests>11.1 Unit Tests<a class=headerlink href=#111-unit-tests title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=c1>// __tests__/auth/plex.test.ts</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>describe</span><span class=p>,</span><span class=w> </span><span class=nx>it</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=p>,</span><span class=w> </span><span class=nx>vi</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;vitest&quot;</span><span class=p>;</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>generatePlexPin</span><span class=p>,</span><span class=w> </span><span class=nx>pollForPlexToken</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/lib/plex&quot;</span><span class=p>;</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=nx>describe</span><span class=p>(</span><span class=s2>&quot;Plex Authentication&quot;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s2>&quot;should generate a valid PIN&quot;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>mockResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;123&quot;</span><span class=p>,</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=w>      </span><span class=nx>code</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;ABCD&quot;</span><span class=p>,</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=w>      </span><span class=nx>authToken</span><span class=o>:</span><span class=w> </span><span class=kt>null</span><span class=p>,</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=w>    </span><span class=nx>vi</span><span class=p>.</span><span class=nx>mocked</span><span class=p>(</span><span class=nx>fetch</span><span class=p>).</span><span class=nx>mockResolvedValueOnce</span><span class=p>({</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=w>      </span><span class=nx>ok</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=w>      </span><span class=nx>json</span><span class=o>:</span><span class=w> </span><span class=kt>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>mockResponse</span><span class=p>,</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>Response</span><span class=p>);</span>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>generatePlexPin</span><span class=p>({</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=w>      </span><span class=nx>clientId</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;test-client&quot;</span><span class=p>,</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=w>      </span><span class=nx>clientName</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;Test App&quot;</span><span class=p>,</span>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>).</span><span class=nx>toEqual</span><span class=p>({</span>
</span><span id=__span-36-24><a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a><span class=w>      </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;123&quot;</span><span class=p>,</span>
</span><span id=__span-36-25><a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a><span class=w>      </span><span class=nx>code</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;ABCD&quot;</span><span class=p>,</span>
</span><span id=__span-36-26><a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a><span class=w>      </span><span class=nx>authUrl</span><span class=o>:</span><span class=w> </span><span class=kt>expect.stringContaining</span><span class=p>(</span><span class=s2>&quot;ABCD&quot;</span><span class=p>),</span>
</span><span id=__span-36-27><a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-36-28><a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-36-29><a id=__codelineno-36-29 name=__codelineno-36-29 href=#__codelineno-36-29></a>
</span><span id=__span-36-30><a id=__codelineno-36-30 name=__codelineno-36-30 href=#__codelineno-36-30></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s2>&quot;should poll for token successfully&quot;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-31><a id=__codelineno-36-31 name=__codelineno-36-31 href=#__codelineno-36-31></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>mockResponses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-36-32><a id=__codelineno-36-32 name=__codelineno-36-32 href=#__codelineno-36-32></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>authToken</span><span class=o>:</span><span class=w> </span><span class=kt>null</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=c1>// First poll - not ready</span>
</span><span id=__span-36-33><a id=__codelineno-36-33 name=__codelineno-36-33 href=#__codelineno-36-33></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>authToken</span><span class=o>:</span><span class=w> </span><span class=kt>null</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=c1>// Second poll - not ready</span>
</span><span id=__span-36-34><a id=__codelineno-36-34 name=__codelineno-36-34 href=#__codelineno-36-34></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>authToken</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;test-token&quot;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=c1>// Third poll - success</span>
</span><span id=__span-36-35><a id=__codelineno-36-35 name=__codelineno-36-35 href=#__codelineno-36-35></a><span class=w>    </span><span class=p>];</span>
</span><span id=__span-36-36><a id=__codelineno-36-36 name=__codelineno-36-36 href=#__codelineno-36-36></a>
</span><span id=__span-36-37><a id=__codelineno-36-37 name=__codelineno-36-37 href=#__codelineno-36-37></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=nx>callCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>0</span><span class=p>;</span>
</span><span id=__span-36-38><a id=__codelineno-36-38 name=__codelineno-36-38 href=#__codelineno-36-38></a><span class=w>    </span><span class=nx>vi</span><span class=p>.</span><span class=nx>mocked</span><span class=p>(</span><span class=nx>fetch</span><span class=p>).</span><span class=nx>mockImplementation</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>({</span>
</span><span id=__span-36-39><a id=__codelineno-36-39 name=__codelineno-36-39 href=#__codelineno-36-39></a><span class=w>      </span><span class=nx>ok</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-36-40><a id=__codelineno-36-40 name=__codelineno-36-40 href=#__codelineno-36-40></a><span class=w>      </span><span class=nx>json</span><span class=o>:</span><span class=w> </span><span class=kt>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>mockResponses</span><span class=p>[</span><span class=nx>callCount</span><span class=o>++</span><span class=p>],</span>
</span><span id=__span-36-41><a id=__codelineno-36-41 name=__codelineno-36-41 href=#__codelineno-36-41></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>Response</span><span class=p>));</span>
</span><span id=__span-36-42><a id=__codelineno-36-42 name=__codelineno-36-42 href=#__codelineno-36-42></a>
</span><span id=__span-36-43><a id=__codelineno-36-43 name=__codelineno-36-43 href=#__codelineno-36-43></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>pollForPlexToken</span><span class=p>(</span><span class=s2>&quot;123&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;test-client&quot;</span><span class=p>);</span>
</span><span id=__span-36-44><a id=__codelineno-36-44 name=__codelineno-36-44 href=#__codelineno-36-44></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>token</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s2>&quot;test-token&quot;</span><span class=p>);</span>
</span><span id=__span-36-45><a id=__codelineno-36-45 name=__codelineno-36-45 href=#__codelineno-36-45></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>fetch</span><span class=p>).</span><span class=nx>toHaveBeenCalledTimes</span><span class=p>(</span><span class=mf>3</span><span class=p>);</span>
</span><span id=__span-36-46><a id=__codelineno-36-46 name=__codelineno-36-46 href=#__codelineno-36-46></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-36-47><a id=__codelineno-36-47 name=__codelineno-36-47 href=#__codelineno-36-47></a><span class=p>});</span>
</span></code></pre></div><h3 id=112-integration-tests>11.2 Integration Tests<a class=headerlink href=#112-integration-tests title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=c1>// __tests__/api/auth.test.ts</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>createMocks</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;node-mocks-http&quot;</span><span class=p>;</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>POST</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>signInHandler</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;@/app/api/auth/[...nextauth]/route&quot;</span><span class=p>;</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=nx>describe</span><span class=p>(</span><span class=s2>&quot;/api/auth/[...nextauth]&quot;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s2>&quot;should handle Plex sign in&quot;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>createMocks</span><span class=p>({</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=w>      </span><span class=nx>method</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;POST&quot;</span><span class=p>,</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=w>      </span><span class=nx>body</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=w>        </span><span class=nx>csrfToken</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;test-csrf&quot;</span><span class=p>,</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=w>        </span><span class=nx>callbackUrl</span><span class=o>:</span><span class=w> </span><span class=s2>&quot;/dashboard&quot;</span><span class=p>,</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>signInHandler</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>);</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17 href=#__codelineno-37-17></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>_getStatusCode</span><span class=p>()).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18 href=#__codelineno-37-18></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>_getData</span><span class=p>());</span>
</span><span id=__span-37-19><a id=__codelineno-37-19 name=__codelineno-37-19 href=#__codelineno-37-19></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>json</span><span class=p>).</span><span class=nx>toHaveProperty</span><span class=p>(</span><span class=s2>&quot;url&quot;</span><span class=p>);</span>
</span><span id=__span-37-20><a id=__codelineno-37-20 name=__codelineno-37-20 href=#__codelineno-37-20></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-37-21><a id=__codelineno-37-21 name=__codelineno-37-21 href=#__codelineno-37-21></a><span class=p>});</span>
</span></code></pre></div><h2 id=12-troubleshooting>12. Troubleshooting<a class=headerlink href=#12-troubleshooting title="Permanent link">&para;</a></h2><h3 id=common-issues-and-solutions>Common Issues and Solutions<a class=headerlink href=#common-issues-and-solutions title="Permanent link">&para;</a></h3><h4 id=1-pin-expires-before-user-authenticates>1. PIN Expires Before User Authenticates<a class=headerlink href=#1-pin-expires-before-user-authenticates title="Permanent link">&para;</a></h4><p><strong>Problem</strong>: User takes too long to enter PIN<br><strong>Solution</strong>: - Increase polling duration in client - Add countdown timer to UI - Implement PIN refresh mechanism</p><h4 id=2-session-expires-unexpectedly>2. Session Expires Unexpectedly<a class=headerlink href=#2-session-expires-unexpectedly title="Permanent link">&para;</a></h4><p><strong>Problem</strong>: Users complaining about frequent logouts<br><strong>Solution</strong>: - Check Redis connection stability - Verify JWT expiration settings - Implement session refresh on activity</p><h4 id=3-rate-limiting-too-aggressive>3. Rate Limiting Too Aggressive<a class=headerlink href=#3-rate-limiting-too-aggressive title="Permanent link">&para;</a></h4><p><strong>Problem</strong>: Legitimate users hitting rate limits<br><strong>Solution</strong>: <div class="language-typescript highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=c1>// Implement graduated rate limiting</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=kd>const</span><span class=w> </span><span class=nx>rateLimits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=w>  </span><span class=nx>unauthenticated</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>windowMs</span><span class=o>:</span><span class=w> </span><span class=kt>60000</span><span class=p>,</span><span class=w> </span><span class=nx>max</span><span class=o>:</span><span class=w> </span><span class=kt>20</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=w>  </span><span class=nx>authenticated</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>windowMs</span><span class=o>:</span><span class=w> </span><span class=kt>60000</span><span class=p>,</span><span class=w> </span><span class=nx>max</span><span class=o>:</span><span class=w> </span><span class=kt>100</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>  </span><span class=nx>admin</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>windowMs</span><span class=o>:</span><span class=w> </span><span class=kt>60000</span><span class=p>,</span><span class=w> </span><span class=nx>max</span><span class=o>:</span><span class=w> </span><span class=kt>500</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=p>};</span>
</span></code></pre></div></p><h4 id=4-plex-token-invalid>4. Plex Token Invalid<a class=headerlink href=#4-plex-token-invalid title="Permanent link">&para;</a></h4><p><strong>Problem</strong>: Stored Plex tokens becoming invalid<br><strong>Solution</strong>: - Implement token validation on each use - Add automatic re-authentication flow - Monitor Plex API changes</p><h3 id=debug-logging>Debug Logging<a class=headerlink href=#debug-logging title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=c1>// lib/auth/debug.ts</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=k>import</span><span class=w> </span><span class=nx>winston</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s2>&quot;winston&quot;</span><span class=p>;</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=kd>const</span><span class=w> </span><span class=nx>authLogger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>winston</span><span class=p>.</span><span class=nx>createLogger</span><span class=p>({</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=w>  </span><span class=nx>level</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.NODE_ENV</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s2>&quot;production&quot;</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s2>&quot;info&quot;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s2>&quot;debug&quot;</span><span class=p>,</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=w>  </span><span class=nx>format</span><span class=o>:</span><span class=w> </span><span class=kt>winston.format.json</span><span class=p>(),</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=w>  </span><span class=nx>transports</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=w>    </span><span class=ow>new</span><span class=w> </span><span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>({</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=w>      </span><span class=nx>format</span><span class=o>:</span><span class=w> </span><span class=kt>winston.format.simple</span><span class=p>(),</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a><span class=w>  </span><span class=p>],</span>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a><span class=p>});</span>
</span><span id=__span-39-13><a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a>
</span><span id=__span-39-14><a id=__codelineno-39-14 name=__codelineno-39-14 href=#__codelineno-39-14></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>logAuthEvent</span><span class=p>(</span><span class=nx>event</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-15><a id=__codelineno-39-15 name=__codelineno-39-15 href=#__codelineno-39-15></a><span class=w>  </span><span class=nx>authLogger</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=s2>&quot;AUTH_EVENT&quot;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-16><a id=__codelineno-39-16 name=__codelineno-39-16 href=#__codelineno-39-16></a><span class=w>    </span><span class=nx>event</span><span class=p>,</span>
</span><span id=__span-39-17><a id=__codelineno-39-17 name=__codelineno-39-17 href=#__codelineno-39-17></a><span class=w>    </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span><span id=__span-39-18><a id=__codelineno-39-18 name=__codelineno-39-18 href=#__codelineno-39-18></a><span class=w>    </span><span class=p>...</span><span class=nx>data</span><span class=p>,</span>
</span><span id=__span-39-19><a id=__codelineno-39-19 name=__codelineno-39-19 href=#__codelineno-39-19></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-39-20><a id=__codelineno-39-20 name=__codelineno-39-20 href=#__codelineno-39-20></a><span class=p>}</span>
</span></code></pre></div><h2 id=conclusion>Conclusion<a class=headerlink href=#conclusion title="Permanent link">&para;</a></h2><p>This authentication architecture provides a secure, scalable foundation for MediaNest. The implementation leverages industry best practices while accommodating the unique requirements of Plex's PIN-based OAuth flow. Regular security audits and monitoring will ensure the system remains robust as the application evolves.</p><h3 id=key-takeaways>Key Takeaways<a class=headerlink href=#key-takeaways title="Permanent link">&para;</a></h3><ol><li><strong>Security First</strong>: Every component implements defense in depth</li><li><strong>User Experience</strong>: Seamless authentication with familiar Plex credentials</li><li><strong>Scalability</strong>: Stateless design supports horizontal scaling</li><li><strong>Maintainability</strong>: Clear separation of concerns and comprehensive testing</li></ol><p>For additional support or questions, refer to the MediaNest development documentation or contact the technical team.</p><aside class=md-source-file><span class=md-source-file__fact><span class=md-icon title="Last update"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="September 5, 2025 23:03:40 UTC"><span class=timeago datetime=2025-09-05T23:03:40+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="September 5, 2025 23:03:40 UTC">2025-09-05</span></span><span class=md-source-file__fact><span class=md-icon title=Created><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="July 2, 2025 08:28:00 UTC"><span class=timeago datetime=2025-07-02T08:28:00+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="July 2, 2025 08:28:00 UTC">2025-07-02</span></span></aside><form class=md-feedback name=feedback hidden><fieldset><legend class=md-feedback__title> Was this page helpful? </legend><div class=md-feedback__inner><div class=md-feedback__list><button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg></button><button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg></button></div><div class=md-feedback__note><div data-md-value=1 hidden> Thanks for your feedback! Consider starring us on <a href=https://github.com/medianest/medianest target=_blank rel=noopener>GitHub</a></div><div data-md-value=0 hidden> Thanks for your feedback! Help us improve by <a href="https://github.com/medianest/medianest/issues/new/?title=[Docs]+MediaNest%20Authentication%20Architecture%20and%20Implementation%20Guide+-+/AUTHENTICATION_ARCHITECTURE/" target=_blank rel=noopener>creating an issue</a> or <a href=https://github.com/medianest/medianest/edit/develop/docs/{path} target=_blank rel=noopener>editing this page</a>. </div></div></div></fieldset></form></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright><div class=md-copyright__highlight> Copyright &copy; 2024 MediaNest Development Team - <a href=#__consent>Manage Cookies</a> | <a href=/privacy>Privacy Policy</a> | <a href=/terms>Terms of Service</a></div></div><div class=md-social><a href=https://github.com/medianest/medianest target=_blank rel=noopener title="GitHub Repository" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg></a><a href=https://hub.docker.com/r/medianest/medianest target=_blank rel=noopener title="Docker Hub" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg></a><a href=https://discord.gg/medianest target=_blank rel=noopener title="Discord Community" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg></a><a href=https://twitter.com/medianest target=_blank rel=noopener title="Twitter Updates" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg></a><a href=https://medianest.com target=_blank rel=noopener title="Official Website" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M351.9 280H161c2.9 64.5 17.2 123.9 37.5 167.4 11.4 24.5 23.7 41.8 35.1 52.4 11.2 10.5 18.9 12.2 22.9 12.2s11.7-1.7 22.9-12.2c11.4-10.6 23.7-28 35.1-52.4 20.3-43.5 34.6-102.9 37.5-167.4zm-191-48h190.9c-2.8-64.5-17.1-123.9-37.4-167.4-11.4-24.4-23.7-41.8-35.1-52.4C268.1 1.7 260.4 0 256.4 0s-11.7 1.7-22.9 12.2c-11.4 10.6-23.7 28-35.1 52.4-20.3 43.5-34.6 102.9-37.5 167.4m-48 0c3.5-85.6 25.6-165.1 57.9-217.3C78.7 47.3 10.9 131.2 1.5 232zM1.5 280c9.4 100.8 77.2 184.7 169.3 217.3-32.3-52.2-54.4-131.7-57.9-217.3zm398.4 0c-3.5 85.6-25.6 165.1-57.9 217.3 92.1-32.7 159.9-116.5 169.3-217.3zm111.4-48C501.9 131.2 434.1 47.3 342 14.7c32.3 52.2 54.4 131.7 57.9 217.3z"/></svg></a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><div class=md-progress data-md-component=progress role=progressbar></div><div class=md-consent data-md-component=consent id=__consent hidden><div class=md-consent__overlay></div><aside class=md-consent__inner><form class="md-consent__form md-grid md-typeset" name=consent><h4>Cookie consent</h4><p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p><input class=md-toggle type=checkbox id=__settings><div class=md-consent__settings><ul class=task-list><li class=task-list-item><label class=task-list-control><input type=checkbox name=analytics checked><span class=task-list-indicator></span> Google Analytics </label></li><li class=task-list-item><label class=task-list-control><input type=checkbox name=github checked><span class=task-list-indicator></span> GitHub </label></li></ul></div><div class=md-consent__controls><button class="md-button md-button--primary">Accept</button><button type=reset class="md-button md-button--primary">Reject</button><label class=md-button for=__settings>Manage settings</label></div></form></aside></div><script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script><script id=__config type=application/json>{"base": "..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"alias": true, "default": "latest", "provider": "mike"}}</script><script src=../assets/javascripts/bundle.92b07e13.min.js></script><script src=../js/timeago.min.js></script><script src=../js/timeago_mkdocs_material.js></script><script src=../assets/javascripts/medianest.js></script><script src=../assets/javascripts/search-enhancements.js></script><script src=../assets/javascripts/analytics.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=https://unpkg.com/mermaid@10/dist/mermaid.min.js></script></body></html>