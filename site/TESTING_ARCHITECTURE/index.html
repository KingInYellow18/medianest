<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete documentation for MediaNest - Advanced Media Management Platform with Plex Integration, API, and Developer Resources"><meta name=author content="MediaNest Development Team"><link href=https://docs.medianest.com/TESTING_ARCHITECTURE/ rel=canonical><link rel=icon href=../assets/images/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.18"><title>MediaNest Test Architecture - MediaNest Documentation</title><link rel=stylesheet href=../assets/stylesheets/main.7e37652d.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../css/timeago.css><link rel=stylesheet href=../assets/stylesheets/extra.css><link rel=stylesheet href=../assets/stylesheets/medianest-theme.css><link rel=stylesheet href=../assets/stylesheets/animations.css><link rel=stylesheet href=../assets/stylesheets/responsive.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=purple><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#medianest-test-architecture class=md-skip> Skip to content </a></div><div data-md-component=announce></div><div data-md-color-scheme=default data-md-component=outdated hidden></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=.. title="MediaNest Documentation" class="md-header__button md-logo" aria-label="MediaNest Documentation" data-md-component=logo><img src=../assets/images/logo.svg alt=logo></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> MediaNest Documentation </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> MediaNest Test Architecture </span></div></div></div><form class=md-header__option data-md-component=palette><input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=deep-purple data-md-color-accent=purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav class=md-search__options aria-label=Search><a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg></a><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav><div class=md-search__suggest data-md-component=search-suggest></div></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div><div class=md-header__source><a href=https://github.com/medianest/medianest title="Go to repository" class=md-source data-md-component=source><div class="md-source__icon md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg></div><div class=md-source__repository> MediaNest/MediaNest </div></a></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=.. class=md-tabs__link> Home </a></li><li class=md-tabs__item><a href=../getting-started/ class=md-tabs__link> Getting Started </a></li><li class=md-tabs__item><a href=../installation/ class=md-tabs__link> Installation </a></li><li class=md-tabs__item><a href=../user-guides/ class=md-tabs__link> User Guides </a></li><li class=md-tabs__item><a href=../api/ class=md-tabs__link> API Reference </a></li><li class=md-tabs__item><a href=../developers/ class=md-tabs__link> Developer Docs </a></li><li class=md-tabs__item><a href=../troubleshooting/ class=md-tabs__link> Troubleshooting </a></li><li class=md-tabs__item><a href=../reference/ class=md-tabs__link> Reference </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=.. title="MediaNest Documentation" class="md-nav__button md-logo" aria-label="MediaNest Documentation" data-md-component=logo><img src=../assets/images/logo.svg alt=logo></a> MediaNest Documentation </label><div class=md-nav__source><a href=https://github.com/medianest/medianest title="Go to repository" class=md-source data-md-component=source><div class="md-source__icon md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg></div><div class=md-source__repository> MediaNest/MediaNest </div></a></div><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=.. class=md-nav__link><span class=md-ellipsis> Home </span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../getting-started/ class=md-nav__link><span class=md-ellipsis> Getting Started </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../installation/ class=md-nav__link><span class=md-ellipsis> Installation </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../user-guides/ class=md-nav__link><span class=md-ellipsis> User Guides </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../api/ class=md-nav__link><span class=md-ellipsis> API Reference </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../developers/ class=md-nav__link><span class=md-ellipsis> Developer Docs </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../troubleshooting/ class=md-nav__link><span class=md-ellipsis> Troubleshooting </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../reference/ class=md-nav__link><span class=md-ellipsis> Reference </span><span class="md-nav__icon md-icon"></span></a></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><a href=https://github.com/medianest/medianest/edit/develop/docs/TESTING_ARCHITECTURE.md title="Edit this page" class="md-content__button md-icon" rel=edit><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg></a><a href=https://github.com/medianest/medianest/raw/develop/docs/TESTING_ARCHITECTURE.md title="View source of this page" class="md-content__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg></a><h1 id=medianest-test-architecture>MediaNest Test Architecture<a class=headerlink href=#medianest-test-architecture title="Permanent link">&para;</a></h1><p><strong>Version:</strong> 3.0<br><strong>Date:</strong> January 12, 2025<br><strong>Status:</strong> Updated - Aligned with Implementation<br><strong>Scope:</strong> Small-scale application (10-20 users) <strong>Last Audit:</strong> January 12, 2025 - 37 test files, 6,500+ lines</p><h2 id=table-of-contents>Table of Contents<a class=headerlink href=#table-of-contents title="Permanent link">&para;</a></h2><ol><li><a href=#1-executive-summary>Executive Summary</a></li><li><a href=#2-pragmatic-testing-approach>Pragmatic Testing Approach</a></li><li><a href=#3-test-implementation>Test Implementation</a></li><li><a href=#4-critical-path-testing>Critical Path Testing</a></li><li><a href=#5-external-service-testing>External Service Testing</a></li><li><a href=#6-simple-cicd-integration>Simple CI/CD Integration</a></li><li><a href=#7-practical-guidelines>Practical Guidelines</a></li></ol><h2 id=1-executive-summary>1. Executive Summary<a class=headerlink href=#1-executive-summary title="Permanent link">&para;</a></h2><p>MediaNest has implemented a <strong>comprehensive and modern test suite</strong> with 43 test files covering 8,800+ lines of test code across frontend, backend, and integration layers. The test architecture leverages Vitest, MSW, and React Testing Library to provide fast, reliable testing for our monolithic Next.js + Express application serving 10-20 concurrent users.</p><h3 id=current-implementation-status>Current Implementation Status<a class=headerlink href=#current-implementation-status title="Permanent link">&para;</a></h3><ul><li>✅ <strong>43 test files</strong> with comprehensive coverage of critical paths</li><li>✅ <strong>Modern stack</strong>: Vitest v1.6.1 + MSW v2.10.2 + React Testing Library</li><li>✅ <strong>Automated setup</strong>: Docker Compose test environment with real databases</li><li>✅ <strong>60% coverage enforced</strong> across both frontend and backend workspaces</li><li>✅ <strong>Real-time testing</strong>: WebSocket, queue processing, and external API mocking</li></ul><h3 id=key-principles-implemented>Key Principles (Implemented)<a class=headerlink href=#key-principles-implemented title="Permanent link">&para;</a></h3><ul><li><strong>Test what matters</strong>: Critical paths (auth, media requests, service status) thoroughly covered</li><li><strong>Modern tooling</strong>: Using 2025 best practices with Vitest and MSW v2</li><li><strong>Fast feedback</strong>: Vitest provides sub-second test startup with HMR-like performance</li><li><strong>Practical coverage</strong>: 60% minimum enforced, targeting 70% for critical components</li></ul><h2 id=2-pragmatic-testing-approach>2. Pragmatic Testing Approach<a class=headerlink href=#2-pragmatic-testing-approach title="Permanent link">&para;</a></h2><h3 id=21-testing-focus-areas>2.1 Testing Focus Areas<a class=headerlink href=#21-testing-focus-areas title="Permanent link">&para;</a></h3><p>Instead of rigid percentages, we test based on risk and value:</p><ol><li><p><strong>Critical Paths (High Priority)</strong></p></li><li><p>Plex OAuth authentication flow</p></li><li>Media request submission</li><li>Service status monitoring</li><li><p>Rate limiting enforcement</p></li><li><p><strong>Core Features (Medium Priority)</strong></p></li><li><p>YouTube download functionality</p></li><li>User data isolation</li><li>Error handling and fallbacks</li><li><p>WebSocket connections</p></li><li><p><strong>Nice-to-Have (Low Priority)</strong></p></li><li>UI component variations</li><li>Edge case scenarios</li><li>Performance optimizations</li></ol><h3 id=22-simplified-standards>2.2 Simplified Standards<a class=headerlink href=#22-simplified-standards title="Permanent link">&para;</a></h3><ul><li><strong>Coverage Goals</strong>: 60-70% overall (not a hard requirement)</li><li><strong>Test Execution</strong>: Under 5 minutes for full suite</li><li><strong>Flaky Tests</strong>: Fix immediately or remove</li></ul><h2 id=3-test-implementation>3. Test Implementation<a class=headerlink href=#3-test-implementation title="Permanent link">&para;</a></h2><h3 id=31-test-types-currently-implemented>3.1 Test Types (Currently Implemented)<a class=headerlink href=#31-test-types-currently-implemented title="Permanent link">&para;</a></h3><table><thead><tr><th>Test Type</th><th>Purpose</th><th>Tools</th><th>Coverage</th><th>Status</th></tr></thead><tbody><tr><td>Unit Tests</td><td>Business logic, utilities</td><td>Vitest</td><td>4 files (backend)</td><td>✅ Implemented</td></tr><tr><td>Component Tests</td><td>React components, hooks</td><td>Vitest + RTL</td><td>18 files (frontend)</td><td>✅ Implemented</td></tr><tr><td>API Tests</td><td>Endpoint validation</td><td>Vitest + Supertest</td><td>10 files (backend)</td><td>✅ Implemented</td></tr><tr><td>Integration Tests</td><td>External services</td><td>Vitest + MSW v2.10.2</td><td>Comprehensive</td><td>✅ Implemented</td></tr><tr><td>E2E Tests</td><td>Critical user flows</td><td>Playwright v1.41.0</td><td>3 files</td><td>✅ Implemented</td></tr></tbody></table><h3 id=32-what-were-successfully-doing>3.2 What We're Successfully Doing<a class=headerlink href=#32-what-were-successfully-doing title="Permanent link">&para;</a></h3><ul><li>✅ <strong>Modern MSW v2.10.2</strong>: Realistic HTTP interception with browser/Node.js support</li><li>✅ <strong>Real Database Testing</strong>: PostgreSQL (port 5433) + Redis (port 6380)</li><li>✅ <strong>Automated Setup</strong>: <code>run-tests.sh</code> script with Docker Compose management</li><li>✅ <strong>Comprehensive Mocking</strong>: Plex, Overseerr, Uptime Kuma APIs fully mocked</li></ul><h3 id=33-current-test-environment>3.3 Current Test Environment<a class=headerlink href=#33-current-test-environment title="Permanent link">&para;</a></h3><p><strong>Actual Implementation:</strong></p><div class="language-yaml highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># docker-compose.test.yml (IMPLEMENTED)</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&#39;3.8&#39;</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=nt>services</span><span class=p>:</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>  </span><span class=nt>postgres-test</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15-alpine</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>    </span><span class=nt>environment</span><span class=p>:</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>      </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">medianest_test</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;5433:5432&#39;</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>  </span><span class=nt>redis-test</span><span class=p>:</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;6380:6379&#39;</span>
</span></code></pre></div><p><strong>Automated Management:</strong></p><ul><li><code>./run-tests.sh</code> - Handles Docker Compose lifecycle</li><li>Automatic database migrations on test startup</li><li>Proper cleanup between test runs</li></ul><h3 id=34-testing-tool-choices-current-implementation>3.4 Testing Tool Choices (Current Implementation)<a class=headerlink href=#34-testing-tool-choices-current-implementation title="Permanent link">&para;</a></h3><h4 id=why-these-tools-were-selected-2025-best-practices>Why These Tools Were Selected (2025 Best Practices):<a class=headerlink href=#why-these-tools-were-selected-2025-best-practices title="Permanent link">&para;</a></h4><ol><li><p><strong>Vitest v1.6.1</strong> ✅ <strong>IMPLEMENTED</strong></p></li><li><p>✅ Native ESM support for Next.js 14 App Router</p></li><li>✅ Sub-second test startup with Vite's HMR-like performance</li><li>✅ Built-in TypeScript support with zero configuration</li><li>✅ Jest-compatible API enabling easy migration</li><li><p>✅ V8 coverage provider for accurate reporting</p></li><li><p><strong>MSW v2.10.2</strong> ✅ <strong>IMPLEMENTED</strong></p></li><li><p>✅ Works seamlessly in both Node.js tests and browser development</p></li><li>✅ Network-level request interception (more realistic than mocks)</li><li>✅ Excellent TypeScript support with request/response typing</li><li><p>✅ Modern Service Worker approach for browser environments</p></li><li><p><strong>React Testing Library</strong> ✅ <strong>IMPLEMENTED</strong></p></li><li><p>✅ Component testing focused on user behavior</p></li><li>✅ Excellent integration with Vitest</li><li><p>✅ Encourages accessible and maintainable tests</p></li><li><p><strong>Supertest v6.3.4</strong> ✅ <strong>IMPLEMENTED</strong></p></li><li><p>✅ Industry standard for Express API testing</p></li><li>✅ Perfect integration with Vitest</li><li><p>✅ Mature, stable, and well-documented</p></li><li><p><strong>Real Databases (not Testcontainers)</strong> ✅ <strong>IMPLEMENTED</strong></p></li><li><p>✅ Dedicated PostgreSQL test instance (port 5433)</p></li><li>✅ Dedicated Redis test instance (port 6380)</li><li>✅ Simpler than Testcontainers for our 10-20 user scale</li><li><p>✅ Faster setup and teardown for continuous testing</p></li><li><p><strong>Playwright</strong> ❌ <strong>NOT IMPLEMENTED</strong></p></li><li>📋 Planned for E2E testing implementation</li><li>📋 Infrastructure exists but no actual tests yet</li></ol><h2 id=4-technology-stack-testing>4. Technology Stack Testing<a class=headerlink href=#4-technology-stack-testing title="Permanent link">&para;</a></h2><h3 id=41-current-testing-stack-implemented>4.1 Current Testing Stack (Implemented)<a class=headerlink href=#41-current-testing-stack-implemented title="Permanent link">&para;</a></h3><h4 id=core-testing-dependencies-verified>Core Testing Dependencies (VERIFIED)<a class=headerlink href=#core-testing-dependencies-verified title="Permanent link">&para;</a></h4><div class="language-json highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=p>{</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>  </span><span class=nt>&quot;devDependencies&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=c1>// Testing Framework (✅ IMPLEMENTED)</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span><span class=nt>&quot;vitest&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^1.6.1&quot;</span><span class=p>,</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>    </span><span class=nt>&quot;@vitest/ui&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^1.6.1&quot;</span><span class=p>,</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>    </span><span class=nt>&quot;@vitest/coverage-v8&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^1.6.1&quot;</span><span class=p>,</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>    </span><span class=c1>// Frontend Testing (✅ IMPLEMENTED)</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>    </span><span class=nt>&quot;@testing-library/react&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^14.3.1&quot;</span><span class=p>,</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>    </span><span class=nt>&quot;@testing-library/user-event&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^14.5.0&quot;</span><span class=p>,</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>    </span><span class=nt>&quot;@testing-library/jest-dom&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^6.2.0&quot;</span><span class=p>,</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>    </span><span class=c1>// API Testing (✅ IMPLEMENTED)</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=w>    </span><span class=nt>&quot;supertest&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^6.3.4&quot;</span><span class=p>,</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=w>    </span><span class=c1>// Modern Mocking (✅ IMPLEMENTED)</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=w>    </span><span class=nt>&quot;msw&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^2.10.2&quot;</span><span class=p>,</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=w>    </span><span class=c1>// E2E Testing (✅ IMPLEMENTED)</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a><span class=w>    </span><span class=nt>&quot;@playwright/test&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^1.41.0&quot;</span><span class=p>,</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a><span class=w>    </span><span class=c1>// Queue Testing (✅ IMPLEMENTED)</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a><span class=w>    </span><span class=nt>&quot;bullmq&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;^5.1.0&quot;</span>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a><span class=p>}</span>
</span></code></pre></div><h4 id=test-infrastructure-verified-implementation>Test Infrastructure (VERIFIED IMPLEMENTATION)<a class=headerlink href=#test-infrastructure-verified-implementation title="Permanent link">&para;</a></h4><ul><li>✅ <strong>43 test files</strong> across backend, frontend, and E2E</li><li>✅ <strong>8,800+ lines</strong> of test code</li><li>✅ <strong>Real databases</strong>: PostgreSQL:5433, Redis:6380</li><li>✅ <strong>Automated setup</strong>: <code>run-tests.sh</code> Docker Compose management</li><li>✅ <strong>MSW handlers</strong>: Comprehensive mocking for Plex, Overseerr, Uptime Kuma</li><li>✅ <strong>Coverage enforcement</strong>: 60% minimum thresholds</li><li>✅ <strong>E2E tests</strong>: Auth flow, service status, media requests</li></ul><div class="language-text highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>#### Vitest Configuration (ACTUAL IMPLEMENTATION)
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>**Backend Configuration** (`backend/vitest.config.ts`):
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>```typescript
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>import { defineConfig } from &#39;vitest/config&#39;
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>import path from &#39;path&#39;
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>export default defineConfig({
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>  test: {
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>    environment: &#39;node&#39;,           // ✅ Server-side testing
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>    setupFiles: [&#39;./tests/setup.ts&#39;],
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>    globals: true,
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>    testTimeout: 30000,            // ✅ 30s for integration tests
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>    coverage: {
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>      provider: &#39;v8&#39;,              // ✅ Modern V8 coverage
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>      reporter: [&#39;text&#39;, &#39;json&#39;, &#39;html&#39;],
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a>      exclude: [
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>        &#39;node_modules/&#39;,
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>        &#39;tests/&#39;,
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>        &#39;**/*.d.ts&#39;,
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>        &#39;**/*.config.*&#39;
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a>      ],
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>      thresholds: {                // ✅ 60% minimum enforced
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>        branches: 60,
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a>        functions: 60,
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>        lines: 60,
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a>        statements: 60
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a>      }
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a>    },
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a>    pool: &#39;forks&#39;,                 // ✅ Process isolation
</span><span id=__span-2-31><a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a>    poolOptions: {
</span><span id=__span-2-32><a id=__codelineno-2-32 name=__codelineno-2-32 href=#__codelineno-2-32></a>      forks: {
</span><span id=__span-2-33><a id=__codelineno-2-33 name=__codelineno-2-33 href=#__codelineno-2-33></a>        singleFork: true           // ✅ Database test isolation
</span><span id=__span-2-34><a id=__codelineno-2-34 name=__codelineno-2-34 href=#__codelineno-2-34></a>      }
</span><span id=__span-2-35><a id=__codelineno-2-35 name=__codelineno-2-35 href=#__codelineno-2-35></a>    }
</span><span id=__span-2-36><a id=__codelineno-2-36 name=__codelineno-2-36 href=#__codelineno-2-36></a>  },
</span><span id=__span-2-37><a id=__codelineno-2-37 name=__codelineno-2-37 href=#__codelineno-2-37></a>  resolve: {
</span><span id=__span-2-38><a id=__codelineno-2-38 name=__codelineno-2-38 href=#__codelineno-2-38></a>    alias: {
</span><span id=__span-2-39><a id=__codelineno-2-39 name=__codelineno-2-39 href=#__codelineno-2-39></a>      &#39;@&#39;: path.resolve(__dirname, &#39;./src&#39;)
</span><span id=__span-2-40><a id=__codelineno-2-40 name=__codelineno-2-40 href=#__codelineno-2-40></a>    }
</span><span id=__span-2-41><a id=__codelineno-2-41 name=__codelineno-2-41 href=#__codelineno-2-41></a>  }
</span><span id=__span-2-42><a id=__codelineno-2-42 name=__codelineno-2-42 href=#__codelineno-2-42></a>})
</span></code></pre></div><p><strong>Frontend Configuration</strong> (<code>frontend/vitest.config.mts</code>):</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>defineConfig</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest/config&#39;</span><span class=p>;</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=k>import</span><span class=w> </span><span class=nx>react</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@vitejs/plugin-react&#39;</span><span class=p>;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=k>import</span><span class=w> </span><span class=nx>path</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nx>defineConfig</span><span class=p>({</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>  </span><span class=nx>plugins</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=nx>react</span><span class=p>()],</span><span class=w> </span><span class=c1>// ✅ React support</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>  </span><span class=nx>test</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>    </span><span class=nx>environment</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;jsdom&#39;</span><span class=p>,</span><span class=w> </span><span class=c1>// ✅ DOM testing environment</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>    </span><span class=nx>setupFiles</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;./tests/setup.ts&#39;</span><span class=p>],</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>    </span><span class=nx>globals</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>    </span><span class=nx>coverage</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>      </span><span class=nx>provider</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;v8&#39;</span><span class=p>,</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>      </span><span class=nx>reporter</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;json&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;html&#39;</span><span class=p>],</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>      </span><span class=nx>thresholds</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>        </span><span class=c1>// ✅ Same standards as backend</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>        </span><span class=nx>branches</span><span class=o>:</span><span class=w> </span><span class=kt>60</span><span class=p>,</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>        </span><span class=nx>functions</span><span class=o>:</span><span class=w> </span><span class=kt>60</span><span class=p>,</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>        </span><span class=nx>lines</span><span class=o>:</span><span class=w> </span><span class=kt>60</span><span class=p>,</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>        </span><span class=nx>statements</span><span class=o>:</span><span class=w> </span><span class=kt>60</span><span class=p>,</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>    </span><span class=nx>pool</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;threads&#39;</span><span class=p>,</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>    </span><span class=nx>poolOptions</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>      </span><span class=nx>threads</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=w>        </span><span class=nx>singleThread</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span><span class=w> </span><span class=c1>// ✅ Consistent execution</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a><span class=w>  </span><span class=nx>resolve</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a><span class=w>    </span><span class=nx>alias</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a><span class=w>      </span><span class=c1>// ✅ Path aliases for clean imports</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a><span class=w>      </span><span class=s1>&#39;@&#39;</span><span class=o>:</span><span class=w> </span><span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;./src&#39;</span><span class=p>),</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a><span class=w>      </span><span class=s1>&#39;@/components&#39;</span><span class=o>:</span><span class=w> </span><span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;./src/components&#39;</span><span class=p>),</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a><span class=w>      </span><span class=s1>&#39;@/lib&#39;</span><span class=o>:</span><span class=w> </span><span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;./src/lib&#39;</span><span class=p>),</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a><span class=p>});</span>
</span></code></pre></div><h4 id=test-setup-files-actual-implementation>Test Setup Files (ACTUAL IMPLEMENTATION)<a class=headerlink href=#test-setup-files-actual-implementation title="Permanent link">&para;</a></h4><p><strong>Backend Setup</strong> (<code>backend/tests/setup.ts</code>):</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>beforeAll</span><span class=p>,</span><span class=w> </span><span class=nx>afterEach</span><span class=p>,</span><span class=w> </span><span class=nx>afterAll</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span><span class=p>;</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>server</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./mocks/server&#39;</span><span class=p>;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=c1>// ✅ MSW Server lifecycle management</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=nx>beforeAll</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>({</span><span class=w> </span><span class=nx>onUnhandledRequest</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;error&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=p>});</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=nx>afterEach</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>resetHandlers</span><span class=p>();</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=p>});</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=nx>afterAll</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=p>});</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=c1>// ✅ Global test utilities (IMPLEMENTED)</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=k>export</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>createTestUser</span><span class=p>,</span><span class=w> </span><span class=nx>createTestJWT</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./helpers/auth&#39;</span><span class=p>;</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=k>export</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>setupTestDB</span><span class=p>,</span><span class=w> </span><span class=nx>cleanupTestDB</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./helpers/database&#39;</span><span class=p>;</span>
</span></code></pre></div><p><strong>Frontend Setup</strong> (<code>frontend/tests/setup.ts</code>):</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>import</span><span class=w> </span><span class=s1>&#39;@testing-library/jest-dom/vitest&#39;</span><span class=p>;</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>cleanup</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@testing-library/react&#39;</span><span class=p>;</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>afterEach</span><span class=p>,</span><span class=w> </span><span class=nx>vi</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span><span class=p>;</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=c1>// ✅ React Testing Library cleanup</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=nx>afterEach</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>  </span><span class=nx>cleanup</span><span class=p>();</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=p>});</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=c1>// ✅ Socket.io mocking (COMPREHENSIVE IMPLEMENTATION)</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=nx>vi</span><span class=p>.</span><span class=nx>mock</span><span class=p>(</span><span class=s1>&#39;socket.io-client&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>({</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=w>  </span><span class=nx>io</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>({</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=w>    </span><span class=nx>on</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=w>    </span><span class=nx>off</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=w>    </span><span class=nx>emit</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=w>    </span><span class=nx>disconnect</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=w>    </span><span class=nx>connected</span><span class=o>:</span><span class=w> </span><span class=kt>false</span><span class=p>,</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=w>  </span><span class=p>})),</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=p>}));</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=c1>// ✅ Window.matchMedia mocking</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=nb>Object</span><span class=p>.</span><span class=nx>defineProperty</span><span class=p>(</span><span class=nb>window</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;matchMedia&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=w>  </span><span class=nx>writable</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=w>  </span><span class=nx>value</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>().</span><span class=nx>mockImplementation</span><span class=p>((</span><span class=nx>query</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>({</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=w>    </span><span class=nx>matches</span><span class=o>:</span><span class=w> </span><span class=kt>false</span><span class=p>,</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a><span class=w>    </span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=kt>query</span><span class=p>,</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a><span class=w>    </span><span class=nx>onchange</span><span class=o>:</span><span class=w> </span><span class=kt>null</span><span class=p>,</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=w>    </span><span class=nx>addListener</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a><span class=w>    </span><span class=nx>removeListener</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a><span class=w>    </span><span class=nx>addEventListener</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a><span class=w>    </span><span class=nx>removeEventListener</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a><span class=w>    </span><span class=nx>dispatchEvent</span><span class=o>:</span><span class=w> </span><span class=kt>vi.fn</span><span class=p>(),</span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a><span class=w>  </span><span class=p>})),</span>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a><span class=p>});</span>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a><span class=c1>// ✅ Fetch API mocking for API calls</span>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a><span class=nb>global</span><span class=p>.</span><span class=nx>fetch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>vi</span><span class=p>.</span><span class=nx>fn</span><span class=p>();</span>
</span></code></pre></div><h3 id=42-frontend-testing-nextjs-14>4.2 Frontend Testing (Next.js 14)<a class=headerlink href=#42-frontend-testing-nextjs-14 title="Permanent link">&para;</a></h3><h4 id=component-testing>Component Testing<a class=headerlink href=#component-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1>// components/__tests__/Dashboard.test.tsx</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>describe</span><span class=p>,</span><span class=w> </span><span class=nx>it</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=p>,</span><span class=w> </span><span class=nx>vi</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>render</span><span class=p>,</span><span class=w> </span><span class=nx>screen</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@testing-library/react&#39;</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Dashboard</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@/components/Dashboard&#39;</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Dashboard Component&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;displays service status indicators&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>mockServices</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Plex&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;up&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>uptime</span><span class=o>:</span><span class=w> </span><span class=kt>99.9</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Overseerr&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;down&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>uptime</span><span class=o>:</span><span class=w> </span><span class=kt>85.2</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>    </span><span class=p>]</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>    </span><span class=nx>render</span><span class=p>(</span><span class=o>&lt;</span><span class=nx>Dashboard</span><span class=w> </span><span class=nx>services</span><span class=o>=</span><span class=p>{</span><span class=nx>mockServices</span><span class=p>}</span><span class=w> </span><span class=o>/&gt;</span><span class=p>)</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>screen</span><span class=p>.</span><span class=nx>getByText</span><span class=p>(</span><span class=s1>&#39;Plex&#39;</span><span class=p>)).</span><span class=nx>toBeInTheDocument</span><span class=p>()</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>screen</span><span class=p>.</span><span class=nx>getByRole</span><span class=p>(</span><span class=s1>&#39;status&#39;</span><span class=p>)).</span><span class=nx>toHaveClass</span><span class=p>(</span><span class=s1>&#39;status-up&#39;</span><span class=p>)</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>  </span><span class=p>})</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=p>})</span>
</span></code></pre></div><h4 id=server-side-rendering-testing>Server-Side Rendering Testing<a class=headerlink href=#server-side-rendering-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=c1>// app/__tests__/dashboard.test.ts</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>describe</span><span class=p>,</span><span class=w> </span><span class=nx>it</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span><span class=p>;</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>getServerSideProps</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../dashboard&#39;</span><span class=p>;</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Dashboard SSR&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;fetches service status data&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>req</span><span class=o>:</span><span class=w> </span><span class=p>{},</span><span class=w> </span><span class=nx>res</span><span class=o>:</span><span class=w> </span><span class=p>{},</span><span class=w> </span><span class=nx>query</span><span class=o>:</span><span class=w> </span><span class=p>{}</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>getServerSideProps</span><span class=p>(</span><span class=nx>context</span><span class=p>);</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>services</span><span class=p>).</span><span class=nx>toBeDefined</span><span class=p>();</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>services</span><span class=p>.</span><span class=nx>length</span><span class=p>).</span><span class=nx>toBeGreaterThan</span><span class=p>(</span><span class=mf>0</span><span class=p>);</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=p>});</span>
</span></code></pre></div><h4 id=api-route-testing>API Route Testing<a class=headerlink href=#api-route-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=c1>// app/api/__tests__/auth.test.ts</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>describe</span><span class=p>,</span><span class=w> </span><span class=nx>it</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span><span class=p>;</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=k>import</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;supertest&#39;</span><span class=p>;</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>createMocks</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;node-mocks-http&#39;</span><span class=p>;</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=k>import</span><span class=w> </span><span class=nx>handler</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../auth/session&#39;</span><span class=p>;</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api/auth/session&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;returns user session data&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>createMocks</span><span class=p>({</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>      </span><span class=nx>method</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;GET&#39;</span><span class=p>,</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>      </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>authorization</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Bearer valid-token&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>handler</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>);</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>_getStatusCode</span><span class=p>()).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>_getData</span><span class=p>())).</span><span class=nx>toMatchObject</span><span class=p>({</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=w>      </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>expect.any</span><span class=p>(</span><span class=nb>String</span><span class=p>)</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=p>});</span>
</span></code></pre></div><h3 id=43-backend-testing-express>4.3 Backend Testing (Express)<a class=headerlink href=#43-backend-testing-express title="Permanent link">&para;</a></h3><h4 id=api-endpoint-testing>API Endpoint Testing<a class=headerlink href=#api-endpoint-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1>// backend/tests/integration/api/media.test.ts</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>describe</span><span class=p>,</span><span class=w> </span><span class=nx>it</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=p>,</span><span class=w> </span><span class=nx>beforeAll</span><span class=p>,</span><span class=w> </span><span class=nx>afterAll</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span><span class=p>;</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=k>import</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;supertest&#39;</span><span class=p>;</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>app</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@/app&#39;</span><span class=p>;</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>setupTestDB</span><span class=p>,</span><span class=w> </span><span class=nx>cleanupTestDB</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../helpers/database&#39;</span><span class=p>;</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Media API&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>  </span><span class=nx>beforeAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>setupTestDB</span><span class=p>();</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>  </span><span class=nx>afterAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>cleanupTestDB</span><span class=p>();</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=w>  </span><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;POST /api/media/request&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=w>    </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;creates media request with authentication&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=w>        </span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/media/request&#39;</span><span class=p>)</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=w>        </span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Bearer valid-jwt&#39;</span><span class=p>)</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=w>        </span><span class=p>.</span><span class=nx>send</span><span class=p>({</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=w>          </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;The Matrix&#39;</span><span class=p>,</span>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=w>          </span><span class=nx>mediaType</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=p>,</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=w>          </span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;603&#39;</span><span class=p>,</span>
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a><span class=w>        </span><span class=p>});</span>
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a>
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a><span class=w>      </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>201</span><span class=p>);</span>
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a><span class=w>      </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>title</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;The Matrix&#39;</span><span class=p>);</span>
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-9-30><a id=__codelineno-9-30 name=__codelineno-9-30 href=#__codelineno-9-30></a>
</span><span id=__span-9-31><a id=__codelineno-9-31 name=__codelineno-9-31 href=#__codelineno-9-31></a><span class=w>    </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;rejects unauthenticated requests&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-32><a id=__codelineno-9-32 name=__codelineno-9-32 href=#__codelineno-9-32></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/media/request&#39;</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span><span class=w> </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Test Movie&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-9-33><a id=__codelineno-9-33 name=__codelineno-9-33 href=#__codelineno-9-33></a>
</span><span id=__span-9-34><a id=__codelineno-9-34 name=__codelineno-9-34 href=#__codelineno-9-34></a><span class=w>      </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>401</span><span class=p>);</span>
</span><span id=__span-9-35><a id=__codelineno-9-35 name=__codelineno-9-35 href=#__codelineno-9-35></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-9-36><a id=__codelineno-9-36 name=__codelineno-9-36 href=#__codelineno-9-36></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-9-37><a id=__codelineno-9-37 name=__codelineno-9-37 href=#__codelineno-9-37></a><span class=p>});</span>
</span></code></pre></div><h4 id=service-layer-testing>Service Layer Testing<a class=headerlink href=#service-layer-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1>// backend/tests/unit/services/authService.test.ts</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>describe</span><span class=p>,</span><span class=w> </span><span class=nx>it</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=p>,</span><span class=w> </span><span class=nx>beforeEach</span><span class=p>,</span><span class=w> </span><span class=nx>vi</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span><span class=p>;</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>AuthService</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@/services/authService&#39;</span><span class=p>;</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PlexClient</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@/integrations/plex&#39;</span><span class=p>;</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=nx>vi</span><span class=p>.</span><span class=nx>mock</span><span class=p>(</span><span class=s1>&#39;@/integrations/plex&#39;</span><span class=p>);</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;AuthService&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>authService</span><span class=o>:</span><span class=w> </span><span class=kt>AuthService</span><span class=p>;</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>mockPlexClient</span><span class=o>:</span><span class=w> </span><span class=kt>PlexClient</span><span class=p>;</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>  </span><span class=nx>beforeEach</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=w>    </span><span class=nx>mockPlexClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PlexClient</span><span class=p>();</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>    </span><span class=nx>authService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>AuthService</span><span class=p>(</span><span class=nx>mockPlexClient</span><span class=p>);</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;validates Plex token correctly&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=w>    </span><span class=nx>vi</span><span class=p>.</span><span class=nx>spyOn</span><span class=p>(</span><span class=nx>mockPlexClient</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;validateToken&#39;</span><span class=p>).</span><span class=nx>mockResolvedValue</span><span class=p>({</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a><span class=w>      </span><span class=nx>valid</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a><span class=w>      </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;testuser&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>authService</span><span class=p>.</span><span class=nx>validatePlexToken</span><span class=p>(</span><span class=s1>&#39;test-token&#39;</span><span class=p>);</span>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>valid</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;testuser&#39;</span><span class=p>);</span>
</span><span id=__span-10-27><a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-10-28><a id=__codelineno-10-28 name=__codelineno-10-28 href=#__codelineno-10-28></a><span class=p>});</span>
</span></code></pre></div><h3 id=44-database-testing-postgresql>4.4 Database Testing (PostgreSQL)<a class=headerlink href=#44-database-testing-postgresql title="Permanent link">&para;</a></h3><h4 id=repository-testing-with-testcontainers>Repository Testing with Testcontainers<a class=headerlink href=#repository-testing-with-testcontainers title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1>// backend/tests/integration/repositories/userRepository.test.ts</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PostgreSqlContainer</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@testcontainers/postgresql&#39;</span><span class=p>;</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>UserRepository</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../../src/repositories/userRepository&#39;</span><span class=p>;</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PrismaClient</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@prisma/client&#39;</span><span class=p>;</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;UserRepository&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>container</span><span class=o>:</span><span class=w> </span><span class=kt>PostgreSqlContainer</span><span class=p>;</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>prisma</span><span class=o>:</span><span class=w> </span><span class=kt>PrismaClient</span><span class=p>;</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>userRepository</span><span class=o>:</span><span class=w> </span><span class=kt>UserRepository</span><span class=p>;</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>  </span><span class=nx>beforeAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>    </span><span class=nx>container</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PostgreSqlContainer</span><span class=p>(</span><span class=s1>&#39;postgres:15-alpine&#39;</span><span class=p>)</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>      </span><span class=p>.</span><span class=nx>withDatabase</span><span class=p>(</span><span class=s1>&#39;medianest_test&#39;</span><span class=p>)</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>      </span><span class=p>.</span><span class=nx>withUsername</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>)</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>      </span><span class=p>.</span><span class=nx>withPassword</span><span class=p>(</span><span class=s1>&#39;test&#39;</span><span class=p>)</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>      </span><span class=p>.</span><span class=nx>start</span><span class=p>();</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>connectionString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>container</span><span class=p>.</span><span class=nx>getConnectionUri</span><span class=p>();</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>    </span><span class=nx>prisma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PrismaClient</span><span class=p>({</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=w>      </span><span class=nx>datasources</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>db</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>url</span><span class=o>:</span><span class=w> </span><span class=kt>connectionString</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>$executeRawUnsafe</span><span class=p>(</span><span class=s1>&#39;CREATE EXTENSION IF NOT EXISTS &quot;uuid-ossp&quot;&#39;</span><span class=p>);</span>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>$executeRaw</span><span class=sb>`</span>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a><span class=sb>      CREATE TABLE users (</span>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=sb>        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),</span>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=sb>        plex_id VARCHAR(255) UNIQUE NOT NULL,</span>
</span><span id=__span-11-28><a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a><span class=sb>        username VARCHAR(255) NOT NULL,</span>
</span><span id=__span-11-29><a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=sb>        email VARCHAR(255),</span>
</span><span id=__span-11-30><a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a><span class=sb>        role VARCHAR(50) DEFAULT &#39;user&#39;,</span>
</span><span id=__span-11-31><a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a><span class=sb>        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
</span><span id=__span-11-32><a id=__codelineno-11-32 name=__codelineno-11-32 href=#__codelineno-11-32></a><span class=sb>      )</span>
</span><span id=__span-11-33><a id=__codelineno-11-33 name=__codelineno-11-33 href=#__codelineno-11-33></a><span class=sb>    `</span><span class=p>;</span>
</span><span id=__span-11-34><a id=__codelineno-11-34 name=__codelineno-11-34 href=#__codelineno-11-34></a>
</span><span id=__span-11-35><a id=__codelineno-11-35 name=__codelineno-11-35 href=#__codelineno-11-35></a><span class=w>    </span><span class=nx>userRepository</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>UserRepository</span><span class=p>(</span><span class=nx>prisma</span><span class=p>);</span>
</span><span id=__span-11-36><a id=__codelineno-11-36 name=__codelineno-11-36 href=#__codelineno-11-36></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-11-37><a id=__codelineno-11-37 name=__codelineno-11-37 href=#__codelineno-11-37></a>
</span><span id=__span-11-38><a id=__codelineno-11-38 name=__codelineno-11-38 href=#__codelineno-11-38></a><span class=w>  </span><span class=nx>afterAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-39><a id=__codelineno-11-39 name=__codelineno-11-39 href=#__codelineno-11-39></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>$disconnect</span><span class=p>();</span>
</span><span id=__span-11-40><a id=__codelineno-11-40 name=__codelineno-11-40 href=#__codelineno-11-40></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>container</span><span class=p>.</span><span class=nx>stop</span><span class=p>();</span>
</span><span id=__span-11-41><a id=__codelineno-11-41 name=__codelineno-11-41 href=#__codelineno-11-41></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-11-42><a id=__codelineno-11-42 name=__codelineno-11-42 href=#__codelineno-11-42></a>
</span><span id=__span-11-43><a id=__codelineno-11-43 name=__codelineno-11-43 href=#__codelineno-11-43></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;creates user with Plex OAuth data&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-44><a id=__codelineno-11-44 name=__codelineno-11-44 href=#__codelineno-11-44></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>userData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-45><a id=__codelineno-11-45 name=__codelineno-11-45 href=#__codelineno-11-45></a><span class=w>      </span><span class=nx>plexId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;12345&#39;</span><span class=p>,</span>
</span><span id=__span-11-46><a id=__codelineno-11-46 name=__codelineno-11-46 href=#__codelineno-11-46></a><span class=w>      </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;testuser&#39;</span><span class=p>,</span>
</span><span id=__span-11-47><a id=__codelineno-11-47 name=__codelineno-11-47 href=#__codelineno-11-47></a><span class=w>      </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test@example.com&#39;</span><span class=p>,</span>
</span><span id=__span-11-48><a id=__codelineno-11-48 name=__codelineno-11-48 href=#__codelineno-11-48></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-11-49><a id=__codelineno-11-49 name=__codelineno-11-49 href=#__codelineno-11-49></a>
</span><span id=__span-11-50><a id=__codelineno-11-50 name=__codelineno-11-50 href=#__codelineno-11-50></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>userRepository</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>userData</span><span class=p>);</span>
</span><span id=__span-11-51><a id=__codelineno-11-51 name=__codelineno-11-51 href=#__codelineno-11-51></a>
</span><span id=__span-11-52><a id=__codelineno-11-52 name=__codelineno-11-52 href=#__codelineno-11-52></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>plexId</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;12345&#39;</span><span class=p>);</span>
</span><span id=__span-11-53><a id=__codelineno-11-53 name=__codelineno-11-53 href=#__codelineno-11-53></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;testuser&#39;</span><span class=p>);</span>
</span><span id=__span-11-54><a id=__codelineno-11-54 name=__codelineno-11-54 href=#__codelineno-11-54></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-11-55><a id=__codelineno-11-55 name=__codelineno-11-55 href=#__codelineno-11-55></a><span class=p>});</span>
</span></code></pre></div><h3 id=45-redis-testing>4.5 Redis Testing<a class=headerlink href=#45-redis-testing title="Permanent link">&para;</a></h3><h4 id=cache-testing>Cache Testing<a class=headerlink href=#cache-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1>// backend/tests/integration/cache/redisCache.test.ts</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>RedisContainer</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@testcontainers/redis&#39;</span><span class=p>;</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>RedisCache</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../../src/cache/redisCache&#39;</span><span class=p>;</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=k>import</span><span class=w> </span><span class=nx>Redis</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;ioredis&#39;</span><span class=p>;</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;RedisCache&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>container</span><span class=o>:</span><span class=w> </span><span class=kt>RedisContainer</span><span class=p>;</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>redis</span><span class=o>:</span><span class=w> </span><span class=kt>Redis</span><span class=p>;</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>cache</span><span class=o>:</span><span class=w> </span><span class=kt>RedisCache</span><span class=p>;</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=w>  </span><span class=nx>beforeAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=w>    </span><span class=nx>container</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>RedisContainer</span><span class=p>(</span><span class=s1>&#39;redis:7-alpine&#39;</span><span class=p>).</span><span class=nx>start</span><span class=p>();</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>    </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Redis</span><span class=p>({</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=w>      </span><span class=nx>host</span><span class=o>:</span><span class=w> </span><span class=kt>container.getHost</span><span class=p>(),</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=w>      </span><span class=nx>port</span><span class=o>:</span><span class=w> </span><span class=kt>container.getMappedPort</span><span class=p>(</span><span class=mf>6379</span><span class=p>),</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a><span class=w>    </span><span class=nx>cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>RedisCache</span><span class=p>(</span><span class=nx>redis</span><span class=p>);</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a><span class=w>  </span><span class=nx>afterAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>quit</span><span class=p>();</span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>container</span><span class=p>.</span><span class=nx>stop</span><span class=p>();</span>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a>
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a><span class=w>  </span><span class=nx>beforeEach</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28 href=#__codelineno-12-28></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>redis</span><span class=p>.</span><span class=nx>flushall</span><span class=p>();</span>
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29 href=#__codelineno-12-29></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-12-30><a id=__codelineno-12-30 name=__codelineno-12-30 href=#__codelineno-12-30></a>
</span><span id=__span-12-31><a id=__codelineno-12-31 name=__codelineno-12-31 href=#__codelineno-12-31></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;stores and retrieves service status&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-32><a id=__codelineno-12-32 name=__codelineno-12-32 href=#__codelineno-12-32></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>service</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;plex&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;up&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>lastCheck</span><span class=o>:</span><span class=w> </span><span class=kt>Date.now</span><span class=p>()</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-12-33><a id=__codelineno-12-33 name=__codelineno-12-33 href=#__codelineno-12-33></a>
</span><span id=__span-12-34><a id=__codelineno-12-34 name=__codelineno-12-34 href=#__codelineno-12-34></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>cache</span><span class=p>.</span><span class=nx>setServiceStatus</span><span class=p>(</span><span class=s1>&#39;plex&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>status</span><span class=p>);</span>
</span><span id=__span-12-35><a id=__codelineno-12-35 name=__codelineno-12-35 href=#__codelineno-12-35></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>retrieved</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>cache</span><span class=p>.</span><span class=nx>getServiceStatus</span><span class=p>(</span><span class=s1>&#39;plex&#39;</span><span class=p>);</span>
</span><span id=__span-12-36><a id=__codelineno-12-36 name=__codelineno-12-36 href=#__codelineno-12-36></a>
</span><span id=__span-12-37><a id=__codelineno-12-37 name=__codelineno-12-37 href=#__codelineno-12-37></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>retrieved</span><span class=p>).</span><span class=nx>toEqual</span><span class=p>(</span><span class=nx>status</span><span class=p>);</span>
</span><span id=__span-12-38><a id=__codelineno-12-38 name=__codelineno-12-38 href=#__codelineno-12-38></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-12-39><a id=__codelineno-12-39 name=__codelineno-12-39 href=#__codelineno-12-39></a>
</span><span id=__span-12-40><a id=__codelineno-12-40 name=__codelineno-12-40 href=#__codelineno-12-40></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;expires keys correctly&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-41><a id=__codelineno-12-41 name=__codelineno-12-41 href=#__codelineno-12-41></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>cache</span><span class=p>.</span><span class=nx>setServiceStatus</span><span class=p>(</span><span class=s1>&#39;plex&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;up&#39;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=mf>1</span><span class=p>);</span><span class=w> </span><span class=c1>// 1 second TTL</span>
</span><span id=__span-12-42><a id=__codelineno-12-42 name=__codelineno-12-42 href=#__codelineno-12-42></a>
</span><span id=__span-12-43><a id=__codelineno-12-43 name=__codelineno-12-43 href=#__codelineno-12-43></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>setTimeout</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span><span class=w> </span><span class=mf>1100</span><span class=p>));</span>
</span><span id=__span-12-44><a id=__codelineno-12-44 name=__codelineno-12-44 href=#__codelineno-12-44></a>
</span><span id=__span-12-45><a id=__codelineno-12-45 name=__codelineno-12-45 href=#__codelineno-12-45></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>retrieved</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>cache</span><span class=p>.</span><span class=nx>getServiceStatus</span><span class=p>(</span><span class=s1>&#39;plex&#39;</span><span class=p>);</span>
</span><span id=__span-12-46><a id=__codelineno-12-46 name=__codelineno-12-46 href=#__codelineno-12-46></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>retrieved</span><span class=p>).</span><span class=nx>toBeNull</span><span class=p>();</span>
</span><span id=__span-12-47><a id=__codelineno-12-47 name=__codelineno-12-47 href=#__codelineno-12-47></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-12-48><a id=__codelineno-12-48 name=__codelineno-12-48 href=#__codelineno-12-48></a><span class=p>});</span>
</span></code></pre></div><h4 id=rate-limiting-testing>Rate Limiting Testing<a class=headerlink href=#rate-limiting-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1>// backend/tests/unit/middleware/rateLimiter.test.ts</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>rateLimitMiddleware</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../../src/middleware/rateLimiter&#39;</span><span class=p>;</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=k>import</span><span class=w> </span><span class=nx>Redis</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;ioredis-mock&#39;</span><span class=p>;</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Rate Limiter&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>redis</span><span class=o>:</span><span class=w> </span><span class=kt>Redis</span><span class=p>;</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=w>  </span><span class=nx>beforeEach</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=w>    </span><span class=nx>redis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Redis</span><span class=p>();</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;allows requests within limit&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>middleware</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>rateLimitMiddleware</span><span class=p>(</span><span class=nx>redis</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>limit</span><span class=o>:</span><span class=w> </span><span class=kt>5</span><span class=p>,</span><span class=w> </span><span class=nx>window</span><span class=o>:</span><span class=w> </span><span class=kt>60</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user123&#39;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=nx>path</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;/api/test&#39;</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>jest.fn</span><span class=p>().</span><span class=nx>mockReturnThis</span><span class=p>(),</span><span class=w> </span><span class=nx>json</span><span class=o>:</span><span class=w> </span><span class=kt>jest.fn</span><span class=p>()</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jest</span><span class=p>.</span><span class=nx>fn</span><span class=p>();</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>middleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>,</span><span class=w> </span><span class=nx>next</span><span class=p>);</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>next</span><span class=p>).</span><span class=nx>toHaveBeenCalled</span><span class=p>();</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>not</span><span class=p>.</span><span class=nx>toHaveBeenCalled</span><span class=p>();</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;blocks requests exceeding limit&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>middleware</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>rateLimitMiddleware</span><span class=p>(</span><span class=nx>redis</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>limit</span><span class=o>:</span><span class=w> </span><span class=kt>1</span><span class=p>,</span><span class=w> </span><span class=nx>window</span><span class=o>:</span><span class=w> </span><span class=kt>60</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user123&#39;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=nx>path</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;/api/test&#39;</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>jest.fn</span><span class=p>().</span><span class=nx>mockReturnThis</span><span class=p>(),</span><span class=w> </span><span class=nx>json</span><span class=o>:</span><span class=w> </span><span class=kt>jest.fn</span><span class=p>()</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jest</span><span class=p>.</span><span class=nx>fn</span><span class=p>();</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a><span class=w>    </span><span class=c1>// First request should pass</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>middleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>,</span><span class=w> </span><span class=nx>next</span><span class=p>);</span>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32 href=#__codelineno-13-32></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>next</span><span class=p>).</span><span class=nx>toHaveBeenCalledTimes</span><span class=p>(</span><span class=mf>1</span><span class=p>);</span>
</span><span id=__span-13-33><a id=__codelineno-13-33 name=__codelineno-13-33 href=#__codelineno-13-33></a>
</span><span id=__span-13-34><a id=__codelineno-13-34 name=__codelineno-13-34 href=#__codelineno-13-34></a><span class=w>    </span><span class=c1>// Second request should be blocked</span>
</span><span id=__span-13-35><a id=__codelineno-13-35 name=__codelineno-13-35 href=#__codelineno-13-35></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>middleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>res</span><span class=p>,</span><span class=w> </span><span class=nx>next</span><span class=p>);</span>
</span><span id=__span-13-36><a id=__codelineno-13-36 name=__codelineno-13-36 href=#__codelineno-13-36></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>toHaveBeenCalledWith</span><span class=p>(</span><span class=mf>429</span><span class=p>);</span>
</span><span id=__span-13-37><a id=__codelineno-13-37 name=__codelineno-13-37 href=#__codelineno-13-37></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-13-38><a id=__codelineno-13-38 name=__codelineno-13-38 href=#__codelineno-13-38></a><span class=p>});</span>
</span></code></pre></div><h2 id=4-critical-path-testing>4. Critical Path Testing<a class=headerlink href=#4-critical-path-testing title="Permanent link">&para;</a></h2><h3 id=41-what-to-test-first>4.1 What to Test First<a class=headerlink href=#41-what-to-test-first title="Permanent link">&para;</a></h3><ol><li><strong>Authentication Flow</strong> (Most Critical)</li></ol><div class="language-typescript highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1>// Simple test for Plex OAuth</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Plex Authentication&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should handle PIN generation&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>pin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>authService</span><span class=p>.</span><span class=nx>generatePlexPin</span><span class=p>();</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>pin</span><span class=p>).</span><span class=nx>toHaveProperty</span><span class=p>(</span><span class=s1>&#39;code&#39;</span><span class=p>);</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>pin</span><span class=p>.</span><span class=nx>code</span><span class=p>).</span><span class=nx>toHaveLength</span><span class=p>(</span><span class=mf>4</span><span class=p>);</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should create user from Plex data&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>plexUser</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test@example.com&#39;</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>userService</span><span class=p>.</span><span class=nx>createFromPlex</span><span class=p>(</span><span class=nx>plexUser</span><span class=p>);</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>plexId</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>);</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=p>});</span>
</span></code></pre></div><ol><li><strong>Media Request Flow</strong></li></ol><div class="language-typescript highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1>// Test the happy path only</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should submit media request&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>    </span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/media/request&#39;</span><span class=p>)</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Bearer valid-token&#39;</span><span class=p>)</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>    </span><span class=p>.</span><span class=nx>send</span><span class=p>({</span><span class=w> </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;The Matrix&#39;</span><span class=p>,</span><span class=w> </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=w>  </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>201</span><span class=p>);</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=p>});</span>
</span></code></pre></div><ol><li><strong>Service Status Check</strong></li></ol><div class="language-typescript highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>// Simple mock for Uptime Kuma</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should return service status&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>  </span><span class=nx>mockUptimeKuma</span><span class=p>.</span><span class=nx>getStatus</span><span class=p>.</span><span class=nx>mockResolvedValue</span><span class=p>([</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Plex&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;up&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Overseerr&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;down&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>  </span><span class=p>]);</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/dashboard/status&#39;</span><span class=p>);</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>  </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>services</span><span class=p>).</span><span class=nx>toHaveLength</span><span class=p>(</span><span class=mf>2</span><span class=p>);</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=p>});</span>
</span></code></pre></div><div class="language-text highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>### 5.2 External Service Mocking with MSW v2.10.2 (IMPLEMENTED)
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>#### MSW Server Setup (VERIFIED IMPLEMENTATION)
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>```typescript
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>// backend/tests/mocks/server.ts ✅ IMPLEMENTED
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>import { setupServer } from &#39;msw/node&#39;
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>import { handlers } from &#39;./handlers&#39;
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>export const server = setupServer(...handlers)
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>// ✅ Lifecycle management in setup.ts
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a>beforeAll(() =&gt; server.listen({ onUnhandledRequest: &#39;error&#39; }))
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a>afterEach(() =&gt; server.resetHandlers())
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a>afterAll(() =&gt; server.close())
</span></code></pre></div><h4 id=msw-handlers-comprehensive-implementation>MSW Handlers (COMPREHENSIVE IMPLEMENTATION)<a class=headerlink href=#msw-handlers-comprehensive-implementation title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1>// backend/tests/mocks/handlers/ ✅ 3 HANDLER FILES IMPLEMENTED</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=c1>// 1. plex-handlers.ts - Plex API mocking</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>plexHandlers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=w>  </span><span class=c1>// PIN generation</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;https://plex.tv/pins.xml&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span><span class=sb>`&lt;pin&gt;&lt;id&gt;12345&lt;/id&gt;&lt;code&gt;ABCD&lt;/code&gt;&lt;/pin&gt;`</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=w>      </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;application/xml&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=w>  </span><span class=p>}),</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=w>  </span><span class=c1>// PIN verification with auth token</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;https://plex.tv/pins/:id.xml&#39;</span><span class=p>,</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>params</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=w>      </span><span class=sb>`</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=sb>      &lt;pin&gt;</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=sb>        &lt;id&gt;</span><span class=si>${</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=si>}</span><span class=sb>&lt;/id&gt;</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=sb>        &lt;authToken&gt;plex-auth-token-123&lt;/authToken&gt;</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=sb>      &lt;/pin&gt;`</span><span class=p>,</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=w>        </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;application/xml&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=w>  </span><span class=p>}),</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a><span class=w>  </span><span class=c1>// User account info</span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;https://plex.tv/users/account.xml&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span>
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a><span class=w>      </span><span class=sb>`</span>
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a><span class=sb>      &lt;user&gt;</span>
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a><span class=sb>        &lt;id&gt;456&lt;/id&gt;</span>
</span><span id=__span-18-32><a id=__codelineno-18-32 name=__codelineno-18-32 href=#__codelineno-18-32></a><span class=sb>        &lt;username&gt;testplexuser&lt;/username&gt;</span>
</span><span id=__span-18-33><a id=__codelineno-18-33 name=__codelineno-18-33 href=#__codelineno-18-33></a><span class=sb>        &lt;email&gt;test@example.com&lt;/email&gt;</span>
</span><span id=__span-18-34><a id=__codelineno-18-34 name=__codelineno-18-34 href=#__codelineno-18-34></a><span class=sb>      &lt;/user&gt;`</span><span class=p>,</span>
</span><span id=__span-18-35><a id=__codelineno-18-35 name=__codelineno-18-35 href=#__codelineno-18-35></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-18-36><a id=__codelineno-18-36 name=__codelineno-18-36 href=#__codelineno-18-36></a><span class=w>        </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;application/xml&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-18-37><a id=__codelineno-18-37 name=__codelineno-18-37 href=#__codelineno-18-37></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-18-38><a id=__codelineno-18-38 name=__codelineno-18-38 href=#__codelineno-18-38></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-18-39><a id=__codelineno-18-39 name=__codelineno-18-39 href=#__codelineno-18-39></a><span class=w>  </span><span class=p>}),</span>
</span><span id=__span-18-40><a id=__codelineno-18-40 name=__codelineno-18-40 href=#__codelineno-18-40></a><span class=p>];</span>
</span><span id=__span-18-41><a id=__codelineno-18-41 name=__codelineno-18-41 href=#__codelineno-18-41></a>
</span><span id=__span-18-42><a id=__codelineno-18-42 name=__codelineno-18-42 href=#__codelineno-18-42></a><span class=c1>// 2. overseerr-handlers.ts - Overseerr API mocking</span>
</span><span id=__span-18-43><a id=__codelineno-18-43 name=__codelineno-18-43 href=#__codelineno-18-43></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>overseerrHandlers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-18-44><a id=__codelineno-18-44 name=__codelineno-18-44 href=#__codelineno-18-44></a><span class=w>  </span><span class=c1>// Media request submission</span>
</span><span id=__span-18-45><a id=__codelineno-18-45 name=__codelineno-18-45 href=#__codelineno-18-45></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=sr>/\/api\/v1\/request$/</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-46><a id=__codelineno-18-46 name=__codelineno-18-46 href=#__codelineno-18-46></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span><span id=__span-18-47><a id=__codelineno-18-47 name=__codelineno-18-47 href=#__codelineno-18-47></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span><span id=__span-18-48><a id=__codelineno-18-48 name=__codelineno-18-48 href=#__codelineno-18-48></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-18-49><a id=__codelineno-18-49 name=__codelineno-18-49 href=#__codelineno-18-49></a><span class=w>        </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=kt>123</span><span class=p>,</span>
</span><span id=__span-18-50><a id=__codelineno-18-50 name=__codelineno-18-50 href=#__codelineno-18-50></a><span class=w>        </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=nx>body</span><span class=p>.</span><span class=nx>mediaType</span><span class=p>,</span>
</span><span id=__span-18-51><a id=__codelineno-18-51 name=__codelineno-18-51 href=#__codelineno-18-51></a><span class=w>        </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;pending&#39;</span><span class=p>,</span>
</span><span id=__span-18-52><a id=__codelineno-18-52 name=__codelineno-18-52 href=#__codelineno-18-52></a><span class=w>        </span><span class=nx>media</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=kt>body.tmdbId</span><span class=p>,</span><span class=w> </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;The Matrix&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-18-53><a id=__codelineno-18-53 name=__codelineno-18-53 href=#__codelineno-18-53></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-18-54><a id=__codelineno-18-54 name=__codelineno-18-54 href=#__codelineno-18-54></a><span class=w>      </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>201</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-18-55><a id=__codelineno-18-55 name=__codelineno-18-55 href=#__codelineno-18-55></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-18-56><a id=__codelineno-18-56 name=__codelineno-18-56 href=#__codelineno-18-56></a><span class=w>  </span><span class=p>}),</span>
</span><span id=__span-18-57><a id=__codelineno-18-57 name=__codelineno-18-57 href=#__codelineno-18-57></a>
</span><span id=__span-18-58><a id=__codelineno-18-58 name=__codelineno-18-58 href=#__codelineno-18-58></a><span class=w>  </span><span class=c1>// Service status check</span>
</span><span id=__span-18-59><a id=__codelineno-18-59 name=__codelineno-18-59 href=#__codelineno-18-59></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sr>/\/api\/v1\/status$/</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-60><a id=__codelineno-18-60 name=__codelineno-18-60 href=#__codelineno-18-60></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span><span id=__span-18-61><a id=__codelineno-18-61 name=__codelineno-18-61 href=#__codelineno-18-61></a><span class=w>      </span><span class=nx>version</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1.33.2&#39;</span><span class=p>,</span>
</span><span id=__span-18-62><a id=__codelineno-18-62 name=__codelineno-18-62 href=#__codelineno-18-62></a><span class=w>      </span><span class=nx>totalRequests</span><span class=o>:</span><span class=w> </span><span class=kt>1234</span><span class=p>,</span>
</span><span id=__span-18-63><a id=__codelineno-18-63 name=__codelineno-18-63 href=#__codelineno-18-63></a><span class=w>      </span><span class=nx>totalMovieRequests</span><span class=o>:</span><span class=w> </span><span class=kt>800</span><span class=p>,</span>
</span><span id=__span-18-64><a id=__codelineno-18-64 name=__codelineno-18-64 href=#__codelineno-18-64></a><span class=w>      </span><span class=nx>totalTvRequests</span><span class=o>:</span><span class=w> </span><span class=kt>434</span><span class=p>,</span>
</span><span id=__span-18-65><a id=__codelineno-18-65 name=__codelineno-18-65 href=#__codelineno-18-65></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-18-66><a id=__codelineno-18-66 name=__codelineno-18-66 href=#__codelineno-18-66></a><span class=w>  </span><span class=p>}),</span>
</span><span id=__span-18-67><a id=__codelineno-18-67 name=__codelineno-18-67 href=#__codelineno-18-67></a><span class=p>];</span>
</span><span id=__span-18-68><a id=__codelineno-18-68 name=__codelineno-18-68 href=#__codelineno-18-68></a>
</span><span id=__span-18-69><a id=__codelineno-18-69 name=__codelineno-18-69 href=#__codelineno-18-69></a><span class=c1>// 3. uptime-kuma-handlers.ts - Uptime Kuma mocking</span>
</span><span id=__span-18-70><a id=__codelineno-18-70 name=__codelineno-18-70 href=#__codelineno-18-70></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>uptimeKumaHandlers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-18-71><a id=__codelineno-18-71 name=__codelineno-18-71 href=#__codelineno-18-71></a><span class=w>  </span><span class=c1>// Status page heartbeat</span>
</span><span id=__span-18-72><a id=__codelineno-18-72 name=__codelineno-18-72 href=#__codelineno-18-72></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sr>/\/api\/status-page\/heartbeat/</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-73><a id=__codelineno-18-73 name=__codelineno-18-73 href=#__codelineno-18-73></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span><span id=__span-18-74><a id=__codelineno-18-74 name=__codelineno-18-74 href=#__codelineno-18-74></a><span class=w>      </span><span class=nx>heartbeatList</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-75><a id=__codelineno-18-75 name=__codelineno-18-75 href=#__codelineno-18-75></a><span class=w>        </span><span class=s1>&#39;1&#39;</span><span class=o>:</span><span class=w> </span><span class=p>[{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>1</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=o>:</span><span class=w> </span><span class=kt>Date.now</span><span class=p>()</span><span class=w> </span><span class=p>}],</span><span class=w> </span><span class=c1>// Plex up</span>
</span><span id=__span-18-76><a id=__codelineno-18-76 name=__codelineno-18-76 href=#__codelineno-18-76></a><span class=w>        </span><span class=s1>&#39;2&#39;</span><span class=o>:</span><span class=w> </span><span class=p>[{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>0</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=o>:</span><span class=w> </span><span class=kt>Date.now</span><span class=p>()</span><span class=w> </span><span class=p>}],</span><span class=w> </span><span class=c1>// Overseerr down</span>
</span><span id=__span-18-77><a id=__codelineno-18-77 name=__codelineno-18-77 href=#__codelineno-18-77></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-18-78><a id=__codelineno-18-78 name=__codelineno-18-78 href=#__codelineno-18-78></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-18-79><a id=__codelineno-18-79 name=__codelineno-18-79 href=#__codelineno-18-79></a><span class=w>  </span><span class=p>}),</span>
</span><span id=__span-18-80><a id=__codelineno-18-80 name=__codelineno-18-80 href=#__codelineno-18-80></a><span class=p>];</span>
</span></code></pre></div><h4 id=msw-test-helpers-implemented>MSW Test Helpers (IMPLEMENTED)<a class=headerlink href=#msw-test-helpers-implemented title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=c1>// backend/tests/helpers/external-services.ts ✅ IMPLEMENTED</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>server</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../mocks/server&#39;</span><span class=p>;</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>http</span><span class=p>,</span><span class=w> </span><span class=nx>HttpResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;msw&#39;</span><span class=p>;</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=c1>// ✅ Helper to authorize Plex PIN for testing</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>authorizePlexPin</span><span class=p>(</span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>authToken?</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=w>    </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`https://plex.tv/pins/</span><span class=si>${</span><span class=nx>pinId</span><span class=si>}</span><span class=sb>.xml`</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span><span class=sb>`</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=sb>        &lt;pin&gt;</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=sb>          &lt;id&gt;</span><span class=si>${</span><span class=nx>pinId</span><span class=si>}</span><span class=sb>&lt;/id&gt;</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=sb>          &lt;authToken&gt;</span><span class=si>${</span><span class=nx>authToken</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39;test-auth-token&#39;</span><span class=si>}</span><span class=sb>&lt;/authToken&gt;</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=sb>        &lt;/pin&gt;`</span><span class=p>);</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=p>}</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=c1>// ✅ Helper to simulate service outages</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>simulatePlexDown</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a><span class=w>    </span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;https://plex.tv/pins.xml&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span><span class=s1>&#39;Service Unavailable&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>503</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-19-25><a id=__codelineno-19-25 name=__codelineno-19-25 href=#__codelineno-19-25></a><span class=p>}</span>
</span><span id=__span-19-26><a id=__codelineno-19-26 name=__codelineno-19-26 href=#__codelineno-19-26></a>
</span><span id=__span-19-27><a id=__codelineno-19-27 name=__codelineno-19-27 href=#__codelineno-19-27></a><span class=c1>// ✅ Helper for media request conflicts</span>
</span><span id=__span-19-28><a id=__codelineno-19-28 name=__codelineno-19-28 href=#__codelineno-19-28></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>simulateMediaAlreadyRequested</span><span class=p>(</span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-29><a id=__codelineno-19-29 name=__codelineno-19-29 href=#__codelineno-19-29></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span><span id=__span-19-30><a id=__codelineno-19-30 name=__codelineno-19-30 href=#__codelineno-19-30></a><span class=w>    </span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=sr>/\/api\/v1\/request$/</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-31><a id=__codelineno-19-31 name=__codelineno-19-31 href=#__codelineno-19-31></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span><span id=__span-19-32><a id=__codelineno-19-32 name=__codelineno-19-32 href=#__codelineno-19-32></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>tmdbId</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>tmdbId</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-33><a id=__codelineno-19-33 name=__codelineno-19-33 href=#__codelineno-19-33></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Media already requested&#39;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>409</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-19-34><a id=__codelineno-19-34 name=__codelineno-19-34 href=#__codelineno-19-34></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-19-35><a id=__codelineno-19-35 name=__codelineno-19-35 href=#__codelineno-19-35></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-19-36><a id=__codelineno-19-36 name=__codelineno-19-36 href=#__codelineno-19-36></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-19-37><a id=__codelineno-19-37 name=__codelineno-19-37 href=#__codelineno-19-37></a><span class=p>}</span>
</span></code></pre></div><h4 id=overseerr-api-testing>Overseerr API Testing<a class=headerlink href=#overseerr-api-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1>// backend/tests/integration/overseerr/overseerrService.test.ts</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>describe</span><span class=p>,</span><span class=w> </span><span class=nx>it</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=p>,</span><span class=w> </span><span class=nx>beforeAll</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span><span class=p>;</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>OverseerrService</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@/services/overseerrService&#39;</span><span class=p>;</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>server</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../../mocks/server&#39;</span><span class=p>;</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>http</span><span class=p>,</span><span class=w> </span><span class=nx>HttpResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;msw&#39;</span><span class=p>;</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Overseerr Service Integration&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=w>  </span><span class=nx>beforeAll</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=w>    </span><span class=c1>// Import MSW server setup</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=w>    </span><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>();</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;submits media request successfully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>OverseerrService</span><span class=p>(</span><span class=s1>&#39;http://localhost:5055&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;api-key&#39;</span><span class=p>);</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>service</span><span class=p>.</span><span class=nx>submitRequest</span><span class=p>({</span>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a><span class=w>      </span><span class=nx>mediaType</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=p>,</span>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=w>      </span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=kt>603</span><span class=p>,</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>123</span><span class=p>);</span>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;pending&#39;</span><span class=p>);</span>
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-20-23><a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a>
</span><span id=__span-20-24><a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles service errors gracefully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-25><a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a><span class=w>    </span><span class=c1>// Override handler for this test</span>
</span><span id=__span-20-26><a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a><span class=w>    </span><span class=nx>server</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span><span id=__span-20-27><a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a><span class=w>      </span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;http://localhost:5055/api/v1/request&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-28><a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Service unavailable&#39;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>503</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-20-29><a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a><span class=w>      </span><span class=p>}),</span>
</span><span id=__span-20-30><a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-20-31><a id=__codelineno-20-31 name=__codelineno-20-31 href=#__codelineno-20-31></a>
</span><span id=__span-20-32><a id=__codelineno-20-32 name=__codelineno-20-32 href=#__codelineno-20-32></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>OverseerrService</span><span class=p>(</span><span class=s1>&#39;http://localhost:5055&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;api-key&#39;</span><span class=p>);</span>
</span><span id=__span-20-33><a id=__codelineno-20-33 name=__codelineno-20-33 href=#__codelineno-20-33></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>expect</span><span class=p>(</span>
</span><span id=__span-20-34><a id=__codelineno-20-34 name=__codelineno-20-34 href=#__codelineno-20-34></a><span class=w>      </span><span class=nx>service</span><span class=p>.</span><span class=nx>submitRequest</span><span class=p>({</span>
</span><span id=__span-20-35><a id=__codelineno-20-35 name=__codelineno-20-35 href=#__codelineno-20-35></a><span class=w>        </span><span class=nx>mediaType</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=p>,</span>
</span><span id=__span-20-36><a id=__codelineno-20-36 name=__codelineno-20-36 href=#__codelineno-20-36></a><span class=w>        </span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=kt>603</span><span class=p>,</span>
</span><span id=__span-20-37><a id=__codelineno-20-37 name=__codelineno-20-37 href=#__codelineno-20-37></a><span class=w>      </span><span class=p>}),</span>
</span><span id=__span-20-38><a id=__codelineno-20-38 name=__codelineno-20-38 href=#__codelineno-20-38></a><span class=w>    </span><span class=p>).</span><span class=nx>rejects</span><span class=p>.</span><span class=nx>toThrow</span><span class=p>(</span><span class=s1>&#39;Service unavailable&#39;</span><span class=p>);</span>
</span><span id=__span-20-39><a id=__codelineno-20-39 name=__codelineno-20-39 href=#__codelineno-20-39></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-20-40><a id=__codelineno-20-40 name=__codelineno-20-40 href=#__codelineno-20-40></a><span class=p>});</span>
</span></code></pre></div><h3 id=53-websocket-testing-socketio>5.3 WebSocket Testing (Socket.io)<a class=headerlink href=#53-websocket-testing-socketio title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1>// frontend/tests/integration/websocket.test.ts</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>io</span><span class=p>,</span><span class=w> </span><span class=nx>Socket</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;socket.io-client&#39;</span><span class=p>;</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>createServer</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Server</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;socket.io&#39;</span><span class=p>;</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;WebSocket Integration&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>httpServer</span><span class=o>:</span><span class=w> </span><span class=kt>any</span><span class=p>;</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>ioServer</span><span class=o>:</span><span class=w> </span><span class=kt>Server</span><span class=p>;</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>clientSocket</span><span class=o>:</span><span class=w> </span><span class=kt>Socket</span><span class=p>;</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=w>  </span><span class=nx>beforeAll</span><span class=p>((</span><span class=nx>done</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=w>    </span><span class=nx>httpServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>createServer</span><span class=p>();</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=w>    </span><span class=nx>ioServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Server</span><span class=p>(</span><span class=nx>httpServer</span><span class=p>);</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>    </span><span class=nx>httpServer</span><span class=p>.</span><span class=nx>listen</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>httpServer</span><span class=p>.</span><span class=nx>address</span><span class=p>().</span><span class=nx>port</span><span class=p>;</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=w>      </span><span class=nx>clientSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>io</span><span class=p>(</span><span class=sb>`http://localhost:</span><span class=si>${</span><span class=nx>port</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=w>        </span><span class=nx>auth</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;valid-jwt&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=w>      </span><span class=nx>ioServer</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;connection&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>socket</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=w>        </span><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;subscribe:status&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-23><a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a><span class=w>          </span><span class=nx>socket</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s1>&#39;status-updates&#39;</span><span class=p>);</span>
</span><span id=__span-21-24><a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a><span class=w>        </span><span class=p>});</span>
</span><span id=__span-21-25><a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-21-26><a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a>
</span><span id=__span-21-27><a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a><span class=w>      </span><span class=nx>clientSocket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;connect&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>done</span><span class=p>);</span>
</span><span id=__span-21-28><a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-21-29><a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-21-30><a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a>
</span><span id=__span-21-31><a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a><span class=w>  </span><span class=nx>afterAll</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-32><a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a><span class=w>    </span><span class=nx>ioServer</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-21-33><a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a><span class=w>    </span><span class=nx>clientSocket</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-21-34><a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a><span class=w>    </span><span class=nx>httpServer</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-21-35><a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-21-36><a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a>
</span><span id=__span-21-37><a id=__codelineno-21-37 name=__codelineno-21-37 href=#__codelineno-21-37></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;receives service status updates&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>done</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-38><a id=__codelineno-21-38 name=__codelineno-21-38 href=#__codelineno-21-38></a><span class=w>    </span><span class=nx>clientSocket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;subscribe:status&#39;</span><span class=p>);</span>
</span><span id=__span-21-39><a id=__codelineno-21-39 name=__codelineno-21-39 href=#__codelineno-21-39></a>
</span><span id=__span-21-40><a id=__codelineno-21-40 name=__codelineno-21-40 href=#__codelineno-21-40></a><span class=w>    </span><span class=nx>clientSocket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;service:status&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>data</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-41><a id=__codelineno-21-41 name=__codelineno-21-41 href=#__codelineno-21-41></a><span class=w>      </span><span class=nx>expect</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>service</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;plex&#39;</span><span class=p>);</span>
</span><span id=__span-21-42><a id=__codelineno-21-42 name=__codelineno-21-42 href=#__codelineno-21-42></a><span class=w>      </span><span class=nx>expect</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;up&#39;</span><span class=p>);</span>
</span><span id=__span-21-43><a id=__codelineno-21-43 name=__codelineno-21-43 href=#__codelineno-21-43></a><span class=w>      </span><span class=nx>done</span><span class=p>();</span>
</span><span id=__span-21-44><a id=__codelineno-21-44 name=__codelineno-21-44 href=#__codelineno-21-44></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-21-45><a id=__codelineno-21-45 name=__codelineno-21-45 href=#__codelineno-21-45></a>
</span><span id=__span-21-46><a id=__codelineno-21-46 name=__codelineno-21-46 href=#__codelineno-21-46></a><span class=w>    </span><span class=c1>// Simulate status update</span>
</span><span id=__span-21-47><a id=__codelineno-21-47 name=__codelineno-21-47 href=#__codelineno-21-47></a><span class=w>    </span><span class=nx>ioServer</span><span class=p>.</span><span class=nx>to</span><span class=p>(</span><span class=s1>&#39;status-updates&#39;</span><span class=p>).</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;service:status&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-48><a id=__codelineno-21-48 name=__codelineno-21-48 href=#__codelineno-21-48></a><span class=w>      </span><span class=nx>service</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;plex&#39;</span><span class=p>,</span>
</span><span id=__span-21-49><a id=__codelineno-21-49 name=__codelineno-21-49 href=#__codelineno-21-49></a><span class=w>      </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;up&#39;</span><span class=p>,</span>
</span><span id=__span-21-50><a id=__codelineno-21-50 name=__codelineno-21-50 href=#__codelineno-21-50></a><span class=w>      </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>Date.now</span><span class=p>(),</span>
</span><span id=__span-21-51><a id=__codelineno-21-51 name=__codelineno-21-51 href=#__codelineno-21-51></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-21-52><a id=__codelineno-21-52 name=__codelineno-21-52 href=#__codelineno-21-52></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-21-53><a id=__codelineno-21-53 name=__codelineno-21-53 href=#__codelineno-21-53></a>
</span><span id=__span-21-54><a id=__codelineno-21-54 name=__codelineno-21-54 href=#__codelineno-21-54></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles authentication failure&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>done</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-55><a id=__codelineno-21-55 name=__codelineno-21-55 href=#__codelineno-21-55></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>unauthorizedClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>io</span><span class=p>(</span><span class=sb>`http://localhost:</span><span class=si>${</span><span class=nx>httpServer</span><span class=p>.</span><span class=nx>address</span><span class=p>().</span><span class=nx>port</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-56><a id=__codelineno-21-56 name=__codelineno-21-56 href=#__codelineno-21-56></a><span class=w>      </span><span class=nx>auth</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>token</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;invalid-token&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-21-57><a id=__codelineno-21-57 name=__codelineno-21-57 href=#__codelineno-21-57></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-21-58><a id=__codelineno-21-58 name=__codelineno-21-58 href=#__codelineno-21-58></a>
</span><span id=__span-21-59><a id=__codelineno-21-59 name=__codelineno-21-59 href=#__codelineno-21-59></a><span class=w>    </span><span class=nx>unauthorizedClient</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;connect_error&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-60><a id=__codelineno-21-60 name=__codelineno-21-60 href=#__codelineno-21-60></a><span class=w>      </span><span class=nx>expect</span><span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>message</span><span class=p>).</span><span class=nx>toMatch</span><span class=p>(</span><span class=sr>/authentication/i</span><span class=p>);</span>
</span><span id=__span-21-61><a id=__codelineno-21-61 name=__codelineno-21-61 href=#__codelineno-21-61></a><span class=w>      </span><span class=nx>done</span><span class=p>();</span>
</span><span id=__span-21-62><a id=__codelineno-21-62 name=__codelineno-21-62 href=#__codelineno-21-62></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-21-63><a id=__codelineno-21-63 name=__codelineno-21-63 href=#__codelineno-21-63></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-21-64><a id=__codelineno-21-64 name=__codelineno-21-64 href=#__codelineno-21-64></a><span class=p>});</span>
</span></code></pre></div><h3 id=54-background-job-testing-bullmqredis>5.4 Background Job Testing (BullMQ/Redis)<a class=headerlink href=#54-background-job-testing-bullmqredis title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=c1>// backend/tests/integration/jobs/youtubeDownload.test.ts</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>describe</span><span class=p>,</span><span class=w> </span><span class=nx>it</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=p>,</span><span class=w> </span><span class=nx>beforeAll</span><span class=p>,</span><span class=w> </span><span class=nx>afterAll</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest&#39;</span><span class=p>;</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>Queue</span><span class=p>,</span><span class=w> </span><span class=nx>Worker</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;bullmq&#39;</span><span class=p>;</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>RedisContainer</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@testcontainers/redis&#39;</span><span class=p>;</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>processYouTubeDownload</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@/jobs/youtubeProcessor&#39;</span><span class=p>;</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;YouTube Download Jobs&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>container</span><span class=o>:</span><span class=w> </span><span class=kt>RedisContainer</span><span class=p>;</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>queue</span><span class=o>:</span><span class=w> </span><span class=kt>Queue</span><span class=p>;</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>worker</span><span class=o>:</span><span class=w> </span><span class=kt>Worker</span><span class=p>;</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=w>  </span><span class=nx>beforeAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=w>    </span><span class=nx>container</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>RedisContainer</span><span class=p>(</span><span class=s1>&#39;redis:7-alpine&#39;</span><span class=p>).</span><span class=nx>start</span><span class=p>();</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=w>      </span><span class=nx>host</span><span class=o>:</span><span class=w> </span><span class=kt>container.getHost</span><span class=p>(),</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=w>      </span><span class=nx>port</span><span class=o>:</span><span class=w> </span><span class=kt>container.getMappedPort</span><span class=p>(</span><span class=mf>6379</span><span class=p>),</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a><span class=w>    </span><span class=nx>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Queue</span><span class=p>(</span><span class=s1>&#39;youtube-test&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>connection</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a><span class=w>    </span><span class=nx>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Worker</span><span class=p>(</span><span class=s1>&#39;youtube-test&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>processYouTubeDownload</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>connection</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23 href=#__codelineno-22-23></a>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24 href=#__codelineno-22-24></a><span class=w>  </span><span class=nx>afterAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25 href=#__codelineno-22-25></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>worker</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26 href=#__codelineno-22-26></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>queue</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27 href=#__codelineno-22-27></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>container</span><span class=p>.</span><span class=nx>stop</span><span class=p>();</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28 href=#__codelineno-22-28></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29 href=#__codelineno-22-29></a>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30 href=#__codelineno-22-30></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;processes download job successfully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-31><a id=__codelineno-22-31 name=__codelineno-22-31 href=#__codelineno-22-31></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>jobData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-32><a id=__codelineno-22-32 name=__codelineno-22-32 href=#__codelineno-22-32></a><span class=w>      </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user123&#39;</span><span class=p>,</span>
</span><span id=__span-22-33><a id=__codelineno-22-33 name=__codelineno-22-33 href=#__codelineno-22-33></a><span class=w>      </span><span class=nx>playlistUrl</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;https://www.youtube.com/playlist?list=TEST&#39;</span><span class=p>,</span>
</span><span id=__span-22-34><a id=__codelineno-22-34 name=__codelineno-22-34 href=#__codelineno-22-34></a><span class=w>      </span><span class=nx>outputPath</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;/tmp/test-downloads&#39;</span><span class=p>,</span>
</span><span id=__span-22-35><a id=__codelineno-22-35 name=__codelineno-22-35 href=#__codelineno-22-35></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-22-36><a id=__codelineno-22-36 name=__codelineno-22-36 href=#__codelineno-22-36></a>
</span><span id=__span-22-37><a id=__codelineno-22-37 name=__codelineno-22-37 href=#__codelineno-22-37></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>queue</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=s1>&#39;download&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>jobData</span><span class=p>);</span>
</span><span id=__span-22-38><a id=__codelineno-22-38 name=__codelineno-22-38 href=#__codelineno-22-38></a>
</span><span id=__span-22-39><a id=__codelineno-22-39 name=__codelineno-22-39 href=#__codelineno-22-39></a><span class=w>    </span><span class=c1>// Wait for job completion</span>
</span><span id=__span-22-40><a id=__codelineno-22-40 name=__codelineno-22-40 href=#__codelineno-22-40></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>job</span><span class=p>.</span><span class=nx>waitUntilFinished</span><span class=p>(</span><span class=nx>worker</span><span class=p>.</span><span class=nx>queueEvents</span><span class=p>);</span>
</span><span id=__span-22-41><a id=__codelineno-22-41 name=__codelineno-22-41 href=#__codelineno-22-41></a>
</span><span id=__span-22-42><a id=__codelineno-22-42 name=__codelineno-22-42 href=#__codelineno-22-42></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>success</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-22-43><a id=__codelineno-22-43 name=__codelineno-22-43 href=#__codelineno-22-43></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>files</span><span class=p>).</span><span class=nx>toBeDefined</span><span class=p>();</span>
</span><span id=__span-22-44><a id=__codelineno-22-44 name=__codelineno-22-44 href=#__codelineno-22-44></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-22-45><a id=__codelineno-22-45 name=__codelineno-22-45 href=#__codelineno-22-45></a>
</span><span id=__span-22-46><a id=__codelineno-22-46 name=__codelineno-22-46 href=#__codelineno-22-46></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles invalid YouTube URL&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-47><a id=__codelineno-22-47 name=__codelineno-22-47 href=#__codelineno-22-47></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>jobData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-48><a id=__codelineno-22-48 name=__codelineno-22-48 href=#__codelineno-22-48></a><span class=w>      </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user123&#39;</span><span class=p>,</span>
</span><span id=__span-22-49><a id=__codelineno-22-49 name=__codelineno-22-49 href=#__codelineno-22-49></a><span class=w>      </span><span class=nx>playlistUrl</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;invalid-url&#39;</span><span class=p>,</span>
</span><span id=__span-22-50><a id=__codelineno-22-50 name=__codelineno-22-50 href=#__codelineno-22-50></a><span class=w>      </span><span class=nx>outputPath</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;/tmp/test-downloads&#39;</span><span class=p>,</span>
</span><span id=__span-22-51><a id=__codelineno-22-51 name=__codelineno-22-51 href=#__codelineno-22-51></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-22-52><a id=__codelineno-22-52 name=__codelineno-22-52 href=#__codelineno-22-52></a>
</span><span id=__span-22-53><a id=__codelineno-22-53 name=__codelineno-22-53 href=#__codelineno-22-53></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>queue</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=s1>&#39;download&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>jobData</span><span class=p>);</span>
</span><span id=__span-22-54><a id=__codelineno-22-54 name=__codelineno-22-54 href=#__codelineno-22-54></a>
</span><span id=__span-22-55><a id=__codelineno-22-55 name=__codelineno-22-55 href=#__codelineno-22-55></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>expect</span><span class=p>(</span><span class=nx>job</span><span class=p>.</span><span class=nx>waitUntilFinished</span><span class=p>(</span><span class=nx>worker</span><span class=p>.</span><span class=nx>queueEvents</span><span class=p>)).</span><span class=nx>rejects</span><span class=p>.</span><span class=nx>toThrow</span><span class=p>(</span><span class=s1>&#39;Invalid YouTube URL&#39;</span><span class=p>);</span>
</span><span id=__span-22-56><a id=__codelineno-22-56 name=__codelineno-22-56 href=#__codelineno-22-56></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-22-57><a id=__codelineno-22-57 name=__codelineno-22-57 href=#__codelineno-22-57></a>
</span><span id=__span-22-58><a id=__codelineno-22-58 name=__codelineno-22-58 href=#__codelineno-22-58></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;retries failed downloads&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-59><a id=__codelineno-22-59 name=__codelineno-22-59 href=#__codelineno-22-59></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>jobData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-60><a id=__codelineno-22-60 name=__codelineno-22-60 href=#__codelineno-22-60></a><span class=w>      </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user123&#39;</span><span class=p>,</span>
</span><span id=__span-22-61><a id=__codelineno-22-61 name=__codelineno-22-61 href=#__codelineno-22-61></a><span class=w>      </span><span class=nx>playlistUrl</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;https://www.youtube.com/playlist?list=NONEXISTENT&#39;</span><span class=p>,</span>
</span><span id=__span-22-62><a id=__codelineno-22-62 name=__codelineno-22-62 href=#__codelineno-22-62></a><span class=w>      </span><span class=nx>outputPath</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;/tmp/test-downloads&#39;</span><span class=p>,</span>
</span><span id=__span-22-63><a id=__codelineno-22-63 name=__codelineno-22-63 href=#__codelineno-22-63></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-22-64><a id=__codelineno-22-64 name=__codelineno-22-64 href=#__codelineno-22-64></a>
</span><span id=__span-22-65><a id=__codelineno-22-65 name=__codelineno-22-65 href=#__codelineno-22-65></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>queue</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=s1>&#39;download&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>jobData</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-66><a id=__codelineno-22-66 name=__codelineno-22-66 href=#__codelineno-22-66></a><span class=w>      </span><span class=nx>attempts</span><span class=o>:</span><span class=w> </span><span class=kt>3</span><span class=p>,</span>
</span><span id=__span-22-67><a id=__codelineno-22-67 name=__codelineno-22-67 href=#__codelineno-22-67></a><span class=w>      </span><span class=nx>backoff</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=kr>type</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;exponential&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>delay</span><span class=o>:</span><span class=w> </span><span class=kt>1000</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-22-68><a id=__codelineno-22-68 name=__codelineno-22-68 href=#__codelineno-22-68></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-22-69><a id=__codelineno-22-69 name=__codelineno-22-69 href=#__codelineno-22-69></a>
</span><span id=__span-22-70><a id=__codelineno-22-70 name=__codelineno-22-70 href=#__codelineno-22-70></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-71><a id=__codelineno-22-71 name=__codelineno-22-71 href=#__codelineno-22-71></a><span class=w>      </span><span class=k>await</span><span class=w> </span><span class=nx>job</span><span class=p>.</span><span class=nx>waitUntilFinished</span><span class=p>(</span><span class=nx>worker</span><span class=p>.</span><span class=nx>queueEvents</span><span class=p>);</span>
</span><span id=__span-22-72><a id=__codelineno-22-72 name=__codelineno-22-72 href=#__codelineno-22-72></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=nx>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-73><a id=__codelineno-22-73 name=__codelineno-22-73 href=#__codelineno-22-73></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>jobState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>job</span><span class=p>.</span><span class=nx>getState</span><span class=p>();</span>
</span><span id=__span-22-74><a id=__codelineno-22-74 name=__codelineno-22-74 href=#__codelineno-22-74></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>attempts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>job</span><span class=p>.</span><span class=nx>getFailedReason</span><span class=p>();</span>
</span><span id=__span-22-75><a id=__codelineno-22-75 name=__codelineno-22-75 href=#__codelineno-22-75></a><span class=w>      </span><span class=nx>expect</span><span class=p>(</span><span class=nx>jobState</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;failed&#39;</span><span class=p>);</span>
</span><span id=__span-22-76><a id=__codelineno-22-76 name=__codelineno-22-76 href=#__codelineno-22-76></a><span class=w>      </span><span class=nx>expect</span><span class=p>(</span><span class=nx>job</span><span class=p>.</span><span class=nx>attemptsMade</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>3</span><span class=p>);</span>
</span><span id=__span-22-77><a id=__codelineno-22-77 name=__codelineno-22-77 href=#__codelineno-22-77></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-22-78><a id=__codelineno-22-78 name=__codelineno-22-78 href=#__codelineno-22-78></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-22-79><a id=__codelineno-22-79 name=__codelineno-22-79 href=#__codelineno-22-79></a><span class=p>});</span>
</span></code></pre></div><h3 id=55-authentication-testing>5.5 Authentication Testing<a class=headerlink href=#55-authentication-testing title="Permanent link">&para;</a></h3><h4 id=plex-oauth-testing>Plex OAuth Testing<a class=headerlink href=#plex-oauth-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=c1>// backend/tests/integration/auth/plexOAuth.test.ts</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=k>import</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;supertest&#39;</span><span class=p>;</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=k>import</span><span class=w> </span><span class=nx>nock</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;nock&#39;</span><span class=p>;</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>app</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../../src/app&#39;</span><span class=p>;</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Plex OAuth Authentication&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;completes OAuth flow successfully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=w>    </span><span class=c1>// Mock Plex PIN generation</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=w>    </span><span class=nx>nock</span><span class=p>(</span><span class=s1>&#39;https://plex.tv&#39;</span><span class=p>)</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=w>      </span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/pins.xml&#39;</span><span class=p>)</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=w>      </span><span class=p>.</span><span class=nx>reply</span><span class=p>(</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=w>        </span><span class=mf>200</span><span class=p>,</span>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=w>        </span><span class=sb>`</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a><span class=sb>        &lt;pin&gt;</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=sb>          &lt;id&gt;12345&lt;/id&gt;</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=sb>          &lt;code&gt;ABCD&lt;/code&gt;</span>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=sb>        &lt;/pin&gt;</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a><span class=sb>      `</span><span class=p>,</span>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=w>    </span><span class=c1>// Request PIN</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>pinResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/auth/plex/pin&#39;</span><span class=p>).</span><span class=nx>expect</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23 href=#__codelineno-23-23></a>
</span><span id=__span-23-24><a id=__codelineno-23-24 name=__codelineno-23-24 href=#__codelineno-23-24></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>pinResponse</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>pin</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;ABCD&#39;</span><span class=p>);</span>
</span><span id=__span-23-25><a id=__codelineno-23-25 name=__codelineno-23-25 href=#__codelineno-23-25></a>
</span><span id=__span-23-26><a id=__codelineno-23-26 name=__codelineno-23-26 href=#__codelineno-23-26></a><span class=w>    </span><span class=c1>// Mock PIN verification with auth token</span>
</span><span id=__span-23-27><a id=__codelineno-23-27 name=__codelineno-23-27 href=#__codelineno-23-27></a><span class=w>    </span><span class=nx>nock</span><span class=p>(</span><span class=s1>&#39;https://plex.tv&#39;</span><span class=p>)</span>
</span><span id=__span-23-28><a id=__codelineno-23-28 name=__codelineno-23-28 href=#__codelineno-23-28></a><span class=w>      </span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/pins/12345.xml&#39;</span><span class=p>)</span>
</span><span id=__span-23-29><a id=__codelineno-23-29 name=__codelineno-23-29 href=#__codelineno-23-29></a><span class=w>      </span><span class=p>.</span><span class=nx>reply</span><span class=p>(</span>
</span><span id=__span-23-30><a id=__codelineno-23-30 name=__codelineno-23-30 href=#__codelineno-23-30></a><span class=w>        </span><span class=mf>200</span><span class=p>,</span>
</span><span id=__span-23-31><a id=__codelineno-23-31 name=__codelineno-23-31 href=#__codelineno-23-31></a><span class=w>        </span><span class=sb>`</span>
</span><span id=__span-23-32><a id=__codelineno-23-32 name=__codelineno-23-32 href=#__codelineno-23-32></a><span class=sb>        &lt;pin&gt;</span>
</span><span id=__span-23-33><a id=__codelineno-23-33 name=__codelineno-23-33 href=#__codelineno-23-33></a><span class=sb>          &lt;id&gt;12345&lt;/id&gt;</span>
</span><span id=__span-23-34><a id=__codelineno-23-34 name=__codelineno-23-34 href=#__codelineno-23-34></a><span class=sb>          &lt;authToken&gt;plex-auth-token&lt;/authToken&gt;</span>
</span><span id=__span-23-35><a id=__codelineno-23-35 name=__codelineno-23-35 href=#__codelineno-23-35></a><span class=sb>        &lt;/pin&gt;</span>
</span><span id=__span-23-36><a id=__codelineno-23-36 name=__codelineno-23-36 href=#__codelineno-23-36></a><span class=sb>      `</span><span class=p>,</span>
</span><span id=__span-23-37><a id=__codelineno-23-37 name=__codelineno-23-37 href=#__codelineno-23-37></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-23-38><a id=__codelineno-23-38 name=__codelineno-23-38 href=#__codelineno-23-38></a>
</span><span id=__span-23-39><a id=__codelineno-23-39 name=__codelineno-23-39 href=#__codelineno-23-39></a><span class=w>    </span><span class=c1>// Mock user info fetch</span>
</span><span id=__span-23-40><a id=__codelineno-23-40 name=__codelineno-23-40 href=#__codelineno-23-40></a><span class=w>    </span><span class=nx>nock</span><span class=p>(</span><span class=s1>&#39;https://plex.tv&#39;</span><span class=p>)</span>
</span><span id=__span-23-41><a id=__codelineno-23-41 name=__codelineno-23-41 href=#__codelineno-23-41></a><span class=w>      </span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/users/account.xml&#39;</span><span class=p>)</span>
</span><span id=__span-23-42><a id=__codelineno-23-42 name=__codelineno-23-42 href=#__codelineno-23-42></a><span class=w>      </span><span class=p>.</span><span class=nx>query</span><span class=p>({</span><span class=w> </span><span class=s1>&#39;X-Plex-Token&#39;</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;plex-auth-token&#39;</span><span class=w> </span><span class=p>})</span>
</span><span id=__span-23-43><a id=__codelineno-23-43 name=__codelineno-23-43 href=#__codelineno-23-43></a><span class=w>      </span><span class=p>.</span><span class=nx>reply</span><span class=p>(</span>
</span><span id=__span-23-44><a id=__codelineno-23-44 name=__codelineno-23-44 href=#__codelineno-23-44></a><span class=w>        </span><span class=mf>200</span><span class=p>,</span>
</span><span id=__span-23-45><a id=__codelineno-23-45 name=__codelineno-23-45 href=#__codelineno-23-45></a><span class=w>        </span><span class=sb>`</span>
</span><span id=__span-23-46><a id=__codelineno-23-46 name=__codelineno-23-46 href=#__codelineno-23-46></a><span class=sb>        &lt;user&gt;</span>
</span><span id=__span-23-47><a id=__codelineno-23-47 name=__codelineno-23-47 href=#__codelineno-23-47></a><span class=sb>          &lt;id&gt;456&lt;/id&gt;</span>
</span><span id=__span-23-48><a id=__codelineno-23-48 name=__codelineno-23-48 href=#__codelineno-23-48></a><span class=sb>          &lt;username&gt;testuser&lt;/username&gt;</span>
</span><span id=__span-23-49><a id=__codelineno-23-49 name=__codelineno-23-49 href=#__codelineno-23-49></a><span class=sb>          &lt;email&gt;test@example.com&lt;/email&gt;</span>
</span><span id=__span-23-50><a id=__codelineno-23-50 name=__codelineno-23-50 href=#__codelineno-23-50></a><span class=sb>        &lt;/user&gt;</span>
</span><span id=__span-23-51><a id=__codelineno-23-51 name=__codelineno-23-51 href=#__codelineno-23-51></a><span class=sb>      `</span><span class=p>,</span>
</span><span id=__span-23-52><a id=__codelineno-23-52 name=__codelineno-23-52 href=#__codelineno-23-52></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-23-53><a id=__codelineno-23-53 name=__codelineno-23-53 href=#__codelineno-23-53></a>
</span><span id=__span-23-54><a id=__codelineno-23-54 name=__codelineno-23-54 href=#__codelineno-23-54></a><span class=w>    </span><span class=c1>// Verify PIN and complete OAuth</span>
</span><span id=__span-23-55><a id=__codelineno-23-55 name=__codelineno-23-55 href=#__codelineno-23-55></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>authResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span><span id=__span-23-56><a id=__codelineno-23-56 name=__codelineno-23-56 href=#__codelineno-23-56></a><span class=w>      </span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/auth/plex/verify&#39;</span><span class=p>)</span>
</span><span id=__span-23-57><a id=__codelineno-23-57 name=__codelineno-23-57 href=#__codelineno-23-57></a><span class=w>      </span><span class=p>.</span><span class=nx>send</span><span class=p>({</span><span class=w> </span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;12345&#39;</span><span class=w> </span><span class=p>})</span>
</span><span id=__span-23-58><a id=__codelineno-23-58 name=__codelineno-23-58 href=#__codelineno-23-58></a><span class=w>      </span><span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-23-59><a id=__codelineno-23-59 name=__codelineno-23-59 href=#__codelineno-23-59></a>
</span><span id=__span-23-60><a id=__codelineno-23-60 name=__codelineno-23-60 href=#__codelineno-23-60></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>authResponse</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;testuser&#39;</span><span class=p>);</span>
</span><span id=__span-23-61><a id=__codelineno-23-61 name=__codelineno-23-61 href=#__codelineno-23-61></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>authResponse</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>).</span><span class=nx>toBeDefined</span><span class=p>();</span>
</span><span id=__span-23-62><a id=__codelineno-23-62 name=__codelineno-23-62 href=#__codelineno-23-62></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-23-63><a id=__codelineno-23-63 name=__codelineno-23-63 href=#__codelineno-23-63></a>
</span><span id=__span-23-64><a id=__codelineno-23-64 name=__codelineno-23-64 href=#__codelineno-23-64></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles expired PIN gracefully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-65><a id=__codelineno-23-65 name=__codelineno-23-65 href=#__codelineno-23-65></a><span class=w>    </span><span class=nx>nock</span><span class=p>(</span><span class=s1>&#39;https://plex.tv&#39;</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/pins/expired-pin.xml&#39;</span><span class=p>).</span><span class=nx>reply</span><span class=p>(</span><span class=mf>404</span><span class=p>);</span>
</span><span id=__span-23-66><a id=__codelineno-23-66 name=__codelineno-23-66 href=#__codelineno-23-66></a>
</span><span id=__span-23-67><a id=__codelineno-23-67 name=__codelineno-23-67 href=#__codelineno-23-67></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/auth/plex/verify&#39;</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span><span class=w> </span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;expired-pin&#39;</span><span class=w> </span><span class=p>}).</span><span class=nx>expect</span><span class=p>(</span><span class=mf>400</span><span class=p>);</span>
</span><span id=__span-23-68><a id=__codelineno-23-68 name=__codelineno-23-68 href=#__codelineno-23-68></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-23-69><a id=__codelineno-23-69 name=__codelineno-23-69 href=#__codelineno-23-69></a><span class=p>});</span>
</span></code></pre></div><h4 id=jwt-token-testing>JWT Token Testing<a class=headerlink href=#jwt-token-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=c1>// backend/tests/unit/auth/jwtService.test.ts</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>JWTService</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../../src/services/jwtService&#39;</span><span class=p>;</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;JWT Service&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>jwtService</span><span class=o>:</span><span class=w> </span><span class=kt>JWTService</span><span class=p>;</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>  </span><span class=nx>beforeEach</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>    </span><span class=nx>jwtService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>JWTService</span><span class=p>(</span><span class=s1>&#39;test-secret&#39;</span><span class=p>);</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;generates and validates tokens correctly&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwtService</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>payload</span><span class=p>);</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>token</span><span class=p>).</span><span class=nx>toBeDefined</span><span class=p>();</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>decoded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwtService</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>decoded</span><span class=p>.</span><span class=nx>userId</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>);</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>decoded</span><span class=p>.</span><span class=nx>role</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>);</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;rejects expired tokens&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-24-24><a id=__codelineno-24-24 name=__codelineno-24-24 href=#__codelineno-24-24></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwtService</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>payload</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>expiresIn</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1ms&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-24-25><a id=__codelineno-24-25 name=__codelineno-24-25 href=#__codelineno-24-25></a>
</span><span id=__span-24-26><a id=__codelineno-24-26 name=__codelineno-24-26 href=#__codelineno-24-26></a><span class=w>    </span><span class=c1>// Wait for token to expire</span>
</span><span id=__span-24-27><a id=__codelineno-24-27 name=__codelineno-24-27 href=#__codelineno-24-27></a><span class=w>    </span><span class=nx>setTimeout</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-28><a id=__codelineno-24-28 name=__codelineno-24-28 href=#__codelineno-24-28></a><span class=w>      </span><span class=nx>expect</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>jwtService</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>)).</span><span class=nx>toThrow</span><span class=p>(</span><span class=s1>&#39;Token expired&#39;</span><span class=p>);</span>
</span><span id=__span-24-29><a id=__codelineno-24-29 name=__codelineno-24-29 href=#__codelineno-24-29></a><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=mf>10</span><span class=p>);</span>
</span><span id=__span-24-30><a id=__codelineno-24-30 name=__codelineno-24-30 href=#__codelineno-24-30></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-24-31><a id=__codelineno-24-31 name=__codelineno-24-31 href=#__codelineno-24-31></a>
</span><span id=__span-24-32><a id=__codelineno-24-32 name=__codelineno-24-32 href=#__codelineno-24-32></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;rejects tampered tokens&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-33><a id=__codelineno-24-33 name=__codelineno-24-33 href=#__codelineno-24-33></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-24-34><a id=__codelineno-24-34 name=__codelineno-24-34 href=#__codelineno-24-34></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>jwtService</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>payload</span><span class=p>);</span>
</span><span id=__span-24-35><a id=__codelineno-24-35 name=__codelineno-24-35 href=#__codelineno-24-35></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>tamperedToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>token</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mf>0</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=mf>1</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;x&#39;</span><span class=p>;</span>
</span><span id=__span-24-36><a id=__codelineno-24-36 name=__codelineno-24-36 href=#__codelineno-24-36></a>
</span><span id=__span-24-37><a id=__codelineno-24-37 name=__codelineno-24-37 href=#__codelineno-24-37></a><span class=w>    </span><span class=nx>expect</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>jwtService</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>tamperedToken</span><span class=p>)).</span><span class=nx>toThrow</span><span class=p>(</span><span class=s1>&#39;Invalid signature&#39;</span><span class=p>);</span>
</span><span id=__span-24-38><a id=__codelineno-24-38 name=__codelineno-24-38 href=#__codelineno-24-38></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-24-39><a id=__codelineno-24-39 name=__codelineno-24-39 href=#__codelineno-24-39></a><span class=p>});</span>
</span></code></pre></div><h3 id=56-end-to-end-testing>5.6 End-to-End Testing<a class=headerlink href=#56-end-to-end-testing title="Permanent link">&para;</a></h3><h4 id=actual-e2e-test-implementation>Actual E2E Test Implementation<a class=headerlink href=#actual-e2e-test-implementation title="Permanent link">&para;</a></h4><p>Contrary to earlier sections marking E2E as "NOT IMPLEMENTED", the project has 3 working E2E test files:</p><ol><li><strong>auth/auth-flow.spec.ts</strong> - Tests the complete Plex OAuth authentication flow</li><li><strong>dashboard/service-status.spec.ts</strong> - Tests real-time service status updates via WebSocket</li><li><strong>media/media-request-flow.spec.ts</strong> - Tests the media search and request submission process</li></ol><div class="language-typescript highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=c1>// e2e/tests/mediaRequest.spec.ts</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>test</span><span class=p>,</span><span class=w> </span><span class=nx>expect</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@playwright/test&#39;</span><span class=p>;</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=nx>test</span><span class=p>.</span><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Media Request Flow&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>  </span><span class=nx>test</span><span class=p>.</span><span class=nx>beforeEach</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>page</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=w>    </span><span class=c1>// Login with test user</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=kr>goto</span><span class=p>(</span><span class=s1>&#39;/auth/login&#39;</span><span class=p>);</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>click</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;plex-login-button&quot;]&#39;</span><span class=p>);</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=w>    </span><span class=c1>// Mock Plex OAuth flow</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>route</span><span class=p>(</span><span class=s1>&#39;https://plex.tv/pins.xml&#39;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nx>route</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>      </span><span class=nx>route</span><span class=p>.</span><span class=nx>fulfill</span><span class=p>({</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>        </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>200</span><span class=p>,</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=w>        </span><span class=nx>body</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;&lt;pin&gt;&lt;id&gt;test&lt;/id&gt;&lt;code&gt;1234&lt;/code&gt;&lt;/pin&gt;&#39;</span><span class=p>,</span>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a>
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>fill</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;pin-input&quot;]&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;1234&#39;</span><span class=p>);</span>
</span><span id=__span-25-19><a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>click</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;verify-pin&quot;]&#39;</span><span class=p>);</span>
</span><span id=__span-25-20><a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>waitForURL</span><span class=p>(</span><span class=s1>&#39;/dashboard&#39;</span><span class=p>);</span>
</span><span id=__span-25-21><a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-25-22><a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a>
</span><span id=__span-25-23><a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=w>  </span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;user can request new media&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>page</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-24><a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a><span class=w>    </span><span class=c1>// Navigate to media search</span>
</span><span id=__span-25-25><a id=__codelineno-25-25 name=__codelineno-25-25 href=#__codelineno-25-25></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>click</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;media-search-nav&quot;]&#39;</span><span class=p>);</span>
</span><span id=__span-25-26><a id=__codelineno-25-26 name=__codelineno-25-26 href=#__codelineno-25-26></a>
</span><span id=__span-25-27><a id=__codelineno-25-27 name=__codelineno-25-27 href=#__codelineno-25-27></a><span class=w>    </span><span class=c1>// Search for movie</span>
</span><span id=__span-25-28><a id=__codelineno-25-28 name=__codelineno-25-28 href=#__codelineno-25-28></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>fill</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;search-input&quot;]&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;The Matrix&#39;</span><span class=p>);</span>
</span><span id=__span-25-29><a id=__codelineno-25-29 name=__codelineno-25-29 href=#__codelineno-25-29></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>click</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;search-button&quot;]&#39;</span><span class=p>);</span>
</span><span id=__span-25-30><a id=__codelineno-25-30 name=__codelineno-25-30 href=#__codelineno-25-30></a>
</span><span id=__span-25-31><a id=__codelineno-25-31 name=__codelineno-25-31 href=#__codelineno-25-31></a><span class=w>    </span><span class=c1>// Verify search results</span>
</span><span id=__span-25-32><a id=__codelineno-25-32 name=__codelineno-25-32 href=#__codelineno-25-32></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>expect</span><span class=p>(</span><span class=nx>page</span><span class=p>.</span><span class=nx>locator</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;search-results&quot;]&#39;</span><span class=p>)).</span><span class=nx>toBeVisible</span><span class=p>();</span>
</span><span id=__span-25-33><a id=__codelineno-25-33 name=__codelineno-25-33 href=#__codelineno-25-33></a>
</span><span id=__span-25-34><a id=__codelineno-25-34 name=__codelineno-25-34 href=#__codelineno-25-34></a><span class=w>    </span><span class=c1>// Request movie</span>
</span><span id=__span-25-35><a id=__codelineno-25-35 name=__codelineno-25-35 href=#__codelineno-25-35></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>click</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;request-button-603&quot;]&#39;</span><span class=p>);</span>
</span><span id=__span-25-36><a id=__codelineno-25-36 name=__codelineno-25-36 href=#__codelineno-25-36></a>
</span><span id=__span-25-37><a id=__codelineno-25-37 name=__codelineno-25-37 href=#__codelineno-25-37></a><span class=w>    </span><span class=c1>// Confirm request</span>
</span><span id=__span-25-38><a id=__codelineno-25-38 name=__codelineno-25-38 href=#__codelineno-25-38></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>click</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;confirm-request&quot;]&#39;</span><span class=p>);</span>
</span><span id=__span-25-39><a id=__codelineno-25-39 name=__codelineno-25-39 href=#__codelineno-25-39></a>
</span><span id=__span-25-40><a id=__codelineno-25-40 name=__codelineno-25-40 href=#__codelineno-25-40></a><span class=w>    </span><span class=c1>// Verify success message</span>
</span><span id=__span-25-41><a id=__codelineno-25-41 name=__codelineno-25-41 href=#__codelineno-25-41></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>expect</span><span class=p>(</span><span class=nx>page</span><span class=p>.</span><span class=nx>locator</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;success-message&quot;]&#39;</span><span class=p>)).</span><span class=nx>toContainText</span><span class=p>(</span>
</span><span id=__span-25-42><a id=__codelineno-25-42 name=__codelineno-25-42 href=#__codelineno-25-42></a><span class=w>      </span><span class=s1>&#39;Request submitted successfully&#39;</span><span class=p>,</span>
</span><span id=__span-25-43><a id=__codelineno-25-43 name=__codelineno-25-43 href=#__codelineno-25-43></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-25-44><a id=__codelineno-25-44 name=__codelineno-25-44 href=#__codelineno-25-44></a>
</span><span id=__span-25-45><a id=__codelineno-25-45 name=__codelineno-25-45 href=#__codelineno-25-45></a><span class=w>    </span><span class=c1>// Check request appears in user&#39;s queue</span>
</span><span id=__span-25-46><a id=__codelineno-25-46 name=__codelineno-25-46 href=#__codelineno-25-46></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>click</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;my-requests-nav&quot;]&#39;</span><span class=p>);</span>
</span><span id=__span-25-47><a id=__codelineno-25-47 name=__codelineno-25-47 href=#__codelineno-25-47></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>expect</span><span class=p>(</span><span class=nx>page</span><span class=p>.</span><span class=nx>locator</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;request-item&quot;]&#39;</span><span class=p>)).</span><span class=nx>toContainText</span><span class=p>(</span><span class=s1>&#39;The Matrix&#39;</span><span class=p>);</span>
</span><span id=__span-25-48><a id=__codelineno-25-48 name=__codelineno-25-48 href=#__codelineno-25-48></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-25-49><a id=__codelineno-25-49 name=__codelineno-25-49 href=#__codelineno-25-49></a>
</span><span id=__span-25-50><a id=__codelineno-25-50 name=__codelineno-25-50 href=#__codelineno-25-50></a><span class=w>  </span><span class=nx>test</span><span class=p>(</span><span class=s1>&#39;user sees service status updates in real-time&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>page</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-51><a id=__codelineno-25-51 name=__codelineno-25-51 href=#__codelineno-25-51></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=kr>goto</span><span class=p>(</span><span class=s1>&#39;/dashboard&#39;</span><span class=p>);</span>
</span><span id=__span-25-52><a id=__codelineno-25-52 name=__codelineno-25-52 href=#__codelineno-25-52></a>
</span><span id=__span-25-53><a id=__codelineno-25-53 name=__codelineno-25-53 href=#__codelineno-25-53></a><span class=w>    </span><span class=c1>// Initial service status</span>
</span><span id=__span-25-54><a id=__codelineno-25-54 name=__codelineno-25-54 href=#__codelineno-25-54></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>expect</span><span class=p>(</span><span class=nx>page</span><span class=p>.</span><span class=nx>locator</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;plex-status&quot;]&#39;</span><span class=p>)).</span><span class=nx>toHaveClass</span><span class=p>(</span><span class=sr>/status-up/</span><span class=p>);</span>
</span><span id=__span-25-55><a id=__codelineno-25-55 name=__codelineno-25-55 href=#__codelineno-25-55></a>
</span><span id=__span-25-56><a id=__codelineno-25-56 name=__codelineno-25-56 href=#__codelineno-25-56></a><span class=w>    </span><span class=c1>// Simulate service going down via WebSocket</span>
</span><span id=__span-25-57><a id=__codelineno-25-57 name=__codelineno-25-57 href=#__codelineno-25-57></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>page</span><span class=p>.</span><span class=nx>evaluate</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-58><a id=__codelineno-25-58 name=__codelineno-25-58 href=#__codelineno-25-58></a><span class=w>      </span><span class=nb>window</span><span class=p>.</span><span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;service:status&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-59><a id=__codelineno-25-59 name=__codelineno-25-59 href=#__codelineno-25-59></a><span class=w>        </span><span class=nx>service</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;plex&#39;</span><span class=p>,</span>
</span><span id=__span-25-60><a id=__codelineno-25-60 name=__codelineno-25-60 href=#__codelineno-25-60></a><span class=w>        </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;down&#39;</span><span class=p>,</span>
</span><span id=__span-25-61><a id=__codelineno-25-61 name=__codelineno-25-61 href=#__codelineno-25-61></a><span class=w>        </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>Date.now</span><span class=p>(),</span>
</span><span id=__span-25-62><a id=__codelineno-25-62 name=__codelineno-25-62 href=#__codelineno-25-62></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-25-63><a id=__codelineno-25-63 name=__codelineno-25-63 href=#__codelineno-25-63></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-25-64><a id=__codelineno-25-64 name=__codelineno-25-64 href=#__codelineno-25-64></a>
</span><span id=__span-25-65><a id=__codelineno-25-65 name=__codelineno-25-65 href=#__codelineno-25-65></a><span class=w>    </span><span class=c1>// Verify status update</span>
</span><span id=__span-25-66><a id=__codelineno-25-66 name=__codelineno-25-66 href=#__codelineno-25-66></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>expect</span><span class=p>(</span><span class=nx>page</span><span class=p>.</span><span class=nx>locator</span><span class=p>(</span><span class=s1>&#39;[data-testid=&quot;plex-status&quot;]&#39;</span><span class=p>)).</span><span class=nx>toHaveClass</span><span class=p>(</span><span class=sr>/status-down/</span><span class=p>);</span>
</span><span id=__span-25-67><a id=__codelineno-25-67 name=__codelineno-25-67 href=#__codelineno-25-67></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-25-68><a id=__codelineno-25-68 name=__codelineno-25-68 href=#__codelineno-25-68></a><span class=p>});</span>
</span></code></pre></div><h2 id=6-environment-configuration>6. Environment Configuration<a class=headerlink href=#6-environment-configuration title="Permanent link">&para;</a></h2><h3 id=61-test-environment-setup>6.1 Test Environment Setup<a class=headerlink href=#61-test-environment-setup title="Permanent link">&para;</a></h3><h4 id=docker-compose-for-testing>Docker Compose for Testing<a class=headerlink href=#docker-compose-for-testing title="Permanent link">&para;</a></h4><div class="language-yaml highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=c1># docker-compose.test.yml</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s>&#39;3.8&#39;</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=nt>services</span><span class=p>:</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>  </span><span class=nt>postgres-test</span><span class=p>:</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15-alpine</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=w>    </span><span class=nt>environment</span><span class=p>:</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=w>      </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">medianest_test</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;5433:5432&#39;</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=w>    </span><span class=nt>tmpfs</span><span class=p>:</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=w>  </span><span class=nt>redis-test</span><span class=p>:</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&#39;6380:6379&#39;</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redis-server --save &quot;&quot;</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=w>  </span><span class=nt>app-test</span><span class=p>:</span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=w>    </span><span class=nt>build</span><span class=p>:</span>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a><span class=w>      </span><span class=nt>dockerfile</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.test</span>
</span><span id=__span-26-26><a id=__codelineno-26-26 name=__codelineno-26-26 href=#__codelineno-26-26></a><span class=w>    </span><span class=nt>environment</span><span class=p>:</span>
</span><span id=__span-26-27><a id=__codelineno-26-27 name=__codelineno-26-27 href=#__codelineno-26-27></a><span class=w>      </span><span class=nt>NODE_ENV</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span><span id=__span-26-28><a id=__codelineno-26-28 name=__codelineno-26-28 href=#__codelineno-26-28></a><span class=w>      </span><span class=nt>DATABASE_URL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgresql://test:test@postgres-test:5432/medianest_test</span>
</span><span id=__span-26-29><a id=__codelineno-26-29 name=__codelineno-26-29 href=#__codelineno-26-29></a><span class=w>      </span><span class=nt>REDIS_URL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redis://redis-test:6379</span>
</span><span id=__span-26-30><a id=__codelineno-26-30 name=__codelineno-26-30 href=#__codelineno-26-30></a><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span>
</span><span id=__span-26-31><a id=__codelineno-26-31 name=__codelineno-26-31 href=#__codelineno-26-31></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgres-test</span>
</span><span id=__span-26-32><a id=__codelineno-26-32 name=__codelineno-26-32 href=#__codelineno-26-32></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redis-test</span>
</span><span id=__span-26-33><a id=__codelineno-26-33 name=__codelineno-26-33 href=#__codelineno-26-33></a><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span>
</span><span id=__span-26-34><a id=__codelineno-26-34 name=__codelineno-26-34 href=#__codelineno-26-34></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./test-results:/app/test-results</span>
</span></code></pre></div><h4 id=test-configuration>Test Configuration<a class=headerlink href=#test-configuration title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=c1>// vitest.config.ts - Backend configuration</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>defineConfig</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest/config&#39;</span><span class=p>;</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=k>import</span><span class=w> </span><span class=nx>path</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nx>defineConfig</span><span class=p>({</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=w>  </span><span class=nx>test</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=w>    </span><span class=nx>environment</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;node&#39;</span><span class=p>,</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=w>    </span><span class=nx>setupFiles</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;./tests/setup.ts&#39;</span><span class=p>],</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=w>    </span><span class=nx>globals</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=w>    </span><span class=nx>coverage</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=w>      </span><span class=nx>provider</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;v8&#39;</span><span class=p>,</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=w>      </span><span class=nx>reporter</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;json&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;html&#39;</span><span class=p>],</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=w>      </span><span class=nx>exclude</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;node_modules/&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;tests/&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;**/*.d.ts&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;**/*.config.*&#39;</span><span class=p>],</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=w>      </span><span class=nx>thresholds</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=w>        </span><span class=nx>branches</span><span class=o>:</span><span class=w> </span><span class=kt>70</span><span class=p>,</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=w>        </span><span class=nx>functions</span><span class=o>:</span><span class=w> </span><span class=kt>70</span><span class=p>,</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=w>        </span><span class=nx>lines</span><span class=o>:</span><span class=w> </span><span class=kt>70</span><span class=p>,</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=w>        </span><span class=nx>statements</span><span class=o>:</span><span class=w> </span><span class=kt>70</span><span class=p>,</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=w>    </span><span class=nx>testTimeout</span><span class=o>:</span><span class=w> </span><span class=kt>30000</span><span class=p>,</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=w>    </span><span class=nx>pool</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;forks&#39;</span><span class=p>,</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=w>    </span><span class=nx>poolOptions</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=w>      </span><span class=nx>forks</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=w>        </span><span class=nx>singleFork</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-27-26><a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-27-27><a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-27-28><a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-27-29><a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a><span class=w>  </span><span class=nx>resolve</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-30><a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a><span class=w>    </span><span class=nx>alias</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-31><a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a><span class=w>      </span><span class=s1>&#39;@&#39;</span><span class=o>:</span><span class=w> </span><span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;./src&#39;</span><span class=p>),</span>
</span><span id=__span-27-32><a id=__codelineno-27-32 name=__codelineno-27-32 href=#__codelineno-27-32></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-27-33><a id=__codelineno-27-33 name=__codelineno-27-33 href=#__codelineno-27-33></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-27-34><a id=__codelineno-27-34 name=__codelineno-27-34 href=#__codelineno-27-34></a><span class=p>});</span>
</span></code></pre></div><h4 id=playwright-configuration>Playwright Configuration<a class=headerlink href=#playwright-configuration title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1>// playwright.config.ts</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>defineConfig</span><span class=p>,</span><span class=w> </span><span class=nx>devices</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@playwright/test&#39;</span><span class=p>;</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nx>defineConfig</span><span class=p>({</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=w>  </span><span class=nx>testDir</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;./e2e/tests&#39;</span><span class=p>,</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=w>  </span><span class=nx>fullyParallel</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=p>,</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=w>  </span><span class=nx>forbidOnly</span><span class=o>:</span><span class=w> </span><span class=o>!!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CI</span><span class=p>,</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=w>  </span><span class=nx>retries</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.CI</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>2</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=kt>0</span><span class=p>,</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=w>  </span><span class=nx>workers</span><span class=o>:</span><span class=w> </span><span class=kt>process.env.CI</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>1</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=kt>undefined</span><span class=p>,</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=w>  </span><span class=nx>reporter</span><span class=o>:</span><span class=w> </span><span class=p>[[</span><span class=s1>&#39;html&#39;</span><span class=p>],</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;junit&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>outputFile</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test-results/results.xml&#39;</span><span class=w> </span><span class=p>}]],</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=w>  </span><span class=nx>use</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=w>    </span><span class=nx>baseURL</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;http://localhost:3000&#39;</span><span class=p>,</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=w>    </span><span class=nx>trace</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;on-first-retry&#39;</span><span class=p>,</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=w>    </span><span class=nx>screenshot</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;only-on-failure&#39;</span><span class=p>,</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=w>  </span><span class=nx>projects</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=w>      </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;chromium&#39;</span><span class=p>,</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a><span class=w>      </span><span class=nx>use</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>...</span><span class=nx>devices</span><span class=p>[</span><span class=s1>&#39;Desktop Chrome&#39;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a><span class=w>      </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;firefox&#39;</span><span class=p>,</span>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a><span class=w>      </span><span class=nx>use</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>...</span><span class=nx>devices</span><span class=p>[</span><span class=s1>&#39;Desktop Firefox&#39;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24 href=#__codelineno-28-24></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25 href=#__codelineno-28-25></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26 href=#__codelineno-28-26></a><span class=w>      </span><span class=nx>name</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;webkit&#39;</span><span class=p>,</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27 href=#__codelineno-28-27></a><span class=w>      </span><span class=nx>use</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>...</span><span class=nx>devices</span><span class=p>[</span><span class=s1>&#39;Desktop Safari&#39;</span><span class=p>]</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28 href=#__codelineno-28-28></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-28-29><a id=__codelineno-28-29 name=__codelineno-28-29 href=#__codelineno-28-29></a><span class=w>  </span><span class=p>],</span>
</span><span id=__span-28-30><a id=__codelineno-28-30 name=__codelineno-28-30 href=#__codelineno-28-30></a><span class=w>  </span><span class=nx>webServer</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-31><a id=__codelineno-28-31 name=__codelineno-28-31 href=#__codelineno-28-31></a><span class=w>    </span><span class=nx>command</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;npm run dev&#39;</span><span class=p>,</span>
</span><span id=__span-28-32><a id=__codelineno-28-32 name=__codelineno-28-32 href=#__codelineno-28-32></a><span class=w>    </span><span class=nx>port</span><span class=o>:</span><span class=w> </span><span class=kt>3000</span><span class=p>,</span>
</span><span id=__span-28-33><a id=__codelineno-28-33 name=__codelineno-28-33 href=#__codelineno-28-33></a><span class=w>    </span><span class=nx>reuseExistingServer</span><span class=o>:</span><span class=w> </span><span class=o>!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CI</span><span class=p>,</span>
</span><span id=__span-28-34><a id=__codelineno-28-34 name=__codelineno-28-34 href=#__codelineno-28-34></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-28-35><a id=__codelineno-28-35 name=__codelineno-28-35 href=#__codelineno-28-35></a><span class=p>});</span>
</span></code></pre></div><h3 id=62-test-data-management>6.2 Test Data Management<a class=headerlink href=#62-test-data-management title="Permanent link">&para;</a></h3><h4 id=database-fixtures>Database Fixtures<a class=headerlink href=#database-fixtures title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=c1>// tests/fixtures/users.ts</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>testUsers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=w>  </span><span class=p>{</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=w>    </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user-1&#39;</span><span class=p>,</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=w>    </span><span class=nx>plexId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;plex-123&#39;</span><span class=p>,</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=w>    </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;testuser1&#39;</span><span class=p>,</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=w>    </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test1@example.com&#39;</span><span class=p>,</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=w>    </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=w>  </span><span class=p>{</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a><span class=w>    </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;admin-1&#39;</span><span class=p>,</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=w>    </span><span class=nx>plexId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;plex-456&#39;</span><span class=p>,</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=w>    </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=w>    </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;admin@example.com&#39;</span><span class=p>,</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a><span class=w>    </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=p>];</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>testMediaRequests</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=w>  </span><span class=p>{</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=w>    </span><span class=nx>id</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;request-1&#39;</span><span class=p>,</span>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=w>    </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user-1&#39;</span><span class=p>,</span>
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=w>    </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;The Matrix&#39;</span><span class=p>,</span>
</span><span id=__span-29-24><a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a><span class=w>    </span><span class=nx>mediaType</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=p>,</span>
</span><span id=__span-29-25><a id=__codelineno-29-25 name=__codelineno-29-25 href=#__codelineno-29-25></a><span class=w>    </span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;603&#39;</span><span class=p>,</span>
</span><span id=__span-29-26><a id=__codelineno-29-26 name=__codelineno-29-26 href=#__codelineno-29-26></a><span class=w>    </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;pending&#39;</span><span class=p>,</span>
</span><span id=__span-29-27><a id=__codelineno-29-27 name=__codelineno-29-27 href=#__codelineno-29-27></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-29-28><a id=__codelineno-29-28 name=__codelineno-29-28 href=#__codelineno-29-28></a><span class=p>];</span>
</span></code></pre></div><h4 id=test-database-helpers>Test Database Helpers<a class=headerlink href=#test-database-helpers title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=c1>// tests/helpers/database.ts</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PrismaClient</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@prisma/client&#39;</span><span class=p>;</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>testUsers</span><span class=p>,</span><span class=w> </span><span class=nx>testMediaRequests</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../fixtures&#39;</span><span class=p>;</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>TestDatabase</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>prisma</span><span class=o>:</span><span class=w> </span><span class=kt>PrismaClient</span><span class=p>;</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=w>  </span><span class=kr>constructor</span><span class=p>(</span><span class=nx>connectionString</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PrismaClient</span><span class=p>({</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=w>      </span><span class=nx>datasources</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>db</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>url</span><span class=o>:</span><span class=w> </span><span class=kt>connectionString</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>seed</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=w>    </span><span class=c1>// Clear existing data</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>mediaRequest</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>();</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>();</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a>
</span><span id=__span-30-19><a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a><span class=w>    </span><span class=c1>// Insert test data</span>
</span><span id=__span-30-20><a id=__codelineno-30-20 name=__codelineno-30-20 href=#__codelineno-30-20></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>createMany</span><span class=p>({</span><span class=w> </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>testUsers</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-30-21><a id=__codelineno-30-21 name=__codelineno-30-21 href=#__codelineno-30-21></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>mediaRequest</span><span class=p>.</span><span class=nx>createMany</span><span class=p>({</span><span class=w> </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=kt>testMediaRequests</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-30-22><a id=__codelineno-30-22 name=__codelineno-30-22 href=#__codelineno-30-22></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-23><a id=__codelineno-30-23 name=__codelineno-30-23 href=#__codelineno-30-23></a>
</span><span id=__span-30-24><a id=__codelineno-30-24 name=__codelineno-30-24 href=#__codelineno-30-24></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>cleanup</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-25><a id=__codelineno-30-25 name=__codelineno-30-25 href=#__codelineno-30-25></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>mediaRequest</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>();</span>
</span><span id=__span-30-26><a id=__codelineno-30-26 name=__codelineno-30-26 href=#__codelineno-30-26></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>();</span>
</span><span id=__span-30-27><a id=__codelineno-30-27 name=__codelineno-30-27 href=#__codelineno-30-27></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-28><a id=__codelineno-30-28 name=__codelineno-30-28 href=#__codelineno-30-28></a>
</span><span id=__span-30-29><a id=__codelineno-30-29 name=__codelineno-30-29 href=#__codelineno-30-29></a><span class=w>  </span><span class=k>async</span><span class=w> </span><span class=nx>disconnect</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-30><a id=__codelineno-30-30 name=__codelineno-30-30 href=#__codelineno-30-30></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>$disconnect</span><span class=p>();</span>
</span><span id=__span-30-31><a id=__codelineno-30-31 name=__codelineno-30-31 href=#__codelineno-30-31></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-32><a id=__codelineno-30-32 name=__codelineno-30-32 href=#__codelineno-30-32></a><span class=p>}</span>
</span></code></pre></div><h2 id=7-test-implementation-guidelines>7. Test Implementation Guidelines<a class=headerlink href=#7-test-implementation-guidelines title="Permanent link">&para;</a></h2><h3 id=71-writing-effective-tests>7.1 Writing Effective Tests<a class=headerlink href=#71-writing-effective-tests title="Permanent link">&para;</a></h3><h4 id=test-structure-aaa-pattern>Test Structure (AAA Pattern)<a class=headerlink href=#test-structure-aaa-pattern title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Service Under Test&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should behave correctly when condition is met&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=w>    </span><span class=c1>// Arrange</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>mockDependency</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>createMockDependency</span><span class=p>();</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>ServiceUnderTest</span><span class=p>(</span><span class=nx>mockDependency</span><span class=p>);</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>input</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=w>      </span><span class=cm>/* test input */</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=w>    </span><span class=c1>// Act</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>service</span><span class=p>.</span><span class=nx>methodUnderTest</span><span class=p>(</span><span class=nx>input</span><span class=p>);</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=w>    </span><span class=c1>// Assert</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>).</span><span class=nx>toEqual</span><span class=p>(</span><span class=nx>expectedResult</span><span class=p>);</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>mockDependency</span><span class=p>.</span><span class=nx>method</span><span class=p>).</span><span class=nx>toHaveBeenCalledWith</span><span class=p>(</span><span class=nx>expectedArgs</span><span class=p>);</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=p>});</span>
</span></code></pre></div><h4 id=test-naming-conventions>Test Naming Conventions<a class=headerlink href=#test-naming-conventions title="Permanent link">&para;</a></h4><ul><li><strong>Unit tests</strong>: <code>service.method.should.behavior.when.condition.test.ts</code></li><li><strong>Integration tests</strong>: <code>feature.integration.test.ts</code></li><li><strong>E2E tests</strong>: <code>userFlow.spec.ts</code></li></ul><h4 id=mock-strategy>Mock Strategy<a class=headerlink href=#mock-strategy title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=c1>// Prefer dependency injection for easier mocking</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>MediaService</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=w>  </span><span class=kr>constructor</span><span class=p>(</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=w>    </span><span class=k>private</span><span class=w> </span><span class=nx>plexClient</span><span class=o>:</span><span class=w> </span><span class=kt>PlexClient</span><span class=p>,</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=w>    </span><span class=k>private</span><span class=w> </span><span class=nx>overseerrClient</span><span class=o>:</span><span class=w> </span><span class=kt>OverseerrClient</span><span class=p>,</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=w>    </span><span class=k>private</span><span class=w> </span><span class=nx>database</span><span class=o>:</span><span class=w> </span><span class=kt>Database</span><span class=p>,</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a><span class=w>  </span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=p>}</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=c1>// In tests</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=kd>const</span><span class=w> </span><span class=nx>mockPlexClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=w>  </span><span class=nx>getLibraries</span><span class=o>:</span><span class=w> </span><span class=kt>jest.fn</span><span class=p>(),</span>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=w>  </span><span class=nx>searchMedia</span><span class=o>:</span><span class=w> </span><span class=kt>jest.fn</span><span class=p>(),</span>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a><span class=p>};</span>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=kd>const</span><span class=w> </span><span class=nx>mediaService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>MediaService</span><span class=p>(</span><span class=nx>mockPlexClient</span><span class=p>,</span><span class=w> </span><span class=nx>mockOverseerrClient</span><span class=p>,</span><span class=w> </span><span class=nx>mockDatabase</span><span class=p>);</span>
</span></code></pre></div><h3 id=72-error-testing>7.2 Error Testing<a class=headerlink href=#72-error-testing title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=c1>// Test error conditions explicitly</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Error Handling&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles Plex server timeout gracefully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a><span class=w>    </span><span class=nx>mockPlexClient</span><span class=p>.</span><span class=nx>getLibraries</span><span class=p>.</span><span class=nx>mockRejectedValue</span><span class=p>(</span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;ETIMEDOUT&#39;</span><span class=p>));</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>mediaService</span><span class=p>.</span><span class=nx>getLibraries</span><span class=p>();</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>success</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>error</span><span class=p>).</span><span class=nx>toMatch</span><span class=p>(</span><span class=sr>/service unavailable/i</span><span class=p>);</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>cached</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// Should return cached data</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles invalid JWT tokens&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>invalidToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;invalid.jwt.token&#39;</span><span class=p>;</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a><span class=w>      </span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/protected&#39;</span><span class=p>)</span>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=w>      </span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span><span class=w> </span><span class=sb>`Bearer </span><span class=si>${</span><span class=nx>invalidToken</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=w>      </span><span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mf>401</span><span class=p>);</span>
</span><span id=__span-33-20><a id=__codelineno-33-20 name=__codelineno-33-20 href=#__codelineno-33-20></a>
</span><span id=__span-33-21><a id=__codelineno-33-21 name=__codelineno-33-21 href=#__codelineno-33-21></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;INVALID_TOKEN&#39;</span><span class=p>);</span>
</span><span id=__span-33-22><a id=__codelineno-33-22 name=__codelineno-33-22 href=#__codelineno-33-22></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-33-23><a id=__codelineno-33-23 name=__codelineno-33-23 href=#__codelineno-33-23></a><span class=p>});</span>
</span></code></pre></div><h3 id=73-performance-testing-in-unit-tests>7.3 Performance Testing in Unit Tests<a class=headerlink href=#73-performance-testing-in-unit-tests title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=c1>// Performance assertions in unit tests</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Performance Requirements&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;processes YouTube download metadata under 5 seconds&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>metadata</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>youtubeService</span><span class=p>.</span><span class=nx>extractMetadata</span><span class=p>(</span><span class=s1>&#39;https://youtube.com/playlist?list=TEST&#39;</span><span class=p>);</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>startTime</span><span class=p>;</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>duration</span><span class=p>).</span><span class=nx>toBeLessThan</span><span class=p>(</span><span class=mf>5000</span><span class=p>);</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>videos</span><span class=p>.</span><span class=nx>length</span><span class=p>).</span><span class=nx>toBeGreaterThan</span><span class=p>(</span><span class=mf>0</span><span class=p>);</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=p>});</span>
</span></code></pre></div><h2 id=6-simple-cicd-integration>6. Simple CI/CD Integration<a class=headerlink href=#6-simple-cicd-integration title="Permanent link">&para;</a></h2><h3 id=61-one-simple-github-actions-workflow>6.1 One Simple GitHub Actions Workflow<a class=headerlink href=#61-one-simple-github-actions-workflow title="Permanent link">&para;</a></h3><div class="language-yaml highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=c1># .github/workflows/test.yml</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Tests</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=nt>on</span><span class=p>:</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=w>  </span><span class=nt>push</span><span class=p>:</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>main</span><span class="p p-Indicator">]</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=w>  </span><span class=nt>pull_request</span><span class=p>:</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=nt>jobs</span><span class=p>:</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=w>  </span><span class=nt>test</span><span class=p>:</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=w>    </span><span class=nt>services</span><span class=p>:</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=w>      </span><span class=nt>postgres</span><span class=p>:</span>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15-alpine</span>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=w>        </span><span class=nt>env</span><span class=p>:</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a><span class=w>          </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=w>          </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a><span class=w>          </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">medianest_test</span>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a><span class=w>        </span><span class=nt>options</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">&gt;-</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a><span class=w>          </span><span class=no>--health-cmd pg_isready</span>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a><span class=w>          </span><span class=no>--health-interval 10s</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a>
</span><span id=__span-35-24><a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a><span class=w>      </span><span class=nt>redis</span><span class=p>:</span>
</span><span id=__span-35-25><a id=__codelineno-35-25 name=__codelineno-35-25 href=#__codelineno-35-25></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redis:7-alpine</span>
</span><span id=__span-35-26><a id=__codelineno-35-26 name=__codelineno-35-26 href=#__codelineno-35-26></a><span class=w>        </span><span class=nt>options</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">&gt;-</span>
</span><span id=__span-35-27><a id=__codelineno-35-27 name=__codelineno-35-27 href=#__codelineno-35-27></a><span class=w>          </span><span class=no>--health-cmd &quot;redis-cli ping&quot;</span>
</span><span id=__span-35-28><a id=__codelineno-35-28 name=__codelineno-35-28 href=#__codelineno-35-28></a><span class=w>          </span><span class=no>--health-interval 10s</span>
</span><span id=__span-35-29><a id=__codelineno-35-29 name=__codelineno-35-29 href=#__codelineno-35-29></a>
</span><span id=__span-35-30><a id=__codelineno-35-30 name=__codelineno-35-30 href=#__codelineno-35-30></a><span class=w>    </span><span class=nt>steps</span><span class=p>:</span>
</span><span id=__span-35-31><a id=__codelineno-35-31 name=__codelineno-35-31 href=#__codelineno-35-31></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>
</span><span id=__span-35-32><a id=__codelineno-35-32 name=__codelineno-35-32 href=#__codelineno-35-32></a>
</span><span id=__span-35-33><a id=__codelineno-35-33 name=__codelineno-35-33 href=#__codelineno-35-33></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Setup Node.js</span>
</span><span id=__span-35-34><a id=__codelineno-35-34 name=__codelineno-35-34 href=#__codelineno-35-34></a><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-node@v3</span>
</span><span id=__span-35-35><a id=__codelineno-35-35 name=__codelineno-35-35 href=#__codelineno-35-35></a><span class=w>        </span><span class=nt>with</span><span class=p>:</span>
</span><span id=__span-35-36><a id=__codelineno-35-36 name=__codelineno-35-36 href=#__codelineno-35-36></a><span class=w>          </span><span class=nt>node-version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
</span><span id=__span-35-37><a id=__codelineno-35-37 name=__codelineno-35-37 href=#__codelineno-35-37></a><span class=w>          </span><span class=nt>cache</span><span class=p>:</span><span class=w> </span><span class=s>&#39;npm&#39;</span>
</span><span id=__span-35-38><a id=__codelineno-35-38 name=__codelineno-35-38 href=#__codelineno-35-38></a>
</span><span id=__span-35-39><a id=__codelineno-35-39 name=__codelineno-35-39 href=#__codelineno-35-39></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Install and Test</span>
</span><span id=__span-35-40><a id=__codelineno-35-40 name=__codelineno-35-40 href=#__codelineno-35-40></a><span class=w>        </span><span class=nt>env</span><span class=p>:</span>
</span><span id=__span-35-41><a id=__codelineno-35-41 name=__codelineno-35-41 href=#__codelineno-35-41></a><span class=w>          </span><span class=nt>DATABASE_URL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">postgresql://test:test@localhost:5432/medianest_test</span>
</span><span id=__span-35-42><a id=__codelineno-35-42 name=__codelineno-35-42 href=#__codelineno-35-42></a><span class=w>          </span><span class=nt>REDIS_URL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">redis://localhost:6379</span>
</span><span id=__span-35-43><a id=__codelineno-35-43 name=__codelineno-35-43 href=#__codelineno-35-43></a><span class=w>          </span><span class=nt>NODE_ENV</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
</span><span id=__span-35-44><a id=__codelineno-35-44 name=__codelineno-35-44 href=#__codelineno-35-44></a><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
</span><span id=__span-35-45><a id=__codelineno-35-45 name=__codelineno-35-45 href=#__codelineno-35-45></a><span class=w>          </span><span class=no>npm ci</span>
</span><span id=__span-35-46><a id=__codelineno-35-46 name=__codelineno-35-46 href=#__codelineno-35-46></a><span class=w>          </span><span class=no>npm test</span>
</span><span id=__span-35-47><a id=__codelineno-35-47 name=__codelineno-35-47 href=#__codelineno-35-47></a>
</span><span id=__span-35-48><a id=__codelineno-35-48 name=__codelineno-35-48 href=#__codelineno-35-48></a><span class=w>      </span><span class=c1># Only run E2E on main branch to save time</span>
</span><span id=__span-35-49><a id=__codelineno-35-49 name=__codelineno-35-49 href=#__codelineno-35-49></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">E2E Tests</span>
</span><span id=__span-35-50><a id=__codelineno-35-50 name=__codelineno-35-50 href=#__codelineno-35-50></a><span class=w>        </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">github.ref == &#39;refs/heads/main&#39;</span>
</span><span id=__span-35-51><a id=__codelineno-35-51 name=__codelineno-35-51 href=#__codelineno-35-51></a><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
</span><span id=__span-35-52><a id=__codelineno-35-52 name=__codelineno-35-52 href=#__codelineno-35-52></a><span class=w>          </span><span class=no>npx playwright install chromium</span>
</span><span id=__span-35-53><a id=__codelineno-35-53 name=__codelineno-35-53 href=#__codelineno-35-53></a><span class=w>          </span><span class=no>npm run test:e2e</span>
</span></code></pre></div><h3 id=62-local-testing>6.2 Local Testing<a class=headerlink href=#62-local-testing title="Permanent link">&para;</a></h3><div class="language-bash highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=c1># Simple test commands</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>npm<span class=w> </span><span class=nb>test</span><span class=w>              </span><span class=c1># Run all tests with Vitest</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a>npm<span class=w> </span>run<span class=w> </span>test:ui<span class=w>       </span><span class=c1># Open Vitest UI for debugging</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>npm<span class=w> </span>run<span class=w> </span>test:watch<span class=w>    </span><span class=c1># Watch mode for development</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a>npm<span class=w> </span>run<span class=w> </span>test:coverage<span class=w> </span><span class=c1># Generate coverage report</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a>npm<span class=w> </span>run<span class=w> </span>test:api<span class=w>      </span><span class=c1># Just API tests</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a>npm<span class=w> </span>run<span class=w> </span>test:e2e<span class=w>      </span><span class=c1># Just E2E tests (rarely)</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=c1># Package.json scripts</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a><span class=o>{</span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=w>  </span><span class=s2>&quot;scripts&quot;</span>:<span class=w> </span><span class=o>{</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=w>    </span><span class=s2>&quot;test&quot;</span>:<span class=w> </span><span class=s2>&quot;vitest run&quot;</span>,
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=w>    </span><span class=s2>&quot;test:ui&quot;</span>:<span class=w> </span><span class=s2>&quot;vitest --ui&quot;</span>,
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=w>    </span><span class=s2>&quot;test:watch&quot;</span>:<span class=w> </span><span class=s2>&quot;vitest&quot;</span>,
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=w>    </span><span class=s2>&quot;test:coverage&quot;</span>:<span class=w> </span><span class=s2>&quot;vitest run --coverage&quot;</span>,
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=w>    </span><span class=s2>&quot;test:api&quot;</span>:<span class=w> </span><span class=s2>&quot;vitest run tests/integration/api&quot;</span>,
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=w>    </span><span class=s2>&quot;test:unit&quot;</span>:<span class=w> </span><span class=s2>&quot;vitest run tests/unit&quot;</span>,
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=w>    </span><span class=s2>&quot;test:e2e&quot;</span>:<span class=w> </span><span class=s2>&quot;playwright test&quot;</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=w>  </span><span class=o>}</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=o>}</span>
</span></code></pre></div><h3 id=82-test-reporting-and-metrics>8.2 Test Reporting and Metrics<a class=headerlink href=#82-test-reporting-and-metrics title="Permanent link">&para;</a></h3><h4 id=coverage-reporting>Coverage Reporting<a class=headerlink href=#coverage-reporting title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=c1>// vitest.config.ts - Coverage configuration</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nx>defineConfig</span><span class=p>({</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=w>  </span><span class=nx>test</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=w>    </span><span class=nx>coverage</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=w>      </span><span class=nx>provider</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;v8&#39;</span><span class=p>,</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=w>      </span><span class=nx>reporter</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;json&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;html&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;lcov&#39;</span><span class=p>],</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=w>      </span><span class=nx>reportsDirectory</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;./test-results/coverage&#39;</span><span class=p>,</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=w>      </span><span class=nx>exclude</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;node_modules/&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;tests/&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;**/*.d.ts&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;**/*.config.*&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;**/mockData.ts&#39;</span><span class=p>],</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=w>    </span><span class=nx>reporters</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;default&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;html&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;junit&#39;</span><span class=p>],</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=w>    </span><span class=nx>outputFile</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=w>      </span><span class=nx>junit</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;./test-results/junit.xml&#39;</span><span class=p>,</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=w>      </span><span class=nx>html</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;./test-results/html/index.html&#39;</span><span class=p>,</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=p>});</span>
</span></code></pre></div><h4 id=performance-metrics-collection>Performance Metrics Collection<a class=headerlink href=#performance-metrics-collection title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=c1>// tests/helpers/metrics.ts</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=k>export</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nx>TestMetrics</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=w>  </span><span class=k>private</span><span class=w> </span><span class=nx>metrics</span><span class=o>:</span><span class=w> </span><span class=kt>Map</span><span class=o>&lt;</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=kt>number</span><span class=p>[]</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nb>Map</span><span class=p>();</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>  </span><span class=nx>recordExecutionTime</span><span class=p>(</span><span class=nx>testName</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>testName</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>testName</span><span class=p>,</span><span class=w> </span><span class=p>[]);</span>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>testName</span><span class=p>)</span><span class=o>!</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>duration</span><span class=p>);</span>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=w>  </span><span class=nx>generateReport</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>report</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=w>      </span><span class=nx>timestamp</span><span class=o>:</span><span class=w> </span><span class=kt>new</span><span class=w> </span><span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=w>      </span><span class=nx>metrics</span><span class=o>:</span><span class=w> </span><span class=p>{},</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=w>    </span><span class=p>};</span>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>testName</span><span class=p>,</span><span class=w> </span><span class=nx>durations</span><span class=p>]</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>metrics</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>avg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>durations</span><span class=p>.</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>a</span><span class=p>,</span><span class=w> </span><span class=nx>b</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>b</span><span class=p>,</span><span class=w> </span><span class=mf>0</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=nx>durations</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>max</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(...</span><span class=nx>durations</span><span class=p>);</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>min</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(...</span><span class=nx>durations</span><span class=p>);</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a>
</span><span id=__span-38-23><a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=w>      </span><span class=nx>report</span><span class=p>.</span><span class=nx>metrics</span><span class=p>[</span><span class=nx>testName</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>avg</span><span class=p>,</span><span class=w> </span><span class=nx>max</span><span class=p>,</span><span class=w> </span><span class=nx>min</span><span class=p>,</span><span class=w> </span><span class=nx>count</span><span class=o>:</span><span class=w> </span><span class=kt>durations.length</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-38-24><a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-38-25><a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a>
</span><span id=__span-38-26><a id=__codelineno-38-26 name=__codelineno-38-26 href=#__codelineno-38-26></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>report</span><span class=p>;</span>
</span><span id=__span-38-27><a id=__codelineno-38-27 name=__codelineno-38-27 href=#__codelineno-38-27></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-38-28><a id=__codelineno-38-28 name=__codelineno-38-28 href=#__codelineno-38-28></a><span class=p>}</span>
</span></code></pre></div><h2 id=5-external-service-testing>5. External Service Testing<a class=headerlink href=#5-external-service-testing title="Permanent link">&para;</a></h2><h3 id=51-hybrid-mocking-strategy-90-mocks-10-live>5.1 Hybrid Mocking Strategy (90% Mocks, 10% Live)<a class=headerlink href=#51-hybrid-mocking-strategy-90-mocks-10-live title="Permanent link">&para;</a></h3><p>We use a hybrid approach that prioritizes mocked tests for speed and reliability, with optional live integration tests for critical flows.</p><h4 id=msw-mock-handler-architecture>MSW Mock Handler Architecture<a class=headerlink href=#msw-mock-handler-architecture title="Permanent link">&para;</a></h4><p>MSW (Mock Service Worker) provides request interception at the network level, allowing realistic API mocking:</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=c1>// tests/mocks/handlers.ts</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>http</span><span class=p>,</span><span class=w> </span><span class=nx>HttpResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;msw&#39;</span><span class=p>;</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>handlers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=w>  </span><span class=c1>// PLEX API HANDLERS</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;https://plex.tv/pins.xml&#39;</span><span class=p>,</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>clientId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;X-Plex-Client-Identifier&#39;</span><span class=p>);</span>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>clientId</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span><span class=s1>&#39;Unauthorized&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>401</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span>
</span><span id=__span-39-13><a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a><span class=w>      </span><span class=sb>`</span>
</span><span id=__span-39-14><a id=__codelineno-39-14 name=__codelineno-39-14 href=#__codelineno-39-14></a><span class=sb>      &lt;pin&gt;</span>
</span><span id=__span-39-15><a id=__codelineno-39-15 name=__codelineno-39-15 href=#__codelineno-39-15></a><span class=sb>        &lt;id&gt;12345&lt;/id&gt;</span>
</span><span id=__span-39-16><a id=__codelineno-39-16 name=__codelineno-39-16 href=#__codelineno-39-16></a><span class=sb>        &lt;code&gt;ABCD&lt;/code&gt;</span>
</span><span id=__span-39-17><a id=__codelineno-39-17 name=__codelineno-39-17 href=#__codelineno-39-17></a><span class=sb>      &lt;/pin&gt;</span>
</span><span id=__span-39-18><a id=__codelineno-39-18 name=__codelineno-39-18 href=#__codelineno-39-18></a><span class=sb>    `</span><span class=p>,</span>
</span><span id=__span-39-19><a id=__codelineno-39-19 name=__codelineno-39-19 href=#__codelineno-39-19></a><span class=w>      </span><span class=p>{</span>
</span><span id=__span-39-20><a id=__codelineno-39-20 name=__codelineno-39-20 href=#__codelineno-39-20></a><span class=w>        </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;application/xml&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-39-21><a id=__codelineno-39-21 name=__codelineno-39-21 href=#__codelineno-39-21></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-39-22><a id=__codelineno-39-22 name=__codelineno-39-22 href=#__codelineno-39-22></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-39-23><a id=__codelineno-39-23 name=__codelineno-39-23 href=#__codelineno-39-23></a><span class=w>  </span><span class=p>}),</span>
</span><span id=__span-39-24><a id=__codelineno-39-24 name=__codelineno-39-24 href=#__codelineno-39-24></a>
</span><span id=__span-39-25><a id=__codelineno-39-25 name=__codelineno-39-25 href=#__codelineno-39-25></a><span class=w>  </span><span class=c1>// OVERSEERR API HANDLERS</span>
</span><span id=__span-39-26><a id=__codelineno-39-26 name=__codelineno-39-26 href=#__codelineno-39-26></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sr>/^https?:\/\/[^\/]+\/api\/v1\/status$/</span><span class=p>,</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-27><a id=__codelineno-39-27 name=__codelineno-39-27 href=#__codelineno-39-27></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>apiKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;X-Api-Key&#39;</span><span class=p>);</span>
</span><span id=__span-39-28><a id=__codelineno-39-28 name=__codelineno-39-28 href=#__codelineno-39-28></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>apiKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-29><a id=__codelineno-39-29 name=__codelineno-39-29 href=#__codelineno-39-29></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;API key required&#39;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>401</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-39-30><a id=__codelineno-39-30 name=__codelineno-39-30 href=#__codelineno-39-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-39-31><a id=__codelineno-39-31 name=__codelineno-39-31 href=#__codelineno-39-31></a>
</span><span id=__span-39-32><a id=__codelineno-39-32 name=__codelineno-39-32 href=#__codelineno-39-32></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span><span id=__span-39-33><a id=__codelineno-39-33 name=__codelineno-39-33 href=#__codelineno-39-33></a><span class=w>      </span><span class=nx>version</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1.33.2&#39;</span><span class=p>,</span>
</span><span id=__span-39-34><a id=__codelineno-39-34 name=__codelineno-39-34 href=#__codelineno-39-34></a><span class=w>      </span><span class=nx>totalRequests</span><span class=o>:</span><span class=w> </span><span class=kt>1234</span><span class=p>,</span>
</span><span id=__span-39-35><a id=__codelineno-39-35 name=__codelineno-39-35 href=#__codelineno-39-35></a><span class=w>      </span><span class=nx>totalMovieRequests</span><span class=o>:</span><span class=w> </span><span class=kt>800</span><span class=p>,</span>
</span><span id=__span-39-36><a id=__codelineno-39-36 name=__codelineno-39-36 href=#__codelineno-39-36></a><span class=w>      </span><span class=nx>totalTvRequests</span><span class=o>:</span><span class=w> </span><span class=kt>434</span><span class=p>,</span>
</span><span id=__span-39-37><a id=__codelineno-39-37 name=__codelineno-39-37 href=#__codelineno-39-37></a><span class=w>      </span><span class=nx>appDataPath</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;/app/config&#39;</span><span class=p>,</span>
</span><span id=__span-39-38><a id=__codelineno-39-38 name=__codelineno-39-38 href=#__codelineno-39-38></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-39-39><a id=__codelineno-39-39 name=__codelineno-39-39 href=#__codelineno-39-39></a><span class=w>  </span><span class=p>}),</span>
</span><span id=__span-39-40><a id=__codelineno-39-40 name=__codelineno-39-40 href=#__codelineno-39-40></a>
</span><span id=__span-39-41><a id=__codelineno-39-41 name=__codelineno-39-41 href=#__codelineno-39-41></a><span class=w>  </span><span class=c1>// UPTIME KUMA API HANDLERS</span>
</span><span id=__span-39-42><a id=__codelineno-39-42 name=__codelineno-39-42 href=#__codelineno-39-42></a><span class=w>  </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span>
</span><span id=__span-39-43><a id=__codelineno-39-43 name=__codelineno-39-43 href=#__codelineno-39-43></a><span class=w>    </span><span class=sr>/^https?:\/\/[^\/]+\/api\/badge\/(\d+)\/(status|uptime|ping|cert-exp)$/</span><span class=p>,</span>
</span><span id=__span-39-44><a id=__codelineno-39-44 name=__codelineno-39-44 href=#__codelineno-39-44></a><span class=w>    </span><span class=p>({</span><span class=w> </span><span class=nx>params</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-45><a id=__codelineno-39-45 name=__codelineno-39-45 href=#__codelineno-39-45></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=p>[</span><span class=nx>monitorId</span><span class=p>,</span><span class=w> </span><span class=kr>type</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>params</span><span class=p>;</span>
</span><span id=__span-39-46><a id=__codelineno-39-46 name=__codelineno-39-46 href=#__codelineno-39-46></a>
</span><span id=__span-39-47><a id=__codelineno-39-47 name=__codelineno-39-47 href=#__codelineno-39-47></a><span class=w>      </span><span class=c1>// Return SVG badges like real Uptime Kuma</span>
</span><span id=__span-39-48><a id=__codelineno-39-48 name=__codelineno-39-48 href=#__codelineno-39-48></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kr>type</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;status&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-49><a id=__codelineno-39-49 name=__codelineno-39-49 href=#__codelineno-39-49></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span>
</span><span id=__span-39-50><a id=__codelineno-39-50 name=__codelineno-39-50 href=#__codelineno-39-50></a><span class=w>          </span><span class=sb>`&lt;svg&gt;...&lt;/svg&gt;`</span><span class=p>,</span><span class=w> </span><span class=c1>// Actual SVG omitted for brevity</span>
</span><span id=__span-39-51><a id=__codelineno-39-51 name=__codelineno-39-51 href=#__codelineno-39-51></a><span class=w>          </span><span class=p>{</span><span class=w> </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;image/svg+xml&#39;</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-39-52><a id=__codelineno-39-52 name=__codelineno-39-52 href=#__codelineno-39-52></a><span class=w>        </span><span class=p>);</span>
</span><span id=__span-39-53><a id=__codelineno-39-53 name=__codelineno-39-53 href=#__codelineno-39-53></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-39-54><a id=__codelineno-39-54 name=__codelineno-39-54 href=#__codelineno-39-54></a>
</span><span id=__span-39-55><a id=__codelineno-39-55 name=__codelineno-39-55 href=#__codelineno-39-55></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span><span id=__span-39-56><a id=__codelineno-39-56 name=__codelineno-39-56 href=#__codelineno-39-56></a><span class=w>        </span><span class=nx>monitorId</span><span class=p>,</span>
</span><span id=__span-39-57><a id=__codelineno-39-57 name=__codelineno-39-57 href=#__codelineno-39-57></a><span class=w>        </span><span class=kr>type</span><span class=p>,</span>
</span><span id=__span-39-58><a id=__codelineno-39-58 name=__codelineno-39-58 href=#__codelineno-39-58></a><span class=w>        </span><span class=nx>value</span><span class=o>:</span><span class=w> </span><span class=kt>type</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;uptime&#39;</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=nx>99.9</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=kt>45</span><span class=p>,</span>
</span><span id=__span-39-59><a id=__codelineno-39-59 name=__codelineno-39-59 href=#__codelineno-39-59></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-39-60><a id=__codelineno-39-60 name=__codelineno-39-60 href=#__codelineno-39-60></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-39-61><a id=__codelineno-39-61 name=__codelineno-39-61 href=#__codelineno-39-61></a><span class=w>  </span><span class=p>),</span>
</span><span id=__span-39-62><a id=__codelineno-39-62 name=__codelineno-39-62 href=#__codelineno-39-62></a><span class=p>];</span>
</span></code></pre></div><h4 id=critical-msw-setup-configuration>Critical MSW Setup Configuration<a class=headerlink href=#critical-msw-setup-configuration title="Permanent link">&para;</a></h4><p>The key to proper mock isolation is configuring MSW to bypass local Express routes:</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=c1>// tests/setup.ts</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>server</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;./mocks/server&#39;</span><span class=p>;</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=nx>beforeAll</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=w>  </span><span class=c1>// CRITICAL: Use &#39;bypass&#39; to let local Express routes pass through</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>({</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=w>    </span><span class=nx>onUnhandledRequest</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;bypass&#39;</span><span class=p>,</span><span class=w> </span><span class=c1>// Don&#39;t intercept local API calls</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=p>});</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=nx>afterEach</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>resetHandlers</span><span class=p>();</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=p>});</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=nx>afterAll</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-40-17><a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a><span class=p>});</span>
</span></code></pre></div><h4 id=test-helper-functions>Test Helper Functions<a class=headerlink href=#test-helper-functions title="Permanent link">&para;</a></h4><p>Helper functions provide clean test scenarios without modifying core handlers:</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=c1>// tests/helpers/external-services.ts</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>server</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../mocks/server&#39;</span><span class=p>;</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>http</span><span class=p>,</span><span class=w> </span><span class=nx>HttpResponse</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;msw&#39;</span><span class=p>;</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=c1>// Authorize a Plex PIN for testing</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>authorizePlexPin</span><span class=p>(</span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>authToken?</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=w>    </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`https://plex.tv/pins/</span><span class=si>${</span><span class=nx>pinId</span><span class=si>}</span><span class=sb>.xml`</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-9><a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span>
</span><span id=__span-41-10><a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a><span class=w>        </span><span class=sb>`</span>
</span><span id=__span-41-11><a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a><span class=sb>        &lt;pin&gt;</span>
</span><span id=__span-41-12><a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a><span class=sb>          &lt;id&gt;</span><span class=si>${</span><span class=nx>pinId</span><span class=si>}</span><span class=sb>&lt;/id&gt;</span>
</span><span id=__span-41-13><a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a><span class=sb>          &lt;code&gt;ABCD&lt;/code&gt;</span>
</span><span id=__span-41-14><a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a><span class=sb>          &lt;authToken&gt;</span><span class=si>${</span><span class=nx>authToken</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39;plex-auth-token-123&#39;</span><span class=si>}</span><span class=sb>&lt;/authToken&gt;</span>
</span><span id=__span-41-15><a id=__codelineno-41-15 name=__codelineno-41-15 href=#__codelineno-41-15></a><span class=sb>        &lt;/pin&gt;</span>
</span><span id=__span-41-16><a id=__codelineno-41-16 name=__codelineno-41-16 href=#__codelineno-41-16></a><span class=sb>      `</span><span class=p>,</span>
</span><span id=__span-41-17><a id=__codelineno-41-17 name=__codelineno-41-17 href=#__codelineno-41-17></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-41-18><a id=__codelineno-41-18 name=__codelineno-41-18 href=#__codelineno-41-18></a><span class=w>          </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;application/xml&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-41-19><a id=__codelineno-41-19 name=__codelineno-41-19 href=#__codelineno-41-19></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-41-20><a id=__codelineno-41-20 name=__codelineno-41-20 href=#__codelineno-41-20></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-41-21><a id=__codelineno-41-21 name=__codelineno-41-21 href=#__codelineno-41-21></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-41-22><a id=__codelineno-41-22 name=__codelineno-41-22 href=#__codelineno-41-22></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-41-23><a id=__codelineno-41-23 name=__codelineno-41-23 href=#__codelineno-41-23></a><span class=p>}</span>
</span><span id=__span-41-24><a id=__codelineno-41-24 name=__codelineno-41-24 href=#__codelineno-41-24></a>
</span><span id=__span-41-25><a id=__codelineno-41-25 name=__codelineno-41-25 href=#__codelineno-41-25></a><span class=c1>// Simulate service outages</span>
</span><span id=__span-41-26><a id=__codelineno-41-26 name=__codelineno-41-26 href=#__codelineno-41-26></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>simulatePlexDown</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-27><a id=__codelineno-41-27 name=__codelineno-41-27 href=#__codelineno-41-27></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span><span id=__span-41-28><a id=__codelineno-41-28 name=__codelineno-41-28 href=#__codelineno-41-28></a><span class=w>    </span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;https://plex.tv/pins.xml&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-29><a id=__codelineno-41-29 name=__codelineno-41-29 href=#__codelineno-41-29></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span><span class=s1>&#39;Service Unavailable&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>503</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-41-30><a id=__codelineno-41-30 name=__codelineno-41-30 href=#__codelineno-41-30></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-41-31><a id=__codelineno-41-31 name=__codelineno-41-31 href=#__codelineno-41-31></a><span class=w>    </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sr>/https:\/\/plex\.tv\/.*/</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-32><a id=__codelineno-41-32 name=__codelineno-41-32 href=#__codelineno-41-32></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>text</span><span class=p>(</span><span class=s1>&#39;Service Unavailable&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>503</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-41-33><a id=__codelineno-41-33 name=__codelineno-41-33 href=#__codelineno-41-33></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-41-34><a id=__codelineno-41-34 name=__codelineno-41-34 href=#__codelineno-41-34></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-41-35><a id=__codelineno-41-35 name=__codelineno-41-35 href=#__codelineno-41-35></a><span class=p>}</span>
</span><span id=__span-41-36><a id=__codelineno-41-36 name=__codelineno-41-36 href=#__codelineno-41-36></a>
</span><span id=__span-41-37><a id=__codelineno-41-37 name=__codelineno-41-37 href=#__codelineno-41-37></a><span class=c1>// Mock specific Overseerr scenarios</span>
</span><span id=__span-41-38><a id=__codelineno-41-38 name=__codelineno-41-38 href=#__codelineno-41-38></a><span class=k>export</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>simulateMediaAlreadyRequested</span><span class=p>(</span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=kt>number</span><span class=p>,</span><span class=w> </span><span class=nx>mediaType</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=s1>&#39;tv&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-39><a id=__codelineno-41-39 name=__codelineno-41-39 href=#__codelineno-41-39></a><span class=w>  </span><span class=nx>server</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span><span id=__span-41-40><a id=__codelineno-41-40 name=__codelineno-41-40 href=#__codelineno-41-40></a><span class=w>    </span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=sr>/\/api\/v1\/request$/</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>({</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-41><a id=__codelineno-41-41 name=__codelineno-41-41 href=#__codelineno-41-41></a><span class=w>      </span><span class=kd>const</span><span class=w> </span><span class=nx>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>.</span><span class=nx>json</span><span class=p>())</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=nx>any</span><span class=p>;</span>
</span><span id=__span-41-42><a id=__codelineno-41-42 name=__codelineno-41-42 href=#__codelineno-41-42></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>mediaId</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>tmdbId</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>body</span><span class=p>.</span><span class=nx>mediaType</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=nx>mediaType</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-43><a id=__codelineno-41-43 name=__codelineno-41-43 href=#__codelineno-41-43></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>HttpResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span><span class=w> </span><span class=nx>error</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Media already requested&#39;</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=kt>409</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-41-44><a id=__codelineno-41-44 name=__codelineno-41-44 href=#__codelineno-41-44></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-41-45><a id=__codelineno-41-45 name=__codelineno-41-45 href=#__codelineno-41-45></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>undefined</span><span class=p>;</span><span class=w> </span><span class=c1>// Let default handler process</span>
</span><span id=__span-41-46><a id=__codelineno-41-46 name=__codelineno-41-46 href=#__codelineno-41-46></a><span class=w>    </span><span class=p>}),</span>
</span><span id=__span-41-47><a id=__codelineno-41-47 name=__codelineno-41-47 href=#__codelineno-41-47></a><span class=w>  </span><span class=p>);</span>
</span><span id=__span-41-48><a id=__codelineno-41-48 name=__codelineno-41-48 href=#__codelineno-41-48></a><span class=p>}</span>
</span></code></pre></div><h3 id=52-testing-service-integration-patterns>5.2 Testing Service Integration Patterns<a class=headerlink href=#52-testing-service-integration-patterns title="Permanent link">&para;</a></h3><h4 id=pattern-1-happy-path-testing>Pattern 1: Happy Path Testing<a class=headerlink href=#pattern-1-happy-path-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Plex OAuth Flow&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;completes authentication successfully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=w>    </span><span class=c1>// PIN is generated by default handler</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>pinResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/v1/auth/plex/pin&#39;</span><span class=p>).</span><span class=nx>expect</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>pinResponse</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>code</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;ABCD&#39;</span><span class=p>);</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=w>    </span><span class=c1>// Authorize the PIN for verification</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=w>    </span><span class=nx>authorizePlexPin</span><span class=p>(</span><span class=s1>&#39;12345&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;test-auth-token&#39;</span><span class=p>);</span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=w>    </span><span class=c1>// Verify PIN and create user</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>authResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=w>      </span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/v1/auth/plex/verify&#39;</span><span class=p>)</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=w>      </span><span class=p>.</span><span class=nx>send</span><span class=p>({</span><span class=w> </span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;12345&#39;</span><span class=w> </span><span class=p>})</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=w>      </span><span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>authResponse</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;testplexuser&#39;</span><span class=p>);</span>
</span><span id=__span-42-18><a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-42-19><a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a><span class=p>});</span>
</span></code></pre></div><h4 id=pattern-2-service-failure-testing>Pattern 2: Service Failure Testing<a class=headerlink href=#pattern-2-service-failure-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Service Resilience&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles Plex unavailability gracefully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=w>    </span><span class=nx>simulatePlexDown</span><span class=p>();</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/v1/auth/plex/pin&#39;</span><span class=p>).</span><span class=nx>expect</span><span class=p>(</span><span class=mf>503</span><span class=p>);</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;PLEX_UNREACHABLE&#39;</span><span class=p>);</span>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>error</span><span class=p>.</span><span class=nx>message</span><span class=p>).</span><span class=nx>toContain</span><span class=p>(</span><span class=s1>&#39;Cannot connect to Plex&#39;</span><span class=p>);</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;provides cached data when Overseerr is down&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=w>    </span><span class=c1>// Seed cache with valid data</span>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>cache</span><span class=p>.</span><span class=nx>setServiceStatus</span><span class=p>(</span><span class=s1>&#39;overseerr&#39;</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;up&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=w>    </span><span class=nx>simulateOverseerrDown</span><span class=p>();</span>
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/dashboard/status&#39;</span><span class=p>).</span><span class=nx>expect</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-43-18><a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a>
</span><span id=__span-43-19><a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>services</span><span class=p>.</span><span class=nx>overseerr</span><span class=p>.</span><span class=nx>cached</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-43-20><a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-43-21><a id=__codelineno-43-21 name=__codelineno-43-21 href=#__codelineno-43-21></a><span class=p>});</span>
</span></code></pre></div><h4 id=pattern-3-edge-case-testing>Pattern 3: Edge Case Testing<a class=headerlink href=#pattern-3-edge-case-testing title="Permanent link">&para;</a></h4><div class="language-typescript highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Edge Cases&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles expired Plex PIN gracefully&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=w>    </span><span class=c1>// Don&#39;t authorize the PIN - it remains unauthorized</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=w>      </span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/v1/auth/plex/verify&#39;</span><span class=p>)</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=w>      </span><span class=p>.</span><span class=nx>send</span><span class=p>({</span><span class=w> </span><span class=nx>pinId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;12345&#39;</span><span class=w> </span><span class=p>})</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=w>      </span><span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mf>400</span><span class=p>);</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;PIN_NOT_AUTHORIZED&#39;</span><span class=p>);</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;prevents duplicate media requests&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-13><a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a><span class=w>    </span><span class=nx>simulateMediaAlreadyRequested</span><span class=p>(</span><span class=mf>603</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=p>);</span>
</span><span id=__span-44-14><a id=__codelineno-44-14 name=__codelineno-44-14 href=#__codelineno-44-14></a>
</span><span id=__span-44-15><a id=__codelineno-44-15 name=__codelineno-44-15 href=#__codelineno-44-15></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span><span id=__span-44-16><a id=__codelineno-44-16 name=__codelineno-44-16 href=#__codelineno-44-16></a><span class=w>      </span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/v1/media/request&#39;</span><span class=p>)</span>
</span><span id=__span-44-17><a id=__codelineno-44-17 name=__codelineno-44-17 href=#__codelineno-44-17></a><span class=w>      </span><span class=p>.</span><span class=nx>send</span><span class=p>({</span><span class=w> </span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=kt>603</span><span class=p>,</span><span class=w> </span><span class=nx>mediaType</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=w> </span><span class=p>})</span>
</span><span id=__span-44-18><a id=__codelineno-44-18 name=__codelineno-44-18 href=#__codelineno-44-18></a><span class=w>      </span><span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mf>409</span><span class=p>);</span>
</span><span id=__span-44-19><a id=__codelineno-44-19 name=__codelineno-44-19 href=#__codelineno-44-19></a>
</span><span id=__span-44-20><a id=__codelineno-44-20 name=__codelineno-44-20 href=#__codelineno-44-20></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>error</span><span class=p>.</span><span class=nx>message</span><span class=p>).</span><span class=nx>toContain</span><span class=p>(</span><span class=s1>&#39;already requested&#39;</span><span class=p>);</span>
</span><span id=__span-44-21><a id=__codelineno-44-21 name=__codelineno-44-21 href=#__codelineno-44-21></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-44-22><a id=__codelineno-44-22 name=__codelineno-44-22 href=#__codelineno-44-22></a><span class=p>});</span>
</span></code></pre></div><h3 id=53-live-integration-testing-optional>5.3 Live Integration Testing (Optional)<a class=headerlink href=#53-live-integration-testing-optional title="Permanent link">&para;</a></h3><p>For critical flows, we support optional live integration tests with strict safeguards:</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=c1>// tests/live/plex-integration.test.ts</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=nx>describe</span><span class=p>.</span><span class=nx>skipIf</span><span class=p>(</span><span class=o>!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>ENABLE_LIVE_TESTS</span><span class=p>)(</span><span class=s1>&#39;Live Plex Integration&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>TEST_USER_PREFIX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;medianest_test_&#39;</span><span class=p>;</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=w>  </span><span class=nx>beforeAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=w>    </span><span class=c1>// Verify we&#39;re in test environment</span>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PLEX_TEST_SERVER_URL</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=ne>Error</span><span class=p>(</span><span class=s1>&#39;Live tests require PLEX_TEST_SERVER_URL&#39;</span><span class=p>);</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a>
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a><span class=w>  </span><span class=nx>afterEach</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-13><a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a><span class=w>    </span><span class=c1>// Cleanup any test data</span>
</span><span id=__span-45-14><a id=__codelineno-45-14 name=__codelineno-45-14 href=#__codelineno-45-14></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>cleanupTestUsers</span><span class=p>(</span><span class=nx>TEST_USER_PREFIX</span><span class=p>);</span>
</span><span id=__span-45-15><a id=__codelineno-45-15 name=__codelineno-45-15 href=#__codelineno-45-15></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-45-16><a id=__codelineno-45-16 name=__codelineno-45-16 href=#__codelineno-45-16></a>
</span><span id=__span-45-17><a id=__codelineno-45-17 name=__codelineno-45-17 href=#__codelineno-45-17></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;validates real Plex token&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-18><a id=__codelineno-45-18 name=__codelineno-45-18 href=#__codelineno-45-18></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>plexClient</span><span class=p>.</span><span class=nx>validateToken</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PLEX_TEST_TOKEN</span><span class=p>);</span>
</span><span id=__span-45-19><a id=__codelineno-45-19 name=__codelineno-45-19 href=#__codelineno-45-19></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>valid</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-45-20><a id=__codelineno-45-20 name=__codelineno-45-20 href=#__codelineno-45-20></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-45-21><a id=__codelineno-45-21 name=__codelineno-45-21 href=#__codelineno-45-21></a><span class=p>});</span>
</span></code></pre></div><h3 id=54-mock-vs-live-decision-matrix>5.4 Mock vs Live Decision Matrix<a class=headerlink href=#54-mock-vs-live-decision-matrix title="Permanent link">&para;</a></h3><table><thead><tr><th>Scenario</th><th>Use Mocks</th><th>Use Live</th><th>Reason</th></tr></thead><tbody><tr><td>Unit Tests</td><td>✅</td><td>❌</td><td>Speed and isolation</td></tr><tr><td>Integration Tests</td><td>✅</td><td>❌</td><td>Predictable behavior</td></tr><tr><td>CI/CD Pipeline</td><td>✅</td><td>❌</td><td>No external dependencies</td></tr><tr><td>Pre-deployment Validation</td><td>❌</td><td>✅</td><td>Real-world verification</td></tr><tr><td>Debugging Production Issues</td><td>❌</td><td>✅</td><td>Reproduce actual behavior</td></tr></tbody></table><h3 id=55-testing-service-failures>5.5 Testing Service Failures<a class=headerlink href=#55-testing-service-failures title="Permanent link">&para;</a></h3><p>Focus on graceful degradation:</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=c1>// Test what happens when services fail</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Service Resilience&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should show degraded status when Overseerr is down&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=w>    </span><span class=nx>simulateOverseerrDown</span><span class=p>();</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/dashboard/status&#39;</span><span class=p>);</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>overseerr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>response</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>services</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>s</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>name</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;Overseerr&#39;</span><span class=p>);</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>overseerr</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;down&#39;</span><span class=p>);</span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>overseerr</span><span class=p>.</span><span class=nx>features</span><span class=p>).</span><span class=nx>toContain</span><span class=p>(</span><span class=s1>&#39;disabled&#39;</span><span class=p>);</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a><span class=p>});</span>
</span></code></pre></div><h3 id=92-websocket-load-testing>9.2 WebSocket Load Testing<a class=headerlink href=#92-websocket-load-testing title="Permanent link">&para;</a></h3><div class="language-javascript highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=c1>// tests/performance/websocket-load.js</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=k>import</span><span class=w> </span><span class=nx>ws</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;k6/ws&#39;</span><span class=p>;</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>check</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;k6&#39;</span><span class=p>;</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=k>export</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=w>  </span><span class=nx>vus</span><span class=o>:</span><span class=w> </span><span class=mf>50</span><span class=p>,</span><span class=w> </span><span class=c1>// 50 virtual users</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=w>  </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;5m&#39;</span><span class=p>,</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a><span class=p>};</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;ws://localhost:4000&#39;</span><span class=p>;</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>tags</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>my_tag</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;websocket&#39;</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>ws</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span><span class=w> </span><span class=nx>params</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=p>(</span><span class=nx>socket</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=w>    </span><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;open&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-16><a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a><span class=w>      </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;WebSocket connection established&#39;</span><span class=p>);</span>
</span><span id=__span-47-17><a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a>
</span><span id=__span-47-18><a id=__codelineno-47-18 name=__codelineno-47-18 href=#__codelineno-47-18></a><span class=w>      </span><span class=c1>// Subscribe to status updates</span>
</span><span id=__span-47-19><a id=__codelineno-47-19 name=__codelineno-47-19 href=#__codelineno-47-19></a><span class=w>      </span><span class=nx>socket</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span>
</span><span id=__span-47-20><a id=__codelineno-47-20 name=__codelineno-47-20 href=#__codelineno-47-20></a><span class=w>        </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span><span id=__span-47-21><a id=__codelineno-47-21 name=__codelineno-47-21 href=#__codelineno-47-21></a><span class=w>          </span><span class=nx>event</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;subscribe:status&#39;</span><span class=p>,</span>
</span><span id=__span-47-22><a id=__codelineno-47-22 name=__codelineno-47-22 href=#__codelineno-47-22></a><span class=w>        </span><span class=p>}),</span>
</span><span id=__span-47-23><a id=__codelineno-47-23 name=__codelineno-47-23 href=#__codelineno-47-23></a><span class=w>      </span><span class=p>);</span>
</span><span id=__span-47-24><a id=__codelineno-47-24 name=__codelineno-47-24 href=#__codelineno-47-24></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-47-25><a id=__codelineno-47-25 name=__codelineno-47-25 href=#__codelineno-47-25></a>
</span><span id=__span-47-26><a id=__codelineno-47-26 name=__codelineno-47-26 href=#__codelineno-47-26></a><span class=w>    </span><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=p>(</span><span class=nx>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-27><a id=__codelineno-47-27 name=__codelineno-47-27 href=#__codelineno-47-27></a><span class=w>      </span><span class=kd>let</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>message</span><span class=p>);</span>
</span><span id=__span-47-28><a id=__codelineno-47-28 name=__codelineno-47-28 href=#__codelineno-47-28></a>
</span><span id=__span-47-29><a id=__codelineno-47-29 name=__codelineno-47-29 href=#__codelineno-47-29></a><span class=w>      </span><span class=nx>check</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-30><a id=__codelineno-47-30 name=__codelineno-47-30 href=#__codelineno-47-30></a><span class=w>        </span><span class=s1>&#39;status message received&#39;</span><span class=o>:</span><span class=w> </span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>event</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=s1>&#39;service:status&#39;</span><span class=p>,</span>
</span><span id=__span-47-31><a id=__codelineno-47-31 name=__codelineno-47-31 href=#__codelineno-47-31></a><span class=w>        </span><span class=s1>&#39;status has valid format&#39;</span><span class=o>:</span><span class=w> </span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>service</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>status</span><span class=p>,</span>
</span><span id=__span-47-32><a id=__codelineno-47-32 name=__codelineno-47-32 href=#__codelineno-47-32></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-47-33><a id=__codelineno-47-33 name=__codelineno-47-33 href=#__codelineno-47-33></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-47-34><a id=__codelineno-47-34 name=__codelineno-47-34 href=#__codelineno-47-34></a>
</span><span id=__span-47-35><a id=__codelineno-47-35 name=__codelineno-47-35 href=#__codelineno-47-35></a><span class=w>    </span><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;close&#39;</span><span class=p>,</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-36><a id=__codelineno-47-36 name=__codelineno-47-36 href=#__codelineno-47-36></a><span class=w>      </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;WebSocket connection closed&#39;</span><span class=p>);</span>
</span><span id=__span-47-37><a id=__codelineno-47-37 name=__codelineno-47-37 href=#__codelineno-47-37></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-47-38><a id=__codelineno-47-38 name=__codelineno-47-38 href=#__codelineno-47-38></a>
</span><span id=__span-47-39><a id=__codelineno-47-39 name=__codelineno-47-39 href=#__codelineno-47-39></a><span class=w>    </span><span class=nx>socket</span><span class=p>.</span><span class=nx>setTimeout</span><span class=p>(</span><span class=kd>function</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-40><a id=__codelineno-47-40 name=__codelineno-47-40 href=#__codelineno-47-40></a><span class=w>      </span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;WebSocket connection timeout&#39;</span><span class=p>);</span>
</span><span id=__span-47-41><a id=__codelineno-47-41 name=__codelineno-47-41 href=#__codelineno-47-41></a><span class=w>      </span><span class=nx>socket</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span><span id=__span-47-42><a id=__codelineno-47-42 name=__codelineno-47-42 href=#__codelineno-47-42></a><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=mf>10000</span><span class=p>);</span>
</span><span id=__span-47-43><a id=__codelineno-47-43 name=__codelineno-47-43 href=#__codelineno-47-43></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-47-44><a id=__codelineno-47-44 name=__codelineno-47-44 href=#__codelineno-47-44></a>
</span><span id=__span-47-45><a id=__codelineno-47-45 name=__codelineno-47-45 href=#__codelineno-47-45></a><span class=w>  </span><span class=nx>check</span><span class=p>(</span><span class=nx>response</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-46><a id=__codelineno-47-46 name=__codelineno-47-46 href=#__codelineno-47-46></a><span class=w>    </span><span class=s1>&#39;WebSocket connection successful&#39;</span><span class=o>:</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>status</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>101</span><span class=p>,</span>
</span><span id=__span-47-47><a id=__codelineno-47-47 name=__codelineno-47-47 href=#__codelineno-47-47></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-47-48><a id=__codelineno-47-48 name=__codelineno-47-48 href=#__codelineno-47-48></a><span class=p>}</span>
</span></code></pre></div><h3 id=93-database-performance-testing>9.3 Database Performance Testing<a class=headerlink href=#93-database-performance-testing title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=c1>// tests/performance/database.test.ts</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>PrismaClient</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;@prisma/client&#39;</span><span class=p>;</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>performance</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;perf_hooks&#39;</span><span class=p>;</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Database Performance&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nx>prisma</span><span class=o>:</span><span class=w> </span><span class=kt>PrismaClient</span><span class=p>;</span>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a><span class=w>  </span><span class=nx>beforeAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-9><a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a><span class=w>    </span><span class=nx>prisma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>PrismaClient</span><span class=p>();</span>
</span><span id=__span-48-10><a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-48-11><a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a>
</span><span id=__span-48-12><a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a><span class=w>  </span><span class=nx>afterAll</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-13><a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>$disconnect</span><span class=p>();</span>
</span><span id=__span-48-14><a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-48-15><a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a>
</span><span id=__span-48-16><a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;handles concurrent user creation&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-17><a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span><span id=__span-48-18><a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a>
</span><span id=__span-48-19><a id=__codelineno-48-19 name=__codelineno-48-19 href=#__codelineno-48-19></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>promises</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Array</span><span class=p>.</span><span class=kr>from</span><span class=p>({</span><span class=w> </span><span class=nx>length</span><span class=o>:</span><span class=w> </span><span class=kt>100</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>(</span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>i</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span>
</span><span id=__span-48-20><a id=__codelineno-48-20 name=__codelineno-48-20 href=#__codelineno-48-20></a><span class=w>      </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span><span id=__span-48-21><a id=__codelineno-48-21 name=__codelineno-48-21 href=#__codelineno-48-21></a><span class=w>        </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-22><a id=__codelineno-48-22 name=__codelineno-48-22 href=#__codelineno-48-22></a><span class=w>          </span><span class=nx>plexId</span><span class=o>:</span><span class=w> </span><span class=sb>`test-</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-48-23><a id=__codelineno-48-23 name=__codelineno-48-23 href=#__codelineno-48-23></a><span class=w>          </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=sb>`user</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-48-24><a id=__codelineno-48-24 name=__codelineno-48-24 href=#__codelineno-48-24></a><span class=w>          </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=sb>`user</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>@test.com`</span><span class=p>,</span>
</span><span id=__span-48-25><a id=__codelineno-48-25 name=__codelineno-48-25 href=#__codelineno-48-25></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-48-26><a id=__codelineno-48-26 name=__codelineno-48-26 href=#__codelineno-48-26></a><span class=w>      </span><span class=p>}),</span>
</span><span id=__span-48-27><a id=__codelineno-48-27 name=__codelineno-48-27 href=#__codelineno-48-27></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-48-28><a id=__codelineno-48-28 name=__codelineno-48-28 href=#__codelineno-48-28></a>
</span><span id=__span-48-29><a id=__codelineno-48-29 name=__codelineno-48-29 href=#__codelineno-48-29></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span><span class=nx>promises</span><span class=p>);</span>
</span><span id=__span-48-30><a id=__codelineno-48-30 name=__codelineno-48-30 href=#__codelineno-48-30></a>
</span><span id=__span-48-31><a id=__codelineno-48-31 name=__codelineno-48-31 href=#__codelineno-48-31></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>startTime</span><span class=p>;</span>
</span><span id=__span-48-32><a id=__codelineno-48-32 name=__codelineno-48-32 href=#__codelineno-48-32></a>
</span><span id=__span-48-33><a id=__codelineno-48-33 name=__codelineno-48-33 href=#__codelineno-48-33></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>duration</span><span class=p>).</span><span class=nx>toBeLessThan</span><span class=p>(</span><span class=mf>5000</span><span class=p>);</span><span class=w> </span><span class=c1>// Under 5 seconds for 100 users</span>
</span><span id=__span-48-34><a id=__codelineno-48-34 name=__codelineno-48-34 href=#__codelineno-48-34></a>
</span><span id=__span-48-35><a id=__codelineno-48-35 name=__codelineno-48-35 href=#__codelineno-48-35></a><span class=w>    </span><span class=c1>// Cleanup</span>
</span><span id=__span-48-36><a id=__codelineno-48-36 name=__codelineno-48-36 href=#__codelineno-48-36></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>({</span>
</span><span id=__span-48-37><a id=__codelineno-48-37 name=__codelineno-48-37 href=#__codelineno-48-37></a><span class=w>      </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>startsWith</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-48-38><a id=__codelineno-48-38 name=__codelineno-48-38 href=#__codelineno-48-38></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-48-39><a id=__codelineno-48-39 name=__codelineno-48-39 href=#__codelineno-48-39></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-48-40><a id=__codelineno-48-40 name=__codelineno-48-40 href=#__codelineno-48-40></a>
</span><span id=__span-48-41><a id=__codelineno-48-41 name=__codelineno-48-41 href=#__codelineno-48-41></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;efficiently queries media requests with pagination&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-42><a id=__codelineno-48-42 name=__codelineno-48-42 href=#__codelineno-48-42></a><span class=w>    </span><span class=c1>// Seed test data</span>
</span><span id=__span-48-43><a id=__codelineno-48-43 name=__codelineno-48-43 href=#__codelineno-48-43></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>users</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span><span id=__span-48-44><a id=__codelineno-48-44 name=__codelineno-48-44 href=#__codelineno-48-44></a><span class=w>      </span><span class=nb>Array</span><span class=p>.</span><span class=kr>from</span><span class=p>({</span><span class=w> </span><span class=nx>length</span><span class=o>:</span><span class=w> </span><span class=kt>10</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>(</span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>i</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span>
</span><span id=__span-48-45><a id=__codelineno-48-45 name=__codelineno-48-45 href=#__codelineno-48-45></a><span class=w>        </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span><span id=__span-48-46><a id=__codelineno-48-46 name=__codelineno-48-46 href=#__codelineno-48-46></a><span class=w>          </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-47><a id=__codelineno-48-47 name=__codelineno-48-47 href=#__codelineno-48-47></a><span class=w>            </span><span class=nx>plexId</span><span class=o>:</span><span class=w> </span><span class=sb>`perf-test-</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-48-48><a id=__codelineno-48-48 name=__codelineno-48-48 href=#__codelineno-48-48></a><span class=w>            </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=sb>`perfuser</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-48-49><a id=__codelineno-48-49 name=__codelineno-48-49 href=#__codelineno-48-49></a><span class=w>            </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=sb>`perfuser</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>@test.com`</span><span class=p>,</span>
</span><span id=__span-48-50><a id=__codelineno-48-50 name=__codelineno-48-50 href=#__codelineno-48-50></a><span class=w>          </span><span class=p>},</span>
</span><span id=__span-48-51><a id=__codelineno-48-51 name=__codelineno-48-51 href=#__codelineno-48-51></a><span class=w>        </span><span class=p>}),</span>
</span><span id=__span-48-52><a id=__codelineno-48-52 name=__codelineno-48-52 href=#__codelineno-48-52></a><span class=w>      </span><span class=p>),</span>
</span><span id=__span-48-53><a id=__codelineno-48-53 name=__codelineno-48-53 href=#__codelineno-48-53></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-48-54><a id=__codelineno-48-54 name=__codelineno-48-54 href=#__codelineno-48-54></a>
</span><span id=__span-48-55><a id=__codelineno-48-55 name=__codelineno-48-55 href=#__codelineno-48-55></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span><span id=__span-48-56><a id=__codelineno-48-56 name=__codelineno-48-56 href=#__codelineno-48-56></a><span class=w>      </span><span class=nx>users</span><span class=p>.</span><span class=nx>flatMap</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span>
</span><span id=__span-48-57><a id=__codelineno-48-57 name=__codelineno-48-57 href=#__codelineno-48-57></a><span class=w>        </span><span class=nb>Array</span><span class=p>.</span><span class=kr>from</span><span class=p>({</span><span class=w> </span><span class=nx>length</span><span class=o>:</span><span class=w> </span><span class=kt>100</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=p>(</span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>i</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span>
</span><span id=__span-48-58><a id=__codelineno-48-58 name=__codelineno-48-58 href=#__codelineno-48-58></a><span class=w>          </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>mediaRequest</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span><span id=__span-48-59><a id=__codelineno-48-59 name=__codelineno-48-59 href=#__codelineno-48-59></a><span class=w>            </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-60><a id=__codelineno-48-60 name=__codelineno-48-60 href=#__codelineno-48-60></a><span class=w>              </span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>user.id</span><span class=p>,</span>
</span><span id=__span-48-61><a id=__codelineno-48-61 name=__codelineno-48-61 href=#__codelineno-48-61></a><span class=w>              </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=sb>`Movie </span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-48-62><a id=__codelineno-48-62 name=__codelineno-48-62 href=#__codelineno-48-62></a><span class=w>              </span><span class=nx>mediaType</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;movie&#39;</span><span class=p>,</span>
</span><span id=__span-48-63><a id=__codelineno-48-63 name=__codelineno-48-63 href=#__codelineno-48-63></a><span class=w>              </span><span class=nx>tmdbId</span><span class=o>:</span><span class=w> </span><span class=sb>`</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span><span id=__span-48-64><a id=__codelineno-48-64 name=__codelineno-48-64 href=#__codelineno-48-64></a><span class=w>              </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;pending&#39;</span><span class=p>,</span>
</span><span id=__span-48-65><a id=__codelineno-48-65 name=__codelineno-48-65 href=#__codelineno-48-65></a><span class=w>            </span><span class=p>},</span>
</span><span id=__span-48-66><a id=__codelineno-48-66 name=__codelineno-48-66 href=#__codelineno-48-66></a><span class=w>          </span><span class=p>}),</span>
</span><span id=__span-48-67><a id=__codelineno-48-67 name=__codelineno-48-67 href=#__codelineno-48-67></a><span class=w>        </span><span class=p>),</span>
</span><span id=__span-48-68><a id=__codelineno-48-68 name=__codelineno-48-68 href=#__codelineno-48-68></a><span class=w>      </span><span class=p>),</span>
</span><span id=__span-48-69><a id=__codelineno-48-69 name=__codelineno-48-69 href=#__codelineno-48-69></a><span class=w>    </span><span class=p>);</span>
</span><span id=__span-48-70><a id=__codelineno-48-70 name=__codelineno-48-70 href=#__codelineno-48-70></a>
</span><span id=__span-48-71><a id=__codelineno-48-71 name=__codelineno-48-71 href=#__codelineno-48-71></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span><span id=__span-48-72><a id=__codelineno-48-72 name=__codelineno-48-72 href=#__codelineno-48-72></a>
</span><span id=__span-48-73><a id=__codelineno-48-73 name=__codelineno-48-73 href=#__codelineno-48-73></a><span class=w>    </span><span class=c1>// Query with pagination</span>
</span><span id=__span-48-74><a id=__codelineno-48-74 name=__codelineno-48-74 href=#__codelineno-48-74></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>requests</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>mediaRequest</span><span class=p>.</span><span class=nx>findMany</span><span class=p>({</span>
</span><span id=__span-48-75><a id=__codelineno-48-75 name=__codelineno-48-75 href=#__codelineno-48-75></a><span class=w>      </span><span class=nx>take</span><span class=o>:</span><span class=w> </span><span class=kt>20</span><span class=p>,</span>
</span><span id=__span-48-76><a id=__codelineno-48-76 name=__codelineno-48-76 href=#__codelineno-48-76></a><span class=w>      </span><span class=nx>skip</span><span class=o>:</span><span class=w> </span><span class=kt>0</span><span class=p>,</span>
</span><span id=__span-48-77><a id=__codelineno-48-77 name=__codelineno-48-77 href=#__codelineno-48-77></a><span class=w>      </span><span class=nx>orderBy</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>createdAt</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;desc&#39;</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-48-78><a id=__codelineno-48-78 name=__codelineno-48-78 href=#__codelineno-48-78></a><span class=w>      </span><span class=nx>include</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>user</span><span class=o>:</span><span class=w> </span><span class=kt>true</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-48-79><a id=__codelineno-48-79 name=__codelineno-48-79 href=#__codelineno-48-79></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-48-80><a id=__codelineno-48-80 name=__codelineno-48-80 href=#__codelineno-48-80></a>
</span><span id=__span-48-81><a id=__codelineno-48-81 name=__codelineno-48-81 href=#__codelineno-48-81></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>performance</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>startTime</span><span class=p>;</span>
</span><span id=__span-48-82><a id=__codelineno-48-82 name=__codelineno-48-82 href=#__codelineno-48-82></a>
</span><span id=__span-48-83><a id=__codelineno-48-83 name=__codelineno-48-83 href=#__codelineno-48-83></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>duration</span><span class=p>).</span><span class=nx>toBeLessThan</span><span class=p>(</span><span class=mf>100</span><span class=p>);</span><span class=w> </span><span class=c1>// Under 100ms</span>
</span><span id=__span-48-84><a id=__codelineno-48-84 name=__codelineno-48-84 href=#__codelineno-48-84></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>requests</span><span class=p>).</span><span class=nx>toHaveLength</span><span class=p>(</span><span class=mf>20</span><span class=p>);</span>
</span><span id=__span-48-85><a id=__codelineno-48-85 name=__codelineno-48-85 href=#__codelineno-48-85></a>
</span><span id=__span-48-86><a id=__codelineno-48-86 name=__codelineno-48-86 href=#__codelineno-48-86></a><span class=w>    </span><span class=c1>// Cleanup</span>
</span><span id=__span-48-87><a id=__codelineno-48-87 name=__codelineno-48-87 href=#__codelineno-48-87></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>mediaRequest</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>({</span>
</span><span id=__span-48-88><a id=__codelineno-48-88 name=__codelineno-48-88 href=#__codelineno-48-88></a><span class=w>      </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>title</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>startsWith</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Movie&#39;</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-48-89><a id=__codelineno-48-89 name=__codelineno-48-89 href=#__codelineno-48-89></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-48-90><a id=__codelineno-48-90 name=__codelineno-48-90 href=#__codelineno-48-90></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>({</span>
</span><span id=__span-48-91><a id=__codelineno-48-91 name=__codelineno-48-91 href=#__codelineno-48-91></a><span class=w>      </span><span class=nx>where</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>startsWith</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;perfuser&#39;</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>},</span>
</span><span id=__span-48-92><a id=__codelineno-48-92 name=__codelineno-48-92 href=#__codelineno-48-92></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-48-93><a id=__codelineno-48-93 name=__codelineno-48-93 href=#__codelineno-48-93></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-48-94><a id=__codelineno-48-94 name=__codelineno-48-94 href=#__codelineno-48-94></a><span class=p>});</span>
</span></code></pre></div><h3 id=53-simple-performance-checks>5.3 Simple Performance Checks<a class=headerlink href=#53-simple-performance-checks title="Permanent link">&para;</a></h3><p>No need for k6 or Artillery - just add assertions to existing tests:</p><div class="language-typescript highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=c1>// Add performance checks to integration tests</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should respond quickly to API requests&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=w>    </span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/dashboard/status&#39;</span><span class=p>)</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=w>    </span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Bearer valid-token&#39;</span><span class=p>);</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>start</span><span class=p>;</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=w>  </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=w>  </span><span class=nx>expect</span><span class=p>(</span><span class=nx>duration</span><span class=p>).</span><span class=nx>toBeLessThan</span><span class=p>(</span><span class=mf>1000</span><span class=p>);</span><span class=w> </span><span class=c1>// Under 1 second</span>
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=p>});</span>
</span><span id=__span-49-14><a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a>
</span><span id=__span-49-15><a id=__codelineno-49-15 name=__codelineno-49-15 href=#__codelineno-49-15></a><span class=c1>// Simple concurrent user test</span>
</span><span id=__span-49-16><a id=__codelineno-49-16 name=__codelineno-49-16 href=#__codelineno-49-16></a><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should handle 20 concurrent requests&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-49-17><a id=__codelineno-49-17 name=__codelineno-49-17 href=#__codelineno-49-17></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>requests</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Array</span><span class=p>(</span><span class=mf>20</span><span class=p>)</span>
</span><span id=__span-49-18><a id=__codelineno-49-18 name=__codelineno-49-18 href=#__codelineno-49-18></a><span class=w>    </span><span class=p>.</span><span class=nx>fill</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span>
</span><span id=__span-49-19><a id=__codelineno-49-19 name=__codelineno-49-19 href=#__codelineno-49-19></a><span class=w>    </span><span class=p>.</span><span class=nx>map</span><span class=p>(()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/health&#39;</span><span class=p>));</span>
</span><span id=__span-49-20><a id=__codelineno-49-20 name=__codelineno-49-20 href=#__codelineno-49-20></a>
</span><span id=__span-49-21><a id=__codelineno-49-21 name=__codelineno-49-21 href=#__codelineno-49-21></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>responses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span><span class=nx>requests</span><span class=p>);</span>
</span><span id=__span-49-22><a id=__codelineno-49-22 name=__codelineno-49-22 href=#__codelineno-49-22></a><span class=w>  </span><span class=kd>const</span><span class=w> </span><span class=nx>successful</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>responses</span><span class=p>.</span><span class=nx>filter</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>status</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-49-23><a id=__codelineno-49-23 name=__codelineno-49-23 href=#__codelineno-49-23></a>
</span><span id=__span-49-24><a id=__codelineno-49-24 name=__codelineno-49-24 href=#__codelineno-49-24></a><span class=w>  </span><span class=nx>expect</span><span class=p>(</span><span class=nx>successful</span><span class=p>.</span><span class=nx>length</span><span class=p>).</span><span class=nx>toBe</span><span class=p>(</span><span class=mf>20</span><span class=p>);</span>
</span><span id=__span-49-25><a id=__codelineno-49-25 name=__codelineno-49-25 href=#__codelineno-49-25></a><span class=p>});</span>
</span></code></pre></div><div class="language-text highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a>### 10.2 SQL Injection Prevention Testing
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a>```typescript
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a>// tests/security/sqlInjection.test.ts
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a>import { PrismaClient } from &#39;@prisma/client&#39;;
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a>describe(&#39;Security: SQL Injection Prevention&#39;, () =&gt; {
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a>  let prisma: PrismaClient;
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a>
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a>  beforeAll(async () =&gt; {
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a>    prisma = new PrismaClient();
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12 href=#__codelineno-50-12></a>  });
</span><span id=__span-50-13><a id=__codelineno-50-13 name=__codelineno-50-13 href=#__codelineno-50-13></a>
</span><span id=__span-50-14><a id=__codelineno-50-14 name=__codelineno-50-14 href=#__codelineno-50-14></a>  afterAll(async () =&gt; {
</span><span id=__span-50-15><a id=__codelineno-50-15 name=__codelineno-50-15 href=#__codelineno-50-15></a>    await prisma.$disconnect();
</span><span id=__span-50-16><a id=__codelineno-50-16 name=__codelineno-50-16 href=#__codelineno-50-16></a>  });
</span><span id=__span-50-17><a id=__codelineno-50-17 name=__codelineno-50-17 href=#__codelineno-50-17></a>
</span><span id=__span-50-18><a id=__codelineno-50-18 name=__codelineno-50-18 href=#__codelineno-50-18></a>  it(&#39;prevents SQL injection in user search&#39;, async () =&gt; {
</span><span id=__span-50-19><a id=__codelineno-50-19 name=__codelineno-50-19 href=#__codelineno-50-19></a>    const maliciousInput = &quot;&#39;; DROP TABLE users; --&quot;;
</span><span id=__span-50-20><a id=__codelineno-50-20 name=__codelineno-50-20 href=#__codelineno-50-20></a>
</span><span id=__span-50-21><a id=__codelineno-50-21 name=__codelineno-50-21 href=#__codelineno-50-21></a>    // This should not throw an error or affect the database
</span><span id=__span-50-22><a id=__codelineno-50-22 name=__codelineno-50-22 href=#__codelineno-50-22></a>    const result = await prisma.user.findMany({
</span><span id=__span-50-23><a id=__codelineno-50-23 name=__codelineno-50-23 href=#__codelineno-50-23></a>      where: {
</span><span id=__span-50-24><a id=__codelineno-50-24 name=__codelineno-50-24 href=#__codelineno-50-24></a>        username: {
</span><span id=__span-50-25><a id=__codelineno-50-25 name=__codelineno-50-25 href=#__codelineno-50-25></a>          contains: maliciousInput
</span><span id=__span-50-26><a id=__codelineno-50-26 name=__codelineno-50-26 href=#__codelineno-50-26></a>        }
</span><span id=__span-50-27><a id=__codelineno-50-27 name=__codelineno-50-27 href=#__codelineno-50-27></a>      }
</span><span id=__span-50-28><a id=__codelineno-50-28 name=__codelineno-50-28 href=#__codelineno-50-28></a>    });
</span><span id=__span-50-29><a id=__codelineno-50-29 name=__codelineno-50-29 href=#__codelineno-50-29></a>
</span><span id=__span-50-30><a id=__codelineno-50-30 name=__codelineno-50-30 href=#__codelineno-50-30></a>    expect(result).toEqual([]);
</span><span id=__span-50-31><a id=__codelineno-50-31 name=__codelineno-50-31 href=#__codelineno-50-31></a>
</span><span id=__span-50-32><a id=__codelineno-50-32 name=__codelineno-50-32 href=#__codelineno-50-32></a>    // Verify users table still exists
</span><span id=__span-50-33><a id=__codelineno-50-33 name=__codelineno-50-33 href=#__codelineno-50-33></a>    const userCount = await prisma.user.count();
</span><span id=__span-50-34><a id=__codelineno-50-34 name=__codelineno-50-34 href=#__codelineno-50-34></a>    expect(userCount).toBeGreaterThanOrEqual(0);
</span><span id=__span-50-35><a id=__codelineno-50-35 name=__codelineno-50-35 href=#__codelineno-50-35></a>  });
</span><span id=__span-50-36><a id=__codelineno-50-36 name=__codelineno-50-36 href=#__codelineno-50-36></a>
</span><span id=__span-50-37><a id=__codelineno-50-37 name=__codelineno-50-37 href=#__codelineno-50-37></a>  it(&#39;prevents SQL injection in media search&#39;, async () =&gt; {
</span><span id=__span-50-38><a id=__codelineno-50-38 name=__codelineno-50-38 href=#__codelineno-50-38></a>    const maliciousInput = &quot;&#39; UNION SELECT * FROM users --&quot;;
</span><span id=__span-50-39><a id=__codelineno-50-39 name=__codelineno-50-39 href=#__codelineno-50-39></a>
</span><span id=__span-50-40><a id=__codelineno-50-40 name=__codelineno-50-40 href=#__codelineno-50-40></a>    const result = await prisma.mediaRequest.findMany({
</span><span id=__span-50-41><a id=__codelineno-50-41 name=__codelineno-50-41 href=#__codelineno-50-41></a>      where: {
</span><span id=__span-50-42><a id=__codelineno-50-42 name=__codelineno-50-42 href=#__codelineno-50-42></a>        title: {
</span><span id=__span-50-43><a id=__codelineno-50-43 name=__codelineno-50-43 href=#__codelineno-50-43></a>          contains: maliciousInput
</span><span id=__span-50-44><a id=__codelineno-50-44 name=__codelineno-50-44 href=#__codelineno-50-44></a>        }
</span><span id=__span-50-45><a id=__codelineno-50-45 name=__codelineno-50-45 href=#__codelineno-50-45></a>      }
</span><span id=__span-50-46><a id=__codelineno-50-46 name=__codelineno-50-46 href=#__codelineno-50-46></a>    });
</span><span id=__span-50-47><a id=__codelineno-50-47 name=__codelineno-50-47 href=#__codelineno-50-47></a>
</span><span id=__span-50-48><a id=__codelineno-50-48 name=__codelineno-50-48 href=#__codelineno-50-48></a>    expect(result).toEqual([]);
</span><span id=__span-50-49><a id=__codelineno-50-49 name=__codelineno-50-49 href=#__codelineno-50-49></a>  });
</span><span id=__span-50-50><a id=__codelineno-50-50 name=__codelineno-50-50 href=#__codelineno-50-50></a>});
</span></code></pre></div><h3 id=103-security-headers-testing>10.3 Security Headers Testing<a class=headerlink href=#103-security-headers-testing title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=c1>// tests/security/headers.test.ts</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=k>import</span><span class=w> </span><span class=nx>request</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;supertest&#39;</span><span class=p>;</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>app</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;../src/app&#39;</span><span class=p>;</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;Security: HTTP Headers&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;sets security headers correctly&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/health&#39;</span><span class=p>).</span><span class=nx>expect</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;x-content-type-options&#39;</span><span class=p>]).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;nosniff&#39;</span><span class=p>);</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;x-frame-options&#39;</span><span class=p>]).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;DENY&#39;</span><span class=p>);</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;x-xss-protection&#39;</span><span class=p>]).</span><span class=nx>toBe</span><span class=p>(</span><span class=s1>&#39;1; mode=block&#39;</span><span class=p>);</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;strict-transport-security&#39;</span><span class=p>]).</span><span class=nx>toMatch</span><span class=p>(</span><span class=sr>/max-age=\d+/</span><span class=p>);</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;content-security-policy&#39;</span><span class=p>]).</span><span class=nx>toBeDefined</span><span class=p>();</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a><span class=w>  </span><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;does not expose sensitive information&#39;</span><span class=p>,</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>).</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/health&#39;</span><span class=p>).</span><span class=nx>expect</span><span class=p>(</span><span class=mf>200</span><span class=p>);</span>
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a>
</span><span id=__span-51-19><a id=__codelineno-51-19 name=__codelineno-51-19 href=#__codelineno-51-19></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;x-powered-by&#39;</span><span class=p>]).</span><span class=nx>toBeUndefined</span><span class=p>();</span>
</span><span id=__span-51-20><a id=__codelineno-51-20 name=__codelineno-51-20 href=#__codelineno-51-20></a><span class=w>    </span><span class=nx>expect</span><span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;server&#39;</span><span class=p>]).</span><span class=nx>toBeUndefined</span><span class=p>();</span>
</span><span id=__span-51-21><a id=__codelineno-51-21 name=__codelineno-51-21 href=#__codelineno-51-21></a><span class=w>  </span><span class=p>});</span>
</span><span id=__span-51-22><a id=__codelineno-51-22 name=__codelineno-51-22 href=#__codelineno-51-22></a><span class=p>});</span>
</span></code></pre></div><h2 id=7-practical-guidelines>7. Practical Guidelines<a class=headerlink href=#7-practical-guidelines title="Permanent link">&para;</a></h2><h3 id=71-test-helpers-keep-it-simple>7.1 Test Helpers (Keep It Simple)<a class=headerlink href=#71-test-helpers-keep-it-simple title="Permanent link">&para;</a></h3><div class="language-typescript highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=c1>// Simple test utilities</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>testUtils</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=w>  </span><span class=c1>// Generate test JWT</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=w>  </span><span class=nx>createAuthToken</span><span class=o>:</span><span class=w> </span><span class=p>(</span><span class=nx>userId</span><span class=o>:</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>role</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>jwt</span><span class=p>.</span><span class=nx>sign</span><span class=p>({</span><span class=w> </span><span class=nx>userId</span><span class=p>,</span><span class=w> </span><span class=nx>role</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>expiresIn</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1h&#39;</span><span class=w> </span><span class=p>});</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=w>  </span><span class=c1>// Create test user</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=w>  </span><span class=nx>createTestUser</span><span class=o>:</span><span class=w> </span><span class=kt>async</span><span class=w> </span><span class=p>(</span><span class=nx>overrides</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{})</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=w>      </span><span class=nx>data</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=w>        </span><span class=nx>plexId</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test-&#39;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>(),</span>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=w>        </span><span class=nx>username</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;testuser&#39;</span><span class=p>,</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=w>        </span><span class=nx>email</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;test@example.com&#39;</span><span class=p>,</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a><span class=w>        </span><span class=nx>role</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=w>        </span><span class=p>...</span><span class=nx>overrides</span><span class=p>,</span>
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=w>      </span><span class=p>},</span>
</span><span id=__span-52-18><a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a><span class=w>    </span><span class=p>});</span>
</span><span id=__span-52-19><a id=__codelineno-52-19 name=__codelineno-52-19 href=#__codelineno-52-19></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-52-20><a id=__codelineno-52-20 name=__codelineno-52-20 href=#__codelineno-52-20></a>
</span><span id=__span-52-21><a id=__codelineno-52-21 name=__codelineno-52-21 href=#__codelineno-52-21></a><span class=w>  </span><span class=c1>// Clean database after tests</span>
</span><span id=__span-52-22><a id=__codelineno-52-22 name=__codelineno-52-22 href=#__codelineno-52-22></a><span class=w>  </span><span class=nx>cleanDatabase</span><span class=o>:</span><span class=w> </span><span class=kt>async</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-23><a id=__codelineno-52-23 name=__codelineno-52-23 href=#__codelineno-52-23></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>mediaRequest</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>();</span>
</span><span id=__span-52-24><a id=__codelineno-52-24 name=__codelineno-52-24 href=#__codelineno-52-24></a><span class=w>    </span><span class=k>await</span><span class=w> </span><span class=nx>prisma</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>deleteMany</span><span class=p>();</span>
</span><span id=__span-52-25><a id=__codelineno-52-25 name=__codelineno-52-25 href=#__codelineno-52-25></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-52-26><a id=__codelineno-52-26 name=__codelineno-52-26 href=#__codelineno-52-26></a><span class=p>};</span>
</span></code></pre></div><h3 id=72-what-to-test-checklist>7.2 What to Test Checklist<a class=headerlink href=#72-what-to-test-checklist title="Permanent link">&para;</a></h3><p>✅ <strong>Must Test:</strong></p><ul><li>Plex OAuth flow (critical path)</li><li>User data isolation (security)</li><li>Rate limiting (prevent abuse)</li><li>Service unavailability handling</li><li>Basic API authentication</li></ul><p>❌ <strong>Skip Testing:</strong></p><ul><li>UI component props/state</li><li>Simple CRUD operations</li><li>Third-party library internals</li><li>CSS/styling</li><li>Performance under extreme load</li></ul><h3 id=73-test-maintenance>7.3 Test Maintenance<a class=headerlink href=#73-test-maintenance title="Permanent link">&para;</a></h3><ol><li><strong>Fix or Delete</strong>: Flaky tests get one chance to be fixed, then deleted</li><li><strong>Review Quarterly</strong>: Remove obsolete tests</li><li><strong>Document Weird Tests</strong>: If a test is non-obvious, add a comment explaining why</li><li><strong>Keep It Fast</strong>: If total suite &gt; 5 minutes, remove low-value tests</li></ol><h3 id=74-coverage-guidelines-realistic-goals>7.4 Coverage Guidelines (Realistic Goals)<a class=headerlink href=#74-coverage-guidelines-realistic-goals title="Permanent link">&para;</a></h3><p><strong>Target Coverage: 60-70% overall</strong></p><p>Prioritize coverage where it matters:</p><ul><li>Authentication/Security: 80%</li><li>Business Logic: 70%</li><li>API Routes: 60%</li><li>UI Components: 40-50%</li></ul><div class="language-typescript highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=c1>// vitest.config.ts - Simple configuration</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>defineConfig</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;vitest/config&#39;</span><span class=p>;</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nx>defineConfig</span><span class=p>({</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=w>  </span><span class=nx>test</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=w>    </span><span class=nx>environment</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;node&#39;</span><span class=p>,</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=w>    </span><span class=nx>coverage</span><span class=o>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=w>      </span><span class=nx>provider</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;v8&#39;</span><span class=p>,</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=w>      </span><span class=nx>reportsDirectory</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;./coverage&#39;</span><span class=p>,</span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=w>      </span><span class=nx>exclude</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;node_modules/&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;tests/&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;**/*.test.{js,ts}&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;src/types/**&#39;</span><span class=p>],</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=w>      </span><span class=c1>// No hard thresholds - use as guidance only</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=w>      </span><span class=nx>reporter</span><span class=o>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;html&#39;</span><span class=p>],</span>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-53-14><a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-53-15><a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a><span class=p>});</span>
</span></code></pre></div><h2 id=example-test-structure>Example Test Structure<a class=headerlink href=#example-test-structure title="Permanent link">&para;</a></h2><div class="language-text highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a>tests/
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a>├── unit/
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a>│   ├── services/          # Business logic tests
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a>│   └── utils/             # Utility function tests
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a>├── integration/
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a>│   ├── api/               # API endpoint tests
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a>│   └── external/          # External service mocks
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a>├── e2e/
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a>│   ├── auth.spec.ts       # Auth flow
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a>│   └── media-request.spec.ts  # Request flow
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a>└── helpers/
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a>    ├── setup.ts           # Test setup
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a>    └── mocks.ts           # Shared mocks
</span></code></pre></div><h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2><p>This simplified test architecture is designed specifically for MediaNest's scale (10-20 users). It prioritizes:</p><ol><li><strong>Practical Testing</strong>: Focus on what can break, not arbitrary coverage</li><li><strong>Simple Tools</strong>: Jest, Supertest, and basic mocks - no complex frameworks</li><li><strong>Fast Execution</strong>: Under 5 minutes for everything</li><li><strong>Easy Maintenance</strong>: If a test is hard to maintain, delete it</li></ol><p>Remember: For a small application, a few well-written tests covering critical paths are worth more than thousands of tests covering every edge case.</p><p><strong>Key Takeaway</strong>: Test the Plex OAuth flow thoroughly, ensure services fail gracefully, verify rate limiting works, and call it done. Everything else is optional.</p><hr><p><strong>Document Version</strong>: 2.0 (Simplified)<br><strong>Review Schedule</strong>: When something breaks<br><strong>Maintenance</strong>: Keep it simple</p><aside class=md-source-file><span class=md-source-file__fact><span class=md-icon title="Last update"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="July 19, 2025 07:57:00 UTC"><span class=timeago datetime=2025-07-19T07:57:00+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="July 19, 2025 07:57:00 UTC">2025-07-19</span></span><span class=md-source-file__fact><span class=md-icon title=Created><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="July 2, 2025 08:33:47 UTC"><span class=timeago datetime=2025-07-02T08:33:47+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="July 2, 2025 08:33:47 UTC">2025-07-02</span></span></aside><form class=md-feedback name=feedback hidden><fieldset><legend class=md-feedback__title> Was this page helpful? </legend><div class=md-feedback__inner><div class=md-feedback__list><button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg></button><button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg></button></div><div class=md-feedback__note><div data-md-value=1 hidden> Thanks for your feedback! Consider starring us on <a href=https://github.com/medianest/medianest target=_blank rel=noopener>GitHub</a></div><div data-md-value=0 hidden> Thanks for your feedback! Help us improve by <a href="https://github.com/medianest/medianest/issues/new/?title=[Docs]+MediaNest%20Test%20Architecture+-+/TESTING_ARCHITECTURE/" target=_blank rel=noopener>creating an issue</a> or <a href=https://github.com/medianest/medianest/edit/develop/docs/{path} target=_blank rel=noopener>editing this page</a>. </div></div></div></fieldset></form></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright><div class=md-copyright__highlight> Copyright &copy; 2024 MediaNest Development Team - <a href=#__consent>Manage Cookies</a> | <a href=/privacy>Privacy Policy</a> | <a href=/terms>Terms of Service</a></div></div><div class=md-social><a href=https://github.com/medianest/medianest target=_blank rel=noopener title="GitHub Repository" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg></a><a href=https://hub.docker.com/r/medianest/medianest target=_blank rel=noopener title="Docker Hub" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg></a><a href=https://discord.gg/medianest target=_blank rel=noopener title="Discord Community" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg></a><a href=https://twitter.com/medianest target=_blank rel=noopener title="Twitter Updates" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg></a><a href=https://medianest.com target=_blank rel=noopener title="Official Website" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M351.9 280H161c2.9 64.5 17.2 123.9 37.5 167.4 11.4 24.5 23.7 41.8 35.1 52.4 11.2 10.5 18.9 12.2 22.9 12.2s11.7-1.7 22.9-12.2c11.4-10.6 23.7-28 35.1-52.4 20.3-43.5 34.6-102.9 37.5-167.4zm-191-48h190.9c-2.8-64.5-17.1-123.9-37.4-167.4-11.4-24.4-23.7-41.8-35.1-52.4C268.1 1.7 260.4 0 256.4 0s-11.7 1.7-22.9 12.2c-11.4 10.6-23.7 28-35.1 52.4-20.3 43.5-34.6 102.9-37.5 167.4m-48 0c3.5-85.6 25.6-165.1 57.9-217.3C78.7 47.3 10.9 131.2 1.5 232zM1.5 280c9.4 100.8 77.2 184.7 169.3 217.3-32.3-52.2-54.4-131.7-57.9-217.3zm398.4 0c-3.5 85.6-25.6 165.1-57.9 217.3 92.1-32.7 159.9-116.5 169.3-217.3zm111.4-48C501.9 131.2 434.1 47.3 342 14.7c32.3 52.2 54.4 131.7 57.9 217.3z"/></svg></a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><div class=md-progress data-md-component=progress role=progressbar></div><div class=md-consent data-md-component=consent id=__consent hidden><div class=md-consent__overlay></div><aside class=md-consent__inner><form class="md-consent__form md-grid md-typeset" name=consent><h4>Cookie consent</h4><p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p><input class=md-toggle type=checkbox id=__settings><div class=md-consent__settings><ul class=task-list><li class=task-list-item><label class=task-list-control><input type=checkbox name=analytics checked><span class=task-list-indicator></span> Google Analytics </label></li><li class=task-list-item><label class=task-list-control><input type=checkbox name=github checked><span class=task-list-indicator></span> GitHub </label></li></ul></div><div class=md-consent__controls><button class="md-button md-button--primary">Accept</button><button type=reset class="md-button md-button--primary">Reject</button><label class=md-button for=__settings>Manage settings</label></div></form></aside></div><script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script><script id=__config type=application/json>{"base": "..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"alias": true, "default": "latest", "provider": "mike"}}</script><script src=../assets/javascripts/bundle.92b07e13.min.js></script><script src=../js/timeago.min.js></script><script src=../js/timeago_mkdocs_material.js></script><script src=../assets/javascripts/medianest.js></script><script src=../assets/javascripts/search-enhancements.js></script><script src=../assets/javascripts/analytics.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=https://unpkg.com/mermaid@10/dist/mermaid.min.js></script></body></html>