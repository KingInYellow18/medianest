# MediaNest Production Deployment Guide

This guide covers deploying MediaNest to a production environment with security best practices, SSL/TLS configuration, and monitoring.

## Prerequisites

- Ubuntu 20.04+ or similar Linux distribution
- Docker 20.10+ and Docker Compose v2
- Domain name with DNS configured
- SSL certificate (Let's Encrypt recommended)
- At least 2GB RAM and 20GB storage

## Pre-Deployment Security Checklist

### 1. Critical Security Fixes Applied ✅

- [x] JWT secret fallbacks removed
- [x] Random salt encryption implemented
- [x] Environment validation enforced

### 2. Environment Preparation

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install required packages
sudo apt install -y curl git ufw fail2ban

# Configure firewall
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable

# Configure fail2ban for SSH protection
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

## Deployment Steps

### 1. Clone Repository

```bash
cd /opt
sudo git clone https://github.com/yourusername/medianest.git
cd medianest
```

### 2. Configure Environment

```bash
# Copy production environment template
cp .env.production.example .env.production

# Generate secure secrets
npm run generate-secrets

# Edit configuration
nano .env.production
```

**Required configurations:**

- `DOMAIN_NAME`: Your domain (e.g., media.example.com)
- `DATABASE_URL`: Use a strong password
- `REDIS_URL`: Use a strong password
- `JWT_SECRET`: Generated by script
- `NEXTAUTH_SECRET`: Generated by script
- `ENCRYPTION_KEY`: Generated by script (min 32 chars)
- `PLEX_CLIENT_ID` & `PLEX_CLIENT_SECRET`: From Plex app

### 3. SSL Certificate Setup

#### Option A: Let's Encrypt (Recommended)

```bash
# Install Certbot
sudo apt install certbot

# Generate certificate
sudo certbot certonly --standalone -d your-domain.com

# Create SSL directory
sudo mkdir -p infrastructure/nginx/ssl

# Link certificates
sudo ln -s /etc/letsencrypt/live/your-domain.com/fullchain.pem infrastructure/nginx/ssl/
sudo ln -s /etc/letsencrypt/live/your-domain.com/privkey.pem infrastructure/nginx/ssl/

# Set up auto-renewal
echo "0 0,12 * * * root certbot renew --quiet" | sudo tee -a /etc/crontab
```

#### Option B: Custom Certificate

```bash
# Copy your certificates
sudo cp /path/to/fullchain.pem infrastructure/nginx/ssl/
sudo cp /path/to/privkey.pem infrastructure/nginx/ssl/
sudo chmod 600 infrastructure/nginx/ssl/*
```

### 4. Docker Secrets Setup

```bash
# Generate Docker secrets
./scripts/generate-docker-secrets.sh

# Verify secrets created
docker secret ls
```

### 5. Build and Deploy

```bash
# Build production images
docker compose -f docker-compose.prod.yml build

# Start services
docker compose -f docker-compose.prod.yml up -d

# Verify all services are running
docker compose -f docker-compose.prod.yml ps

# Check logs
docker compose -f docker-compose.prod.yml logs -f
```

### 6. Database Initialization

```bash
# Run database migrations
docker compose -f docker-compose.prod.yml exec backend npm run db:migrate

# Verify database
docker compose -f docker-compose.prod.yml exec backend npm run db:studio
```

### 7. Health Verification

```bash
# Check API health
curl https://your-domain.com/api/health

# Check frontend
curl -I https://your-domain.com

# Test WebSocket connection
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" https://your-domain.com/socket.io/
```

## Post-Deployment Configuration

### 1. Configure External Services

1. **Login as admin** (first Plex user becomes admin)
2. Navigate to **Settings → Services**
3. Configure:
   - Plex server URL and token
   - Overseerr URL and API key
   - Uptime Kuma URL

### 2. Set Up Monitoring

#### Prometheus Metrics

```yaml
# Add to your prometheus.yml
scrape_configs:
  - job_name: 'medianest'
    static_configs:
      - targets: ['medianest-backend:9090']
```

#### Health Checks

```bash
# Add to crontab
*/5 * * * * curl -f https://your-domain.com/api/health || docker restart medianest-backend-1
```

### 3. Configure Backups

```bash
# Create backup script
cat > /opt/medianest/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backups/medianest/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

# Backup database
docker compose -f docker-compose.prod.yml exec -T postgres \
  pg_dump -U medianest medianest | gzip > "$BACKUP_DIR/database.sql.gz"

# Backup uploads
docker cp medianest-backend-1:/app/uploads "$BACKUP_DIR/"

# Backup environment
cp .env.production "$BACKUP_DIR/"

# Clean old backups
find /backups/medianest -type d -mtime +7 -exec rm -rf {} +

echo "Backup completed: $BACKUP_DIR"
EOF

chmod +x /opt/medianest/backup.sh

# Add to crontab
echo "0 3 * * * /opt/medianest/backup.sh" | sudo tee -a /etc/crontab
```

## Security Hardening

### 1. Additional Nginx Security Headers

Already configured in `nginx.conf`:

- HSTS with preload
- XSS Protection
- Content Type Options
- Frame Options
- Referrer Policy
- Permissions Policy

### 2. Rate Limiting

Pre-configured zones:

- API: 100 requests/minute
- Auth: 5 requests/minute
- Static: 200 requests/minute

### 3. File Upload Security

```bash
# Set upload limits in nginx.conf
client_max_body_size 100M;  # Already configured

# Verify file type validation in backend
# Configured in upload middleware
```

### 4. Database Security

```bash
# Restrict database access
docker compose -f docker-compose.prod.yml exec postgres psql -U postgres -c "
  REVOKE ALL ON DATABASE medianest FROM PUBLIC;
  GRANT CONNECT ON DATABASE medianest TO medianest;
  GRANT ALL PRIVILEGES ON DATABASE medianest TO medianest;
"
```

## Monitoring and Alerts

### 1. Log Aggregation

```bash
# View aggregated logs
docker compose -f docker-compose.prod.yml logs -f

# Export logs to file
docker compose -f docker-compose.prod.yml logs > medianest-logs-$(date +%Y%m%d).log
```

### 2. Resource Monitoring

```bash
# Monitor container resources
docker stats

# Check disk usage
df -h
du -sh /var/lib/docker/
```

### 3. Error Tracking

If using Sentry:

1. Set `SENTRY_DSN` in `.env.production`
2. Restart backend service
3. Verify in Sentry dashboard

## Troubleshooting

### Common Issues

#### 1. Container Won't Start

```bash
# Check logs
docker compose -f docker-compose.prod.yml logs backend

# Verify environment
docker compose -f docker-compose.prod.yml config

# Check secrets
docker secret ls
```

#### 2. Database Connection Failed

```bash
# Test connection
docker compose -f docker-compose.prod.yml exec backend \
  psql $DATABASE_URL -c "SELECT 1"

# Check postgres logs
docker compose -f docker-compose.prod.yml logs postgres
```

#### 3. SSL Certificate Issues

```bash
# Verify certificate
openssl x509 -in infrastructure/nginx/ssl/fullchain.pem -text -noout

# Test SSL
curl -vI https://your-domain.com
```

#### 4. Memory Issues

```bash
# Check memory usage
free -h

# Adjust Docker memory limits in docker-compose.prod.yml
deploy:
  resources:
    limits:
      memory: 1g
```

## Maintenance

### Regular Tasks

#### Weekly

- Review logs for errors
- Check disk space
- Verify backups

#### Monthly

- Update dependencies
- Security patches
- Performance review

#### Quarterly

- Full security audit
- Database optimization
- Certificate renewal check

### Update Procedure

```bash
# Backup first!
./backup.sh

# Pull updates
git pull origin main

# Rebuild and restart
docker compose -f docker-compose.prod.yml build
docker compose -f docker-compose.prod.yml up -d

# Run migrations
docker compose -f docker-compose.prod.yml exec backend npm run db:migrate
```

## Rollback Procedure

If deployment fails:

```bash
# Stop containers
docker compose -f docker-compose.prod.yml down

# Restore from backup
cd /backups/medianest/latest
gunzip -c database.sql.gz | docker compose -f docker-compose.prod.yml exec -T postgres psql -U medianest

# Restore environment
cp .env.production /opt/medianest/

# Restart with previous version
docker compose -f docker-compose.prod.yml up -d
```

## Performance Optimization

### 1. Enable Redis Persistence

```yaml
# In docker-compose.prod.yml
redis:
  command: redis-server --appendonly yes
```

### 2. PostgreSQL Tuning

```sql
-- Connect to database
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET work_mem = '4MB';
```

### 3. Node.js Optimization

```bash
# Set in .env.production
NODE_OPTIONS="--max-old-space-size=1024"
```

## Security Incident Response

1. **Immediate Actions**
   - Isolate affected system
   - Review logs
   - Change all credentials

2. **Investigation**
   - Check access logs
   - Review authentication logs
   - Audit database queries

3. **Recovery**
   - Restore from clean backup
   - Apply security patches
   - Update documentation

## Support

For production issues:

1. Check logs first
2. Review this documentation
3. Search existing issues
4. Create detailed bug report

Remember: **Security is an ongoing process**. Regularly update, monitor, and audit your deployment.
