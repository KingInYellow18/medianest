# System Maintenance\n\nComprehensive maintenance procedures and best practices for MediaNest.\n\n## Overview\n\nThis section covers all aspects of maintaining a MediaNest installation, from routine maintenance tasks to system updates and long-term operational procedures.\n\n## Maintenance Documentation\n\n### Routine Maintenance\n- [Daily Tasks](./daily-tasks.md) - Daily maintenance checklist\n- [Weekly Tasks](./weekly-tasks.md) - Weekly system maintenance\n- [Monthly Tasks](./monthly-tasks.md) - Monthly maintenance procedures\n- [Health Checks](./health-checks.md) - Regular system health verification\n\n### Data Management\n- [Backup Procedures](./backups.md) - Complete backup strategies\n- [Data Archival](./data-archival.md) - Long-term data management\n- [Database Maintenance](./database-maintenance.md) - Database optimization and cleanup\n- [Log Management](./log-management.md) - Log rotation and cleanup\n\n### System Updates\n- [Update Procedures](./updates.md) - System and application updates\n- [Security Updates](./security-updates.md) - Critical security patches\n- [Dependency Updates](./dependency-updates.md) - Node.js and package updates\n- [Database Migrations](./database-migrations.md) - Schema updates and migrations\n\n### Monitoring & Alerting\n- [Monitoring Maintenance](./monitoring-maintenance.md) - Maintaining monitoring systems\n- [Alert Management](./alert-management.md) - Managing alerts and notifications\n- [Performance Baselines](./performance-baselines.md) - Updating performance benchmarks\n- [Capacity Planning](./capacity-planning.md) - Resource planning and scaling\n\n## Maintenance Schedule\n\n### Daily (Automated)\n\n`bash\n#!/bin/bash\n# scripts/daily-maintenance.sh\n\n# Health check\ncurl -f http://localhost:3001/api/health || echo \"Health check failed\"\n\n# Check disk space\ndf -h | grep -E '9[0-9]%' && echo \"Warning: Disk space low\"\n\n# Check service status\ndocker-compose ps | grep -v \"Up\" && echo \"Warning: Services not running\"\n\n# Backup database\n./scripts/backup-database.sh\n\n# Clean old logs (keep 30 days)\nfind /var/log -name \"*.log\" -mtime +30 -delete\n`\n\n### Weekly (Manual/Automated)\n\n`bash\n#!/bin/bash\n# scripts/weekly-maintenance.sh\n\n# Update system packages\nsudo apt update && sudo apt upgrade -y\n\n# Clean Docker cache\ndocker system prune -f\n\n# Analyze database performance\ndocker-compose exec postgres psql -U postgres -c \"ANALYZE;\"\n\n# Check SSL certificate expiry\necho | openssl s_client -servername yourdomain.com -connect yourdomain.com:443 2>/dev/null | openssl x509 -noout -dates\n\n# Review monitoring alerts\n# Manual task: Review Grafana dashboards\n`\n\n### Monthly (Manual)\n\n`bash\n#!/bin/bash\n# scripts/monthly-maintenance.sh\n\n# Full database vacuum\ndocker-compose exec postgres psql -U postgres -c \"VACUUM FULL;\"\n\n# Update dependencies\nnpm audit\nnpm update\n\n# Review security logs\n# Manual task: Review authentication logs for anomalies\n\n# Capacity planning review\n# Manual task: Review resource usage trends\n\n# Backup verification\n# Manual task: Test backup restore procedure\n`\n\n## Backup Procedures\n\n### Automated Daily Backups\n\n`bash\n#!/bin/bash\n# scripts/backup-database.sh\n\nBACKUP_DIR=\"/backups/$(date +%Y/%m)\"\nBACKUP_FILE=\"medianest-$(date +%Y%m%d-%H%M%S).sql.gz\"\n\n# Create backup directory\nmkdir -p \"$BACKUP_DIR\"\n\n# Backup database\ndocker-compose exec -T postgres pg_dump -U postgres medianest | gzip > \"$BACKUP_DIR/$BACKUP_FILE\"\n\n# Backup Redis\ndocker-compose exec redis redis-cli BGSAVE\nsleep 5\ndocker cp $(docker-compose ps -q redis):/data/dump.rdb \"$BACKUP_DIR/redis-$(date +%Y%m%d-%H%M%S).rdb\"\n\n# Clean old backups (keep 30 days)\nfind /backups -name \"*.sql.gz\" -mtime +30 -delete\nfind /backups -name \"*.rdb\" -mtime +30 -delete\n\necho \"Backup completed: $BACKUP_FILE\"\n`\n\n### Backup Verification\n\n`bash\n#!/bin/bash\n# scripts/verify-backup.sh\n\nBACKUP_FILE=$1\n\nif [ -z \"$BACKUP_FILE\" ]; then\n    echo \"Usage: $0 <backup_file>\"\n    exit 1\nfi\n\n# Test backup integrity\nzcat \"$BACKUP_FILE\" | head -20\necho \"Backup file appears valid\"\n\n# Optional: Restore to test database\n# createdb test_restore\n# zcat \"$BACKUP_FILE\" | psql test_restore\n# dropdb test_restore\n`\n\n## System Updates\n\n### Application Updates\n\n`bash\n#!/bin/bash\n# scripts/update-application.sh\n\n# Backup before update\n./scripts/backup-database.sh\n\n# Pull latest code\ngit fetch origin\ngit pull origin main\n\n# Update dependencies\nnpm ci\ncd frontend && npm ci && cd ..\ncd backend && npm ci && cd ..\n\n# Run database migrations\ndocker-compose exec backend npm run db:migrate\n\n# Rebuild and restart services\ndocker-compose build\ndocker-compose up -d\n\n# Verify deployment\nsleep 30\ncurl -f http://localhost:3001/api/health || echo \"Deployment verification failed\"\n`\n\n### Security Updates\n\n`bash\n#!/bin/bash\n# scripts/security-update.sh\n\n# Update system packages\nsudo apt update\nsudo apt upgrade -y\nsudo apt autoremove -y\n\n# Update Docker\nsudo apt update\nsudo apt install docker-ce docker-ce-cli containerd.io\n\n# Update Node.js dependencies\nnpm audit fix\n\n# Rebuild containers with latest base images\ndocker-compose build --no-cache\ndocker-compose up -d\n\n# Restart services for security patches\nsudo systemctl restart docker\ndocker-compose restart\n`\n\n## Database Maintenance\n\n### Regular Database Optimization\n\n`sql\n-- Monthly database maintenance\n\n-- Update table statistics\nANALYZE;\n\n-- Reclaim space\nVACUUM VERBOSE;\n\n-- Check for slow queries\nSELECT query, mean_time, calls \nFROM pg_stat_statements \nORDER BY mean_time DESC \nLIMIT 10;\n\n-- Check index usage\nSELECT schemaname, tablename, indexname, idx_tup_read, idx_tup_fetch\nFROM pg_stat_user_indexes\nWHERE idx_tup_read = 0;\n\n-- Check table sizes\nSELECT schemaname, tablename, \n       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size\nFROM pg_tables\nORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;\n`\n\n### Log Cleanup\n\n`bash\n#!/bin/bash\n# scripts/cleanup-logs.sh\n\n# Application logs (keep 30 days)\nfind /var/log/medianest -name \"*.log\" -mtime +30 -delete\n\n# Docker logs\ndocker system prune -f --volumes\n\n# Database logs\ndocker-compose exec postgres find /var/log/postgresql -name \"*.log\" -mtime +7 -delete\n\n# System logs\njournalctl --vacuum-time=30d\n\necho \"Log cleanup completed\"\n`\n\n## Monitoring Maintenance\n\n### Update Monitoring Configuration\n\n`yaml\n# Update monitoring/prometheus.yml\nscrape_configs:\n  - job_name: 'medianest'\n    static_configs:\n      - targets: ['backend:3001']\n    metrics_path: '/api/metrics'\n    scrape_interval: 15s\n    \n  - job_name: 'postgres'\n    static_configs:\n      - targets: ['postgres:9187']\n`\n\n### Alert Maintenance\n\n`bash\n#!/bin/bash\n# scripts/update-alerts.sh\n\n# Test alert endpoints\ncurl -f http://localhost:9093/api/v1/alerts\n\n# Validate alert rules\npromtool check rules monitoring/alert-rules.yml\n\n# Reload Prometheus configuration\ncurl -X POST http://localhost:9090/-/reload\n`\n\n## Disaster Recovery\n\n### Recovery Procedures\n\n`bash\n#!/bin/bash\n# scripts/disaster-recovery.sh\n\nBACKUP_DATE=$1\n\nif [ -z \"$BACKUP_DATE\" ]; then\n    echo \"Usage: $0 <YYYYMMDD>\"\n    echo \"Available backups:\"\n    ls /backups/\n    exit 1\nfi\n\n# Stop all services\ndocker-compose down -v\n\n# Restore database\nzcat \"/backups/medianest-${BACKUP_DATE}*.sql.gz\" | docker-compose exec -T postgres psql -U postgres medianest\n\n# Restore Redis\ndocker cp \"/backups/redis-${BACKUP_DATE}*.rdb\" $(docker-compose ps -q redis):/data/dump.rdb\n\n# Start services\ndocker-compose up -d\n\n# Verify recovery\nsleep 30\ncurl -f http://localhost:3001/api/health\n\necho \"Disaster recovery completed for $BACKUP_DATE\"\n`\n\n## Maintenance Checklist\n\n### Pre-Maintenance\n\n- [ ] **Backup System** - Complete system backup\n- [ ] **Check Monitoring** - Verify monitoring is operational\n- [ ] **Resource Check** - Ensure adequate system resources\n- [ ] **Schedule Window** - Plan maintenance during low usage\n- [ ] **Rollback Plan** - Prepare rollback procedures\n\n### During Maintenance\n\n- [ ] **Monitor Progress** - Watch for errors during updates\n- [ ] **Test Functionality** - Verify core features work\n- [ ] **Check Performance** - Monitor response times\n- [ ] **Verify Backups** - Ensure backups are valid\n- [ ] **Update Documentation** - Record any changes\n\n### Post-Maintenance\n\n- [ ] **Health Verification** - Complete system health check\n- [ ] **Performance Baseline** - Update performance metrics\n- [ ] **Alert Testing** - Verify monitoring and alerting\n- [ ] **User Communication** - Notify users of completion\n- [ ] **Schedule Next** - Plan next maintenance window\n\n## Related Documentation\n\n- [Monitoring Guide](../08-monitoring/README.md) - Setting up monitoring for maintenance\n- [Deployment Guide](../06-deployment/README.md) - Production deployment maintenance\n- [Troubleshooting](../10-troubleshooting/README.md) - Resolving maintenance issues\n- [Performance Guide](../11-performance/README.md) - Performance optimization during maintenance
