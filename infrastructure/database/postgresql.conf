# MediaNest PostgreSQL Production Configuration
# Optimized for a homelab environment with moderate usage

# Connection Settings
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# Memory Settings (adjust based on available RAM)
shared_buffers = 256MB              # 25% of RAM for dedicated DB server
effective_cache_size = 1GB          # 50-75% of RAM
maintenance_work_mem = 64MB         # Memory for maintenance tasks
work_mem = 4MB                      # Memory per query operation

# Checkpoint Settings
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
max_wal_size = 1GB
min_wal_size = 80MB

# Write-Ahead Logging
wal_level = replica
wal_buffers = 16MB
wal_compression = on
archive_mode = off                  # Enable if you want WAL archiving

# Query Planner
random_page_cost = 1.1              # SSD optimization
effective_io_concurrency = 200      # SSD optimization
default_statistics_target = 100

# Logging
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000   # Log queries slower than 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_line_prefix = '%t [%p] %u@%d '
log_statement = 'mod'               # Log all data-modifying statements

# Statistics
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Autovacuum
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# Lock Management
deadlock_timeout = 1s
max_locks_per_transaction = 64

# Error Handling
restart_after_crash = on

# Performance Tuning for MediaNest
# Optimized for mixed read/write workload
synchronous_commit = on
full_page_writes = on
wal_sync_method = fdatasync

# Connection Pooling Settings (when using PgBouncer)
# tcp_keepalives_idle = 600
# tcp_keepalives_interval = 30
# tcp_keepalives_count = 10

# SSL Configuration (if using SSL)
# ssl = on
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'
# ssl_prefer_server_ciphers = on
# ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'

# Locale Settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Shared Libraries
shared_preload_libraries = 'pg_stat_statements'

# Statement Tracking
pg_stat_statements.track = all
pg_stat_statements.max = 10000