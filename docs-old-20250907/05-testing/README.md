# Testing Documentation

Comprehensive testing strategies and guides for MediaNest.

## Overview

MediaNest uses a multi-layered testing approach combining unit, integration, and end-to-end tests to ensure reliability and maintainability.

## Testing Strategy

### Test Types

1. **Unit Tests** - Test individual functions and components in isolation
2. **Integration Tests** - Test service interactions and API endpoints
3. **End-to-End Tests** - Test complete user workflows
4. **Performance Tests** - Test system performance under load
5. **Security Tests** - Test for vulnerabilities and security issues
6. **Manual Tests** - Structured manual testing procedures

### Coverage Goals

- **Unit Tests**: >90% code coverage
- **Integration Tests**: All API endpoints and service integrations
- **E2E Tests**: All critical user journeys
- **Performance**: All major workflows under expected load

## Test Documentation

### Core Testing Guides

- [Unit Testing](./unit-testing.md) - Component and function testing
- [Integration Testing](./integration-testing.md) - API and service testing
- [End-to-End Testing](./e2e-testing.md) - User workflow testing
- [Performance Testing](./performance-testing.md) - Load and stress testing

### Specialized Testing

- [API Testing](./api-testing.md) - REST API endpoint testing
- [Database Testing](./database-testing.md) - Data layer testing
- [Security Testing](./security-testing.md) - Vulnerability and penetration testing
- [Manual Testing](./manual-testing.md) - Structured manual test procedures

## Technology Stack

### Frontend Testing

`yaml\nFramework: Jest + React Testing Library\nE2E Testing: Playwright\nMocking: MSW (Mock Service Worker)\nCoverage: Istanbul/NYC\nVisual Testing: Chromatic (planned)\n`\n\n### Backend Testing\n`yaml\nFramework: Jest + Supertest\nDatabase Testing: Test containers\nMocking: Jest mocks + Testdouble\nAPI Testing: Supertest + Postman\nLoad Testing: k6\n`\n\n### Test Environment\n`yaml\nContainers: Docker Compose test services\nDatabase: PostgreSQL test instance\nCache: Redis test instance\nMocking: Wiremock for external services\nCI/CD: GitHub Actions\n`\n\n## Quick Start\n\n### Running Tests\n\n`bash\n# Run all tests\nnpm test\n\n# Run unit tests only\nnpm run test:unit\n\n# Run integration tests\nnpm run test:integration\n\n# Run E2E tests\nnpm run test:e2e\n\n# Run with coverage\nnpm run test:coverage\n\n# Watch mode for development\nnpm run test:watch\n`\n\n### Test Structure\n\n`\ntests/\n├── unit/\n│   ├── frontend/\n│   │   ├── components/\n│   │   ├── hooks/\n│   │   └── utils/\n│   └── backend/\n│       ├── controllers/\n│       ├── services/\n│       └── utils/\n├── integration/\n│   ├── api/\n│   ├── database/\n│   └── services/\n├── e2e/\n│   ├── auth/\n│   ├── media/\n│   └── admin/\n├── performance/\n├── security/\n├── fixtures/\n└── helpers/\n`\n\n## Writing Tests\n\n### Unit Test Example\n\n`typescript\n// tests/unit/backend/services/auth.service.test.ts\nimport { authService } from '@/services/auth.service';\nimport { userRepository } from '@/repositories/user.repository';\n\njest.mock('@/repositories/user.repository');\n\ndescribe('AuthService', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('validateUser', () => {\n    it('should return user when credentials are valid', async () => {\n      // Arrange\n      const mockUser = {\n        id: '1',\n        email: 'test@example.com',\n        password: 'hashed-password'\n      };\n      (userRepository.findByEmail as jest.Mock).mockResolvedValue(mockUser);\n      \n      // Act\n      const result = await authService.validateUser('test@example.com', 'password');\n      \n      // Assert\n      expect(result).toEqual(expect.objectContaining({\n        id: '1',\n        email: 'test@example.com'\n      }));\n      expect(result.password).toBeUndefined(); // Password should be stripped\n    });\n    \n    it('should throw error when user not found', async () => {\n      // Arrange\n      (userRepository.findByEmail as jest.Mock).mockResolvedValue(null);\n      \n      // Act & Assert\n      await expect(\n        authService.validateUser('nonexistent@example.com', 'password')\n      ).rejects.toThrow('Invalid credentials');\n    });\n  });\n});\n`\n\n### Integration Test Example\n\n`typescript\n// tests/integration/api/auth.test.ts\nimport request from 'supertest';\nimport { app } from '@/app';\nimport { setupTestDatabase, cleanupTestDatabase } from '../helpers/database';\n\ndescribe('Authentication API', () => {\n  beforeAll(async () => {\n    await setupTestDatabase();\n  });\n  \n  afterAll(async () => {\n    await cleanupTestDatabase();\n  });\n  \n  describe('POST /api/auth/plex/pin', () => {\n    it('should generate a valid PIN', async () => {\n      const response = await request(app)\n        .post('/api/auth/plex/pin')\n        .expect(200);\n        \n      expect(response.body).toMatchObject({\n        success: true,\n        data: {\n          pin: expect.stringMatching(/^[A-Z0-9]{4}$/),\n          id: expect.any(Number),\n          expiresAt: expect.any(String)\n        }\n      });\n    });\n  });\n});\n`\n\n### E2E Test Example\n\n`typescript\n// tests/e2e/auth/plex-login.spec.ts\nimport { test, expect } from '@playwright/test';\n\ntest.describe('Plex Authentication', () => {\n  test('should complete Plex login flow', async ({ page }) => {\n    // Navigate to login page\n    await page.goto('/login');\n    \n    // Click Plex login button\n    await page.click('[data-testid=\"plex-login-button\"]');\n    \n    // Should show PIN input\n    await expect(page.locator('[data-testid=\"plex-pin\"]')).toBeVisible();\n    \n    // Mock successful PIN verification\n    await page.route('/api/auth/plex/verify', async route => {\n      await route.fulfill({\n        status: 200,\n        contentType: 'application/json',\n        body: JSON.stringify({\n          success: true,\n          data: {\n            user: { id: '1', email: 'test@plex.tv', role: 'user' }\n          }\n        })\n      });\n    });\n    \n    // Simulate PIN authorization\n    await page.evaluate(() => {\n      window.dispatchEvent(new CustomEvent('plex-pin-authorized'));\n    });\n    \n    // Should redirect to dashboard\n    await expect(page).toHaveURL('/dashboard');\n    await expect(page.locator('[data-testid=\"user-menu\"]')).toBeVisible();\n  });\n});\n`\n\n## Test Data Management\n\n### Fixtures\n\n`typescript\n// tests/fixtures/users.ts\nexport const mockUsers = {\n  admin: {\n    id: 'admin-1',\n    email: 'admin@medianest.local',\n    username: 'admin',\n    role: 'admin',\n    createdAt: '2025-01-01T00:00:00.000Z'\n  },\n  user: {\n    id: 'user-1', \n    email: 'user@example.com',\n    username: 'testuser',\n    role: 'user',\n    plexId: '123456',\n    createdAt: '2025-01-01T00:00:00.000Z'\n  }\n};\n`\n\n### Database Seeding\n\n`typescript\n// tests/helpers/database.ts\nimport { PrismaClient } from '@prisma/client';\nimport { mockUsers } from '../fixtures/users';\n\nconst prisma = new PrismaClient({\n  datasources: { db: { url: process.env.TEST_DATABASE_URL } }\n});\n\nexport async function setupTestDatabase() {\n  await prisma.$connect();\n  await prisma.user.createMany({\n    data: Object.values(mockUsers)\n  });\n}\n\nexport async function cleanupTestDatabase() {\n  await prisma.user.deleteMany();\n  await prisma.$disconnect();\n}\n`\n\n## Mocking Strategies\n\n### External Service Mocking\n\n`typescript\n// tests/mocks/plex-api.ts\nimport { rest } from 'msw';\nimport { setupServer } from 'msw/node';\n\nexport const plexApiMocks = [\n  rest.post('https://plex.tv/api/v2/pins', (req, res, ctx) => {\n    return res(\n      ctx.json({\n        id: 12345,\n        code: 'ABCD',\n        expiresAt: new Date(Date.now() + 5 * 60 * 1000).toISOString()\n      })\n    );\n  }),\n  \n  rest.get('https://plex.tv/api/v2/pins/:id', (req, res, ctx) => {\n    const { id } = req.params;\n    return res(\n      ctx.json({\n        id,\n        authToken: 'mock-plex-token',\n        user: {\n          id: 123456,\n          email: 'test@plex.tv',\n          username: 'testuser'\n        }\n      })\n    );\n  })\n];\n\nexport const server = setupServer(...plexApiMocks);\n`\n\n## Continuous Integration\n\n### GitHub Actions Workflow\n\n`yaml\n# .github/workflows/test.yml\nname: Test Suite\non: [push, pull_request]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    services:\n      postgres:\n        image: postgres:14\n        env:\n          POSTGRES_PASSWORD: test\n        options: >-\n          --health-cmd pg_isready\n          --health-interval 10s\n          --health-timeout 5s\n          --health-retries 5\n      redis:\n        image: redis:6\n        options: >-\n          --health-cmd \"redis-cli ping\"\n          --health-interval 10s\n          --health-timeout 5s\n          --health-retries 5\n    \n    steps:\n      - uses: actions/checkout@v3\n      - uses: actions/setup-node@v3\n        with:\n          node-version: '18'\n          cache: 'npm'\n      \n      - run: npm ci\n      - run: npm run build\n      - run: npm run test:coverage\n      - run: npm run test:e2e\n      \n      - uses: codecov/codecov-action@v3\n        with:\n          files: ./coverage/lcov.info\n`\n\n## Performance Testing\n\n### k6 Load Test Example\n\n`javascript\n// tests/performance/auth-load.js\nimport http from 'k6/http';\nimport { check, sleep } from 'k6';\n\nexport let options = {\n  vus: 10, // 10 virtual users\n  duration: '30s',\n  thresholds: {\n    http_req_duration: ['p(95)<500'], // 95% of requests under 500ms\n    http_req_failed: ['rate<0.01'], // Error rate under 1%\n  },\n};\n\nexport default function () {\n  // Test PIN generation\n  let pinResponse = http.post('http://localhost:3001/api/auth/plex/pin');\n  check(pinResponse, {\n    'PIN generation successful': (r) => r.status === 200,\n    'PIN format valid': (r) => JSON.parse(r.body).data.pin.match(/^[A-Z0-9]{4}$/)\n  });\n  \n  sleep(1);\n}\n`\n\n## Test Reporting\n\n### Coverage Reports\n\n`bash\n# Generate coverage reports\nnpm run test:coverage\n\n# View HTML coverage report\nopen coverage/lcov-report/index.html\n`\n\n### Test Results Dashboard\n\n- **Local Development**: Jest built-in reporting\n- **CI/CD**: GitHub Actions test summaries \n- **Coverage**: Codecov integration\n- **E2E Reports**: Playwright HTML reports\n\n## Best Practices\n\n### Test Organization\n\n1. **Arrange-Act-Assert Pattern**: Structure tests clearly\n2. **Single Responsibility**: One assertion per test when possible\n3. **Descriptive Names**: Test names should describe the scenario\n4. **Independent Tests**: Tests should not depend on each other\n5. **Fast Execution**: Keep unit tests fast, integration tests reasonable\n\n### Mocking Guidelines\n\n1. **Mock External Dependencies**: Always mock external APIs and services\n2. **Don't Mock What You Own**: Avoid mocking internal application code\n3. **Use Real Data Structures**: Mock responses should match real API responses\n4. **Reset Mocks**: Clear mocks between tests to avoid interference\n\n### Performance Considerations\n\n1. **Parallel Execution**: Run tests in parallel when possible\n2. **Database Transactions**: Use transactions for test isolation\n3. **Resource Cleanup**: Always clean up resources after tests\n4. **Selective Testing**: Use test patterns for faster feedback\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Flaky Tests**: Usually caused by timing issues or shared state\n2. **Slow Tests**: Often due to unnecessary database calls or timeouts\n3. **Mock Issues**: Verify mock configurations match actual API responses\n4. **Environment Issues**: Ensure test environment variables are set correctly\n\n### Debug Mode\n\n`bash\n# Run tests in debug mode\nnpm run test:debug\n\n# Run specific test file\nnpm test -- tests/unit/auth.test.ts\n\n# Run tests matching pattern\nnpm test -- --testNamePattern=\"should validate user\"\n`\n\n## Related Documentation\n\n- [Implementation Guides](../04-implementation-guides/README.md) - How to implement testable features\n- [API Reference](../03-api-reference/README.md) - API endpoints for testing\n- [Deployment Guide](../06-deployment/README.md) - Production testing strategies\n- [Performance Guide](../11-performance/README.md) - Performance optimization"}]
